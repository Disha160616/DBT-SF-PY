

============================== 2023-01-24 02:09:50.738726 | 85238755-0784-4d14-aab4-6586bc071251 ==============================
[0m02:09:50.738794 [info ] [MainThread]: Running with dbt=1.3.2
[0m02:09:50.739504 [debug] [MainThread]: running dbt with arguments {'write_json': True, 'use_colors': True, 'printer_width': 80, 'version_check': True, 'partial_parse': True, 'static_parser': True, 'profiles_dir': '/Users/bruno/.dbt', 'send_anonymous_usage_stats': True, 'event_buffer_size': 100000, 'quiet': False, 'no_print': False, 'cache_selected_only': False, 'indirect_selection': 'eager', 'resource_types': [], 'which': 'build', 'rpc_method': 'build'}
[0m02:09:50.739656 [debug] [MainThread]: Tracking: tracking
[0m02:09:50.740262 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10e712b80>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10e712be0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10e712c40>]}
[0m02:09:50.751516 [info ] [MainThread]: Partial parse save file not found. Starting full parse.
[0m02:09:50.751783 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'partial_parser', 'label': '85238755-0784-4d14-aab4-6586bc071251', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10e72c0d0>]}
[0m02:09:50.774007 [debug] [MainThread]: Parsing macros/catalog.sql
[0m02:09:50.776202 [debug] [MainThread]: Parsing macros/adapters.sql
[0m02:09:50.814830 [debug] [MainThread]: Parsing macros/apply_grants.sql
[0m02:09:50.815731 [debug] [MainThread]: Parsing macros/materializations/test.sql
[0m02:09:50.816429 [debug] [MainThread]: Parsing macros/materializations/merge.sql
[0m02:09:50.819422 [debug] [MainThread]: Parsing macros/materializations/seed.sql
[0m02:09:50.823470 [debug] [MainThread]: Parsing macros/materializations/view.sql
[0m02:09:50.824441 [debug] [MainThread]: Parsing macros/materializations/table.sql
[0m02:09:50.829060 [debug] [MainThread]: Parsing macros/materializations/incremental.sql
[0m02:09:50.837069 [debug] [MainThread]: Parsing macros/materializations/snapshot.sql
[0m02:09:50.837775 [debug] [MainThread]: Parsing macros/utils/timestamps.sql
[0m02:09:50.839190 [debug] [MainThread]: Parsing macros/utils/escape_single_quotes.sql
[0m02:09:50.839623 [debug] [MainThread]: Parsing macros/utils/right.sql
[0m02:09:50.840089 [debug] [MainThread]: Parsing macros/utils/safe_cast.sql
[0m02:09:50.840446 [debug] [MainThread]: Parsing macros/utils/bool_or.sql
[0m02:09:50.840752 [debug] [MainThread]: Parsing macros/utils/array_construct.sql
[0m02:09:50.841130 [debug] [MainThread]: Parsing macros/materializations/hooks.sql
[0m02:09:50.843999 [debug] [MainThread]: Parsing macros/materializations/configs.sql
[0m02:09:50.845789 [debug] [MainThread]: Parsing macros/materializations/snapshots/snapshot_merge.sql
[0m02:09:50.847034 [debug] [MainThread]: Parsing macros/materializations/snapshots/strategies.sql
[0m02:09:50.859757 [debug] [MainThread]: Parsing macros/materializations/snapshots/helpers.sql
[0m02:09:50.871199 [debug] [MainThread]: Parsing macros/materializations/snapshots/snapshot.sql
[0m02:09:50.881371 [debug] [MainThread]: Parsing macros/materializations/tests/test.sql
[0m02:09:50.884827 [debug] [MainThread]: Parsing macros/materializations/tests/helpers.sql
[0m02:09:50.886133 [debug] [MainThread]: Parsing macros/materializations/tests/where_subquery.sql
[0m02:09:50.887442 [debug] [MainThread]: Parsing macros/materializations/models/incremental/column_helpers.sql
[0m02:09:50.893707 [debug] [MainThread]: Parsing macros/materializations/models/incremental/merge.sql
[0m02:09:50.907145 [debug] [MainThread]: Parsing macros/materializations/models/incremental/is_incremental.sql
[0m02:09:50.908264 [debug] [MainThread]: Parsing macros/materializations/models/incremental/strategies.sql
[0m02:09:50.913350 [debug] [MainThread]: Parsing macros/materializations/models/incremental/incremental.sql
[0m02:09:50.921640 [debug] [MainThread]: Parsing macros/materializations/models/incremental/on_schema_change.sql
[0m02:09:50.936556 [debug] [MainThread]: Parsing macros/materializations/models/table/table.sql
[0m02:09:50.940857 [debug] [MainThread]: Parsing macros/materializations/models/table/create_table_as.sql
[0m02:09:50.943368 [debug] [MainThread]: Parsing macros/materializations/models/view/view.sql
[0m02:09:50.947763 [debug] [MainThread]: Parsing macros/materializations/models/view/helpers.sql
[0m02:09:50.948687 [debug] [MainThread]: Parsing macros/materializations/models/view/create_or_replace_view.sql
[0m02:09:50.951287 [debug] [MainThread]: Parsing macros/materializations/models/view/create_view_as.sql
[0m02:09:50.952969 [debug] [MainThread]: Parsing macros/materializations/seeds/seed.sql
[0m02:09:50.958774 [debug] [MainThread]: Parsing macros/materializations/seeds/helpers.sql
[0m02:09:50.974910 [debug] [MainThread]: Parsing macros/get_custom_name/get_custom_alias.sql
[0m02:09:50.976069 [debug] [MainThread]: Parsing macros/get_custom_name/get_custom_schema.sql
[0m02:09:50.977892 [debug] [MainThread]: Parsing macros/get_custom_name/get_custom_database.sql
[0m02:09:50.979024 [debug] [MainThread]: Parsing macros/generic_test_sql/relationships.sql
[0m02:09:50.979669 [debug] [MainThread]: Parsing macros/generic_test_sql/not_null.sql
[0m02:09:50.980235 [debug] [MainThread]: Parsing macros/generic_test_sql/unique.sql
[0m02:09:50.980717 [debug] [MainThread]: Parsing macros/generic_test_sql/accepted_values.sql
[0m02:09:50.981724 [debug] [MainThread]: Parsing macros/etc/statement.sql
[0m02:09:50.985880 [debug] [MainThread]: Parsing macros/etc/datetime.sql
[0m02:09:50.992566 [debug] [MainThread]: Parsing macros/utils/except.sql
[0m02:09:50.993161 [debug] [MainThread]: Parsing macros/utils/replace.sql
[0m02:09:50.994036 [debug] [MainThread]: Parsing macros/utils/concat.sql
[0m02:09:50.994715 [debug] [MainThread]: Parsing macros/utils/length.sql
[0m02:09:50.995374 [debug] [MainThread]: Parsing macros/utils/dateadd.sql
[0m02:09:50.996272 [debug] [MainThread]: Parsing macros/utils/intersect.sql
[0m02:09:50.996843 [debug] [MainThread]: Parsing macros/utils/escape_single_quotes.sql
[0m02:09:50.997570 [debug] [MainThread]: Parsing macros/utils/right.sql
[0m02:09:50.998443 [debug] [MainThread]: Parsing macros/utils/listagg.sql
[0m02:09:51.000194 [debug] [MainThread]: Parsing macros/utils/datediff.sql
[0m02:09:51.001071 [debug] [MainThread]: Parsing macros/utils/safe_cast.sql
[0m02:09:51.001825 [debug] [MainThread]: Parsing macros/utils/hash.sql
[0m02:09:51.002564 [debug] [MainThread]: Parsing macros/utils/cast_bool_to_text.sql
[0m02:09:51.003283 [debug] [MainThread]: Parsing macros/utils/any_value.sql
[0m02:09:51.003931 [debug] [MainThread]: Parsing macros/utils/position.sql
[0m02:09:51.004685 [debug] [MainThread]: Parsing macros/utils/literal.sql
[0m02:09:51.005314 [debug] [MainThread]: Parsing macros/utils/data_types.sql
[0m02:09:51.010753 [debug] [MainThread]: Parsing macros/utils/array_concat.sql
[0m02:09:51.011486 [debug] [MainThread]: Parsing macros/utils/bool_or.sql
[0m02:09:51.012126 [debug] [MainThread]: Parsing macros/utils/last_day.sql
[0m02:09:51.013396 [debug] [MainThread]: Parsing macros/utils/split_part.sql
[0m02:09:51.015094 [debug] [MainThread]: Parsing macros/utils/date_trunc.sql
[0m02:09:51.015818 [debug] [MainThread]: Parsing macros/utils/array_construct.sql
[0m02:09:51.016878 [debug] [MainThread]: Parsing macros/utils/array_append.sql
[0m02:09:51.017612 [debug] [MainThread]: Parsing macros/adapters/schema.sql
[0m02:09:51.019124 [debug] [MainThread]: Parsing macros/adapters/timestamps.sql
[0m02:09:51.021491 [debug] [MainThread]: Parsing macros/adapters/indexes.sql
[0m02:09:51.023495 [debug] [MainThread]: Parsing macros/adapters/relation.sql
[0m02:09:51.035296 [debug] [MainThread]: Parsing macros/adapters/freshness.sql
[0m02:09:51.036716 [debug] [MainThread]: Parsing macros/adapters/apply_grants.sql
[0m02:09:51.046828 [debug] [MainThread]: Parsing macros/adapters/persist_docs.sql
[0m02:09:51.050105 [debug] [MainThread]: Parsing macros/adapters/metadata.sql
[0m02:09:51.055655 [debug] [MainThread]: Parsing macros/adapters/columns.sql
[0m02:09:51.063168 [debug] [MainThread]: Parsing macros/python_model/python.sql
[0m02:09:51.067870 [debug] [MainThread]: Parsing tests/generic/builtin.sql
[0m02:09:51.267420 [debug] [MainThread]: 1699: static parser successfully parsed customers.sql
[0m02:09:51.276669 [debug] [MainThread]: 1603: static parser failed on order.sql
[0m02:09:51.280707 [debug] [MainThread]: 1602: parser fallback to jinja rendering on order.sql
[0m02:09:51.281578 [debug] [MainThread]: 1699: static parser successfully parsed staging/stg_customers.sql
[0m02:09:51.283685 [debug] [MainThread]: 1699: static parser successfully parsed staging/stg_payments.sql
[0m02:09:51.285567 [debug] [MainThread]: 1699: static parser successfully parsed staging/stg_orders.sql
[0m02:09:51.320105 [warn ] [MainThread]: [[33mWARNING[0m]: Did not find matching node for patch with name 'orders' in the 'models' section of file 'models/schema.yml'
[0m02:09:51.385732 [warn ] [MainThread]: [[33mWARNING[0m]: Test 'test.jaffle_shop.unique_orders_order_id.fed79b3a6e' (models/schema.yml) depends on a node named 'orders' which was not found
[0m02:09:51.386010 [warn ] [MainThread]: [[33mWARNING[0m]: Test 'test.jaffle_shop.not_null_orders_order_id.cf6c17daed' (models/schema.yml) depends on a node named 'orders' which was not found
[0m02:09:51.386169 [warn ] [MainThread]: [[33mWARNING[0m]: Test 'test.jaffle_shop.not_null_orders_customer_id.c5f02694af' (models/schema.yml) depends on a node named 'orders' which was not found
[0m02:09:51.386325 [warn ] [MainThread]: [[33mWARNING[0m]: Test 'test.jaffle_shop.relationships_orders_customer_id__customer_id__ref_customers_.c6ec7f58f2' (models/schema.yml) depends on a node named 'orders' which was not found
[0m02:09:51.386483 [warn ] [MainThread]: [[33mWARNING[0m]: Test 'test.jaffle_shop.accepted_values_orders_status__placed__shipped__completed__return_pending__returned.be6b5b5ec3' (models/schema.yml) depends on a node named 'orders' which was not found
[0m02:09:51.386640 [warn ] [MainThread]: [[33mWARNING[0m]: Test 'test.jaffle_shop.not_null_orders_amount.106140f9fd' (models/schema.yml) depends on a node named 'orders' which was not found
[0m02:09:51.386790 [warn ] [MainThread]: [[33mWARNING[0m]: Test 'test.jaffle_shop.not_null_orders_credit_card_amount.d3ca593b59' (models/schema.yml) depends on a node named 'orders' which was not found
[0m02:09:51.387013 [warn ] [MainThread]: [[33mWARNING[0m]: Test 'test.jaffle_shop.not_null_orders_coupon_amount.ab90c90625' (models/schema.yml) depends on a node named 'orders' which was not found
[0m02:09:51.387183 [warn ] [MainThread]: [[33mWARNING[0m]: Test 'test.jaffle_shop.not_null_orders_bank_transfer_amount.7743500c49' (models/schema.yml) depends on a node named 'orders' which was not found
[0m02:09:51.387339 [warn ] [MainThread]: [[33mWARNING[0m]: Test 'test.jaffle_shop.not_null_orders_gift_card_amount.413a0d2d7a' (models/schema.yml) depends on a node named 'orders' which was not found
[0m02:09:51.450704 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '85238755-0784-4d14-aab4-6586bc071251', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10cb845e0>]}
[0m02:09:51.457979 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '85238755-0784-4d14-aab4-6586bc071251', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10e72c9a0>]}
[0m02:09:51.458171 [info ] [MainThread]: Found 5 models, 10 tests, 0 snapshots, 0 analyses, 303 macros, 0 operations, 3 seed files, 0 sources, 0 exposures, 0 metrics
[0m02:09:51.458346 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '85238755-0784-4d14-aab4-6586bc071251', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10ec86e20>]}
[0m02:09:51.459737 [info ] [MainThread]: 
[0m02:09:51.460201 [debug] [MainThread]: Acquiring new snowflake connection "master"
[0m02:09:51.461074 [debug] [ThreadPool]: Acquiring new snowflake connection "list_jaffle_shop"
[0m02:09:51.472657 [debug] [ThreadPool]: Using snowflake connection "list_jaffle_shop"
[0m02:09:51.472822 [debug] [ThreadPool]: On list_jaffle_shop: /* {"app": "dbt", "dbt_version": "1.3.2", "profile_name": "jaffle_shop", "target_name": "dev", "connection_name": "list_jaffle_shop"} */
show terse schemas in database jaffle_shop
    limit 10000
[0m02:09:51.472909 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m02:09:52.790270 [debug] [ThreadPool]: SQL status: SUCCESS 3 in 1.32 seconds
[0m02:09:52.795831 [debug] [ThreadPool]: On list_jaffle_shop: Close
[0m02:09:53.140629 [debug] [ThreadPool]: Acquiring new snowflake connection "list_jaffle_shop_bruno"
[0m02:09:53.154841 [debug] [ThreadPool]: Using snowflake connection "list_jaffle_shop_bruno"
[0m02:09:53.155195 [debug] [ThreadPool]: On list_jaffle_shop_bruno: /* {"app": "dbt", "dbt_version": "1.3.2", "profile_name": "jaffle_shop", "target_name": "dev", "connection_name": "list_jaffle_shop_bruno"} */
show terse objects in jaffle_shop.bruno
[0m02:09:53.155407 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m02:09:53.759966 [debug] [ThreadPool]: SQL status: SUCCESS 0 in 0.6 seconds
[0m02:09:53.763874 [debug] [ThreadPool]: On list_jaffle_shop_bruno: Close
[0m02:09:54.144056 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '85238755-0784-4d14-aab4-6586bc071251', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10e838b50>]}
[0m02:09:54.145600 [info ] [MainThread]: Concurrency: 1 threads (target='dev')
[0m02:09:54.146136 [info ] [MainThread]: 
[0m02:09:54.152682 [debug] [Thread-1  ]: Began running node seed.jaffle_shop.raw_customers
[0m02:09:54.153291 [info ] [Thread-1  ]: 1 of 18 START seed file bruno.raw_customers .................................... [RUN]
[0m02:09:54.155316 [debug] [Thread-1  ]: Acquiring new snowflake connection "seed.jaffle_shop.raw_customers"
[0m02:09:54.155624 [debug] [Thread-1  ]: Began compiling node seed.jaffle_shop.raw_customers
[0m02:09:54.155918 [debug] [Thread-1  ]: finished collecting timing info
[0m02:09:54.156166 [debug] [Thread-1  ]: Began executing node seed.jaffle_shop.raw_customers
[0m02:09:54.209990 [debug] [Thread-1  ]: Using snowflake connection "seed.jaffle_shop.raw_customers"
[0m02:09:54.210199 [debug] [Thread-1  ]: On seed.jaffle_shop.raw_customers: /* {"app": "dbt", "dbt_version": "1.3.2", "profile_name": "jaffle_shop", "target_name": "dev", "node_id": "seed.jaffle_shop.raw_customers"} */
create table jaffle_shop.bruno.raw_customers (id integer,first_name text,last_name text)
[0m02:09:54.210314 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m02:09:55.045995 [debug] [Thread-1  ]: SQL status: SUCCESS 1 in 0.84 seconds
[0m02:09:55.083842 [debug] [Thread-1  ]: Using snowflake connection "seed.jaffle_shop.raw_customers"
[0m02:09:55.084244 [debug] [Thread-1  ]: On seed.jaffle_shop.raw_customers: /* {"app": "dbt", "dbt_version": "1.3.2", "profile_name": "jaffle_shop", "target_name": "dev", "node_id": "seed.jaffle_shop.raw_customers"} */
BEGIN
[0m02:09:55.283269 [debug] [Thread-1  ]: SQL status: SUCCESS 1 in 0.2 seconds
[0m02:09:55.289444 [debug] [Thread-1  ]: Using snowflake connection "seed.jaffle_shop.raw_customers"
[0m02:09:55.289979 [debug] [Thread-1  ]: On seed.jaffle_shop.raw_customers: /* {"app": "dbt", "dbt_version": "1.3.2", "profile_name": "jaffle_shop", "target_name": "dev", "node_id": "seed.jaffle_shop.raw_customers"} */
insert into jaffle_shop.bruno.raw_customers (id, first_name, last_name) values
            (%s,%s,%s),(%s,%s,%s),(%s,%s,%s),(%s,%s,%s),(%s,%s,%s),(%s,%s,%s),(%s,%s,%s),(%s,%s,%s),(%s,%s,%s),(%s,%s,%s),(%s,%s,%s),(%s,%s,%s),(%s,%s,%s),(%s,%s,%s),(%s,%s,%s),(%s,%s,%s),(%s,%s,%s),(%s,%s,%s),(%s,%s,%s),(%s,%s,%s),(%s,%s,%s),(%s,%s,%s),(%s,%s,%s),(%s,%s,%s),(%s,%s,%s),(%s...
[0m02:09:56.326975 [debug] [Thread-1  ]: SQL status: SUCCESS 100 in 1.04 seconds
[0m02:09:56.327629 [debug] [Thread-1  ]: Using snowflake connection "seed.jaffle_shop.raw_customers"
[0m02:09:56.327912 [debug] [Thread-1  ]: On seed.jaffle_shop.raw_customers: /* {"app": "dbt", "dbt_version": "1.3.2", "profile_name": "jaffle_shop", "target_name": "dev", "node_id": "seed.jaffle_shop.raw_customers"} */
COMMIT
[0m02:09:56.600563 [debug] [Thread-1  ]: SQL status: SUCCESS 1 in 0.27 seconds
[0m02:09:56.620103 [debug] [Thread-1  ]: Writing runtime SQL for node "seed.jaffle_shop.raw_customers"
[0m02:09:56.659225 [debug] [Thread-1  ]: finished collecting timing info
[0m02:09:56.659509 [debug] [Thread-1  ]: On seed.jaffle_shop.raw_customers: Close
[0m02:09:56.989757 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '85238755-0784-4d14-aab4-6586bc071251', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x11054cd60>]}
[0m02:09:56.991126 [info ] [Thread-1  ]: 1 of 18 OK loaded seed file bruno.raw_customers ................................ [[32mINSERT 100[0m in 2.84s]
[0m02:09:56.992380 [debug] [Thread-1  ]: Finished running node seed.jaffle_shop.raw_customers
[0m02:09:56.992786 [debug] [Thread-1  ]: Began running node seed.jaffle_shop.raw_orders
[0m02:09:56.993805 [info ] [Thread-1  ]: 2 of 18 START seed file bruno.raw_orders ....................................... [RUN]
[0m02:09:56.995816 [debug] [Thread-1  ]: Acquiring new snowflake connection "seed.jaffle_shop.raw_orders"
[0m02:09:56.996161 [debug] [Thread-1  ]: Began compiling node seed.jaffle_shop.raw_orders
[0m02:09:56.996454 [debug] [Thread-1  ]: finished collecting timing info
[0m02:09:56.996723 [debug] [Thread-1  ]: Began executing node seed.jaffle_shop.raw_orders
[0m02:09:57.014996 [debug] [Thread-1  ]: Using snowflake connection "seed.jaffle_shop.raw_orders"
[0m02:09:57.015379 [debug] [Thread-1  ]: On seed.jaffle_shop.raw_orders: /* {"app": "dbt", "dbt_version": "1.3.2", "profile_name": "jaffle_shop", "target_name": "dev", "node_id": "seed.jaffle_shop.raw_orders"} */
create table jaffle_shop.bruno.raw_orders (id integer,user_id integer,order_date date,status text)
[0m02:09:57.015595 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m02:09:57.645498 [debug] [Thread-1  ]: SQL status: SUCCESS 1 in 0.63 seconds
[0m02:09:57.653871 [debug] [Thread-1  ]: Using snowflake connection "seed.jaffle_shop.raw_orders"
[0m02:09:57.654119 [debug] [Thread-1  ]: On seed.jaffle_shop.raw_orders: /* {"app": "dbt", "dbt_version": "1.3.2", "profile_name": "jaffle_shop", "target_name": "dev", "node_id": "seed.jaffle_shop.raw_orders"} */
BEGIN
[0m02:09:57.960567 [debug] [Thread-1  ]: SQL status: SUCCESS 1 in 0.31 seconds
[0m02:09:57.969924 [debug] [Thread-1  ]: Using snowflake connection "seed.jaffle_shop.raw_orders"
[0m02:09:57.970468 [debug] [Thread-1  ]: On seed.jaffle_shop.raw_orders: /* {"app": "dbt", "dbt_version": "1.3.2", "profile_name": "jaffle_shop", "target_name": "dev", "node_id": "seed.jaffle_shop.raw_orders"} */
insert into jaffle_shop.bruno.raw_orders (id, user_id, order_date, status) values
            (%s,%s,%s,%s),(%s,%s,%s,%s),(%s,%s,%s,%s),(%s,%s,%s,%s),(%s,%s,%s,%s),(%s,%s,%s,%s),(%s,%s,%s,%s),(%s,%s,%s,%s),(%s,%s,%s,%s),(%s,%s,%s,%s),(%s,%s,%s,%s),(%s,%s,%s,%s),(%s,%s,%s,%s),(%s,%s,%s,%s),(%s,%s,%s,%s),(%s,%s,%s,%s),(%s,%s,%s,%s),(%s,%s,%s,%s),(%s,%s,%s,%s),(%s,%s,%s,%s...
[0m02:09:58.916766 [debug] [Thread-1  ]: SQL status: SUCCESS 99 in 0.95 seconds
[0m02:09:58.917659 [debug] [Thread-1  ]: Using snowflake connection "seed.jaffle_shop.raw_orders"
[0m02:09:58.917999 [debug] [Thread-1  ]: On seed.jaffle_shop.raw_orders: /* {"app": "dbt", "dbt_version": "1.3.2", "profile_name": "jaffle_shop", "target_name": "dev", "node_id": "seed.jaffle_shop.raw_orders"} */
COMMIT
[0m02:09:59.291222 [debug] [Thread-1  ]: SQL status: SUCCESS 1 in 0.37 seconds
[0m02:09:59.294006 [debug] [Thread-1  ]: Writing runtime SQL for node "seed.jaffle_shop.raw_orders"
[0m02:09:59.301289 [debug] [Thread-1  ]: finished collecting timing info
[0m02:09:59.301823 [debug] [Thread-1  ]: On seed.jaffle_shop.raw_orders: Close
[0m02:09:59.635997 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '85238755-0784-4d14-aab4-6586bc071251', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x11054c280>]}
[0m02:09:59.636908 [info ] [Thread-1  ]: 2 of 18 OK loaded seed file bruno.raw_orders ................................... [[32mINSERT 99[0m in 2.64s]
[0m02:09:59.637672 [debug] [Thread-1  ]: Finished running node seed.jaffle_shop.raw_orders
[0m02:09:59.637990 [debug] [Thread-1  ]: Began running node seed.jaffle_shop.raw_payments
[0m02:09:59.638598 [info ] [Thread-1  ]: 3 of 18 START seed file bruno.raw_payments ..................................... [RUN]
[0m02:09:59.640166 [debug] [Thread-1  ]: Acquiring new snowflake connection "seed.jaffle_shop.raw_payments"
[0m02:09:59.640544 [debug] [Thread-1  ]: Began compiling node seed.jaffle_shop.raw_payments
[0m02:09:59.640847 [debug] [Thread-1  ]: finished collecting timing info
[0m02:09:59.641124 [debug] [Thread-1  ]: Began executing node seed.jaffle_shop.raw_payments
[0m02:09:59.657992 [debug] [Thread-1  ]: Using snowflake connection "seed.jaffle_shop.raw_payments"
[0m02:09:59.658342 [debug] [Thread-1  ]: On seed.jaffle_shop.raw_payments: /* {"app": "dbt", "dbt_version": "1.3.2", "profile_name": "jaffle_shop", "target_name": "dev", "node_id": "seed.jaffle_shop.raw_payments"} */
create table jaffle_shop.bruno.raw_payments (id integer,order_id integer,payment_method text,amount integer)
[0m02:09:59.658557 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m02:10:00.351219 [debug] [Thread-1  ]: SQL status: SUCCESS 1 in 0.69 seconds
[0m02:10:00.362510 [debug] [Thread-1  ]: Using snowflake connection "seed.jaffle_shop.raw_payments"
[0m02:10:00.362751 [debug] [Thread-1  ]: On seed.jaffle_shop.raw_payments: /* {"app": "dbt", "dbt_version": "1.3.2", "profile_name": "jaffle_shop", "target_name": "dev", "node_id": "seed.jaffle_shop.raw_payments"} */
BEGIN
[0m02:10:00.560413 [debug] [Thread-1  ]: SQL status: SUCCESS 1 in 0.2 seconds
[0m02:10:00.570209 [debug] [Thread-1  ]: Using snowflake connection "seed.jaffle_shop.raw_payments"
[0m02:10:00.570741 [debug] [Thread-1  ]: On seed.jaffle_shop.raw_payments: /* {"app": "dbt", "dbt_version": "1.3.2", "profile_name": "jaffle_shop", "target_name": "dev", "node_id": "seed.jaffle_shop.raw_payments"} */
insert into jaffle_shop.bruno.raw_payments (id, order_id, payment_method, amount) values
            (%s,%s,%s,%s),(%s,%s,%s,%s),(%s,%s,%s,%s),(%s,%s,%s,%s),(%s,%s,%s,%s),(%s,%s,%s,%s),(%s,%s,%s,%s),(%s,%s,%s,%s),(%s,%s,%s,%s),(%s,%s,%s,%s),(%s,%s,%s,%s),(%s,%s,%s,%s),(%s,%s,%s,%s),(%s,%s,%s,%s),(%s,%s,%s,%s),(%s,%s,%s,%s),(%s,%s,%s,%s),(%s,%s,%s,%s),(%s,%s,%s,%s),(%s...
[0m02:10:01.146483 [debug] [Thread-1  ]: SQL status: SUCCESS 113 in 0.58 seconds
[0m02:10:01.147434 [debug] [Thread-1  ]: Using snowflake connection "seed.jaffle_shop.raw_payments"
[0m02:10:01.147820 [debug] [Thread-1  ]: On seed.jaffle_shop.raw_payments: /* {"app": "dbt", "dbt_version": "1.3.2", "profile_name": "jaffle_shop", "target_name": "dev", "node_id": "seed.jaffle_shop.raw_payments"} */
COMMIT
[0m02:10:01.543671 [debug] [Thread-1  ]: SQL status: SUCCESS 1 in 0.4 seconds
[0m02:10:01.546018 [debug] [Thread-1  ]: Writing runtime SQL for node "seed.jaffle_shop.raw_payments"
[0m02:10:01.553738 [debug] [Thread-1  ]: finished collecting timing info
[0m02:10:01.556905 [debug] [Thread-1  ]: On seed.jaffle_shop.raw_payments: Close
[0m02:10:01.957129 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '85238755-0784-4d14-aab4-6586bc071251', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x110495160>]}
[0m02:10:01.958102 [info ] [Thread-1  ]: 3 of 18 OK loaded seed file bruno.raw_payments ................................. [[32mINSERT 113[0m in 2.32s]
[0m02:10:01.959014 [debug] [Thread-1  ]: Finished running node seed.jaffle_shop.raw_payments
[0m02:10:01.959392 [debug] [Thread-1  ]: Began running node model.jaffle_shop.stg_customers
[0m02:10:01.960083 [info ] [Thread-1  ]: 4 of 18 START sql view model bruno.stg_customers ............................... [RUN]
[0m02:10:01.961701 [debug] [Thread-1  ]: Acquiring new snowflake connection "model.jaffle_shop.stg_customers"
[0m02:10:01.962065 [debug] [Thread-1  ]: Began compiling node model.jaffle_shop.stg_customers
[0m02:10:01.962363 [debug] [Thread-1  ]: Compiling model.jaffle_shop.stg_customers
[0m02:10:01.969383 [debug] [Thread-1  ]: Writing injected SQL for node "model.jaffle_shop.stg_customers"
[0m02:10:01.970726 [debug] [Thread-1  ]: finished collecting timing info
[0m02:10:01.971012 [debug] [Thread-1  ]: Began executing node model.jaffle_shop.stg_customers
[0m02:10:02.000578 [debug] [Thread-1  ]: Writing runtime sql for node "model.jaffle_shop.stg_customers"
[0m02:10:02.001911 [debug] [Thread-1  ]: Using snowflake connection "model.jaffle_shop.stg_customers"
[0m02:10:02.002075 [debug] [Thread-1  ]: On model.jaffle_shop.stg_customers: /* {"app": "dbt", "dbt_version": "1.3.2", "profile_name": "jaffle_shop", "target_name": "dev", "node_id": "model.jaffle_shop.stg_customers"} */
create or replace  view jaffle_shop.bruno.stg_customers
  
   as (
    with source as (
    select * from jaffle_shop.bruno.raw_customers

),

renamed as (

    select
        id as customer_id,
        first_name,
        last_name

    from source

)

select * from renamed
  );
[0m02:10:02.002213 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m02:10:02.748078 [debug] [Thread-1  ]: SQL status: SUCCESS 1 in 0.75 seconds
[0m02:10:02.750890 [debug] [Thread-1  ]: finished collecting timing info
[0m02:10:02.751158 [debug] [Thread-1  ]: On model.jaffle_shop.stg_customers: Close
[0m02:10:02.898754 [debug] [MainThread]: Acquiring new snowflake connection "master"
[0m02:10:02.899261 [debug] [MainThread]: Snowflake adapter: Cancelling query 'model.jaffle_shop.stg_customers' (1183654165)
[0m02:10:02.899817 [debug] [MainThread]: Using snowflake connection "master"
[0m02:10:02.900153 [debug] [MainThread]: On master: /* {"app": "dbt", "dbt_version": "1.3.2", "profile_name": "jaffle_shop", "target_name": "dev", "connection_name": "master"} */
select system$abort_session(1183654165)
[0m02:10:02.901721 [debug] [MainThread]: Opening a new connection, currently in state init
[0m02:10:03.140990 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '85238755-0784-4d14-aab4-6586bc071251', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1105acf40>]}
[0m02:10:03.141559 [debug] [MainThread]: Connection 'master' was properly closed.
[0m02:10:03.141753 [debug] [MainThread]: Connection 'model.jaffle_shop.stg_customers' was properly closed.
[0m02:10:03.142058 [info ] [Thread-1  ]: 4 of 18 OK created sql view model bruno.stg_customers .......................... [[32mSUCCESS 1[0m in 1.18s]
[0m02:10:03.142200 [debug] [MainThread]: Flushing usage events
[0m02:10:03.142562 [debug] [Thread-1  ]: Finished running node model.jaffle_shop.stg_customers
[0m02:10:03.282078 [info ] [MainThread]: ctrl-c


============================== 2023-01-24 02:10:16.479378 | 61b7a1e4-52d3-4c84-b034-dba31f823dff ==============================
[0m02:10:16.479459 [info ] [MainThread]: Running with dbt=1.3.2
[0m02:10:16.480451 [debug] [MainThread]: running dbt with arguments {'write_json': True, 'use_colors': True, 'printer_width': 80, 'version_check': True, 'partial_parse': True, 'static_parser': True, 'profiles_dir': '/Users/bruno/.dbt', 'send_anonymous_usage_stats': True, 'event_buffer_size': 100000, 'quiet': False, 'no_print': False, 'cache_selected_only': False, 'indirect_selection': 'eager', 'resource_types': [], 'which': 'build', 'rpc_method': 'build'}
[0m02:10:16.480623 [debug] [MainThread]: Tracking: tracking
[0m02:10:16.481067 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10fb94b80>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10fb94be0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10fb94c40>]}
[0m02:10:16.541022 [debug] [MainThread]: Partial parsing enabled: 1 files deleted, 1 files added, 0 files changed.
[0m02:10:16.541384 [debug] [MainThread]: Partial parsing: added file: jaffle_shop://models/orders.sql
[0m02:10:16.541491 [debug] [MainThread]: Partial parsing: deleted file: jaffle_shop://models/order.sql
[0m02:10:16.554979 [debug] [MainThread]: 1603: static parser failed on orders.sql
[0m02:10:16.567529 [debug] [MainThread]: 1602: parser fallback to jinja rendering on orders.sql
[0m02:10:16.585401 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '61b7a1e4-52d3-4c84-b034-dba31f823dff', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x110116190>]}
[0m02:10:16.592568 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '61b7a1e4-52d3-4c84-b034-dba31f823dff', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10fcba970>]}
[0m02:10:16.592797 [info ] [MainThread]: Found 5 models, 10 tests, 0 snapshots, 0 analyses, 303 macros, 0 operations, 3 seed files, 0 sources, 0 exposures, 0 metrics
[0m02:10:16.592985 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '61b7a1e4-52d3-4c84-b034-dba31f823dff', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1100deaf0>]}
[0m02:10:16.594515 [info ] [MainThread]: 
[0m02:10:16.595003 [debug] [MainThread]: Acquiring new snowflake connection "master"
[0m02:10:16.596189 [debug] [ThreadPool]: Acquiring new snowflake connection "list_jaffle_shop"
[0m02:10:16.609261 [debug] [ThreadPool]: Using snowflake connection "list_jaffle_shop"
[0m02:10:16.609472 [debug] [ThreadPool]: On list_jaffle_shop: /* {"app": "dbt", "dbt_version": "1.3.2", "profile_name": "jaffle_shop", "target_name": "dev", "connection_name": "list_jaffle_shop"} */
show terse schemas in database jaffle_shop
    limit 10000
[0m02:10:16.609574 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m02:10:17.493589 [debug] [ThreadPool]: SQL status: SUCCESS 3 in 0.88 seconds
[0m02:10:17.498431 [debug] [ThreadPool]: On list_jaffle_shop: Close
[0m02:10:17.829519 [debug] [ThreadPool]: Acquiring new snowflake connection "list_jaffle_shop_bruno"
[0m02:10:17.844179 [debug] [ThreadPool]: Using snowflake connection "list_jaffle_shop_bruno"
[0m02:10:17.844532 [debug] [ThreadPool]: On list_jaffle_shop_bruno: /* {"app": "dbt", "dbt_version": "1.3.2", "profile_name": "jaffle_shop", "target_name": "dev", "connection_name": "list_jaffle_shop_bruno"} */
show terse objects in jaffle_shop.bruno
[0m02:10:17.844750 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m02:10:18.406194 [debug] [ThreadPool]: SQL status: SUCCESS 4 in 0.56 seconds
[0m02:10:18.410379 [debug] [ThreadPool]: On list_jaffle_shop_bruno: Close
[0m02:10:18.797321 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '61b7a1e4-52d3-4c84-b034-dba31f823dff', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x110116250>]}
[0m02:10:18.798885 [info ] [MainThread]: Concurrency: 1 threads (target='dev')
[0m02:10:18.799443 [info ] [MainThread]: 
[0m02:10:18.805530 [debug] [Thread-1  ]: Began running node seed.jaffle_shop.raw_customers
[0m02:10:18.806159 [info ] [Thread-1  ]: 1 of 18 START seed file bruno.raw_customers .................................... [RUN]
[0m02:10:18.808218 [debug] [Thread-1  ]: Acquiring new snowflake connection "seed.jaffle_shop.raw_customers"
[0m02:10:18.808576 [debug] [Thread-1  ]: Began compiling node seed.jaffle_shop.raw_customers
[0m02:10:18.808860 [debug] [Thread-1  ]: finished collecting timing info
[0m02:10:18.809113 [debug] [Thread-1  ]: Began executing node seed.jaffle_shop.raw_customers
[0m02:10:18.866283 [debug] [Thread-1  ]: Using snowflake connection "seed.jaffle_shop.raw_customers"
[0m02:10:18.866491 [debug] [Thread-1  ]: On seed.jaffle_shop.raw_customers: /* {"app": "dbt", "dbt_version": "1.3.2", "profile_name": "jaffle_shop", "target_name": "dev", "node_id": "seed.jaffle_shop.raw_customers"} */
BEGIN
[0m02:10:18.866600 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m02:10:19.454913 [debug] [Thread-1  ]: SQL status: SUCCESS 1 in 0.59 seconds
[0m02:10:19.455759 [debug] [Thread-1  ]: Using snowflake connection "seed.jaffle_shop.raw_customers"
[0m02:10:19.456140 [debug] [Thread-1  ]: On seed.jaffle_shop.raw_customers: /* {"app": "dbt", "dbt_version": "1.3.2", "profile_name": "jaffle_shop", "target_name": "dev", "node_id": "seed.jaffle_shop.raw_customers"} */
truncate table "JAFFLE_SHOP"."BRUNO"."RAW_CUSTOMERS"
  ;
[0m02:10:19.970662 [debug] [Thread-1  ]: SQL status: SUCCESS 1 in 0.51 seconds
[0m02:10:19.971924 [debug] [Thread-1  ]: Using snowflake connection "seed.jaffle_shop.raw_customers"
[0m02:10:19.972219 [debug] [Thread-1  ]: On seed.jaffle_shop.raw_customers: /* {"app": "dbt", "dbt_version": "1.3.2", "profile_name": "jaffle_shop", "target_name": "dev", "node_id": "seed.jaffle_shop.raw_customers"} */
COMMIT
[0m02:10:20.281506 [debug] [Thread-1  ]: SQL status: SUCCESS 1 in 0.31 seconds
[0m02:10:20.314150 [debug] [Thread-1  ]: Using snowflake connection "seed.jaffle_shop.raw_customers"
[0m02:10:20.314511 [debug] [Thread-1  ]: On seed.jaffle_shop.raw_customers: /* {"app": "dbt", "dbt_version": "1.3.2", "profile_name": "jaffle_shop", "target_name": "dev", "node_id": "seed.jaffle_shop.raw_customers"} */
BEGIN
[0m02:10:20.515959 [debug] [Thread-1  ]: SQL status: SUCCESS 1 in 0.2 seconds
[0m02:10:20.522237 [debug] [Thread-1  ]: Using snowflake connection "seed.jaffle_shop.raw_customers"
[0m02:10:20.522935 [debug] [Thread-1  ]: On seed.jaffle_shop.raw_customers: /* {"app": "dbt", "dbt_version": "1.3.2", "profile_name": "jaffle_shop", "target_name": "dev", "node_id": "seed.jaffle_shop.raw_customers"} */
insert into jaffle_shop.bruno.raw_customers (id, first_name, last_name) values
            (%s,%s,%s),(%s,%s,%s),(%s,%s,%s),(%s,%s,%s),(%s,%s,%s),(%s,%s,%s),(%s,%s,%s),(%s,%s,%s),(%s,%s,%s),(%s,%s,%s),(%s,%s,%s),(%s,%s,%s),(%s,%s,%s),(%s,%s,%s),(%s,%s,%s),(%s,%s,%s),(%s,%s,%s),(%s,%s,%s),(%s,%s,%s),(%s,%s,%s),(%s,%s,%s),(%s,%s,%s),(%s,%s,%s),(%s,%s,%s),(%s,%s,%s),(%s...
[0m02:10:21.202156 [debug] [Thread-1  ]: SQL status: SUCCESS 100 in 0.68 seconds
[0m02:10:21.203033 [debug] [Thread-1  ]: Using snowflake connection "seed.jaffle_shop.raw_customers"
[0m02:10:21.203309 [debug] [Thread-1  ]: On seed.jaffle_shop.raw_customers: /* {"app": "dbt", "dbt_version": "1.3.2", "profile_name": "jaffle_shop", "target_name": "dev", "node_id": "seed.jaffle_shop.raw_customers"} */
COMMIT
[0m02:10:21.604262 [debug] [Thread-1  ]: SQL status: SUCCESS 1 in 0.4 seconds
[0m02:10:21.621502 [debug] [Thread-1  ]: Writing runtime SQL for node "seed.jaffle_shop.raw_customers"
[0m02:10:21.654952 [debug] [Thread-1  ]: finished collecting timing info
[0m02:10:21.655172 [debug] [Thread-1  ]: On seed.jaffle_shop.raw_customers: Close
[0m02:10:22.028227 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '61b7a1e4-52d3-4c84-b034-dba31f823dff', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x11067adf0>]}
[0m02:10:22.029294 [info ] [Thread-1  ]: 1 of 18 OK loaded seed file bruno.raw_customers ................................ [[32mINSERT 100[0m in 3.22s]
[0m02:10:22.030417 [debug] [Thread-1  ]: Finished running node seed.jaffle_shop.raw_customers
[0m02:10:22.030792 [debug] [Thread-1  ]: Began running node seed.jaffle_shop.raw_orders
[0m02:10:22.031778 [info ] [Thread-1  ]: 2 of 18 START seed file bruno.raw_orders ....................................... [RUN]
[0m02:10:22.033327 [debug] [Thread-1  ]: Acquiring new snowflake connection "seed.jaffle_shop.raw_orders"
[0m02:10:22.034082 [debug] [Thread-1  ]: Began compiling node seed.jaffle_shop.raw_orders
[0m02:10:22.034399 [debug] [Thread-1  ]: finished collecting timing info
[0m02:10:22.034675 [debug] [Thread-1  ]: Began executing node seed.jaffle_shop.raw_orders
[0m02:10:22.054186 [debug] [Thread-1  ]: Using snowflake connection "seed.jaffle_shop.raw_orders"
[0m02:10:22.054508 [debug] [Thread-1  ]: On seed.jaffle_shop.raw_orders: /* {"app": "dbt", "dbt_version": "1.3.2", "profile_name": "jaffle_shop", "target_name": "dev", "node_id": "seed.jaffle_shop.raw_orders"} */
BEGIN
[0m02:10:22.054703 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m02:10:22.815723 [debug] [Thread-1  ]: SQL status: SUCCESS 1 in 0.76 seconds
[0m02:10:22.816818 [debug] [Thread-1  ]: Using snowflake connection "seed.jaffle_shop.raw_orders"
[0m02:10:22.817335 [debug] [Thread-1  ]: On seed.jaffle_shop.raw_orders: /* {"app": "dbt", "dbt_version": "1.3.2", "profile_name": "jaffle_shop", "target_name": "dev", "node_id": "seed.jaffle_shop.raw_orders"} */
truncate table "JAFFLE_SHOP"."BRUNO"."RAW_ORDERS"
  ;
[0m02:10:23.342938 [debug] [Thread-1  ]: SQL status: SUCCESS 1 in 0.53 seconds
[0m02:10:23.344155 [debug] [Thread-1  ]: Using snowflake connection "seed.jaffle_shop.raw_orders"
[0m02:10:23.344588 [debug] [Thread-1  ]: On seed.jaffle_shop.raw_orders: /* {"app": "dbt", "dbt_version": "1.3.2", "profile_name": "jaffle_shop", "target_name": "dev", "node_id": "seed.jaffle_shop.raw_orders"} */
COMMIT
[0m02:10:23.649236 [debug] [Thread-1  ]: SQL status: SUCCESS 1 in 0.3 seconds
[0m02:10:23.661037 [debug] [Thread-1  ]: Using snowflake connection "seed.jaffle_shop.raw_orders"
[0m02:10:23.661572 [debug] [Thread-1  ]: On seed.jaffle_shop.raw_orders: /* {"app": "dbt", "dbt_version": "1.3.2", "profile_name": "jaffle_shop", "target_name": "dev", "node_id": "seed.jaffle_shop.raw_orders"} */
BEGIN
[0m02:10:23.877710 [debug] [Thread-1  ]: SQL status: SUCCESS 1 in 0.22 seconds
[0m02:10:23.885193 [debug] [Thread-1  ]: Using snowflake connection "seed.jaffle_shop.raw_orders"
[0m02:10:23.885739 [debug] [Thread-1  ]: On seed.jaffle_shop.raw_orders: /* {"app": "dbt", "dbt_version": "1.3.2", "profile_name": "jaffle_shop", "target_name": "dev", "node_id": "seed.jaffle_shop.raw_orders"} */
insert into jaffle_shop.bruno.raw_orders (id, user_id, order_date, status) values
            (%s,%s,%s,%s),(%s,%s,%s,%s),(%s,%s,%s,%s),(%s,%s,%s,%s),(%s,%s,%s,%s),(%s,%s,%s,%s),(%s,%s,%s,%s),(%s,%s,%s,%s),(%s,%s,%s,%s),(%s,%s,%s,%s),(%s,%s,%s,%s),(%s,%s,%s,%s),(%s,%s,%s,%s),(%s,%s,%s,%s),(%s,%s,%s,%s),(%s,%s,%s,%s),(%s,%s,%s,%s),(%s,%s,%s,%s),(%s,%s,%s,%s),(%s,%s,%s,%s...
[0m02:10:24.506310 [debug] [Thread-1  ]: SQL status: SUCCESS 99 in 0.62 seconds
[0m02:10:24.508328 [debug] [Thread-1  ]: Using snowflake connection "seed.jaffle_shop.raw_orders"
[0m02:10:24.508881 [debug] [Thread-1  ]: On seed.jaffle_shop.raw_orders: /* {"app": "dbt", "dbt_version": "1.3.2", "profile_name": "jaffle_shop", "target_name": "dev", "node_id": "seed.jaffle_shop.raw_orders"} */
COMMIT
[0m02:10:24.791669 [debug] [Thread-1  ]: SQL status: SUCCESS 1 in 0.28 seconds
[0m02:10:24.794614 [debug] [Thread-1  ]: Writing runtime SQL for node "seed.jaffle_shop.raw_orders"
[0m02:10:24.801761 [debug] [Thread-1  ]: finished collecting timing info
[0m02:10:24.802199 [debug] [Thread-1  ]: On seed.jaffle_shop.raw_orders: Close
[0m02:10:25.134275 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '61b7a1e4-52d3-4c84-b034-dba31f823dff', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1113b85e0>]}
[0m02:10:25.134853 [info ] [Thread-1  ]: 2 of 18 OK loaded seed file bruno.raw_orders ................................... [[32mINSERT 99[0m in 3.10s]
[0m02:10:25.135503 [debug] [Thread-1  ]: Finished running node seed.jaffle_shop.raw_orders
[0m02:10:25.135814 [debug] [Thread-1  ]: Began running node seed.jaffle_shop.raw_payments
[0m02:10:25.136325 [info ] [Thread-1  ]: 3 of 18 START seed file bruno.raw_payments ..................................... [RUN]
[0m02:10:25.137533 [debug] [Thread-1  ]: Acquiring new snowflake connection "seed.jaffle_shop.raw_payments"
[0m02:10:25.137814 [debug] [Thread-1  ]: Began compiling node seed.jaffle_shop.raw_payments
[0m02:10:25.138060 [debug] [Thread-1  ]: finished collecting timing info
[0m02:10:25.138289 [debug] [Thread-1  ]: Began executing node seed.jaffle_shop.raw_payments
[0m02:10:25.153897 [debug] [Thread-1  ]: Using snowflake connection "seed.jaffle_shop.raw_payments"
[0m02:10:25.154170 [debug] [Thread-1  ]: On seed.jaffle_shop.raw_payments: /* {"app": "dbt", "dbt_version": "1.3.2", "profile_name": "jaffle_shop", "target_name": "dev", "node_id": "seed.jaffle_shop.raw_payments"} */
BEGIN
[0m02:10:25.154334 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m02:10:25.915129 [debug] [Thread-1  ]: SQL status: SUCCESS 1 in 0.76 seconds
[0m02:10:25.915857 [debug] [Thread-1  ]: Using snowflake connection "seed.jaffle_shop.raw_payments"
[0m02:10:25.916149 [debug] [Thread-1  ]: On seed.jaffle_shop.raw_payments: /* {"app": "dbt", "dbt_version": "1.3.2", "profile_name": "jaffle_shop", "target_name": "dev", "node_id": "seed.jaffle_shop.raw_payments"} */
truncate table "JAFFLE_SHOP"."BRUNO"."RAW_PAYMENTS"
  ;
[0m02:10:26.391421 [debug] [Thread-1  ]: SQL status: SUCCESS 1 in 0.47 seconds
[0m02:10:26.392568 [debug] [Thread-1  ]: Using snowflake connection "seed.jaffle_shop.raw_payments"
[0m02:10:26.392902 [debug] [Thread-1  ]: On seed.jaffle_shop.raw_payments: /* {"app": "dbt", "dbt_version": "1.3.2", "profile_name": "jaffle_shop", "target_name": "dev", "node_id": "seed.jaffle_shop.raw_payments"} */
COMMIT
[0m02:10:26.667710 [debug] [Thread-1  ]: SQL status: SUCCESS 1 in 0.27 seconds
[0m02:10:26.679158 [debug] [Thread-1  ]: Using snowflake connection "seed.jaffle_shop.raw_payments"
[0m02:10:26.679671 [debug] [Thread-1  ]: On seed.jaffle_shop.raw_payments: /* {"app": "dbt", "dbt_version": "1.3.2", "profile_name": "jaffle_shop", "target_name": "dev", "node_id": "seed.jaffle_shop.raw_payments"} */
BEGIN
[0m02:10:26.868040 [debug] [Thread-1  ]: SQL status: SUCCESS 1 in 0.19 seconds
[0m02:10:26.876393 [debug] [Thread-1  ]: Using snowflake connection "seed.jaffle_shop.raw_payments"
[0m02:10:26.876969 [debug] [Thread-1  ]: On seed.jaffle_shop.raw_payments: /* {"app": "dbt", "dbt_version": "1.3.2", "profile_name": "jaffle_shop", "target_name": "dev", "node_id": "seed.jaffle_shop.raw_payments"} */
insert into jaffle_shop.bruno.raw_payments (id, order_id, payment_method, amount) values
            (%s,%s,%s,%s),(%s,%s,%s,%s),(%s,%s,%s,%s),(%s,%s,%s,%s),(%s,%s,%s,%s),(%s,%s,%s,%s),(%s,%s,%s,%s),(%s,%s,%s,%s),(%s,%s,%s,%s),(%s,%s,%s,%s),(%s,%s,%s,%s),(%s,%s,%s,%s),(%s,%s,%s,%s),(%s,%s,%s,%s),(%s,%s,%s,%s),(%s,%s,%s,%s),(%s,%s,%s,%s),(%s,%s,%s,%s),(%s,%s,%s,%s),(%s...
[0m02:10:27.576547 [debug] [Thread-1  ]: SQL status: SUCCESS 113 in 0.7 seconds
[0m02:10:27.577819 [debug] [Thread-1  ]: Using snowflake connection "seed.jaffle_shop.raw_payments"
[0m02:10:27.578359 [debug] [Thread-1  ]: On seed.jaffle_shop.raw_payments: /* {"app": "dbt", "dbt_version": "1.3.2", "profile_name": "jaffle_shop", "target_name": "dev", "node_id": "seed.jaffle_shop.raw_payments"} */
COMMIT
[0m02:10:27.861186 [debug] [Thread-1  ]: SQL status: SUCCESS 1 in 0.28 seconds
[0m02:10:27.863494 [debug] [Thread-1  ]: Writing runtime SQL for node "seed.jaffle_shop.raw_payments"
[0m02:10:27.869587 [debug] [Thread-1  ]: finished collecting timing info
[0m02:10:27.869921 [debug] [Thread-1  ]: On seed.jaffle_shop.raw_payments: Close
[0m02:10:28.204349 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '61b7a1e4-52d3-4c84-b034-dba31f823dff', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1113b8850>]}
[0m02:10:28.205294 [info ] [Thread-1  ]: 3 of 18 OK loaded seed file bruno.raw_payments ................................. [[32mINSERT 113[0m in 3.07s]
[0m02:10:28.206251 [debug] [Thread-1  ]: Finished running node seed.jaffle_shop.raw_payments
[0m02:10:28.206641 [debug] [Thread-1  ]: Began running node model.jaffle_shop.stg_customers
[0m02:10:28.207119 [info ] [Thread-1  ]: 4 of 18 START sql view model bruno.stg_customers ............................... [RUN]
[0m02:10:28.208656 [debug] [Thread-1  ]: Acquiring new snowflake connection "model.jaffle_shop.stg_customers"
[0m02:10:28.209156 [debug] [Thread-1  ]: Began compiling node model.jaffle_shop.stg_customers
[0m02:10:28.209531 [debug] [Thread-1  ]: Compiling model.jaffle_shop.stg_customers
[0m02:10:28.218151 [debug] [Thread-1  ]: Writing injected SQL for node "model.jaffle_shop.stg_customers"
[0m02:10:28.218912 [debug] [Thread-1  ]: finished collecting timing info
[0m02:10:28.219182 [debug] [Thread-1  ]: Began executing node model.jaffle_shop.stg_customers
[0m02:10:28.250378 [debug] [Thread-1  ]: Writing runtime sql for node "model.jaffle_shop.stg_customers"
[0m02:10:28.251503 [debug] [Thread-1  ]: Using snowflake connection "model.jaffle_shop.stg_customers"
[0m02:10:28.251670 [debug] [Thread-1  ]: On model.jaffle_shop.stg_customers: /* {"app": "dbt", "dbt_version": "1.3.2", "profile_name": "jaffle_shop", "target_name": "dev", "node_id": "model.jaffle_shop.stg_customers"} */
create or replace  view jaffle_shop.bruno.stg_customers
  
   as (
    with source as (
    select * from jaffle_shop.bruno.raw_customers

),

renamed as (

    select
        id as customer_id,
        first_name,
        last_name

    from source

)

select * from renamed
  );
[0m02:10:28.251809 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m02:10:29.191912 [debug] [Thread-1  ]: SQL status: SUCCESS 1 in 0.94 seconds
[0m02:10:29.207549 [debug] [Thread-1  ]: finished collecting timing info
[0m02:10:29.208299 [debug] [Thread-1  ]: On model.jaffle_shop.stg_customers: Close
[0m02:10:29.607371 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '61b7a1e4-52d3-4c84-b034-dba31f823dff', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1113e6fa0>]}
[0m02:10:29.608743 [info ] [Thread-1  ]: 4 of 18 OK created sql view model bruno.stg_customers .......................... [[32mSUCCESS 1[0m in 1.40s]
[0m02:10:29.610017 [debug] [Thread-1  ]: Finished running node model.jaffle_shop.stg_customers
[0m02:10:29.610590 [debug] [Thread-1  ]: Began running node model.jaffle_shop.stg_orders
[0m02:10:29.611579 [info ] [Thread-1  ]: 5 of 18 START sql view model bruno.stg_orders .................................. [RUN]
[0m02:10:29.614042 [debug] [Thread-1  ]: Acquiring new snowflake connection "model.jaffle_shop.stg_orders"
[0m02:10:29.615158 [debug] [Thread-1  ]: Began compiling node model.jaffle_shop.stg_orders
[0m02:10:29.615567 [debug] [Thread-1  ]: Compiling model.jaffle_shop.stg_orders
[0m02:10:29.623347 [debug] [Thread-1  ]: Writing injected SQL for node "model.jaffle_shop.stg_orders"
[0m02:10:29.624296 [debug] [Thread-1  ]: finished collecting timing info
[0m02:10:29.624556 [debug] [Thread-1  ]: Began executing node model.jaffle_shop.stg_orders
[0m02:10:29.629243 [debug] [Thread-1  ]: Writing runtime sql for node "model.jaffle_shop.stg_orders"
[0m02:10:29.630768 [debug] [Thread-1  ]: Using snowflake connection "model.jaffle_shop.stg_orders"
[0m02:10:29.631160 [debug] [Thread-1  ]: On model.jaffle_shop.stg_orders: /* {"app": "dbt", "dbt_version": "1.3.2", "profile_name": "jaffle_shop", "target_name": "dev", "node_id": "model.jaffle_shop.stg_orders"} */
create or replace  view jaffle_shop.bruno.stg_orders
  
   as (
    with source as (
    select * from jaffle_shop.bruno.raw_orders

),

renamed as (

    select
        id as order_id,
        user_id as customer_id,
        order_date,
        status

    from source

)

select * from renamed
  );
[0m02:10:29.631367 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m02:10:30.420064 [debug] [Thread-1  ]: SQL status: SUCCESS 1 in 0.79 seconds
[0m02:10:30.427684 [debug] [Thread-1  ]: finished collecting timing info
[0m02:10:30.428498 [debug] [Thread-1  ]: On model.jaffle_shop.stg_orders: Close
[0m02:10:30.780993 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '61b7a1e4-52d3-4c84-b034-dba31f823dff', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1113b8a00>]}
[0m02:10:30.782731 [info ] [Thread-1  ]: 5 of 18 OK created sql view model bruno.stg_orders ............................. [[32mSUCCESS 1[0m in 1.17s]
[0m02:10:30.784306 [debug] [Thread-1  ]: Finished running node model.jaffle_shop.stg_orders
[0m02:10:30.785211 [debug] [Thread-1  ]: Began running node model.jaffle_shop.stg_payments
[0m02:10:30.786713 [info ] [Thread-1  ]: 6 of 18 START sql view model bruno.stg_payments ................................ [RUN]
[0m02:10:30.788321 [debug] [Thread-1  ]: Acquiring new snowflake connection "model.jaffle_shop.stg_payments"
[0m02:10:30.788708 [debug] [Thread-1  ]: Began compiling node model.jaffle_shop.stg_payments
[0m02:10:30.789086 [debug] [Thread-1  ]: Compiling model.jaffle_shop.stg_payments
[0m02:10:30.804137 [debug] [Thread-1  ]: Writing injected SQL for node "model.jaffle_shop.stg_payments"
[0m02:10:30.805367 [debug] [Thread-1  ]: finished collecting timing info
[0m02:10:30.805524 [debug] [Thread-1  ]: Began executing node model.jaffle_shop.stg_payments
[0m02:10:30.810052 [debug] [Thread-1  ]: Writing runtime sql for node "model.jaffle_shop.stg_payments"
[0m02:10:30.811735 [debug] [Thread-1  ]: Using snowflake connection "model.jaffle_shop.stg_payments"
[0m02:10:30.811895 [debug] [Thread-1  ]: On model.jaffle_shop.stg_payments: /* {"app": "dbt", "dbt_version": "1.3.2", "profile_name": "jaffle_shop", "target_name": "dev", "node_id": "model.jaffle_shop.stg_payments"} */
create or replace  view jaffle_shop.bruno.stg_payments
  
   as (
    with source as (
    select * from jaffle_shop.bruno.raw_payments

),

renamed as (

    select
        id as payment_id,
        order_id,
        payment_method,

        -- `amount` is currently stored in cents, so we convert it to dollars
        amount / 100 as amount

    from source

)

select * from renamed
  );
[0m02:10:30.812049 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m02:10:31.497778 [debug] [Thread-1  ]: SQL status: SUCCESS 1 in 0.69 seconds
[0m02:10:31.506030 [debug] [Thread-1  ]: finished collecting timing info
[0m02:10:31.506819 [debug] [Thread-1  ]: On model.jaffle_shop.stg_payments: Close
[0m02:10:31.847800 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '61b7a1e4-52d3-4c84-b034-dba31f823dff', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1118d0430>]}
[0m02:10:31.849044 [info ] [Thread-1  ]: 6 of 18 OK created sql view model bruno.stg_payments ........................... [[32mSUCCESS 1[0m in 1.06s]
[0m02:10:31.850231 [debug] [Thread-1  ]: Finished running node model.jaffle_shop.stg_payments
[0m02:10:31.850772 [debug] [Thread-1  ]: Began running node test.jaffle_shop.not_null_stg_customers_customer_id.e2cfb1f9aa
[0m02:10:31.851440 [info ] [Thread-1  ]: 7 of 18 START test not_null_stg_customers_customer_id .......................... [RUN]
[0m02:10:31.853129 [debug] [Thread-1  ]: Acquiring new snowflake connection "test.jaffle_shop.not_null_stg_customers_customer_id.e2cfb1f9aa"
[0m02:10:31.853695 [debug] [Thread-1  ]: Began compiling node test.jaffle_shop.not_null_stg_customers_customer_id.e2cfb1f9aa
[0m02:10:31.854146 [debug] [Thread-1  ]: Compiling test.jaffle_shop.not_null_stg_customers_customer_id.e2cfb1f9aa
[0m02:10:31.882385 [debug] [Thread-1  ]: Writing injected SQL for node "test.jaffle_shop.not_null_stg_customers_customer_id.e2cfb1f9aa"
[0m02:10:31.883251 [debug] [Thread-1  ]: finished collecting timing info
[0m02:10:31.883491 [debug] [Thread-1  ]: Began executing node test.jaffle_shop.not_null_stg_customers_customer_id.e2cfb1f9aa
[0m02:10:31.958709 [debug] [Thread-1  ]: Writing runtime sql for node "test.jaffle_shop.not_null_stg_customers_customer_id.e2cfb1f9aa"
[0m02:10:31.959539 [debug] [Thread-1  ]: Using snowflake connection "test.jaffle_shop.not_null_stg_customers_customer_id.e2cfb1f9aa"
[0m02:10:31.959638 [debug] [Thread-1  ]: On test.jaffle_shop.not_null_stg_customers_customer_id.e2cfb1f9aa: /* {"app": "dbt", "dbt_version": "1.3.2", "profile_name": "jaffle_shop", "target_name": "dev", "node_id": "test.jaffle_shop.not_null_stg_customers_customer_id.e2cfb1f9aa"} */
select
      count(*) as failures,
      count(*) != 0 as should_warn,
      count(*) != 0 as should_error
    from (
      
    
    



select customer_id
from jaffle_shop.bruno.stg_customers
where customer_id is null



      
    ) dbt_internal_test
[0m02:10:31.959727 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m02:10:32.752049 [debug] [Thread-1  ]: SQL status: SUCCESS 1 in 0.79 seconds
[0m02:10:32.770321 [debug] [Thread-1  ]: finished collecting timing info
[0m02:10:32.771040 [debug] [Thread-1  ]: On test.jaffle_shop.not_null_stg_customers_customer_id.e2cfb1f9aa: Close
[0m02:10:33.126658 [info ] [Thread-1  ]: 7 of 18 PASS not_null_stg_customers_customer_id ................................ [[32mPASS[0m in 1.27s]
[0m02:10:33.128373 [debug] [Thread-1  ]: Finished running node test.jaffle_shop.not_null_stg_customers_customer_id.e2cfb1f9aa
[0m02:10:33.129398 [debug] [Thread-1  ]: Began running node test.jaffle_shop.unique_stg_customers_customer_id.c7614daada
[0m02:10:33.130027 [info ] [Thread-1  ]: 8 of 18 START test unique_stg_customers_customer_id ............................ [RUN]
[0m02:10:33.131898 [debug] [Thread-1  ]: Acquiring new snowflake connection "test.jaffle_shop.unique_stg_customers_customer_id.c7614daada"
[0m02:10:33.132331 [debug] [Thread-1  ]: Began compiling node test.jaffle_shop.unique_stg_customers_customer_id.c7614daada
[0m02:10:33.132664 [debug] [Thread-1  ]: Compiling test.jaffle_shop.unique_stg_customers_customer_id.c7614daada
[0m02:10:33.147879 [debug] [Thread-1  ]: Writing injected SQL for node "test.jaffle_shop.unique_stg_customers_customer_id.c7614daada"
[0m02:10:33.148722 [debug] [Thread-1  ]: finished collecting timing info
[0m02:10:33.148955 [debug] [Thread-1  ]: Began executing node test.jaffle_shop.unique_stg_customers_customer_id.c7614daada
[0m02:10:33.153009 [debug] [Thread-1  ]: Writing runtime sql for node "test.jaffle_shop.unique_stg_customers_customer_id.c7614daada"
[0m02:10:33.154643 [debug] [Thread-1  ]: Using snowflake connection "test.jaffle_shop.unique_stg_customers_customer_id.c7614daada"
[0m02:10:33.154877 [debug] [Thread-1  ]: On test.jaffle_shop.unique_stg_customers_customer_id.c7614daada: /* {"app": "dbt", "dbt_version": "1.3.2", "profile_name": "jaffle_shop", "target_name": "dev", "node_id": "test.jaffle_shop.unique_stg_customers_customer_id.c7614daada"} */
select
      count(*) as failures,
      count(*) != 0 as should_warn,
      count(*) != 0 as should_error
    from (
      
    
    

select
    customer_id as unique_field,
    count(*) as n_records

from jaffle_shop.bruno.stg_customers
where customer_id is not null
group by customer_id
having count(*) > 1



      
    ) dbt_internal_test
[0m02:10:33.155083 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m02:10:33.785028 [debug] [Thread-1  ]: SQL status: SUCCESS 1 in 0.63 seconds
[0m02:10:33.791164 [debug] [Thread-1  ]: finished collecting timing info
[0m02:10:33.791796 [debug] [Thread-1  ]: On test.jaffle_shop.unique_stg_customers_customer_id.c7614daada: Close
[0m02:10:34.220361 [info ] [Thread-1  ]: 8 of 18 PASS unique_stg_customers_customer_id .................................. [[32mPASS[0m in 1.09s]
[0m02:10:34.222329 [debug] [Thread-1  ]: Finished running node test.jaffle_shop.unique_stg_customers_customer_id.c7614daada
[0m02:10:34.223050 [debug] [Thread-1  ]: Began running node test.jaffle_shop.accepted_values_stg_orders_status__placed__shipped__completed__return_pending__returned.080fb20aad
[0m02:10:34.223816 [info ] [Thread-1  ]: 9 of 18 START test accepted_values_stg_orders_status__placed__shipped__completed__return_pending__returned  [RUN]
[0m02:10:34.226388 [debug] [Thread-1  ]: Acquiring new snowflake connection "test.jaffle_shop.accepted_values_stg_orders_status__placed__shipped__completed__return_pending__returned.080fb20aad"
[0m02:10:34.226994 [debug] [Thread-1  ]: Began compiling node test.jaffle_shop.accepted_values_stg_orders_status__placed__shipped__completed__return_pending__returned.080fb20aad
[0m02:10:34.227385 [debug] [Thread-1  ]: Compiling test.jaffle_shop.accepted_values_stg_orders_status__placed__shipped__completed__return_pending__returned.080fb20aad
[0m02:10:34.255783 [debug] [Thread-1  ]: Writing injected SQL for node "test.jaffle_shop.accepted_values_stg_orders_status__placed__shipped__completed__return_pending__returned.080fb20aad"
[0m02:10:34.256707 [debug] [Thread-1  ]: finished collecting timing info
[0m02:10:34.256997 [debug] [Thread-1  ]: Began executing node test.jaffle_shop.accepted_values_stg_orders_status__placed__shipped__completed__return_pending__returned.080fb20aad
[0m02:10:34.261156 [debug] [Thread-1  ]: Writing runtime sql for node "test.jaffle_shop.accepted_values_stg_orders_status__placed__shipped__completed__return_pending__returned.080fb20aad"
[0m02:10:34.262780 [debug] [Thread-1  ]: Using snowflake connection "test.jaffle_shop.accepted_values_stg_orders_status__placed__shipped__completed__return_pending__returned.080fb20aad"
[0m02:10:34.263027 [debug] [Thread-1  ]: On test.jaffle_shop.accepted_values_stg_orders_status__placed__shipped__completed__return_pending__returned.080fb20aad: /* {"app": "dbt", "dbt_version": "1.3.2", "profile_name": "jaffle_shop", "target_name": "dev", "node_id": "test.jaffle_shop.accepted_values_stg_orders_status__placed__shipped__completed__return_pending__returned.080fb20aad"} */
select
      count(*) as failures,
      count(*) != 0 as should_warn,
      count(*) != 0 as should_error
    from (
      
    
    

with all_values as (

    select
        status as value_field,
        count(*) as n_records

    from jaffle_shop.bruno.stg_orders
    group by status

)

select *
from all_values
where value_field not in (
    'placed','shipped','completed','return_pending','returned'
)



      
    ) dbt_internal_test
[0m02:10:34.263213 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m02:10:35.180085 [debug] [Thread-1  ]: SQL status: SUCCESS 1 in 0.92 seconds
[0m02:10:35.185078 [debug] [Thread-1  ]: finished collecting timing info
[0m02:10:35.185535 [debug] [Thread-1  ]: On test.jaffle_shop.accepted_values_stg_orders_status__placed__shipped__completed__return_pending__returned.080fb20aad: Close
[0m02:10:35.640007 [info ] [Thread-1  ]: 9 of 18 PASS accepted_values_stg_orders_status__placed__shipped__completed__return_pending__returned  [[32mPASS[0m in 1.42s]
[0m02:10:35.641278 [debug] [Thread-1  ]: Finished running node test.jaffle_shop.accepted_values_stg_orders_status__placed__shipped__completed__return_pending__returned.080fb20aad
[0m02:10:35.641890 [debug] [Thread-1  ]: Began running node test.jaffle_shop.not_null_stg_orders_order_id.81cfe2fe64
[0m02:10:35.642775 [info ] [Thread-1  ]: 10 of 18 START test not_null_stg_orders_order_id ............................... [RUN]
[0m02:10:35.645332 [debug] [Thread-1  ]: Acquiring new snowflake connection "test.jaffle_shop.not_null_stg_orders_order_id.81cfe2fe64"
[0m02:10:35.645893 [debug] [Thread-1  ]: Began compiling node test.jaffle_shop.not_null_stg_orders_order_id.81cfe2fe64
[0m02:10:35.646263 [debug] [Thread-1  ]: Compiling test.jaffle_shop.not_null_stg_orders_order_id.81cfe2fe64
[0m02:10:35.658430 [debug] [Thread-1  ]: Writing injected SQL for node "test.jaffle_shop.not_null_stg_orders_order_id.81cfe2fe64"
[0m02:10:35.659384 [debug] [Thread-1  ]: finished collecting timing info
[0m02:10:35.659680 [debug] [Thread-1  ]: Began executing node test.jaffle_shop.not_null_stg_orders_order_id.81cfe2fe64
[0m02:10:35.662941 [debug] [Thread-1  ]: Writing runtime sql for node "test.jaffle_shop.not_null_stg_orders_order_id.81cfe2fe64"
[0m02:10:35.663688 [debug] [Thread-1  ]: Using snowflake connection "test.jaffle_shop.not_null_stg_orders_order_id.81cfe2fe64"
[0m02:10:35.663795 [debug] [Thread-1  ]: On test.jaffle_shop.not_null_stg_orders_order_id.81cfe2fe64: /* {"app": "dbt", "dbt_version": "1.3.2", "profile_name": "jaffle_shop", "target_name": "dev", "node_id": "test.jaffle_shop.not_null_stg_orders_order_id.81cfe2fe64"} */
select
      count(*) as failures,
      count(*) != 0 as should_warn,
      count(*) != 0 as should_error
    from (
      
    
    



select order_id
from jaffle_shop.bruno.stg_orders
where order_id is null



      
    ) dbt_internal_test
[0m02:10:35.663884 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m02:10:36.387892 [debug] [Thread-1  ]: SQL status: SUCCESS 1 in 0.72 seconds
[0m02:10:36.393360 [debug] [Thread-1  ]: finished collecting timing info
[0m02:10:36.393920 [debug] [Thread-1  ]: On test.jaffle_shop.not_null_stg_orders_order_id.81cfe2fe64: Close
[0m02:10:36.743259 [info ] [Thread-1  ]: 10 of 18 PASS not_null_stg_orders_order_id ..................................... [[32mPASS[0m in 1.10s]
[0m02:10:36.745544 [debug] [Thread-1  ]: Finished running node test.jaffle_shop.not_null_stg_orders_order_id.81cfe2fe64
[0m02:10:36.746159 [debug] [Thread-1  ]: Began running node test.jaffle_shop.unique_stg_orders_order_id.e3b841c71a
[0m02:10:36.746921 [info ] [Thread-1  ]: 11 of 18 START test unique_stg_orders_order_id ................................. [RUN]
[0m02:10:36.748825 [debug] [Thread-1  ]: Acquiring new snowflake connection "test.jaffle_shop.unique_stg_orders_order_id.e3b841c71a"
[0m02:10:36.749473 [debug] [Thread-1  ]: Began compiling node test.jaffle_shop.unique_stg_orders_order_id.e3b841c71a
[0m02:10:36.749931 [debug] [Thread-1  ]: Compiling test.jaffle_shop.unique_stg_orders_order_id.e3b841c71a
[0m02:10:36.764708 [debug] [Thread-1  ]: Writing injected SQL for node "test.jaffle_shop.unique_stg_orders_order_id.e3b841c71a"
[0m02:10:36.765963 [debug] [Thread-1  ]: finished collecting timing info
[0m02:10:36.766320 [debug] [Thread-1  ]: Began executing node test.jaffle_shop.unique_stg_orders_order_id.e3b841c71a
[0m02:10:36.772131 [debug] [Thread-1  ]: Writing runtime sql for node "test.jaffle_shop.unique_stg_orders_order_id.e3b841c71a"
[0m02:10:36.773964 [debug] [Thread-1  ]: Using snowflake connection "test.jaffle_shop.unique_stg_orders_order_id.e3b841c71a"
[0m02:10:36.774204 [debug] [Thread-1  ]: On test.jaffle_shop.unique_stg_orders_order_id.e3b841c71a: /* {"app": "dbt", "dbt_version": "1.3.2", "profile_name": "jaffle_shop", "target_name": "dev", "node_id": "test.jaffle_shop.unique_stg_orders_order_id.e3b841c71a"} */
select
      count(*) as failures,
      count(*) != 0 as should_warn,
      count(*) != 0 as should_error
    from (
      
    
    

select
    order_id as unique_field,
    count(*) as n_records

from jaffle_shop.bruno.stg_orders
where order_id is not null
group by order_id
having count(*) > 1



      
    ) dbt_internal_test
[0m02:10:36.774421 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m02:10:37.419799 [debug] [Thread-1  ]: SQL status: SUCCESS 1 in 0.65 seconds
[0m02:10:37.430520 [debug] [Thread-1  ]: finished collecting timing info
[0m02:10:37.431534 [debug] [Thread-1  ]: On test.jaffle_shop.unique_stg_orders_order_id.e3b841c71a: Close
[0m02:10:37.778218 [info ] [Thread-1  ]: 11 of 18 PASS unique_stg_orders_order_id ....................................... [[32mPASS[0m in 1.03s]
[0m02:10:37.780090 [debug] [Thread-1  ]: Finished running node test.jaffle_shop.unique_stg_orders_order_id.e3b841c71a
[0m02:10:37.780600 [debug] [Thread-1  ]: Began running node test.jaffle_shop.accepted_values_stg_payments_payment_method__credit_card__coupon__bank_transfer__gift_card.3c3820f278
[0m02:10:37.781201 [info ] [Thread-1  ]: 12 of 18 START test accepted_values_stg_payments_payment_method__credit_card__coupon__bank_transfer__gift_card  [RUN]
[0m02:10:37.782823 [debug] [Thread-1  ]: Acquiring new snowflake connection "test.jaffle_shop.accepted_values_stg_payments_payment_method__credit_card__coupon__bank_transfer__gift_card.3c3820f278"
[0m02:10:37.783435 [debug] [Thread-1  ]: Began compiling node test.jaffle_shop.accepted_values_stg_payments_payment_method__credit_card__coupon__bank_transfer__gift_card.3c3820f278
[0m02:10:37.783803 [debug] [Thread-1  ]: Compiling test.jaffle_shop.accepted_values_stg_payments_payment_method__credit_card__coupon__bank_transfer__gift_card.3c3820f278
[0m02:10:37.802211 [debug] [Thread-1  ]: Writing injected SQL for node "test.jaffle_shop.accepted_values_stg_payments_payment_method__credit_card__coupon__bank_transfer__gift_card.3c3820f278"
[0m02:10:37.803276 [debug] [Thread-1  ]: finished collecting timing info
[0m02:10:37.803551 [debug] [Thread-1  ]: Began executing node test.jaffle_shop.accepted_values_stg_payments_payment_method__credit_card__coupon__bank_transfer__gift_card.3c3820f278
[0m02:10:37.808284 [debug] [Thread-1  ]: Writing runtime sql for node "test.jaffle_shop.accepted_values_stg_payments_payment_method__credit_card__coupon__bank_transfer__gift_card.3c3820f278"
[0m02:10:37.810097 [debug] [Thread-1  ]: Using snowflake connection "test.jaffle_shop.accepted_values_stg_payments_payment_method__credit_card__coupon__bank_transfer__gift_card.3c3820f278"
[0m02:10:37.810331 [debug] [Thread-1  ]: On test.jaffle_shop.accepted_values_stg_payments_payment_method__credit_card__coupon__bank_transfer__gift_card.3c3820f278: /* {"app": "dbt", "dbt_version": "1.3.2", "profile_name": "jaffle_shop", "target_name": "dev", "node_id": "test.jaffle_shop.accepted_values_stg_payments_payment_method__credit_card__coupon__bank_transfer__gift_card.3c3820f278"} */
select
      count(*) as failures,
      count(*) != 0 as should_warn,
      count(*) != 0 as should_error
    from (
      
    
    

with all_values as (

    select
        payment_method as value_field,
        count(*) as n_records

    from jaffle_shop.bruno.stg_payments
    group by payment_method

)

select *
from all_values
where value_field not in (
    'credit_card','coupon','bank_transfer','gift_card'
)



      
    ) dbt_internal_test
[0m02:10:37.810552 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m02:10:38.690373 [debug] [Thread-1  ]: SQL status: SUCCESS 1 in 0.88 seconds
[0m02:10:38.700107 [debug] [Thread-1  ]: finished collecting timing info
[0m02:10:38.700833 [debug] [Thread-1  ]: On test.jaffle_shop.accepted_values_stg_payments_payment_method__credit_card__coupon__bank_transfer__gift_card.3c3820f278: Close
[0m02:10:39.044928 [info ] [Thread-1  ]: 12 of 18 PASS accepted_values_stg_payments_payment_method__credit_card__coupon__bank_transfer__gift_card  [[32mPASS[0m in 1.26s]
[0m02:10:39.047102 [debug] [Thread-1  ]: Finished running node test.jaffle_shop.accepted_values_stg_payments_payment_method__credit_card__coupon__bank_transfer__gift_card.3c3820f278
[0m02:10:39.047949 [debug] [Thread-1  ]: Began running node test.jaffle_shop.not_null_stg_payments_payment_id.c19cc50075
[0m02:10:39.048890 [info ] [Thread-1  ]: 13 of 18 START test not_null_stg_payments_payment_id ........................... [RUN]
[0m02:10:39.050918 [debug] [Thread-1  ]: Acquiring new snowflake connection "test.jaffle_shop.not_null_stg_payments_payment_id.c19cc50075"
[0m02:10:39.051513 [debug] [Thread-1  ]: Began compiling node test.jaffle_shop.not_null_stg_payments_payment_id.c19cc50075
[0m02:10:39.051981 [debug] [Thread-1  ]: Compiling test.jaffle_shop.not_null_stg_payments_payment_id.c19cc50075
[0m02:10:39.066305 [debug] [Thread-1  ]: Writing injected SQL for node "test.jaffle_shop.not_null_stg_payments_payment_id.c19cc50075"
[0m02:10:39.067321 [debug] [Thread-1  ]: finished collecting timing info
[0m02:10:39.067639 [debug] [Thread-1  ]: Began executing node test.jaffle_shop.not_null_stg_payments_payment_id.c19cc50075
[0m02:10:39.073108 [debug] [Thread-1  ]: Writing runtime sql for node "test.jaffle_shop.not_null_stg_payments_payment_id.c19cc50075"
[0m02:10:39.074449 [debug] [Thread-1  ]: Using snowflake connection "test.jaffle_shop.not_null_stg_payments_payment_id.c19cc50075"
[0m02:10:39.074692 [debug] [Thread-1  ]: On test.jaffle_shop.not_null_stg_payments_payment_id.c19cc50075: /* {"app": "dbt", "dbt_version": "1.3.2", "profile_name": "jaffle_shop", "target_name": "dev", "node_id": "test.jaffle_shop.not_null_stg_payments_payment_id.c19cc50075"} */
select
      count(*) as failures,
      count(*) != 0 as should_warn,
      count(*) != 0 as should_error
    from (
      
    
    



select payment_id
from jaffle_shop.bruno.stg_payments
where payment_id is null



      
    ) dbt_internal_test
[0m02:10:39.074914 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m02:10:39.938367 [debug] [Thread-1  ]: SQL status: SUCCESS 1 in 0.86 seconds
[0m02:10:39.944097 [debug] [Thread-1  ]: finished collecting timing info
[0m02:10:39.944582 [debug] [Thread-1  ]: On test.jaffle_shop.not_null_stg_payments_payment_id.c19cc50075: Close
[0m02:10:40.280452 [info ] [Thread-1  ]: 13 of 18 PASS not_null_stg_payments_payment_id ................................. [[32mPASS[0m in 1.23s]
[0m02:10:40.282155 [debug] [Thread-1  ]: Finished running node test.jaffle_shop.not_null_stg_payments_payment_id.c19cc50075
[0m02:10:40.282810 [debug] [Thread-1  ]: Began running node test.jaffle_shop.unique_stg_payments_payment_id.3744510712
[0m02:10:40.283261 [info ] [Thread-1  ]: 14 of 18 START test unique_stg_payments_payment_id ............................. [RUN]
[0m02:10:40.284881 [debug] [Thread-1  ]: Acquiring new snowflake connection "test.jaffle_shop.unique_stg_payments_payment_id.3744510712"
[0m02:10:40.285339 [debug] [Thread-1  ]: Began compiling node test.jaffle_shop.unique_stg_payments_payment_id.3744510712
[0m02:10:40.285637 [debug] [Thread-1  ]: Compiling test.jaffle_shop.unique_stg_payments_payment_id.3744510712
[0m02:10:40.299048 [debug] [Thread-1  ]: Writing injected SQL for node "test.jaffle_shop.unique_stg_payments_payment_id.3744510712"
[0m02:10:40.300274 [debug] [Thread-1  ]: finished collecting timing info
[0m02:10:40.300601 [debug] [Thread-1  ]: Began executing node test.jaffle_shop.unique_stg_payments_payment_id.3744510712
[0m02:10:40.306264 [debug] [Thread-1  ]: Writing runtime sql for node "test.jaffle_shop.unique_stg_payments_payment_id.3744510712"
[0m02:10:40.307924 [debug] [Thread-1  ]: Using snowflake connection "test.jaffle_shop.unique_stg_payments_payment_id.3744510712"
[0m02:10:40.308158 [debug] [Thread-1  ]: On test.jaffle_shop.unique_stg_payments_payment_id.3744510712: /* {"app": "dbt", "dbt_version": "1.3.2", "profile_name": "jaffle_shop", "target_name": "dev", "node_id": "test.jaffle_shop.unique_stg_payments_payment_id.3744510712"} */
select
      count(*) as failures,
      count(*) != 0 as should_warn,
      count(*) != 0 as should_error
    from (
      
    
    

select
    payment_id as unique_field,
    count(*) as n_records

from jaffle_shop.bruno.stg_payments
where payment_id is not null
group by payment_id
having count(*) > 1



      
    ) dbt_internal_test
[0m02:10:40.308366 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m02:10:41.071356 [debug] [Thread-1  ]: SQL status: SUCCESS 1 in 0.76 seconds
[0m02:10:41.078992 [debug] [Thread-1  ]: finished collecting timing info
[0m02:10:41.079777 [debug] [Thread-1  ]: On test.jaffle_shop.unique_stg_payments_payment_id.3744510712: Close
[0m02:10:41.490133 [info ] [Thread-1  ]: 14 of 18 PASS unique_stg_payments_payment_id ................................... [[32mPASS[0m in 1.21s]
[0m02:10:41.491969 [debug] [Thread-1  ]: Finished running node test.jaffle_shop.unique_stg_payments_payment_id.3744510712
[0m02:10:41.493840 [debug] [Thread-1  ]: Began running node model.jaffle_shop.customers
[0m02:10:41.494820 [info ] [Thread-1  ]: 15 of 18 START sql table model bruno.customers ................................. [RUN]
[0m02:10:41.497187 [debug] [Thread-1  ]: Acquiring new snowflake connection "model.jaffle_shop.customers"
[0m02:10:41.497770 [debug] [Thread-1  ]: Began compiling node model.jaffle_shop.customers
[0m02:10:41.498157 [debug] [Thread-1  ]: Compiling model.jaffle_shop.customers
[0m02:10:41.508639 [debug] [Thread-1  ]: Writing injected SQL for node "model.jaffle_shop.customers"
[0m02:10:41.509777 [debug] [Thread-1  ]: finished collecting timing info
[0m02:10:41.510117 [debug] [Thread-1  ]: Began executing node model.jaffle_shop.customers
[0m02:10:41.545837 [debug] [Thread-1  ]: Writing runtime sql for node "model.jaffle_shop.customers"
[0m02:10:41.548312 [debug] [Thread-1  ]: Using snowflake connection "model.jaffle_shop.customers"
[0m02:10:41.548452 [debug] [Thread-1  ]: On model.jaffle_shop.customers: /* {"app": "dbt", "dbt_version": "1.3.2", "profile_name": "jaffle_shop", "target_name": "dev", "node_id": "model.jaffle_shop.customers"} */
create or replace transient table jaffle_shop.bruno.customers  as
        (with customers as (

    select * from jaffle_shop.bruno.stg_customers

),

orders as (

    select * from jaffle_shop.bruno.stg_orders

),

payments as (

    select * from jaffle_shop.bruno.stg_payments

),

customer_orders as (

        select
        customer_id,

        min(order_date) as first_order,
        max(order_date) as most_recent_order,
        count(order_id) as number_of_orders
    from orders

    group by customer_id

),

customer_payments as (

    select
        orders.customer_id,
        sum(amount) as total_amount

    from payments

    left join orders on
         payments.order_id = orders.order_id

    group by orders.customer_id

),

final as (

    select
        customers.customer_id,
        customers.first_name,
        customers.last_name,
        customer_orders.first_order,
        customer_orders.most_recent_order,
        customer_orders.number_of_orders,
        customer_payments.total_amount as customer_lifetime_value

    from customers

    left join customer_orders
        on customers.customer_id = customer_orders.customer_id

    left join customer_payments
        on  customers.customer_id = customer_payments.customer_id

)

select * from final
        );
[0m02:10:41.548575 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m02:10:43.016855 [debug] [Thread-1  ]: SQL status: SUCCESS 1 in 1.47 seconds
[0m02:10:43.022547 [debug] [Thread-1  ]: finished collecting timing info
[0m02:10:43.023023 [debug] [Thread-1  ]: On model.jaffle_shop.customers: Close
[0m02:10:43.363571 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '61b7a1e4-52d3-4c84-b034-dba31f823dff', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x111930a00>]}
[0m02:10:43.365277 [info ] [Thread-1  ]: 15 of 18 OK created sql table model bruno.customers ............................ [[32mSUCCESS 1[0m in 1.87s]
[0m02:10:43.366826 [debug] [Thread-1  ]: Finished running node model.jaffle_shop.customers
[0m02:10:43.367438 [debug] [Thread-1  ]: Began running node model.jaffle_shop.orders
[0m02:10:43.368458 [info ] [Thread-1  ]: 16 of 18 START sql table model bruno.orders .................................... [RUN]
[0m02:10:43.371099 [debug] [Thread-1  ]: Acquiring new snowflake connection "model.jaffle_shop.orders"
[0m02:10:43.371642 [debug] [Thread-1  ]: Began compiling node model.jaffle_shop.orders
[0m02:10:43.372023 [debug] [Thread-1  ]: Compiling model.jaffle_shop.orders
[0m02:10:43.385814 [debug] [Thread-1  ]: Writing injected SQL for node "model.jaffle_shop.orders"
[0m02:10:43.387080 [debug] [Thread-1  ]: finished collecting timing info
[0m02:10:43.387411 [debug] [Thread-1  ]: Began executing node model.jaffle_shop.orders
[0m02:10:43.393082 [debug] [Thread-1  ]: Writing runtime sql for node "model.jaffle_shop.orders"
[0m02:10:43.397034 [debug] [Thread-1  ]: Using snowflake connection "model.jaffle_shop.orders"
[0m02:10:43.397266 [debug] [Thread-1  ]: On model.jaffle_shop.orders: /* {"app": "dbt", "dbt_version": "1.3.2", "profile_name": "jaffle_shop", "target_name": "dev", "node_id": "model.jaffle_shop.orders"} */
create or replace transient table jaffle_shop.bruno.orders  as
        (

with orders as (

    select * from jaffle_shop.bruno.stg_orders

),

payments as (

    select * from jaffle_shop.bruno.stg_payments

),

order_payments as (

    select
        order_id,

        sum(case when payment_method = 'credit_card' then amount else 0 end) as credit_card_amount,
        sum(case when payment_method = 'coupon' then amount else 0 end) as coupon_amount,
        sum(case when payment_method = 'bank_transfer' then amount else 0 end) as bank_transfer_amount,
        sum(case when payment_method = 'gift_card' then amount else 0 end) as gift_card_amount,
        sum(amount) as total_amount

    from payments

    group by order_id

),

final as (

    select
        orders.order_id,
        orders.customer_id,
        orders.order_date,
        orders.status,

        order_payments.credit_card_amount,

        order_payments.coupon_amount,

        order_payments.bank_transfer_amount,

        order_payments.gift_card_amount,

        order_payments.total_amount as amount

    from orders


    left join order_payments
        on orders.order_id = order_payments.order_id

)

select * from final
        );
[0m02:10:43.397473 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m02:10:44.570633 [debug] [Thread-1  ]: SQL status: SUCCESS 1 in 1.17 seconds
[0m02:10:44.576664 [debug] [Thread-1  ]: finished collecting timing info
[0m02:10:44.577380 [debug] [Thread-1  ]: On model.jaffle_shop.orders: Close
[0m02:10:44.921961 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '61b7a1e4-52d3-4c84-b034-dba31f823dff', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1113bb670>]}
[0m02:10:44.922974 [info ] [Thread-1  ]: 16 of 18 OK created sql table model bruno.orders ............................... [[32mSUCCESS 1[0m in 1.55s]
[0m02:10:44.923884 [debug] [Thread-1  ]: Finished running node model.jaffle_shop.orders
[0m02:10:44.924329 [debug] [Thread-1  ]: Began running node test.jaffle_shop.not_null_customers_customer_id.5c9bf9911d
[0m02:10:44.924650 [info ] [Thread-1  ]: 17 of 18 START test not_null_customers_customer_id ............................. [RUN]
[0m02:10:44.926454 [debug] [Thread-1  ]: Acquiring new snowflake connection "test.jaffle_shop.not_null_customers_customer_id.5c9bf9911d"
[0m02:10:44.927094 [debug] [Thread-1  ]: Began compiling node test.jaffle_shop.not_null_customers_customer_id.5c9bf9911d
[0m02:10:44.927544 [debug] [Thread-1  ]: Compiling test.jaffle_shop.not_null_customers_customer_id.5c9bf9911d
[0m02:10:44.940948 [debug] [Thread-1  ]: Writing injected SQL for node "test.jaffle_shop.not_null_customers_customer_id.5c9bf9911d"
[0m02:10:44.942073 [debug] [Thread-1  ]: finished collecting timing info
[0m02:10:44.942398 [debug] [Thread-1  ]: Began executing node test.jaffle_shop.not_null_customers_customer_id.5c9bf9911d
[0m02:10:44.947922 [debug] [Thread-1  ]: Writing runtime sql for node "test.jaffle_shop.not_null_customers_customer_id.5c9bf9911d"
[0m02:10:44.949727 [debug] [Thread-1  ]: Using snowflake connection "test.jaffle_shop.not_null_customers_customer_id.5c9bf9911d"
[0m02:10:44.949991 [debug] [Thread-1  ]: On test.jaffle_shop.not_null_customers_customer_id.5c9bf9911d: /* {"app": "dbt", "dbt_version": "1.3.2", "profile_name": "jaffle_shop", "target_name": "dev", "node_id": "test.jaffle_shop.not_null_customers_customer_id.5c9bf9911d"} */
select
      count(*) as failures,
      count(*) != 0 as should_warn,
      count(*) != 0 as should_error
    from (
      
    
    



select customer_id
from jaffle_shop.bruno.customers
where customer_id is null



      
    ) dbt_internal_test
[0m02:10:44.950201 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m02:10:45.673997 [debug] [Thread-1  ]: SQL status: SUCCESS 1 in 0.72 seconds
[0m02:10:45.683497 [debug] [Thread-1  ]: finished collecting timing info
[0m02:10:45.684490 [debug] [Thread-1  ]: On test.jaffle_shop.not_null_customers_customer_id.5c9bf9911d: Close
[0m02:10:46.035735 [info ] [Thread-1  ]: 17 of 18 PASS not_null_customers_customer_id ................................... [[32mPASS[0m in 1.11s]
[0m02:10:46.037512 [debug] [Thread-1  ]: Finished running node test.jaffle_shop.not_null_customers_customer_id.5c9bf9911d
[0m02:10:46.038240 [debug] [Thread-1  ]: Began running node test.jaffle_shop.unique_customers_customer_id.c5af1ff4b1
[0m02:10:46.039100 [info ] [Thread-1  ]: 18 of 18 START test unique_customers_customer_id ............................... [RUN]
[0m02:10:46.040905 [debug] [Thread-1  ]: Acquiring new snowflake connection "test.jaffle_shop.unique_customers_customer_id.c5af1ff4b1"
[0m02:10:46.041416 [debug] [Thread-1  ]: Began compiling node test.jaffle_shop.unique_customers_customer_id.c5af1ff4b1
[0m02:10:46.041792 [debug] [Thread-1  ]: Compiling test.jaffle_shop.unique_customers_customer_id.c5af1ff4b1
[0m02:10:46.056647 [debug] [Thread-1  ]: Writing injected SQL for node "test.jaffle_shop.unique_customers_customer_id.c5af1ff4b1"
[0m02:10:46.057734 [debug] [Thread-1  ]: finished collecting timing info
[0m02:10:46.058064 [debug] [Thread-1  ]: Began executing node test.jaffle_shop.unique_customers_customer_id.c5af1ff4b1
[0m02:10:46.063543 [debug] [Thread-1  ]: Writing runtime sql for node "test.jaffle_shop.unique_customers_customer_id.c5af1ff4b1"
[0m02:10:46.065132 [debug] [Thread-1  ]: Using snowflake connection "test.jaffle_shop.unique_customers_customer_id.c5af1ff4b1"
[0m02:10:46.065372 [debug] [Thread-1  ]: On test.jaffle_shop.unique_customers_customer_id.c5af1ff4b1: /* {"app": "dbt", "dbt_version": "1.3.2", "profile_name": "jaffle_shop", "target_name": "dev", "node_id": "test.jaffle_shop.unique_customers_customer_id.c5af1ff4b1"} */
select
      count(*) as failures,
      count(*) != 0 as should_warn,
      count(*) != 0 as should_error
    from (
      
    
    

select
    customer_id as unique_field,
    count(*) as n_records

from jaffle_shop.bruno.customers
where customer_id is not null
group by customer_id
having count(*) > 1



      
    ) dbt_internal_test
[0m02:10:46.065585 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m02:10:46.775715 [debug] [Thread-1  ]: SQL status: SUCCESS 1 in 0.71 seconds
[0m02:10:46.786343 [debug] [Thread-1  ]: finished collecting timing info
[0m02:10:46.787045 [debug] [Thread-1  ]: On test.jaffle_shop.unique_customers_customer_id.c5af1ff4b1: Close
[0m02:10:47.130220 [info ] [Thread-1  ]: 18 of 18 PASS unique_customers_customer_id ..................................... [[32mPASS[0m in 1.09s]
[0m02:10:47.132438 [debug] [Thread-1  ]: Finished running node test.jaffle_shop.unique_customers_customer_id.c5af1ff4b1
[0m02:10:47.136929 [debug] [MainThread]: Acquiring new snowflake connection "master"
[0m02:10:47.138900 [info ] [MainThread]: 
[0m02:10:47.139671 [info ] [MainThread]: Finished running 3 seeds, 3 view models, 10 tests, 2 table models in 0 hours 0 minutes and 30.54 seconds (30.54s).
[0m02:10:47.140325 [debug] [MainThread]: Connection 'master' was properly closed.
[0m02:10:47.141171 [debug] [MainThread]: Connection 'test.jaffle_shop.unique_customers_customer_id.c5af1ff4b1' was properly closed.
[0m02:10:47.161628 [info ] [MainThread]: 
[0m02:10:47.162146 [info ] [MainThread]: [32mCompleted successfully[0m
[0m02:10:47.162632 [info ] [MainThread]: 
[0m02:10:47.162984 [info ] [MainThread]: Done. PASS=18 WARN=0 ERROR=0 SKIP=0 TOTAL=18
[0m02:10:47.163473 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1101040d0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1118ee580>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1118ee640>]}
[0m02:10:47.163852 [debug] [MainThread]: Flushing usage events


============================== 2023-01-24 02:17:43.859595 | b03da7d5-8845-49d2-9cd6-9ca823c4c9eb ==============================
[0m02:17:43.859648 [info ] [MainThread]: Running with dbt=1.3.2
[0m02:17:43.860396 [debug] [MainThread]: running dbt with arguments {'write_json': True, 'use_colors': True, 'printer_width': 80, 'version_check': True, 'partial_parse': True, 'static_parser': True, 'profiles_dir': '/Users/bruno/.dbt', 'send_anonymous_usage_stats': True, 'event_buffer_size': 100000, 'quiet': False, 'no_print': False, 'cache_selected_only': False, 'select': ['customers.sql', 'orders.sql'], 'which': 'run', 'rpc_method': 'run', 'indirect_selection': 'eager'}
[0m02:17:43.860544 [debug] [MainThread]: Tracking: tracking
[0m02:17:43.860902 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10dc9ebe0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10dc9ec40>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10dc9eca0>]}
[0m02:17:43.912412 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 1 files added, 0 files changed.
[0m02:17:43.912742 [debug] [MainThread]: Partial parsing: added file: jaffle_shop://models/customers.py
[0m02:17:43.924460 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10dd84b20>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10e459b80>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10e459d00>]}
[0m02:17:43.924666 [debug] [MainThread]: Flushing usage events
[0m02:17:44.750066 [error] [MainThread]: Encountered an error:
Parsing Error in model customers (models/customers.py)
  expected an indented block (customers.py, line 3)
  
  


============================== 2023-01-24 02:18:01.476662 | ea99a81f-4703-47de-a4e7-f351daabd583 ==============================
[0m02:18:01.476736 [info ] [MainThread]: Running with dbt=1.3.2
[0m02:18:01.477580 [debug] [MainThread]: running dbt with arguments {'write_json': True, 'use_colors': True, 'printer_width': 80, 'version_check': True, 'partial_parse': True, 'static_parser': True, 'profiles_dir': '/Users/bruno/.dbt', 'send_anonymous_usage_stats': True, 'event_buffer_size': 100000, 'quiet': False, 'no_print': False, 'cache_selected_only': False, 'select': ['customers.sql', 'orders.sql'], 'which': 'run', 'rpc_method': 'run', 'indirect_selection': 'eager'}
[0m02:18:01.477732 [debug] [MainThread]: Tracking: tracking
[0m02:18:01.478116 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10dcd2b80>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10dcd2be0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10dcd2c40>]}
[0m02:18:01.528503 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 0 files changed.
[0m02:18:01.528697 [debug] [MainThread]: Partial parsing enabled, no changes found, skipping parsing
[0m02:18:01.534493 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': 'ea99a81f-4703-47de-a4e7-f351daabd583', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10e270e80>]}
[0m02:18:01.541410 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': 'ea99a81f-4703-47de-a4e7-f351daabd583', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10ddbb490>]}
[0m02:18:01.541614 [info ] [MainThread]: Found 5 models, 10 tests, 0 snapshots, 0 analyses, 303 macros, 0 operations, 3 seed files, 0 sources, 0 exposures, 0 metrics
[0m02:18:01.541795 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'ea99a81f-4703-47de-a4e7-f351daabd583', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10ddbb520>]}
[0m02:18:01.543093 [info ] [MainThread]: 
[0m02:18:01.543559 [debug] [MainThread]: Acquiring new snowflake connection "master"
[0m02:18:01.544384 [debug] [ThreadPool]: Acquiring new snowflake connection "list_jaffle_shop"
[0m02:18:01.556642 [debug] [ThreadPool]: Using snowflake connection "list_jaffle_shop"
[0m02:18:01.556823 [debug] [ThreadPool]: On list_jaffle_shop: /* {"app": "dbt", "dbt_version": "1.3.2", "profile_name": "jaffle_shop", "target_name": "dev", "connection_name": "list_jaffle_shop"} */
show terse schemas in database jaffle_shop
    limit 10000
[0m02:18:01.556920 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m02:18:02.618264 [debug] [ThreadPool]: SQL status: SUCCESS 3 in 1.06 seconds
[0m02:18:02.621429 [debug] [ThreadPool]: On list_jaffle_shop: Close
[0m02:18:02.960911 [debug] [ThreadPool]: Acquiring new snowflake connection "list_jaffle_shop_bruno"
[0m02:18:02.974985 [debug] [ThreadPool]: Using snowflake connection "list_jaffle_shop_bruno"
[0m02:18:02.975329 [debug] [ThreadPool]: On list_jaffle_shop_bruno: /* {"app": "dbt", "dbt_version": "1.3.2", "profile_name": "jaffle_shop", "target_name": "dev", "connection_name": "list_jaffle_shop_bruno"} */
show terse objects in jaffle_shop.bruno
[0m02:18:02.975545 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m02:18:03.537420 [debug] [ThreadPool]: SQL status: SUCCESS 8 in 0.56 seconds
[0m02:18:03.542705 [debug] [ThreadPool]: On list_jaffle_shop_bruno: Close
[0m02:18:03.890794 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'ea99a81f-4703-47de-a4e7-f351daabd583', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10e3564c0>]}
[0m02:18:03.892192 [info ] [MainThread]: Concurrency: 1 threads (target='dev')
[0m02:18:03.892755 [info ] [MainThread]: 
[0m02:18:03.900185 [debug] [Thread-1  ]: Began running node model.jaffle_shop.customers
[0m02:18:03.900862 [info ] [Thread-1  ]: 1 of 2 START sql table model bruno.customers ................................... [RUN]
[0m02:18:03.902711 [debug] [Thread-1  ]: Acquiring new snowflake connection "model.jaffle_shop.customers"
[0m02:18:03.903016 [debug] [Thread-1  ]: Began compiling node model.jaffle_shop.customers
[0m02:18:03.903281 [debug] [Thread-1  ]: Compiling model.jaffle_shop.customers
[0m02:18:03.909633 [debug] [Thread-1  ]: Writing injected SQL for node "model.jaffle_shop.customers"
[0m02:18:03.910686 [debug] [Thread-1  ]: finished collecting timing info
[0m02:18:03.910985 [debug] [Thread-1  ]: Began executing node model.jaffle_shop.customers
[0m02:18:03.953503 [debug] [Thread-1  ]: Writing runtime sql for node "model.jaffle_shop.customers"
[0m02:18:03.955945 [debug] [Thread-1  ]: Using snowflake connection "model.jaffle_shop.customers"
[0m02:18:03.956081 [debug] [Thread-1  ]: On model.jaffle_shop.customers: /* {"app": "dbt", "dbt_version": "1.3.2", "profile_name": "jaffle_shop", "target_name": "dev", "node_id": "model.jaffle_shop.customers"} */
create or replace transient table jaffle_shop.bruno.customers  as
        (with customers as (

    select * from jaffle_shop.bruno.stg_customers

),

orders as (

    select * from jaffle_shop.bruno.stg_orders

),

payments as (

    select * from jaffle_shop.bruno.stg_payments

),

customer_orders as (

        select
        customer_id,

        min(order_date) as first_order,
        max(order_date) as most_recent_order,
        count(order_id) as number_of_orders
    from orders

    group by customer_id

),

customer_payments as (

    select
        orders.customer_id,
        sum(amount) as total_amount

    from payments

    left join orders on
         payments.order_id = orders.order_id

    group by orders.customer_id

),

final as (

    select
        customers.customer_id,
        customers.first_name,
        customers.last_name,
        customer_orders.first_order,
        customer_orders.most_recent_order,
        customer_orders.number_of_orders,
        customer_payments.total_amount as customer_lifetime_value

    from customers

    left join customer_orders
        on customers.customer_id = customer_orders.customer_id

    left join customer_payments
        on  customers.customer_id = customer_payments.customer_id

)

select * from final
        );
[0m02:18:03.956202 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m02:18:05.389463 [debug] [Thread-1  ]: SQL status: SUCCESS 1 in 1.43 seconds
[0m02:18:05.435370 [debug] [Thread-1  ]: finished collecting timing info
[0m02:18:05.435700 [debug] [Thread-1  ]: On model.jaffle_shop.customers: Close
[0m02:18:05.810064 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'ea99a81f-4703-47de-a4e7-f351daabd583', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10e355520>]}
[0m02:18:05.810978 [info ] [Thread-1  ]: 1 of 2 OK created sql table model bruno.customers .............................. [[32mSUCCESS 1[0m in 1.91s]
[0m02:18:05.812023 [debug] [Thread-1  ]: Finished running node model.jaffle_shop.customers
[0m02:18:05.812393 [debug] [Thread-1  ]: Began running node model.jaffle_shop.orders
[0m02:18:05.813246 [info ] [Thread-1  ]: 2 of 2 START sql table model bruno.orders ...................................... [RUN]
[0m02:18:05.814521 [debug] [Thread-1  ]: Acquiring new snowflake connection "model.jaffle_shop.orders"
[0m02:18:05.814835 [debug] [Thread-1  ]: Began compiling node model.jaffle_shop.orders
[0m02:18:05.815112 [debug] [Thread-1  ]: Compiling model.jaffle_shop.orders
[0m02:18:05.824486 [debug] [Thread-1  ]: Writing injected SQL for node "model.jaffle_shop.orders"
[0m02:18:05.825369 [debug] [Thread-1  ]: finished collecting timing info
[0m02:18:05.825637 [debug] [Thread-1  ]: Began executing node model.jaffle_shop.orders
[0m02:18:05.830374 [debug] [Thread-1  ]: Writing runtime sql for node "model.jaffle_shop.orders"
[0m02:18:05.833974 [debug] [Thread-1  ]: Using snowflake connection "model.jaffle_shop.orders"
[0m02:18:05.834250 [debug] [Thread-1  ]: On model.jaffle_shop.orders: /* {"app": "dbt", "dbt_version": "1.3.2", "profile_name": "jaffle_shop", "target_name": "dev", "node_id": "model.jaffle_shop.orders"} */
create or replace transient table jaffle_shop.bruno.orders  as
        (

with orders as (

    select * from jaffle_shop.bruno.stg_orders

),

payments as (

    select * from jaffle_shop.bruno.stg_payments

),

order_payments as (

    select
        order_id,

        sum(case when payment_method = 'credit_card' then amount else 0 end) as credit_card_amount,
        sum(case when payment_method = 'coupon' then amount else 0 end) as coupon_amount,
        sum(case when payment_method = 'bank_transfer' then amount else 0 end) as bank_transfer_amount,
        sum(case when payment_method = 'gift_card' then amount else 0 end) as gift_card_amount,
        sum(amount) as total_amount

    from payments

    group by order_id

),

final as (

    select
        orders.order_id,
        orders.customer_id,
        orders.order_date,
        orders.status,

        order_payments.credit_card_amount,

        order_payments.coupon_amount,

        order_payments.bank_transfer_amount,

        order_payments.gift_card_amount,

        order_payments.total_amount as amount

    from orders


    left join order_payments
        on orders.order_id = order_payments.order_id

)

select * from final
        );
[0m02:18:05.834431 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m02:18:07.249240 [debug] [Thread-1  ]: SQL status: SUCCESS 1 in 1.41 seconds
[0m02:18:07.257402 [debug] [Thread-1  ]: finished collecting timing info
[0m02:18:07.257810 [debug] [Thread-1  ]: On model.jaffle_shop.orders: Close
[0m02:18:07.597715 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'ea99a81f-4703-47de-a4e7-f351daabd583', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10f546ee0>]}
[0m02:18:07.598608 [info ] [Thread-1  ]: 2 of 2 OK created sql table model bruno.orders ................................. [[32mSUCCESS 1[0m in 1.78s]
[0m02:18:07.599421 [debug] [Thread-1  ]: Finished running node model.jaffle_shop.orders
[0m02:18:07.601851 [debug] [MainThread]: Acquiring new snowflake connection "master"
[0m02:18:07.602829 [info ] [MainThread]: 
[0m02:18:07.603317 [info ] [MainThread]: Finished running 2 table models in 0 hours 0 minutes and 6.06 seconds (6.06s).
[0m02:18:07.603781 [debug] [MainThread]: Connection 'master' was properly closed.
[0m02:18:07.604016 [debug] [MainThread]: Connection 'model.jaffle_shop.orders' was properly closed.
[0m02:18:07.619376 [info ] [MainThread]: 
[0m02:18:07.619852 [info ] [MainThread]: [32mCompleted successfully[0m
[0m02:18:07.620258 [info ] [MainThread]: 
[0m02:18:07.620565 [info ] [MainThread]: Done. PASS=2 WARN=0 ERROR=0 SKIP=0 TOTAL=2
[0m02:18:07.620986 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10e270fd0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10ddbb130>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10f48c580>]}
[0m02:18:07.621303 [debug] [MainThread]: Flushing usage events


============================== 2023-01-24 02:26:47.336191 | 20b69895-7dd6-4950-947b-2667636d4d52 ==============================
[0m02:26:47.336249 [info ] [MainThread]: Running with dbt=1.3.2
[0m02:26:47.337051 [debug] [MainThread]: running dbt with arguments {'write_json': True, 'use_colors': True, 'printer_width': 80, 'version_check': True, 'partial_parse': True, 'static_parser': True, 'profiles_dir': '/Users/bruno/.dbt', 'send_anonymous_usage_stats': True, 'event_buffer_size': 100000, 'quiet': False, 'no_print': False, 'cache_selected_only': False, 'select': ['orders.py', 'customers.py'], 'which': 'run', 'rpc_method': 'run', 'indirect_selection': 'eager'}
[0m02:26:47.337188 [debug] [MainThread]: Tracking: tracking
[0m02:26:47.337833 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10dea9bb0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10dea9c10>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10dea9c70>]}
[0m02:26:47.393716 [debug] [MainThread]: Partial parsing enabled: 2 files deleted, 2 files added, 0 files changed.
[0m02:26:47.394043 [debug] [MainThread]: Partial parsing: added file: jaffle_shop://models/orders.py
[0m02:26:47.394183 [debug] [MainThread]: Partial parsing: added file: jaffle_shop://models/customers.py
[0m02:26:47.394305 [debug] [MainThread]: Partial parsing: deleted file: jaffle_shop://models/customers.sql
[0m02:26:47.394389 [debug] [MainThread]: Partial parsing: deleted file: jaffle_shop://models/orders.sql
[0m02:26:47.406079 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10df8ecd0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10e659d30>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10e659eb0>]}
[0m02:26:47.406272 [debug] [MainThread]: Flushing usage events
[0m02:26:48.348177 [error] [MainThread]: Encountered an error:
Parsing Error in model orders (models/orders.py)
  unexpected indent (orders.py, line 25)
  
  


============================== 2023-01-24 02:27:34.029309 | 3a7e5744-9f20-4dc1-946d-bd889d56e3a3 ==============================
[0m02:27:34.029376 [info ] [MainThread]: Running with dbt=1.3.2
[0m02:27:34.030222 [debug] [MainThread]: running dbt with arguments {'write_json': True, 'use_colors': True, 'printer_width': 80, 'version_check': True, 'partial_parse': True, 'static_parser': True, 'profiles_dir': '/Users/bruno/.dbt', 'send_anonymous_usage_stats': True, 'event_buffer_size': 100000, 'quiet': False, 'no_print': False, 'cache_selected_only': False, 'select': ['orders.py', 'customers.py'], 'which': 'run', 'rpc_method': 'run', 'indirect_selection': 'eager'}
[0m02:27:34.030360 [debug] [MainThread]: Tracking: tracking
[0m02:27:34.030701 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10dae6b50>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10dae6bb0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10dae6c10>]}
[0m02:27:34.086644 [debug] [MainThread]: Partial parsing enabled: 2 files deleted, 2 files added, 0 files changed.
[0m02:27:34.087009 [debug] [MainThread]: Partial parsing: added file: jaffle_shop://models/customers.py
[0m02:27:34.087147 [debug] [MainThread]: Partial parsing: added file: jaffle_shop://models/orders.py
[0m02:27:34.087241 [debug] [MainThread]: Partial parsing: deleted file: jaffle_shop://models/orders.sql
[0m02:27:34.087349 [debug] [MainThread]: Partial parsing: deleted file: jaffle_shop://models/customers.sql
[0m02:27:34.146158 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '3a7e5744-9f20-4dc1-946d-bd889d56e3a3', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10e11a0d0>]}
[0m02:27:34.153182 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '3a7e5744-9f20-4dc1-946d-bd889d56e3a3', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10dc0c3a0>]}
[0m02:27:34.153410 [info ] [MainThread]: Found 5 models, 10 tests, 0 snapshots, 0 analyses, 303 macros, 0 operations, 3 seed files, 0 sources, 0 exposures, 0 metrics
[0m02:27:34.153589 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '3a7e5744-9f20-4dc1-946d-bd889d56e3a3', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10d96c0a0>]}
[0m02:27:34.154853 [info ] [MainThread]: 
[0m02:27:34.155317 [debug] [MainThread]: Acquiring new snowflake connection "master"
[0m02:27:34.156058 [debug] [ThreadPool]: Acquiring new snowflake connection "list_jaffle_shop"
[0m02:27:34.166908 [debug] [ThreadPool]: Using snowflake connection "list_jaffle_shop"
[0m02:27:34.167071 [debug] [ThreadPool]: On list_jaffle_shop: /* {"app": "dbt", "dbt_version": "1.3.2", "profile_name": "jaffle_shop", "target_name": "dev", "connection_name": "list_jaffle_shop"} */
show terse schemas in database jaffle_shop
    limit 10000
[0m02:27:34.167172 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m02:27:35.415291 [debug] [ThreadPool]: SQL status: SUCCESS 3 in 1.25 seconds
[0m02:27:35.419769 [debug] [ThreadPool]: On list_jaffle_shop: Close
[0m02:27:35.881783 [debug] [ThreadPool]: Acquiring new snowflake connection "list_jaffle_shop_bruno"
[0m02:27:35.894780 [debug] [ThreadPool]: Using snowflake connection "list_jaffle_shop_bruno"
[0m02:27:35.895102 [debug] [ThreadPool]: On list_jaffle_shop_bruno: /* {"app": "dbt", "dbt_version": "1.3.2", "profile_name": "jaffle_shop", "target_name": "dev", "connection_name": "list_jaffle_shop_bruno"} */
show terse objects in jaffle_shop.bruno
[0m02:27:35.895295 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m02:27:36.594414 [debug] [ThreadPool]: SQL status: SUCCESS 6 in 0.7 seconds
[0m02:27:36.600239 [debug] [ThreadPool]: On list_jaffle_shop_bruno: Close
[0m02:27:36.974368 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '3a7e5744-9f20-4dc1-946d-bd889d56e3a3', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10dbc9100>]}
[0m02:27:36.976025 [info ] [MainThread]: Concurrency: 1 threads (target='dev')
[0m02:27:36.976849 [info ] [MainThread]: 
[0m02:27:36.982206 [debug] [Thread-1  ]: Began running node model.jaffle_shop.customers
[0m02:27:36.982607 [info ] [Thread-1  ]: 1 of 2 START python table model bruno.customers ................................ [RUN]
[0m02:27:36.983592 [debug] [Thread-1  ]: Acquiring new snowflake connection "model.jaffle_shop.customers"
[0m02:27:36.983764 [debug] [Thread-1  ]: Began compiling node model.jaffle_shop.customers
[0m02:27:36.983905 [debug] [Thread-1  ]: Compiling model.jaffle_shop.customers
[0m02:27:37.002708 [debug] [Thread-1  ]: Writing injected SQL for node "model.jaffle_shop.customers"
[0m02:27:37.003623 [debug] [Thread-1  ]: finished collecting timing info
[0m02:27:37.003874 [debug] [Thread-1  ]: Began executing node model.jaffle_shop.customers
[0m02:27:37.037578 [debug] [Thread-1  ]: Writing runtime python for node "model.jaffle_shop.customers"
[0m02:27:37.039953 [debug] [Thread-1  ]: Using snowflake connection "model.jaffle_shop.customers"
[0m02:27:37.040092 [debug] [Thread-1  ]: On model.jaffle_shop.customers: /* {"app": "dbt", "dbt_version": "1.3.2", "profile_name": "jaffle_shop", "target_name": "dev", "node_id": "model.jaffle_shop.customers"} */
CREATE OR REPLACE PROCEDURE jaffle_shop.bruno.customers__dbt_sp ()

RETURNS STRING
LANGUAGE PYTHON
RUNTIME_VERSION = '3.8'
PACKAGES = ('snowflake-snowpark-python')

HANDLER = 'main'
EXECUTE AS CALLER
AS
$$

  
    
def model(dbt, session):

    stg_customers = dbt.ref('stg_customers')
    stg_orders = dbt.ref('stg_orders')
    stg_payments = dbt.ref('stg_payments')

    customer_orders = stg_orders.groupby('customer_id').agg({
        'first_order': min(stg_orders.order_date),
        'most_recent_order': max(stg_orders.order_date),
        'number_of_orders': count(stg_orders.order_id)
    })

    customer_payments = stg_payments.merge(stg_orders, on='order_id', how='left').groupby('customer_id').agg({
        'total_amount': sum(stg_payments.amount)
    })

    final_df = stg_customers.merge(customer_orders, on='customer_id', how='left').merge(customer_payments, on='customer_id', how='left')

    final_df.select(
        'customer_id',
        'first_name',
        'last_name',
        'first_order',
        'most_recent_order',
        'number_of_orders',
        'customer_lifetime_value'
    )

    return final_df


# This part is user provided model code
# you will need to copy the next section to run the code
# COMMAND ----------
# this part is dbt logic for get ref work, do not modify

def ref(*args,dbt_load_df_function):
    refs = {"stg_customers": "jaffle_shop.bruno.stg_customers", "stg_orders": "jaffle_shop.bruno.stg_orders", "stg_payments": "jaffle_shop.bruno.stg_payments"}
    key = ".".join(args)
    return dbt_load_df_function(refs[key])


def source(*args, dbt_load_df_function):
    sources = {}
    key = ".".join(args)
    return dbt_load_df_function(sources[key])


config_dict = {}


class config:
    def __init__(self, *args, **kwargs):
        pass

    @staticmethod
    def get(key, default=None):
        return config_dict.get(key, default)

class this:
    """dbt.this() or dbt.this.identifier"""
    database = 'jaffle_shop'
    schema = 'bruno'
    identifier = 'customers'
    def __repr__(self):
        return 'jaffle_shop.bruno.customers'


class dbtObj:
    def __init__(self, load_df_function) -> None:
        self.source = lambda *args: source(*args, dbt_load_df_function=load_df_function)
        self.ref = lambda *args: ref(*args, dbt_load_df_function=load_df_function)
        self.config = config
        self.this = this()
        self.is_incremental = False

# COMMAND ----------

# To run this in snowsight, you need to select entry point to be main
# And you may have to modify the return type to text to get the result back
# def main(session):
#     dbt = dbtObj(session.table)
#     df = model(dbt, session)
#     return df.collect()

# to run this in local notebook, you need to create a session following examples https://github.com/Snowflake-Labs/sfguide-getting-started-snowpark-python
# then you can do the following to run model
# dbt = dbtObj(session.table)
# df = model(dbt, session)


def materialize(session, df, target_relation):
    # make sure pandas exists
    import importlib.util
    package_name = 'pandas'
    if importlib.util.find_spec(package_name):
        import pandas
        if isinstance(df, pandas.core.frame.DataFrame):
          # session.write_pandas does not have overwrite function
          df = session.createDataFrame(df)
    df.write.mode("overwrite").save_as_table("jaffle_shop.bruno.customers", create_temp_table=False)

def main(session):
    dbt = dbtObj(session.table)
    df = model(dbt, session)
    materialize(session, df, dbt.this)
    return "OK"

  
$$;
[0m02:27:37.040202 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m02:28:01.350186 [debug] [Thread-1  ]: SQL status: SUCCESS 1 in 24.31 seconds
[0m02:28:01.353405 [debug] [Thread-1  ]: Using snowflake connection "model.jaffle_shop.customers"
[0m02:28:01.354000 [debug] [Thread-1  ]: On model.jaffle_shop.customers: /* {"app": "dbt", "dbt_version": "1.3.2", "profile_name": "jaffle_shop", "target_name": "dev", "node_id": "model.jaffle_shop.customers"} */
CALL jaffle_shop.bruno.customers__dbt_sp();
[0m02:28:02.381506 [debug] [Thread-1  ]: Snowflake adapter: Snowflake query id: 01a9dab4-0000-0c55-0000-0000468d26c5
[0m02:28:02.381706 [debug] [Thread-1  ]: Snowflake adapter: Snowflake error: 100357 (P0000): Python Interpreter Error:
Traceback (most recent call last):
  File "_udf_code.py", line 109, in main
  File "_udf_code.py", line 11, in model
  File "/usr/lib/python_udf/6cd8c5edb748108566a6331991a1dbb5d219039edc8195c97d7681b3bda325d2/lib/python3.8/site-packages/snowflake/snowpark/dataframe.py", line 848, in __getattr__
    raise AttributeError(
AttributeError: Table object has no attribute groupby
 in function CUSTOMERS__DBT_SP with handler main
[0m02:28:02.382329 [debug] [Thread-1  ]: finished collecting timing info
[0m02:28:02.382577 [debug] [Thread-1  ]: On model.jaffle_shop.customers: Close
[0m02:28:02.730286 [debug] [Thread-1  ]: Database Error in model customers (models/customers.py)
  100357 (P0000): Python Interpreter Error:
  Traceback (most recent call last):
    File "_udf_code.py", line 109, in main
    File "_udf_code.py", line 11, in model
    File "/usr/lib/python_udf/6cd8c5edb748108566a6331991a1dbb5d219039edc8195c97d7681b3bda325d2/lib/python3.8/site-packages/snowflake/snowpark/dataframe.py", line 848, in __getattr__
      raise AttributeError(
  AttributeError: Table object has no attribute groupby
   in function CUSTOMERS__DBT_SP with handler main
  compiled Code at target/run/jaffle_shop/models/customers.py
[0m02:28:02.732533 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '3a7e5744-9f20-4dc1-946d-bd889d56e3a3', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10f316370>]}
[0m02:28:02.734712 [error] [Thread-1  ]: 1 of 2 ERROR creating python table model bruno.customers ....................... [[31mERROR[0m in 25.75s]
[0m02:28:02.737324 [debug] [Thread-1  ]: Finished running node model.jaffle_shop.customers
[0m02:28:02.738680 [debug] [Thread-1  ]: Began running node model.jaffle_shop.orders
[0m02:28:02.740980 [info ] [Thread-1  ]: 2 of 2 START python table model bruno.orders ................................... [RUN]
[0m02:28:02.743060 [debug] [Thread-1  ]: Acquiring new snowflake connection "model.jaffle_shop.orders"
[0m02:28:02.743537 [debug] [Thread-1  ]: Began compiling node model.jaffle_shop.orders
[0m02:28:02.744024 [debug] [Thread-1  ]: Compiling model.jaffle_shop.orders
[0m02:28:02.755853 [debug] [Thread-1  ]: Writing injected SQL for node "model.jaffle_shop.orders"
[0m02:28:02.756833 [debug] [Thread-1  ]: finished collecting timing info
[0m02:28:02.757161 [debug] [Thread-1  ]: Began executing node model.jaffle_shop.orders
[0m02:28:02.762513 [debug] [Thread-1  ]: Writing runtime python for node "model.jaffle_shop.orders"
[0m02:28:02.766312 [debug] [Thread-1  ]: Using snowflake connection "model.jaffle_shop.orders"
[0m02:28:02.766521 [debug] [Thread-1  ]: On model.jaffle_shop.orders: /* {"app": "dbt", "dbt_version": "1.3.2", "profile_name": "jaffle_shop", "target_name": "dev", "node_id": "model.jaffle_shop.orders"} */
CREATE OR REPLACE PROCEDURE jaffle_shop.bruno.orders__dbt_sp ()

RETURNS STRING
LANGUAGE PYTHON
RUNTIME_VERSION = '3.8'
PACKAGES = ('snowflake-snowpark-python')

HANDLER = 'main'
EXECUTE AS CALLER
AS
$$

  
    
def model(dbt, session):

    payment_methods = ['credit_card', 'coupon', 'bank_transfer', 'gift_card']

    stg_orders = dbt.ref('stg_orders')
    stg_payments = dbt.ref('stg_payments')

    order_payments = stg_payments.groupby('order_id').agg({
        payment_method + '_amount': sum(
            stg_payments.amount if stg_payments.payment_method == payment_method else 0)
        for payment_method in payment_methods
    }).assign(total_amount=stg_payments.amount.sum())

    final_df = stg_orders.merge(order_payments, on='order_id', how='left')

    final_df.select(
        'order_id',
        'customer_id',
        'order_date',
        'status',
        *[payment_method + '_amount' for payment_method in payment_methods],
        'total_amount'
    )

    return final_df


# This part is user provided model code
# you will need to copy the next section to run the code
# COMMAND ----------
# this part is dbt logic for get ref work, do not modify

def ref(*args,dbt_load_df_function):
    refs = {"stg_orders": "jaffle_shop.bruno.stg_orders", "stg_payments": "jaffle_shop.bruno.stg_payments"}
    key = ".".join(args)
    return dbt_load_df_function(refs[key])


def source(*args, dbt_load_df_function):
    sources = {}
    key = ".".join(args)
    return dbt_load_df_function(sources[key])


config_dict = {}


class config:
    def __init__(self, *args, **kwargs):
        pass

    @staticmethod
    def get(key, default=None):
        return config_dict.get(key, default)

class this:
    """dbt.this() or dbt.this.identifier"""
    database = 'jaffle_shop'
    schema = 'bruno'
    identifier = 'orders'
    def __repr__(self):
        return 'jaffle_shop.bruno.orders'


class dbtObj:
    def __init__(self, load_df_function) -> None:
        self.source = lambda *args: source(*args, dbt_load_df_function=load_df_function)
        self.ref = lambda *args: ref(*args, dbt_load_df_function=load_df_function)
        self.config = config
        self.this = this()
        self.is_incremental = False

# COMMAND ----------

# To run this in snowsight, you need to select entry point to be main
# And you may have to modify the return type to text to get the result back
# def main(session):
#     dbt = dbtObj(session.table)
#     df = model(dbt, session)
#     return df.collect()

# to run this in local notebook, you need to create a session following examples https://github.com/Snowflake-Labs/sfguide-getting-started-snowpark-python
# then you can do the following to run model
# dbt = dbtObj(session.table)
# df = model(dbt, session)


def materialize(session, df, target_relation):
    # make sure pandas exists
    import importlib.util
    package_name = 'pandas'
    if importlib.util.find_spec(package_name):
        import pandas
        if isinstance(df, pandas.core.frame.DataFrame):
          # session.write_pandas does not have overwrite function
          df = session.createDataFrame(df)
    df.write.mode("overwrite").save_as_table("jaffle_shop.bruno.orders", create_temp_table=False)

def main(session):
    dbt = dbtObj(session.table)
    df = model(dbt, session)
    materialize(session, df, dbt.this)
    return "OK"

  
$$;
[0m02:28:02.766750 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m02:28:08.873528 [debug] [Thread-1  ]: SQL status: SUCCESS 1 in 6.11 seconds
[0m02:28:08.874766 [debug] [Thread-1  ]: Using snowflake connection "model.jaffle_shop.orders"
[0m02:28:08.875140 [debug] [Thread-1  ]: On model.jaffle_shop.orders: /* {"app": "dbt", "dbt_version": "1.3.2", "profile_name": "jaffle_shop", "target_name": "dev", "node_id": "model.jaffle_shop.orders"} */
CALL jaffle_shop.bruno.orders__dbt_sp();
[0m02:28:09.799169 [debug] [Thread-1  ]: Snowflake adapter: Snowflake query id: 01a9dab4-0000-0c55-0000-0000468d26cd
[0m02:28:09.800745 [debug] [Thread-1  ]: Snowflake adapter: Snowflake error: 100357 (P0000): Python Interpreter Error:
Traceback (most recent call last):
  File "_udf_code.py", line 105, in main
  File "_udf_code.py", line 12, in model
  File "/usr/lib/python_udf/6cd8c5edb748108566a6331991a1dbb5d219039edc8195c97d7681b3bda325d2/lib/python3.8/site-packages/snowflake/snowpark/dataframe.py", line 848, in __getattr__
    raise AttributeError(
AttributeError: Table object has no attribute groupby
 in function ORDERS__DBT_SP with handler main
[0m02:28:09.801756 [debug] [Thread-1  ]: finished collecting timing info
[0m02:28:09.802193 [debug] [Thread-1  ]: On model.jaffle_shop.orders: Close
[0m02:28:10.155432 [debug] [Thread-1  ]: Database Error in model orders (models/orders.py)
  100357 (P0000): Python Interpreter Error:
  Traceback (most recent call last):
    File "_udf_code.py", line 105, in main
    File "_udf_code.py", line 12, in model
    File "/usr/lib/python_udf/6cd8c5edb748108566a6331991a1dbb5d219039edc8195c97d7681b3bda325d2/lib/python3.8/site-packages/snowflake/snowpark/dataframe.py", line 848, in __getattr__
      raise AttributeError(
  AttributeError: Table object has no attribute groupby
   in function ORDERS__DBT_SP with handler main
  compiled Code at target/run/jaffle_shop/models/orders.py
[0m02:28:10.156777 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '3a7e5744-9f20-4dc1-946d-bd889d56e3a3', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10e1347f0>]}
[0m02:28:10.157888 [error] [Thread-1  ]: 2 of 2 ERROR creating python table model bruno.orders .......................... [[31mERROR[0m in 7.41s]
[0m02:28:10.159062 [debug] [Thread-1  ]: Finished running node model.jaffle_shop.orders
[0m02:28:10.165133 [debug] [MainThread]: Acquiring new snowflake connection "master"
[0m02:28:10.166699 [info ] [MainThread]: 
[0m02:28:10.167372 [info ] [MainThread]: Finished running 2 table models in 0 hours 0 minutes and 36.01 seconds (36.01s).
[0m02:28:10.168423 [debug] [MainThread]: Connection 'master' was properly closed.
[0m02:28:10.168780 [debug] [MainThread]: Connection 'model.jaffle_shop.orders' was properly closed.
[0m02:28:10.187009 [info ] [MainThread]: 
[0m02:28:10.187508 [info ] [MainThread]: [31mCompleted with 2 errors and 0 warnings:[0m
[0m02:28:10.187986 [info ] [MainThread]: 
[0m02:28:10.188351 [error] [MainThread]: [33mDatabase Error in model customers (models/customers.py)[0m
[0m02:28:10.188707 [error] [MainThread]:   100357 (P0000): Python Interpreter Error:
[0m02:28:10.189053 [error] [MainThread]:   Traceback (most recent call last):
[0m02:28:10.189381 [error] [MainThread]:     File "_udf_code.py", line 109, in main
[0m02:28:10.189709 [error] [MainThread]:     File "_udf_code.py", line 11, in model
[0m02:28:10.190040 [error] [MainThread]:     File "/usr/lib/python_udf/6cd8c5edb748108566a6331991a1dbb5d219039edc8195c97d7681b3bda325d2/lib/python3.8/site-packages/snowflake/snowpark/dataframe.py", line 848, in __getattr__
[0m02:28:10.190369 [error] [MainThread]:       raise AttributeError(
[0m02:28:10.190693 [error] [MainThread]:   AttributeError: Table object has no attribute groupby
[0m02:28:10.191019 [error] [MainThread]:    in function CUSTOMERS__DBT_SP with handler main
[0m02:28:10.191315 [error] [MainThread]:   compiled Code at target/run/jaffle_shop/models/customers.py
[0m02:28:10.191608 [info ] [MainThread]: 
[0m02:28:10.191892 [error] [MainThread]: [33mDatabase Error in model orders (models/orders.py)[0m
[0m02:28:10.192177 [error] [MainThread]:   100357 (P0000): Python Interpreter Error:
[0m02:28:10.192454 [error] [MainThread]:   Traceback (most recent call last):
[0m02:28:10.192730 [error] [MainThread]:     File "_udf_code.py", line 105, in main
[0m02:28:10.193006 [error] [MainThread]:     File "_udf_code.py", line 12, in model
[0m02:28:10.193277 [error] [MainThread]:     File "/usr/lib/python_udf/6cd8c5edb748108566a6331991a1dbb5d219039edc8195c97d7681b3bda325d2/lib/python3.8/site-packages/snowflake/snowpark/dataframe.py", line 848, in __getattr__
[0m02:28:10.193554 [error] [MainThread]:       raise AttributeError(
[0m02:28:10.193827 [error] [MainThread]:   AttributeError: Table object has no attribute groupby
[0m02:28:10.194117 [error] [MainThread]:    in function ORDERS__DBT_SP with handler main
[0m02:28:10.194388 [error] [MainThread]:   compiled Code at target/run/jaffle_shop/models/orders.py
[0m02:28:10.194694 [info ] [MainThread]: 
[0m02:28:10.194997 [info ] [MainThread]: Done. PASS=0 WARN=0 ERROR=2 SKIP=0 TOTAL=2
[0m02:28:10.195470 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10dafa1c0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10f31f1f0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10f3166d0>]}
[0m02:28:10.195790 [debug] [MainThread]: Flushing usage events


============================== 2023-01-24 02:31:02.613375 | ab83f6ff-07e9-4d10-9581-51fead052251 ==============================
[0m02:31:02.613459 [info ] [MainThread]: Running with dbt=1.3.2
[0m02:31:02.614517 [debug] [MainThread]: running dbt with arguments {'write_json': True, 'use_colors': True, 'printer_width': 80, 'version_check': True, 'partial_parse': True, 'static_parser': True, 'profiles_dir': '/Users/bruno/.dbt', 'send_anonymous_usage_stats': True, 'event_buffer_size': 100000, 'quiet': False, 'no_print': False, 'cache_selected_only': False, 'select': ['orders.py', 'customers.py'], 'which': 'run', 'rpc_method': 'run', 'indirect_selection': 'eager'}
[0m02:31:02.616234 [debug] [MainThread]: Tracking: tracking
[0m02:31:02.616829 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x11205bbb0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x11205bc10>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x11205bc70>]}
[0m02:31:02.686177 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 2 files changed.
[0m02:31:02.686808 [debug] [MainThread]: Partial parsing: updated file: jaffle_shop://models/orders.py
[0m02:31:02.687033 [debug] [MainThread]: Partial parsing: updated file: jaffle_shop://models/customers.py
[0m02:31:02.747910 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': 'ab83f6ff-07e9-4d10-9581-51fead052251', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1128bb0d0>]}
[0m02:31:02.755487 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': 'ab83f6ff-07e9-4d10-9581-51fead052251', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1125b40d0>]}
[0m02:31:02.755780 [info ] [MainThread]: Found 5 models, 10 tests, 0 snapshots, 0 analyses, 303 macros, 0 operations, 3 seed files, 0 sources, 0 exposures, 0 metrics
[0m02:31:02.755980 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'ab83f6ff-07e9-4d10-9581-51fead052251', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1125b4220>]}
[0m02:31:02.757300 [info ] [MainThread]: 
[0m02:31:02.757779 [debug] [MainThread]: Acquiring new snowflake connection "master"
[0m02:31:02.758540 [debug] [ThreadPool]: Acquiring new snowflake connection "list_jaffle_shop"
[0m02:31:02.770165 [debug] [ThreadPool]: Using snowflake connection "list_jaffle_shop"
[0m02:31:02.770460 [debug] [ThreadPool]: On list_jaffle_shop: /* {"app": "dbt", "dbt_version": "1.3.2", "profile_name": "jaffle_shop", "target_name": "dev", "connection_name": "list_jaffle_shop"} */
show terse schemas in database jaffle_shop
    limit 10000
[0m02:31:02.770563 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m02:31:04.065399 [debug] [ThreadPool]: SQL status: SUCCESS 3 in 1.29 seconds
[0m02:31:04.070759 [debug] [ThreadPool]: On list_jaffle_shop: Close
[0m02:31:04.478644 [debug] [ThreadPool]: Acquiring new snowflake connection "list_jaffle_shop_bruno"
[0m02:31:04.493084 [debug] [ThreadPool]: Using snowflake connection "list_jaffle_shop_bruno"
[0m02:31:04.493456 [debug] [ThreadPool]: On list_jaffle_shop_bruno: /* {"app": "dbt", "dbt_version": "1.3.2", "profile_name": "jaffle_shop", "target_name": "dev", "connection_name": "list_jaffle_shop_bruno"} */
show terse objects in jaffle_shop.bruno
[0m02:31:04.493677 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m02:31:05.288529 [debug] [ThreadPool]: SQL status: SUCCESS 6 in 0.79 seconds
[0m02:31:05.291859 [debug] [ThreadPool]: On list_jaffle_shop_bruno: Close
[0m02:31:05.627764 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'ab83f6ff-07e9-4d10-9581-51fead052251', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x112186340>]}
[0m02:31:05.629112 [info ] [MainThread]: Concurrency: 1 threads (target='dev')
[0m02:31:05.629656 [info ] [MainThread]: 
[0m02:31:05.636210 [debug] [Thread-1  ]: Began running node model.jaffle_shop.customers
[0m02:31:05.636706 [info ] [Thread-1  ]: 1 of 2 START python table model bruno.customers ................................ [RUN]
[0m02:31:05.638399 [debug] [Thread-1  ]: Acquiring new snowflake connection "model.jaffle_shop.customers"
[0m02:31:05.638732 [debug] [Thread-1  ]: Began compiling node model.jaffle_shop.customers
[0m02:31:05.639012 [debug] [Thread-1  ]: Compiling model.jaffle_shop.customers
[0m02:31:05.667574 [debug] [Thread-1  ]: Writing injected SQL for node "model.jaffle_shop.customers"
[0m02:31:05.668658 [debug] [Thread-1  ]: finished collecting timing info
[0m02:31:05.668896 [debug] [Thread-1  ]: Began executing node model.jaffle_shop.customers
[0m02:31:05.701959 [debug] [Thread-1  ]: Writing runtime python for node "model.jaffle_shop.customers"
[0m02:31:05.704199 [debug] [Thread-1  ]: Using snowflake connection "model.jaffle_shop.customers"
[0m02:31:05.704324 [debug] [Thread-1  ]: On model.jaffle_shop.customers: /* {"app": "dbt", "dbt_version": "1.3.2", "profile_name": "jaffle_shop", "target_name": "dev", "node_id": "model.jaffle_shop.customers"} */
CREATE OR REPLACE PROCEDURE jaffle_shop.bruno.customers__dbt_sp ()

RETURNS STRING
LANGUAGE PYTHON
RUNTIME_VERSION = '3.8'
PACKAGES = ('snowflake-snowpark-python')

HANDLER = 'main'
EXECUTE AS CALLER
AS
$$

  
    
def model(dbt, session):

    stg_customers = dbt.ref('stg_customers')
    stg_orders = dbt.ref('stg_orders')
    stg_payments = dbt.ref('stg_payments')

    customer_orders = stg_orders.group_by('customer_id').agg({
        'first_order': min(stg_orders.order_date),
        'most_recent_order': max(stg_orders.order_date),
        'number_of_orders': count(stg_orders.order_id)
    })

    customer_payments = stg_payments.merge(stg_orders, on='order_id', how='left').group_by('customer_id').agg({
        'total_amount': sum(stg_payments.amount)
    })

    final_df = stg_customers.merge(customer_orders, on='customer_id', how='left').merge(customer_payments, on='customer_id', how='left')

    final_df.select(
        'customer_id',
        'first_name',
        'last_name',
        'first_order',
        'most_recent_order',
        'number_of_orders',
        'customer_lifetime_value'
    )

    return final_df


# This part is user provided model code
# you will need to copy the next section to run the code
# COMMAND ----------
# this part is dbt logic for get ref work, do not modify

def ref(*args,dbt_load_df_function):
    refs = {"stg_customers": "jaffle_shop.bruno.stg_customers", "stg_orders": "jaffle_shop.bruno.stg_orders", "stg_payments": "jaffle_shop.bruno.stg_payments"}
    key = ".".join(args)
    return dbt_load_df_function(refs[key])


def source(*args, dbt_load_df_function):
    sources = {}
    key = ".".join(args)
    return dbt_load_df_function(sources[key])


config_dict = {}


class config:
    def __init__(self, *args, **kwargs):
        pass

    @staticmethod
    def get(key, default=None):
        return config_dict.get(key, default)

class this:
    """dbt.this() or dbt.this.identifier"""
    database = 'jaffle_shop'
    schema = 'bruno'
    identifier = 'customers'
    def __repr__(self):
        return 'jaffle_shop.bruno.customers'


class dbtObj:
    def __init__(self, load_df_function) -> None:
        self.source = lambda *args: source(*args, dbt_load_df_function=load_df_function)
        self.ref = lambda *args: ref(*args, dbt_load_df_function=load_df_function)
        self.config = config
        self.this = this()
        self.is_incremental = False

# COMMAND ----------

# To run this in snowsight, you need to select entry point to be main
# And you may have to modify the return type to text to get the result back
# def main(session):
#     dbt = dbtObj(session.table)
#     df = model(dbt, session)
#     return df.collect()

# to run this in local notebook, you need to create a session following examples https://github.com/Snowflake-Labs/sfguide-getting-started-snowpark-python
# then you can do the following to run model
# dbt = dbtObj(session.table)
# df = model(dbt, session)


def materialize(session, df, target_relation):
    # make sure pandas exists
    import importlib.util
    package_name = 'pandas'
    if importlib.util.find_spec(package_name):
        import pandas
        if isinstance(df, pandas.core.frame.DataFrame):
          # session.write_pandas does not have overwrite function
          df = session.createDataFrame(df)
    df.write.mode("overwrite").save_as_table("jaffle_shop.bruno.customers", create_temp_table=False)

def main(session):
    dbt = dbtObj(session.table)
    df = model(dbt, session)
    materialize(session, df, dbt.this)
    return "OK"

  
$$;
[0m02:31:05.704428 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m02:31:11.430339 [debug] [Thread-1  ]: SQL status: SUCCESS 1 in 5.73 seconds
[0m02:31:11.431271 [debug] [Thread-1  ]: Using snowflake connection "model.jaffle_shop.customers"
[0m02:31:11.431453 [debug] [Thread-1  ]: On model.jaffle_shop.customers: /* {"app": "dbt", "dbt_version": "1.3.2", "profile_name": "jaffle_shop", "target_name": "dev", "node_id": "model.jaffle_shop.customers"} */
CALL jaffle_shop.bruno.customers__dbt_sp();
[0m02:31:12.450238 [debug] [Thread-1  ]: Snowflake adapter: Snowflake query id: 01a9dab7-0000-0c55-0000-0000468d26d9
[0m02:31:12.450464 [debug] [Thread-1  ]: Snowflake adapter: Snowflake error: 100357 (P0000): Python Interpreter Error:
Traceback (most recent call last):
  File "_udf_code.py", line 109, in main
  File "_udf_code.py", line 12, in model
  File "/usr/lib/python_udf/6cd8c5edb748108566a6331991a1dbb5d219039edc8195c97d7681b3bda325d2/lib/python3.8/site-packages/snowflake/snowpark/column.py", line 308, in __iter__
    raise TypeError(
TypeError: Column is not iterable. This error can occur when you use the Python built-ins for sum, min and max. Please make sure you use the corresponding function from snowflake.snowpark.functions.
 in function CUSTOMERS__DBT_SP with handler main
[0m02:31:12.450794 [debug] [Thread-1  ]: finished collecting timing info
[0m02:31:12.450960 [debug] [Thread-1  ]: On model.jaffle_shop.customers: Close
[0m02:31:12.871123 [debug] [Thread-1  ]: Database Error in model customers (models/customers.py)
  100357 (P0000): Python Interpreter Error:
  Traceback (most recent call last):
    File "_udf_code.py", line 109, in main
    File "_udf_code.py", line 12, in model
    File "/usr/lib/python_udf/6cd8c5edb748108566a6331991a1dbb5d219039edc8195c97d7681b3bda325d2/lib/python3.8/site-packages/snowflake/snowpark/column.py", line 308, in __iter__
      raise TypeError(
  TypeError: Column is not iterable. This error can occur when you use the Python built-ins for sum, min and max. Please make sure you use the corresponding function from snowflake.snowpark.functions.
   in function CUSTOMERS__DBT_SP with handler main
  compiled Code at target/run/jaffle_shop/models/customers.py
[0m02:31:12.872555 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'ab83f6ff-07e9-4d10-9581-51fead052251', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1138af4c0>]}
[0m02:31:12.873829 [error] [Thread-1  ]: 1 of 2 ERROR creating python table model bruno.customers ....................... [[31mERROR[0m in 7.24s]
[0m02:31:12.875428 [debug] [Thread-1  ]: Finished running node model.jaffle_shop.customers
[0m02:31:12.876038 [debug] [Thread-1  ]: Began running node model.jaffle_shop.orders
[0m02:31:12.877383 [info ] [Thread-1  ]: 2 of 2 START python table model bruno.orders ................................... [RUN]
[0m02:31:12.879372 [debug] [Thread-1  ]: Acquiring new snowflake connection "model.jaffle_shop.orders"
[0m02:31:12.879891 [debug] [Thread-1  ]: Began compiling node model.jaffle_shop.orders
[0m02:31:12.880257 [debug] [Thread-1  ]: Compiling model.jaffle_shop.orders
[0m02:31:12.890663 [debug] [Thread-1  ]: Writing injected SQL for node "model.jaffle_shop.orders"
[0m02:31:12.892705 [debug] [Thread-1  ]: finished collecting timing info
[0m02:31:12.893042 [debug] [Thread-1  ]: Began executing node model.jaffle_shop.orders
[0m02:31:12.898150 [debug] [Thread-1  ]: Writing runtime python for node "model.jaffle_shop.orders"
[0m02:31:12.902172 [debug] [Thread-1  ]: Using snowflake connection "model.jaffle_shop.orders"
[0m02:31:12.902407 [debug] [Thread-1  ]: On model.jaffle_shop.orders: /* {"app": "dbt", "dbt_version": "1.3.2", "profile_name": "jaffle_shop", "target_name": "dev", "node_id": "model.jaffle_shop.orders"} */
CREATE OR REPLACE PROCEDURE jaffle_shop.bruno.orders__dbt_sp ()

RETURNS STRING
LANGUAGE PYTHON
RUNTIME_VERSION = '3.8'
PACKAGES = ('snowflake-snowpark-python')

HANDLER = 'main'
EXECUTE AS CALLER
AS
$$

  
    
def model(dbt, session):

    payment_methods = ['credit_card', 'coupon', 'bank_transfer', 'gift_card']

    stg_orders = dbt.ref('stg_orders')
    stg_payments = dbt.ref('stg_payments')

    order_payments = stg_payments.group_by('order_id').agg({
        payment_method + '_amount': sum(
            stg_payments.amount if stg_payments.payment_method == payment_method else 0)
        for payment_method in payment_methods
    }).assign(total_amount=stg_payments.amount.sum())

    final_df = stg_orders.merge(order_payments, on='order_id', how='left')

    final_df.select(
        'order_id',
        'customer_id',
        'order_date',
        'status',
        *[payment_method + '_amount' for payment_method in payment_methods],
        'total_amount'
    )

    return final_df


# This part is user provided model code
# you will need to copy the next section to run the code
# COMMAND ----------
# this part is dbt logic for get ref work, do not modify

def ref(*args,dbt_load_df_function):
    refs = {"stg_orders": "jaffle_shop.bruno.stg_orders", "stg_payments": "jaffle_shop.bruno.stg_payments"}
    key = ".".join(args)
    return dbt_load_df_function(refs[key])


def source(*args, dbt_load_df_function):
    sources = {}
    key = ".".join(args)
    return dbt_load_df_function(sources[key])


config_dict = {}


class config:
    def __init__(self, *args, **kwargs):
        pass

    @staticmethod
    def get(key, default=None):
        return config_dict.get(key, default)

class this:
    """dbt.this() or dbt.this.identifier"""
    database = 'jaffle_shop'
    schema = 'bruno'
    identifier = 'orders'
    def __repr__(self):
        return 'jaffle_shop.bruno.orders'


class dbtObj:
    def __init__(self, load_df_function) -> None:
        self.source = lambda *args: source(*args, dbt_load_df_function=load_df_function)
        self.ref = lambda *args: ref(*args, dbt_load_df_function=load_df_function)
        self.config = config
        self.this = this()
        self.is_incremental = False

# COMMAND ----------

# To run this in snowsight, you need to select entry point to be main
# And you may have to modify the return type to text to get the result back
# def main(session):
#     dbt = dbtObj(session.table)
#     df = model(dbt, session)
#     return df.collect()

# to run this in local notebook, you need to create a session following examples https://github.com/Snowflake-Labs/sfguide-getting-started-snowpark-python
# then you can do the following to run model
# dbt = dbtObj(session.table)
# df = model(dbt, session)


def materialize(session, df, target_relation):
    # make sure pandas exists
    import importlib.util
    package_name = 'pandas'
    if importlib.util.find_spec(package_name):
        import pandas
        if isinstance(df, pandas.core.frame.DataFrame):
          # session.write_pandas does not have overwrite function
          df = session.createDataFrame(df)
    df.write.mode("overwrite").save_as_table("jaffle_shop.bruno.orders", create_temp_table=False)

def main(session):
    dbt = dbtObj(session.table)
    df = model(dbt, session)
    materialize(session, df, dbt.this)
    return "OK"

  
$$;
[0m02:31:12.902614 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m02:31:18.826088 [debug] [Thread-1  ]: SQL status: SUCCESS 1 in 5.92 seconds
[0m02:31:18.828604 [debug] [Thread-1  ]: Using snowflake connection "model.jaffle_shop.orders"
[0m02:31:18.828889 [debug] [Thread-1  ]: On model.jaffle_shop.orders: /* {"app": "dbt", "dbt_version": "1.3.2", "profile_name": "jaffle_shop", "target_name": "dev", "node_id": "model.jaffle_shop.orders"} */
CALL jaffle_shop.bruno.orders__dbt_sp();
[0m02:31:19.949244 [debug] [Thread-1  ]: Snowflake adapter: Snowflake query id: 01a9dab7-0000-0c55-0000-0000468d26e5
[0m02:31:19.949548 [debug] [Thread-1  ]: Snowflake adapter: Snowflake error: 100357 (P0000): Python Interpreter Error:
Traceback (most recent call last):
  File "_udf_code.py", line 105, in main
  File "_udf_code.py", line 12, in model
  File "_udf_code.py", line 14, in <dictcomp>
  File "/usr/lib/python_udf/6cd8c5edb748108566a6331991a1dbb5d219039edc8195c97d7681b3bda325d2/lib/python3.8/site-packages/snowflake/snowpark/column.py", line 302, in __bool__
    raise TypeError(
TypeError: Cannot convert a Column object into bool: please use '&' for 'and', '|' for 'or', '~' for 'not' if you're building DataFrame filter expressions. For example, use df.filter((col1 > 1) & (col2 > 2)) instead of df.filter(col1 > 1 and col2 > 2).
 in function ORDERS__DBT_SP with handler main
[0m02:31:19.950297 [debug] [Thread-1  ]: finished collecting timing info
[0m02:31:19.950627 [debug] [Thread-1  ]: On model.jaffle_shop.orders: Close
[0m02:31:20.345235 [debug] [Thread-1  ]: Database Error in model orders (models/orders.py)
  100357 (P0000): Python Interpreter Error:
  Traceback (most recent call last):
    File "_udf_code.py", line 105, in main
    File "_udf_code.py", line 12, in model
    File "_udf_code.py", line 14, in <dictcomp>
    File "/usr/lib/python_udf/6cd8c5edb748108566a6331991a1dbb5d219039edc8195c97d7681b3bda325d2/lib/python3.8/site-packages/snowflake/snowpark/column.py", line 302, in __bool__
      raise TypeError(
  TypeError: Cannot convert a Column object into bool: please use '&' for 'and', '|' for 'or', '~' for 'not' if you're building DataFrame filter expressions. For example, use df.filter((col1 > 1) & (col2 > 2)) instead of df.filter(col1 > 1 and col2 > 2).
   in function ORDERS__DBT_SP with handler main
  compiled Code at target/run/jaffle_shop/models/orders.py
[0m02:31:20.346388 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'ab83f6ff-07e9-4d10-9581-51fead052251', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x112144160>]}
[0m02:31:20.347612 [error] [Thread-1  ]: 2 of 2 ERROR creating python table model bruno.orders .......................... [[31mERROR[0m in 7.47s]
[0m02:31:20.349006 [debug] [Thread-1  ]: Finished running node model.jaffle_shop.orders
[0m02:31:20.353083 [debug] [MainThread]: Acquiring new snowflake connection "master"
[0m02:31:20.354234 [info ] [MainThread]: 
[0m02:31:20.354729 [info ] [MainThread]: Finished running 2 table models in 0 hours 0 minutes and 17.60 seconds (17.60s).
[0m02:31:20.355149 [debug] [MainThread]: Connection 'master' was properly closed.
[0m02:31:20.355353 [debug] [MainThread]: Connection 'model.jaffle_shop.orders' was properly closed.
[0m02:31:20.370196 [info ] [MainThread]: 
[0m02:31:20.370659 [info ] [MainThread]: [31mCompleted with 2 errors and 0 warnings:[0m
[0m02:31:20.371023 [info ] [MainThread]: 
[0m02:31:20.371310 [error] [MainThread]: [33mDatabase Error in model customers (models/customers.py)[0m
[0m02:31:20.371589 [error] [MainThread]:   100357 (P0000): Python Interpreter Error:
[0m02:31:20.371842 [error] [MainThread]:   Traceback (most recent call last):
[0m02:31:20.372093 [error] [MainThread]:     File "_udf_code.py", line 109, in main
[0m02:31:20.372538 [error] [MainThread]:     File "_udf_code.py", line 12, in model
[0m02:31:20.373068 [error] [MainThread]:     File "/usr/lib/python_udf/6cd8c5edb748108566a6331991a1dbb5d219039edc8195c97d7681b3bda325d2/lib/python3.8/site-packages/snowflake/snowpark/column.py", line 308, in __iter__
[0m02:31:20.373330 [error] [MainThread]:       raise TypeError(
[0m02:31:20.373578 [error] [MainThread]:   TypeError: Column is not iterable. This error can occur when you use the Python built-ins for sum, min and max. Please make sure you use the corresponding function from snowflake.snowpark.functions.
[0m02:31:20.373821 [error] [MainThread]:    in function CUSTOMERS__DBT_SP with handler main
[0m02:31:20.374063 [error] [MainThread]:   compiled Code at target/run/jaffle_shop/models/customers.py
[0m02:31:20.374318 [info ] [MainThread]: 
[0m02:31:20.374582 [error] [MainThread]: [33mDatabase Error in model orders (models/orders.py)[0m
[0m02:31:20.374834 [error] [MainThread]:   100357 (P0000): Python Interpreter Error:
[0m02:31:20.375073 [error] [MainThread]:   Traceback (most recent call last):
[0m02:31:20.375312 [error] [MainThread]:     File "_udf_code.py", line 105, in main
[0m02:31:20.375547 [error] [MainThread]:     File "_udf_code.py", line 12, in model
[0m02:31:20.375770 [error] [MainThread]:     File "_udf_code.py", line 14, in <dictcomp>
[0m02:31:20.375978 [error] [MainThread]:     File "/usr/lib/python_udf/6cd8c5edb748108566a6331991a1dbb5d219039edc8195c97d7681b3bda325d2/lib/python3.8/site-packages/snowflake/snowpark/column.py", line 302, in __bool__
[0m02:31:20.376189 [error] [MainThread]:       raise TypeError(
[0m02:31:20.376397 [error] [MainThread]:   TypeError: Cannot convert a Column object into bool: please use '&' for 'and', '|' for 'or', '~' for 'not' if you're building DataFrame filter expressions. For example, use df.filter((col1 > 1) & (col2 > 2)) instead of df.filter(col1 > 1 and col2 > 2).
[0m02:31:20.376619 [error] [MainThread]:    in function ORDERS__DBT_SP with handler main
[0m02:31:20.376828 [error] [MainThread]:   compiled Code at target/run/jaffle_shop/models/orders.py
[0m02:31:20.377051 [info ] [MainThread]: 
[0m02:31:20.377290 [info ] [MainThread]: Done. PASS=0 WARN=0 ERROR=2 SKIP=0 TOTAL=2
[0m02:31:20.377777 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x113e4fe50>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x112074640>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x113e57700>]}
[0m02:31:20.378077 [debug] [MainThread]: Flushing usage events


============================== 2023-01-24 02:46:36.215724 | 00d2ab02-3c79-41ca-832d-512bf4dd846b ==============================
[0m02:46:36.215791 [info ] [MainThread]: Running with dbt=1.3.2
[0m02:46:36.216596 [debug] [MainThread]: running dbt with arguments {'write_json': True, 'use_colors': True, 'printer_width': 80, 'version_check': True, 'partial_parse': True, 'static_parser': True, 'profiles_dir': '/Users/bruno/.dbt', 'send_anonymous_usage_stats': True, 'event_buffer_size': 100000, 'quiet': False, 'no_print': False, 'cache_selected_only': False, 'select': ['customers.py'], 'which': 'run', 'rpc_method': 'run', 'indirect_selection': 'eager'}
[0m02:46:36.216748 [debug] [MainThread]: Tracking: tracking
[0m02:46:36.217075 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10deeebe0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10deeec40>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10deeeca0>]}
[0m02:46:36.271145 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 0 files changed.
[0m02:46:36.271346 [debug] [MainThread]: Partial parsing enabled, no changes found, skipping parsing
[0m02:46:36.277157 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '00d2ab02-3c79-41ca-832d-512bf4dd846b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10e48aee0>]}
[0m02:46:36.284329 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '00d2ab02-3c79-41ca-832d-512bf4dd846b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10dfd2550>]}
[0m02:46:36.284572 [info ] [MainThread]: Found 5 models, 10 tests, 0 snapshots, 0 analyses, 303 macros, 0 operations, 3 seed files, 0 sources, 0 exposures, 0 metrics
[0m02:46:36.284765 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '00d2ab02-3c79-41ca-832d-512bf4dd846b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10dfd2580>]}
[0m02:46:36.285962 [info ] [MainThread]: 
[0m02:46:36.286439 [debug] [MainThread]: Acquiring new snowflake connection "master"
[0m02:46:36.287198 [debug] [ThreadPool]: Acquiring new snowflake connection "list_jaffle_shop"
[0m02:46:36.298586 [debug] [ThreadPool]: Using snowflake connection "list_jaffle_shop"
[0m02:46:36.298791 [debug] [ThreadPool]: On list_jaffle_shop: /* {"app": "dbt", "dbt_version": "1.3.2", "profile_name": "jaffle_shop", "target_name": "dev", "connection_name": "list_jaffle_shop"} */
show terse schemas in database jaffle_shop
    limit 10000
[0m02:46:36.298903 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m02:46:37.429252 [debug] [ThreadPool]: SQL status: SUCCESS 3 in 1.13 seconds
[0m02:46:37.434618 [debug] [ThreadPool]: On list_jaffle_shop: Close
[0m02:46:37.859987 [debug] [ThreadPool]: Acquiring new snowflake connection "list_jaffle_shop_bruno"
[0m02:46:37.872107 [debug] [ThreadPool]: Using snowflake connection "list_jaffle_shop_bruno"
[0m02:46:37.872356 [debug] [ThreadPool]: On list_jaffle_shop_bruno: /* {"app": "dbt", "dbt_version": "1.3.2", "profile_name": "jaffle_shop", "target_name": "dev", "connection_name": "list_jaffle_shop_bruno"} */
show terse objects in jaffle_shop.bruno
[0m02:46:37.872545 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m02:46:38.491162 [debug] [ThreadPool]: SQL status: SUCCESS 6 in 0.62 seconds
[0m02:46:38.495701 [debug] [ThreadPool]: On list_jaffle_shop_bruno: Close
[0m02:46:38.834893 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '00d2ab02-3c79-41ca-832d-512bf4dd846b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10e49cb50>]}
[0m02:46:38.836354 [info ] [MainThread]: Concurrency: 1 threads (target='dev')
[0m02:46:38.836939 [info ] [MainThread]: 
[0m02:46:38.844439 [debug] [Thread-1  ]: Began running node model.jaffle_shop.customers
[0m02:46:38.845066 [info ] [Thread-1  ]: 1 of 1 START python table model bruno.customers ................................ [RUN]
[0m02:46:38.846960 [debug] [Thread-1  ]: Acquiring new snowflake connection "model.jaffle_shop.customers"
[0m02:46:38.847275 [debug] [Thread-1  ]: Began compiling node model.jaffle_shop.customers
[0m02:46:38.847532 [debug] [Thread-1  ]: Compiling model.jaffle_shop.customers
[0m02:46:38.878873 [debug] [Thread-1  ]: Writing injected SQL for node "model.jaffle_shop.customers"
[0m02:46:38.880195 [debug] [Thread-1  ]: finished collecting timing info
[0m02:46:38.880429 [debug] [Thread-1  ]: Began executing node model.jaffle_shop.customers
[0m02:46:38.913302 [debug] [Thread-1  ]: Writing runtime python for node "model.jaffle_shop.customers"
[0m02:46:38.915295 [debug] [Thread-1  ]: Using snowflake connection "model.jaffle_shop.customers"
[0m02:46:38.915413 [debug] [Thread-1  ]: On model.jaffle_shop.customers: /* {"app": "dbt", "dbt_version": "1.3.2", "profile_name": "jaffle_shop", "target_name": "dev", "node_id": "model.jaffle_shop.customers"} */
CREATE OR REPLACE PROCEDURE jaffle_shop.bruno.customers__dbt_sp ()

RETURNS STRING
LANGUAGE PYTHON
RUNTIME_VERSION = '3.8'
PACKAGES = ('snowflake-snowpark-python')

HANDLER = 'main'
EXECUTE AS CALLER
AS
$$

  
    
def model(dbt, session):

    stg_customers = dbt.ref('stg_customers')
    stg_orders = dbt.ref('stg_orders')
    stg_payments = dbt.ref('stg_payments')

    customer_orders = stg_orders.group_by('customer_id').agg({
        'first_order': min(stg_orders.order_date),
        'most_recent_order': max(stg_orders.order_date),
        'number_of_orders': count(stg_orders.order_id)
    })

    customer_payments = stg_payments.merge(stg_orders, on='order_id', how='left').group_by('customer_id').agg({
        'total_amount': sum(stg_payments.amount)
    })

    final_df = stg_customers.merge(customer_orders, on='customer_id', how='left').merge(customer_payments, on='customer_id', how='left')

    final_df.select(
        'customer_id',
        'first_name',
        'last_name',
        'first_order',
        'most_recent_order',
        'number_of_orders',
        'customer_lifetime_value'
    )

    return final_df


# This part is user provided model code
# you will need to copy the next section to run the code
# COMMAND ----------
# this part is dbt logic for get ref work, do not modify

def ref(*args,dbt_load_df_function):
    refs = {"stg_customers": "jaffle_shop.bruno.stg_customers", "stg_orders": "jaffle_shop.bruno.stg_orders", "stg_payments": "jaffle_shop.bruno.stg_payments"}
    key = ".".join(args)
    return dbt_load_df_function(refs[key])


def source(*args, dbt_load_df_function):
    sources = {}
    key = ".".join(args)
    return dbt_load_df_function(sources[key])


config_dict = {}


class config:
    def __init__(self, *args, **kwargs):
        pass

    @staticmethod
    def get(key, default=None):
        return config_dict.get(key, default)

class this:
    """dbt.this() or dbt.this.identifier"""
    database = 'jaffle_shop'
    schema = 'bruno'
    identifier = 'customers'
    def __repr__(self):
        return 'jaffle_shop.bruno.customers'


class dbtObj:
    def __init__(self, load_df_function) -> None:
        self.source = lambda *args: source(*args, dbt_load_df_function=load_df_function)
        self.ref = lambda *args: ref(*args, dbt_load_df_function=load_df_function)
        self.config = config
        self.this = this()
        self.is_incremental = False

# COMMAND ----------

# To run this in snowsight, you need to select entry point to be main
# And you may have to modify the return type to text to get the result back
# def main(session):
#     dbt = dbtObj(session.table)
#     df = model(dbt, session)
#     return df.collect()

# to run this in local notebook, you need to create a session following examples https://github.com/Snowflake-Labs/sfguide-getting-started-snowpark-python
# then you can do the following to run model
# dbt = dbtObj(session.table)
# df = model(dbt, session)


def materialize(session, df, target_relation):
    # make sure pandas exists
    import importlib.util
    package_name = 'pandas'
    if importlib.util.find_spec(package_name):
        import pandas
        if isinstance(df, pandas.core.frame.DataFrame):
          # session.write_pandas does not have overwrite function
          df = session.createDataFrame(df)
    df.write.mode("overwrite").save_as_table("jaffle_shop.bruno.customers", create_temp_table=False)

def main(session):
    dbt = dbtObj(session.table)
    df = model(dbt, session)
    materialize(session, df, dbt.this)
    return "OK"

  
$$;
[0m02:46:38.915516 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m02:47:02.021137 [debug] [Thread-1  ]: SQL status: SUCCESS 1 in 23.11 seconds
[0m02:47:02.021859 [debug] [Thread-1  ]: Using snowflake connection "model.jaffle_shop.customers"
[0m02:47:02.022129 [debug] [Thread-1  ]: On model.jaffle_shop.customers: /* {"app": "dbt", "dbt_version": "1.3.2", "profile_name": "jaffle_shop", "target_name": "dev", "node_id": "model.jaffle_shop.customers"} */
CALL jaffle_shop.bruno.customers__dbt_sp();
[0m02:47:03.323617 [debug] [Thread-1  ]: Snowflake adapter: Snowflake query id: 01a9dac7-0000-0c55-0000-0000468d26f5
[0m02:47:03.323838 [debug] [Thread-1  ]: Snowflake adapter: Snowflake error: 100357 (P0000): Python Interpreter Error:
Traceback (most recent call last):
  File "_udf_code.py", line 109, in main
  File "_udf_code.py", line 12, in model
  File "/usr/lib/python_udf/6cd8c5edb748108566a6331991a1dbb5d219039edc8195c97d7681b3bda325d2/lib/python3.8/site-packages/snowflake/snowpark/column.py", line 308, in __iter__
    raise TypeError(
TypeError: Column is not iterable. This error can occur when you use the Python built-ins for sum, min and max. Please make sure you use the corresponding function from snowflake.snowpark.functions.
 in function CUSTOMERS__DBT_SP with handler main
[0m02:47:03.324118 [debug] [Thread-1  ]: finished collecting timing info
[0m02:47:03.324261 [debug] [Thread-1  ]: On model.jaffle_shop.customers: Close
[0m02:47:03.711930 [debug] [Thread-1  ]: Database Error in model customers (models/customers.py)
  100357 (P0000): Python Interpreter Error:
  Traceback (most recent call last):
    File "_udf_code.py", line 109, in main
    File "_udf_code.py", line 12, in model
    File "/usr/lib/python_udf/6cd8c5edb748108566a6331991a1dbb5d219039edc8195c97d7681b3bda325d2/lib/python3.8/site-packages/snowflake/snowpark/column.py", line 308, in __iter__
      raise TypeError(
  TypeError: Column is not iterable. This error can occur when you use the Python built-ins for sum, min and max. Please make sure you use the corresponding function from snowflake.snowpark.functions.
   in function CUSTOMERS__DBT_SP with handler main
  compiled Code at target/run/jaffle_shop/models/customers.py
[0m02:47:03.713739 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '00d2ab02-3c79-41ca-832d-512bf4dd846b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10f6c5040>]}
[0m02:47:03.715186 [error] [Thread-1  ]: 1 of 1 ERROR creating python table model bruno.customers ....................... [[31mERROR[0m in 24.87s]
[0m02:47:03.717870 [debug] [Thread-1  ]: Finished running node model.jaffle_shop.customers
[0m02:47:03.722996 [debug] [MainThread]: Acquiring new snowflake connection "master"
[0m02:47:03.724461 [info ] [MainThread]: 
[0m02:47:03.725113 [info ] [MainThread]: Finished running 1 table model in 0 hours 0 minutes and 27.44 seconds (27.44s).
[0m02:47:03.725707 [debug] [MainThread]: Connection 'master' was properly closed.
[0m02:47:03.726018 [debug] [MainThread]: Connection 'model.jaffle_shop.customers' was properly closed.
[0m02:47:03.742872 [info ] [MainThread]: 
[0m02:47:03.743317 [info ] [MainThread]: [31mCompleted with 1 error and 0 warnings:[0m
[0m02:47:03.743745 [info ] [MainThread]: 
[0m02:47:03.744106 [error] [MainThread]: [33mDatabase Error in model customers (models/customers.py)[0m
[0m02:47:03.744452 [error] [MainThread]:   100357 (P0000): Python Interpreter Error:
[0m02:47:03.744785 [error] [MainThread]:   Traceback (most recent call last):
[0m02:47:03.745115 [error] [MainThread]:     File "_udf_code.py", line 109, in main
[0m02:47:03.745443 [error] [MainThread]:     File "_udf_code.py", line 12, in model
[0m02:47:03.745767 [error] [MainThread]:     File "/usr/lib/python_udf/6cd8c5edb748108566a6331991a1dbb5d219039edc8195c97d7681b3bda325d2/lib/python3.8/site-packages/snowflake/snowpark/column.py", line 308, in __iter__
[0m02:47:03.746078 [error] [MainThread]:       raise TypeError(
[0m02:47:03.746356 [error] [MainThread]:   TypeError: Column is not iterable. This error can occur when you use the Python built-ins for sum, min and max. Please make sure you use the corresponding function from snowflake.snowpark.functions.
[0m02:47:03.746632 [error] [MainThread]:    in function CUSTOMERS__DBT_SP with handler main
[0m02:47:03.746908 [error] [MainThread]:   compiled Code at target/run/jaffle_shop/models/customers.py
[0m02:47:03.747193 [info ] [MainThread]: 
[0m02:47:03.747494 [info ] [MainThread]: Done. PASS=0 WARN=0 ERROR=1 SKIP=0 TOTAL=1
[0m02:47:03.747920 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10e570970>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10e44fdc0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10f6c1ac0>]}
[0m02:47:03.748260 [debug] [MainThread]: Flushing usage events


============================== 2023-01-24 02:49:32.139665 | 35ef693e-7cf2-46ad-a19b-51e221caf9d3 ==============================
[0m02:49:32.139740 [info ] [MainThread]: Running with dbt=1.3.2
[0m02:49:32.140523 [debug] [MainThread]: running dbt with arguments {'write_json': True, 'use_colors': True, 'printer_width': 80, 'version_check': True, 'partial_parse': True, 'static_parser': True, 'profiles_dir': '/Users/bruno/.dbt', 'send_anonymous_usage_stats': True, 'event_buffer_size': 100000, 'quiet': False, 'no_print': False, 'cache_selected_only': False, 'select': ['customers.py'], 'which': 'run', 'rpc_method': 'run', 'indirect_selection': 'eager'}
[0m02:49:32.140688 [debug] [MainThread]: Tracking: tracking
[0m02:49:32.141013 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10e0b7b80>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10e0b7be0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10e0b7c40>]}
[0m02:49:32.193270 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 1 files changed.
[0m02:49:32.193695 [debug] [MainThread]: Partial parsing: updated file: jaffle_shop://models/customers.py
[0m02:49:32.249572 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '35ef693e-7cf2-46ad-a19b-51e221caf9d3', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10e844970>]}
[0m02:49:32.256185 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '35ef693e-7cf2-46ad-a19b-51e221caf9d3', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10e1e0400>]}
[0m02:49:32.256394 [info ] [MainThread]: Found 5 models, 10 tests, 0 snapshots, 0 analyses, 303 macros, 0 operations, 3 seed files, 0 sources, 0 exposures, 0 metrics
[0m02:49:32.256580 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '35ef693e-7cf2-46ad-a19b-51e221caf9d3', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10e81c0a0>]}
[0m02:49:32.257736 [info ] [MainThread]: 
[0m02:49:32.258189 [debug] [MainThread]: Acquiring new snowflake connection "master"
[0m02:49:32.258949 [debug] [ThreadPool]: Acquiring new snowflake connection "list_jaffle_shop"
[0m02:49:32.271276 [debug] [ThreadPool]: Using snowflake connection "list_jaffle_shop"
[0m02:49:32.271465 [debug] [ThreadPool]: On list_jaffle_shop: /* {"app": "dbt", "dbt_version": "1.3.2", "profile_name": "jaffle_shop", "target_name": "dev", "connection_name": "list_jaffle_shop"} */
show terse schemas in database jaffle_shop
    limit 10000
[0m02:49:32.271566 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m02:49:33.476829 [debug] [ThreadPool]: SQL status: SUCCESS 3 in 1.21 seconds
[0m02:49:33.480855 [debug] [ThreadPool]: On list_jaffle_shop: Close
[0m02:49:33.867743 [debug] [ThreadPool]: Acquiring new snowflake connection "list_jaffle_shop_bruno"
[0m02:49:33.882287 [debug] [ThreadPool]: Using snowflake connection "list_jaffle_shop_bruno"
[0m02:49:33.882605 [debug] [ThreadPool]: On list_jaffle_shop_bruno: /* {"app": "dbt", "dbt_version": "1.3.2", "profile_name": "jaffle_shop", "target_name": "dev", "connection_name": "list_jaffle_shop_bruno"} */
show terse objects in jaffle_shop.bruno
[0m02:49:33.882834 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m02:49:34.466514 [debug] [ThreadPool]: SQL status: SUCCESS 6 in 0.58 seconds
[0m02:49:34.469070 [debug] [ThreadPool]: On list_jaffle_shop_bruno: Close
[0m02:49:34.913968 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '35ef693e-7cf2-46ad-a19b-51e221caf9d3', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10e828fd0>]}
[0m02:49:34.915294 [info ] [MainThread]: Concurrency: 1 threads (target='dev')
[0m02:49:34.915855 [info ] [MainThread]: 
[0m02:49:34.923088 [debug] [Thread-1  ]: Began running node model.jaffle_shop.customers
[0m02:49:34.923649 [info ] [Thread-1  ]: 1 of 1 START python table model bruno.customers ................................ [RUN]
[0m02:49:34.924851 [debug] [Thread-1  ]: Acquiring new snowflake connection "model.jaffle_shop.customers"
[0m02:49:34.925122 [debug] [Thread-1  ]: Began compiling node model.jaffle_shop.customers
[0m02:49:34.926019 [debug] [Thread-1  ]: Compiling model.jaffle_shop.customers
[0m02:49:34.955054 [debug] [Thread-1  ]: Writing injected SQL for node "model.jaffle_shop.customers"
[0m02:49:34.956180 [debug] [Thread-1  ]: finished collecting timing info
[0m02:49:34.956368 [debug] [Thread-1  ]: Began executing node model.jaffle_shop.customers
[0m02:49:34.988608 [debug] [Thread-1  ]: Writing runtime python for node "model.jaffle_shop.customers"
[0m02:49:34.990708 [debug] [Thread-1  ]: Using snowflake connection "model.jaffle_shop.customers"
[0m02:49:34.990823 [debug] [Thread-1  ]: On model.jaffle_shop.customers: /* {"app": "dbt", "dbt_version": "1.3.2", "profile_name": "jaffle_shop", "target_name": "dev", "node_id": "model.jaffle_shop.customers"} */
CREATE OR REPLACE PROCEDURE jaffle_shop.bruno.customers__dbt_sp ()

RETURNS STRING
LANGUAGE PYTHON
RUNTIME_VERSION = '3.8'
PACKAGES = ('snowflake-snowpark-python')

HANDLER = 'main'
EXECUTE AS CALLER
AS
$$

  
    
def model(dbt, session):

    stg_customers = dbt.ref('stg_customers')
    stg_orders = dbt.ref('stg_orders')
    stg_payments = dbt.ref('stg_payments')

    customer_orders = (
        stg_orders
        .groupby("customer_id")
        .agg(
            first_order = F.min("order_date"),
            most_recent_order = F.max("order_date"),
            number_of_orders = F.count("order_id")
        )
    )

    customer_payments = (
        stg_payments
        .join(orders, payments["order_id"] == orders["order_id"], "left")
        .groupby("orders.customer_id")
        .agg(
            total_amount = F.sum("amount")
        )
    )

    final_df = (
        stg_customers
        .join(customer_orders, customers["customer_id"] == customer_orders["customer_id"], "left")
        .join(customer_payments, customers["customer_id"] == customer_payments["customer_id"], "left")
        .select("customers.customer_id",
                "customers.first_name",
                "customers.last_name",
                "customer_orders.first_order",
                "customer_orders.most_recent_order",
                "customer_orders.number_of_orders",
                F.col("customer_payments.total_amount").alias("customer_lifetime_value")
        )
    )

    return final_df


# This part is user provided model code
# you will need to copy the next section to run the code
# COMMAND ----------
# this part is dbt logic for get ref work, do not modify

def ref(*args,dbt_load_df_function):
    refs = {"stg_customers": "jaffle_shop.bruno.stg_customers", "stg_orders": "jaffle_shop.bruno.stg_orders", "stg_payments": "jaffle_shop.bruno.stg_payments"}
    key = ".".join(args)
    return dbt_load_df_function(refs[key])


def source(*args, dbt_load_df_function):
    sources = {}
    key = ".".join(args)
    return dbt_load_df_function(sources[key])


config_dict = {}


class config:
    def __init__(self, *args, **kwargs):
        pass

    @staticmethod
    def get(key, default=None):
        return config_dict.get(key, default)

class this:
    """dbt.this() or dbt.this.identifier"""
    database = 'jaffle_shop'
    schema = 'bruno'
    identifier = 'customers'
    def __repr__(self):
        return 'jaffle_shop.bruno.customers'


class dbtObj:
    def __init__(self, load_df_function) -> None:
        self.source = lambda *args: source(*args, dbt_load_df_function=load_df_function)
        self.ref = lambda *args: ref(*args, dbt_load_df_function=load_df_function)
        self.config = config
        self.this = this()
        self.is_incremental = False

# COMMAND ----------

# To run this in snowsight, you need to select entry point to be main
# And you may have to modify the return type to text to get the result back
# def main(session):
#     dbt = dbtObj(session.table)
#     df = model(dbt, session)
#     return df.collect()

# to run this in local notebook, you need to create a session following examples https://github.com/Snowflake-Labs/sfguide-getting-started-snowpark-python
# then you can do the following to run model
# dbt = dbtObj(session.table)
# df = model(dbt, session)


def materialize(session, df, target_relation):
    # make sure pandas exists
    import importlib.util
    package_name = 'pandas'
    if importlib.util.find_spec(package_name):
        import pandas
        if isinstance(df, pandas.core.frame.DataFrame):
          # session.write_pandas does not have overwrite function
          df = session.createDataFrame(df)
    df.write.mode("overwrite").save_as_table("jaffle_shop.bruno.customers", create_temp_table=False)

def main(session):
    dbt = dbtObj(session.table)
    df = model(dbt, session)
    materialize(session, df, dbt.this)
    return "OK"

  
$$;
[0m02:49:34.990926 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m02:49:40.465191 [debug] [Thread-1  ]: SQL status: SUCCESS 1 in 5.47 seconds
[0m02:49:40.465592 [debug] [Thread-1  ]: Using snowflake connection "model.jaffle_shop.customers"
[0m02:49:40.465805 [debug] [Thread-1  ]: On model.jaffle_shop.customers: /* {"app": "dbt", "dbt_version": "1.3.2", "profile_name": "jaffle_shop", "target_name": "dev", "node_id": "model.jaffle_shop.customers"} */
CALL jaffle_shop.bruno.customers__dbt_sp();
[0m02:49:41.415099 [debug] [Thread-1  ]: Snowflake adapter: Snowflake query id: 01a9dac9-0000-0c55-0000-0000468d2701
[0m02:49:41.415295 [debug] [Thread-1  ]: Snowflake adapter: Snowflake error: 100357 (P0000): Python Interpreter Error:
Traceback (most recent call last):
  File "_udf_code.py", line 120, in main
  File "_udf_code.py", line 12, in model
  File "/usr/lib/python_udf/6cd8c5edb748108566a6331991a1dbb5d219039edc8195c97d7681b3bda325d2/lib/python3.8/site-packages/snowflake/snowpark/dataframe.py", line 848, in __getattr__
    raise AttributeError(
AttributeError: Table object has no attribute groupby
 in function CUSTOMERS__DBT_SP with handler main
[0m02:49:41.415553 [debug] [Thread-1  ]: finished collecting timing info
[0m02:49:41.415685 [debug] [Thread-1  ]: On model.jaffle_shop.customers: Close
[0m02:49:41.876244 [debug] [Thread-1  ]: Database Error in model customers (models/customers.py)
  100357 (P0000): Python Interpreter Error:
  Traceback (most recent call last):
    File "_udf_code.py", line 120, in main
    File "_udf_code.py", line 12, in model
    File "/usr/lib/python_udf/6cd8c5edb748108566a6331991a1dbb5d219039edc8195c97d7681b3bda325d2/lib/python3.8/site-packages/snowflake/snowpark/dataframe.py", line 848, in __getattr__
      raise AttributeError(
  AttributeError: Table object has no attribute groupby
   in function CUSTOMERS__DBT_SP with handler main
  compiled Code at target/run/jaffle_shop/models/customers.py
[0m02:49:41.877083 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '35ef693e-7cf2-46ad-a19b-51e221caf9d3', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10f892c70>]}
[0m02:49:41.877769 [error] [Thread-1  ]: 1 of 1 ERROR creating python table model bruno.customers ....................... [[31mERROR[0m in 6.95s]
[0m02:49:41.878787 [debug] [Thread-1  ]: Finished running node model.jaffle_shop.customers
[0m02:49:41.881523 [debug] [MainThread]: Acquiring new snowflake connection "master"
[0m02:49:41.882587 [info ] [MainThread]: 
[0m02:49:41.883099 [info ] [MainThread]: Finished running 1 table model in 0 hours 0 minutes and 9.62 seconds (9.62s).
[0m02:49:41.883569 [debug] [MainThread]: Connection 'master' was properly closed.
[0m02:49:41.883806 [debug] [MainThread]: Connection 'model.jaffle_shop.customers' was properly closed.
[0m02:49:41.898612 [info ] [MainThread]: 
[0m02:49:41.899041 [info ] [MainThread]: [31mCompleted with 1 error and 0 warnings:[0m
[0m02:49:41.899413 [info ] [MainThread]: 
[0m02:49:41.899726 [error] [MainThread]: [33mDatabase Error in model customers (models/customers.py)[0m
[0m02:49:41.900108 [error] [MainThread]:   100357 (P0000): Python Interpreter Error:
[0m02:49:41.900402 [error] [MainThread]:   Traceback (most recent call last):
[0m02:49:41.900690 [error] [MainThread]:     File "_udf_code.py", line 120, in main
[0m02:49:41.900977 [error] [MainThread]:     File "_udf_code.py", line 12, in model
[0m02:49:41.901448 [error] [MainThread]:     File "/usr/lib/python_udf/6cd8c5edb748108566a6331991a1dbb5d219039edc8195c97d7681b3bda325d2/lib/python3.8/site-packages/snowflake/snowpark/dataframe.py", line 848, in __getattr__
[0m02:49:41.901906 [error] [MainThread]:       raise AttributeError(
[0m02:49:41.902234 [error] [MainThread]:   AttributeError: Table object has no attribute groupby
[0m02:49:41.902539 [error] [MainThread]:    in function CUSTOMERS__DBT_SP with handler main
[0m02:49:41.902833 [error] [MainThread]:   compiled Code at target/run/jaffle_shop/models/customers.py
[0m02:49:41.903171 [info ] [MainThread]: 
[0m02:49:41.903505 [info ] [MainThread]: Done. PASS=0 WARN=0 ERROR=1 SKIP=0 TOTAL=1
[0m02:49:41.904010 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10e8ea640>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10e8f65b0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10f8927c0>]}
[0m02:49:41.904359 [debug] [MainThread]: Flushing usage events


============================== 2023-01-24 02:49:55.786981 | 14020075-6a63-4a29-8f6e-2726d1d94547 ==============================
[0m02:49:55.787055 [info ] [MainThread]: Running with dbt=1.3.2
[0m02:49:55.787649 [debug] [MainThread]: running dbt with arguments {'write_json': True, 'use_colors': True, 'printer_width': 80, 'version_check': True, 'partial_parse': True, 'static_parser': True, 'profiles_dir': '/Users/bruno/.dbt', 'send_anonymous_usage_stats': True, 'event_buffer_size': 100000, 'quiet': False, 'no_print': False, 'cache_selected_only': False, 'select': ['customers.py'], 'which': 'run', 'rpc_method': 'run', 'indirect_selection': 'eager'}
[0m02:49:55.787790 [debug] [MainThread]: Tracking: tracking
[0m02:49:55.788102 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10fd8fbe0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10fd8fc40>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10fd8fca0>]}
[0m02:49:55.836712 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 1 files changed.
[0m02:49:55.837134 [debug] [MainThread]: Partial parsing: updated file: jaffle_shop://models/customers.py
[0m02:49:55.890274 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '14020075-6a63-4a29-8f6e-2726d1d94547', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x11030ff40>]}
[0m02:49:55.896924 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '14020075-6a63-4a29-8f6e-2726d1d94547', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10feb8490>]}
[0m02:49:55.897117 [info ] [MainThread]: Found 5 models, 10 tests, 0 snapshots, 0 analyses, 303 macros, 0 operations, 3 seed files, 0 sources, 0 exposures, 0 metrics
[0m02:49:55.897303 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '14020075-6a63-4a29-8f6e-2726d1d94547', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1102e6100>]}
[0m02:49:55.898527 [info ] [MainThread]: 
[0m02:49:55.899089 [debug] [MainThread]: Acquiring new snowflake connection "master"
[0m02:49:55.900053 [debug] [ThreadPool]: Acquiring new snowflake connection "list_jaffle_shop"
[0m02:49:55.912449 [debug] [ThreadPool]: Using snowflake connection "list_jaffle_shop"
[0m02:49:55.912665 [debug] [ThreadPool]: On list_jaffle_shop: /* {"app": "dbt", "dbt_version": "1.3.2", "profile_name": "jaffle_shop", "target_name": "dev", "connection_name": "list_jaffle_shop"} */
show terse schemas in database jaffle_shop
    limit 10000
[0m02:49:55.912768 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m02:49:56.762615 [debug] [ThreadPool]: SQL status: SUCCESS 3 in 0.85 seconds
[0m02:49:56.771535 [debug] [ThreadPool]: On list_jaffle_shop: Close
[0m02:49:57.145545 [debug] [ThreadPool]: Acquiring new snowflake connection "list_jaffle_shop_bruno"
[0m02:49:57.167577 [debug] [ThreadPool]: Using snowflake connection "list_jaffle_shop_bruno"
[0m02:49:57.168101 [debug] [ThreadPool]: On list_jaffle_shop_bruno: /* {"app": "dbt", "dbt_version": "1.3.2", "profile_name": "jaffle_shop", "target_name": "dev", "connection_name": "list_jaffle_shop_bruno"} */
show terse objects in jaffle_shop.bruno
[0m02:49:57.168379 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m02:49:57.782353 [debug] [ThreadPool]: SQL status: SUCCESS 6 in 0.61 seconds
[0m02:49:57.790917 [debug] [ThreadPool]: On list_jaffle_shop_bruno: Close
[0m02:49:58.151809 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '14020075-6a63-4a29-8f6e-2726d1d94547', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x11030ff70>]}
[0m02:49:58.154395 [info ] [MainThread]: Concurrency: 1 threads (target='dev')
[0m02:49:58.155065 [info ] [MainThread]: 
[0m02:49:58.163768 [debug] [Thread-1  ]: Began running node model.jaffle_shop.customers
[0m02:49:58.164572 [info ] [Thread-1  ]: 1 of 1 START python table model bruno.customers ................................ [RUN]
[0m02:49:58.166108 [debug] [Thread-1  ]: Acquiring new snowflake connection "model.jaffle_shop.customers"
[0m02:49:58.166402 [debug] [Thread-1  ]: Began compiling node model.jaffle_shop.customers
[0m02:49:58.167437 [debug] [Thread-1  ]: Compiling model.jaffle_shop.customers
[0m02:49:58.199924 [debug] [Thread-1  ]: Writing injected SQL for node "model.jaffle_shop.customers"
[0m02:49:58.200535 [debug] [Thread-1  ]: finished collecting timing info
[0m02:49:58.200733 [debug] [Thread-1  ]: Began executing node model.jaffle_shop.customers
[0m02:49:58.232092 [debug] [Thread-1  ]: Writing runtime python for node "model.jaffle_shop.customers"
[0m02:49:58.233978 [debug] [Thread-1  ]: Using snowflake connection "model.jaffle_shop.customers"
[0m02:49:58.234080 [debug] [Thread-1  ]: On model.jaffle_shop.customers: /* {"app": "dbt", "dbt_version": "1.3.2", "profile_name": "jaffle_shop", "target_name": "dev", "node_id": "model.jaffle_shop.customers"} */
CREATE OR REPLACE PROCEDURE jaffle_shop.bruno.customers__dbt_sp ()

RETURNS STRING
LANGUAGE PYTHON
RUNTIME_VERSION = '3.8'
PACKAGES = ('snowflake-snowpark-python')

HANDLER = 'main'
EXECUTE AS CALLER
AS
$$

  
    
def model(dbt, session):

    stg_customers = dbt.ref('stg_customers')
    stg_orders = dbt.ref('stg_orders')
    stg_payments = dbt.ref('stg_payments')

    customer_orders = (
        stg_orders
        .group_by("customer_id")
        .agg(
            first_order = F.min("order_date"),
            most_recent_order = F.max("order_date"),
            number_of_orders = F.count("order_id")
        )
    )

    customer_payments = (
        stg_payments
        .join(orders, payments["order_id"] == orders["order_id"], "left")
        .group_by("orders.customer_id")
        .agg(
            total_amount = F.sum("amount")
        )
    )

    final_df = (
        stg_customers
        .join(customer_orders, customers["customer_id"] == customer_orders["customer_id"], "left")
        .join(customer_payments, customers["customer_id"] == customer_payments["customer_id"], "left")
        .select("customers.customer_id",
                "customers.first_name",
                "customers.last_name",
                "customer_orders.first_order",
                "customer_orders.most_recent_order",
                "customer_orders.number_of_orders",
                F.col("customer_payments.total_amount").alias("customer_lifetime_value")
        )
    )

    return final_df


# This part is user provided model code
# you will need to copy the next section to run the code
# COMMAND ----------
# this part is dbt logic for get ref work, do not modify

def ref(*args,dbt_load_df_function):
    refs = {"stg_customers": "jaffle_shop.bruno.stg_customers", "stg_orders": "jaffle_shop.bruno.stg_orders", "stg_payments": "jaffle_shop.bruno.stg_payments"}
    key = ".".join(args)
    return dbt_load_df_function(refs[key])


def source(*args, dbt_load_df_function):
    sources = {}
    key = ".".join(args)
    return dbt_load_df_function(sources[key])


config_dict = {}


class config:
    def __init__(self, *args, **kwargs):
        pass

    @staticmethod
    def get(key, default=None):
        return config_dict.get(key, default)

class this:
    """dbt.this() or dbt.this.identifier"""
    database = 'jaffle_shop'
    schema = 'bruno'
    identifier = 'customers'
    def __repr__(self):
        return 'jaffle_shop.bruno.customers'


class dbtObj:
    def __init__(self, load_df_function) -> None:
        self.source = lambda *args: source(*args, dbt_load_df_function=load_df_function)
        self.ref = lambda *args: ref(*args, dbt_load_df_function=load_df_function)
        self.config = config
        self.this = this()
        self.is_incremental = False

# COMMAND ----------

# To run this in snowsight, you need to select entry point to be main
# And you may have to modify the return type to text to get the result back
# def main(session):
#     dbt = dbtObj(session.table)
#     df = model(dbt, session)
#     return df.collect()

# to run this in local notebook, you need to create a session following examples https://github.com/Snowflake-Labs/sfguide-getting-started-snowpark-python
# then you can do the following to run model
# dbt = dbtObj(session.table)
# df = model(dbt, session)


def materialize(session, df, target_relation):
    # make sure pandas exists
    import importlib.util
    package_name = 'pandas'
    if importlib.util.find_spec(package_name):
        import pandas
        if isinstance(df, pandas.core.frame.DataFrame):
          # session.write_pandas does not have overwrite function
          df = session.createDataFrame(df)
    df.write.mode("overwrite").save_as_table("jaffle_shop.bruno.customers", create_temp_table=False)

def main(session):
    dbt = dbtObj(session.table)
    df = model(dbt, session)
    materialize(session, df, dbt.this)
    return "OK"

  
$$;
[0m02:49:58.234175 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m02:50:03.988951 [debug] [Thread-1  ]: SQL status: SUCCESS 1 in 5.75 seconds
[0m02:50:03.990126 [debug] [Thread-1  ]: Using snowflake connection "model.jaffle_shop.customers"
[0m02:50:03.990403 [debug] [Thread-1  ]: On model.jaffle_shop.customers: /* {"app": "dbt", "dbt_version": "1.3.2", "profile_name": "jaffle_shop", "target_name": "dev", "node_id": "model.jaffle_shop.customers"} */
CALL jaffle_shop.bruno.customers__dbt_sp();
[0m02:50:04.973006 [debug] [Thread-1  ]: Snowflake adapter: Snowflake query id: 01a9daca-0000-0c55-0000-0000468d270d
[0m02:50:04.973213 [debug] [Thread-1  ]: Snowflake adapter: Snowflake error: 100357 (P0000): Python Interpreter Error:
Traceback (most recent call last):
  File "_udf_code.py", line 120, in main
  File "_udf_code.py", line 15, in model
NameError: name 'F' is not defined
 in function CUSTOMERS__DBT_SP with handler main
[0m02:50:04.973492 [debug] [Thread-1  ]: finished collecting timing info
[0m02:50:04.973633 [debug] [Thread-1  ]: On model.jaffle_shop.customers: Close
[0m02:50:05.305930 [debug] [Thread-1  ]: Database Error in model customers (models/customers.py)
  100357 (P0000): Python Interpreter Error:
  Traceback (most recent call last):
    File "_udf_code.py", line 120, in main
    File "_udf_code.py", line 15, in model
  NameError: name 'F' is not defined
   in function CUSTOMERS__DBT_SP with handler main
  compiled Code at target/run/jaffle_shop/models/customers.py
[0m02:50:05.306818 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '14020075-6a63-4a29-8f6e-2726d1d94547', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1115541c0>]}
[0m02:50:05.307528 [error] [Thread-1  ]: 1 of 1 ERROR creating python table model bruno.customers ....................... [[31mERROR[0m in 7.14s]
[0m02:50:05.308522 [debug] [Thread-1  ]: Finished running node model.jaffle_shop.customers
[0m02:50:05.311396 [debug] [MainThread]: Acquiring new snowflake connection "master"
[0m02:50:05.312438 [info ] [MainThread]: 
[0m02:50:05.312970 [info ] [MainThread]: Finished running 1 table model in 0 hours 0 minutes and 9.41 seconds (9.41s).
[0m02:50:05.313437 [debug] [MainThread]: Connection 'master' was properly closed.
[0m02:50:05.313676 [debug] [MainThread]: Connection 'model.jaffle_shop.customers' was properly closed.
[0m02:50:05.328895 [info ] [MainThread]: 
[0m02:50:05.329310 [info ] [MainThread]: [31mCompleted with 1 error and 0 warnings:[0m
[0m02:50:05.329676 [info ] [MainThread]: 
[0m02:50:05.329983 [error] [MainThread]: [33mDatabase Error in model customers (models/customers.py)[0m
[0m02:50:05.330281 [error] [MainThread]:   100357 (P0000): Python Interpreter Error:
[0m02:50:05.330565 [error] [MainThread]:   Traceback (most recent call last):
[0m02:50:05.330859 [error] [MainThread]:     File "_udf_code.py", line 120, in main
[0m02:50:05.331135 [error] [MainThread]:     File "_udf_code.py", line 15, in model
[0m02:50:05.331408 [error] [MainThread]:   NameError: name 'F' is not defined
[0m02:50:05.331681 [error] [MainThread]:    in function CUSTOMERS__DBT_SP with handler main
[0m02:50:05.331953 [error] [MainThread]:   compiled Code at target/run/jaffle_shop/models/customers.py
[0m02:50:05.332241 [info ] [MainThread]: 
[0m02:50:05.332537 [info ] [MainThread]: Done. PASS=0 WARN=0 ERROR=1 SKIP=0 TOTAL=1
[0m02:50:05.332957 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1102f0c40>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10feb8160>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x111579430>]}
[0m02:50:05.333282 [debug] [MainThread]: Flushing usage events


============================== 2023-01-24 02:50:20.399630 | e9b2f45e-8b2e-4ab6-89b2-5e2b6de95f10 ==============================
[0m02:50:20.399691 [info ] [MainThread]: Running with dbt=1.3.2
[0m02:50:20.400248 [debug] [MainThread]: running dbt with arguments {'write_json': True, 'use_colors': True, 'printer_width': 80, 'version_check': True, 'partial_parse': True, 'static_parser': True, 'profiles_dir': '/Users/bruno/.dbt', 'send_anonymous_usage_stats': True, 'event_buffer_size': 100000, 'quiet': False, 'no_print': False, 'cache_selected_only': False, 'select': ['customers.py'], 'which': 'run', 'rpc_method': 'run', 'indirect_selection': 'eager'}
[0m02:50:20.400397 [debug] [MainThread]: Tracking: tracking
[0m02:50:20.400783 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x111effbe0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x111effc40>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x111effca0>]}
[0m02:50:20.446573 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 1 files changed.
[0m02:50:20.446983 [debug] [MainThread]: Partial parsing: updated file: jaffle_shop://models/customers.py
[0m02:50:20.500132 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': 'e9b2f45e-8b2e-4ab6-89b2-5e2b6de95f10', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1124879a0>]}
[0m02:50:20.506448 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': 'e9b2f45e-8b2e-4ab6-89b2-5e2b6de95f10', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x112028490>]}
[0m02:50:20.506654 [info ] [MainThread]: Found 5 models, 10 tests, 0 snapshots, 0 analyses, 303 macros, 0 operations, 3 seed files, 0 sources, 0 exposures, 0 metrics
[0m02:50:20.506835 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'e9b2f45e-8b2e-4ab6-89b2-5e2b6de95f10', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x112456100>]}
[0m02:50:20.507974 [info ] [MainThread]: 
[0m02:50:20.508436 [debug] [MainThread]: Acquiring new snowflake connection "master"
[0m02:50:20.509221 [debug] [ThreadPool]: Acquiring new snowflake connection "list_jaffle_shop"
[0m02:50:20.521643 [debug] [ThreadPool]: Using snowflake connection "list_jaffle_shop"
[0m02:50:20.521843 [debug] [ThreadPool]: On list_jaffle_shop: /* {"app": "dbt", "dbt_version": "1.3.2", "profile_name": "jaffle_shop", "target_name": "dev", "connection_name": "list_jaffle_shop"} */
show terse schemas in database jaffle_shop
    limit 10000
[0m02:50:20.521944 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m02:50:21.598150 [debug] [ThreadPool]: SQL status: SUCCESS 3 in 1.08 seconds
[0m02:50:21.603349 [debug] [ThreadPool]: On list_jaffle_shop: Close
[0m02:50:22.124794 [debug] [ThreadPool]: Acquiring new snowflake connection "list_jaffle_shop_bruno"
[0m02:50:22.139405 [debug] [ThreadPool]: Using snowflake connection "list_jaffle_shop_bruno"
[0m02:50:22.139703 [debug] [ThreadPool]: On list_jaffle_shop_bruno: /* {"app": "dbt", "dbt_version": "1.3.2", "profile_name": "jaffle_shop", "target_name": "dev", "connection_name": "list_jaffle_shop_bruno"} */
show terse objects in jaffle_shop.bruno
[0m02:50:22.139934 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m02:50:22.887216 [debug] [ThreadPool]: SQL status: SUCCESS 6 in 0.75 seconds
[0m02:50:22.892033 [debug] [ThreadPool]: On list_jaffle_shop_bruno: Close
[0m02:50:23.238847 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'e9b2f45e-8b2e-4ab6-89b2-5e2b6de95f10', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x111ee8880>]}
[0m02:50:23.240328 [info ] [MainThread]: Concurrency: 1 threads (target='dev')
[0m02:50:23.240879 [info ] [MainThread]: 
[0m02:50:23.246136 [debug] [Thread-1  ]: Began running node model.jaffle_shop.customers
[0m02:50:23.246720 [info ] [Thread-1  ]: 1 of 1 START python table model bruno.customers ................................ [RUN]
[0m02:50:23.247971 [debug] [Thread-1  ]: Acquiring new snowflake connection "model.jaffle_shop.customers"
[0m02:50:23.248292 [debug] [Thread-1  ]: Began compiling node model.jaffle_shop.customers
[0m02:50:23.249335 [debug] [Thread-1  ]: Compiling model.jaffle_shop.customers
[0m02:50:23.279254 [debug] [Thread-1  ]: Writing injected SQL for node "model.jaffle_shop.customers"
[0m02:50:23.279888 [debug] [Thread-1  ]: finished collecting timing info
[0m02:50:23.280099 [debug] [Thread-1  ]: Began executing node model.jaffle_shop.customers
[0m02:50:23.314106 [debug] [Thread-1  ]: Writing runtime python for node "model.jaffle_shop.customers"
[0m02:50:23.316277 [debug] [Thread-1  ]: Using snowflake connection "model.jaffle_shop.customers"
[0m02:50:23.316407 [debug] [Thread-1  ]: On model.jaffle_shop.customers: /* {"app": "dbt", "dbt_version": "1.3.2", "profile_name": "jaffle_shop", "target_name": "dev", "node_id": "model.jaffle_shop.customers"} */
CREATE OR REPLACE PROCEDURE jaffle_shop.bruno.customers__dbt_sp ()

RETURNS STRING
LANGUAGE PYTHON
RUNTIME_VERSION = '3.8'
PACKAGES = ('snowflake-snowpark-python')

HANDLER = 'main'
EXECUTE AS CALLER
AS
$$

  
    
def model(dbt, session):

    stg_customers = dbt.ref('stg_customers')
    stg_orders = dbt.ref('stg_orders')
    stg_payments = dbt.ref('stg_payments')

    customer_orders = (
        stg_orders
        .group_by("customer_id")
        .agg(
            first_order = min("order_date"),
            most_recent_order = max("order_date"),
            number_of_orders = count("order_id")
        )
    )

    customer_payments = (
        stg_payments
        .join(orders, payments["order_id"] == orders["order_id"], "left")
        .group_by("orders.customer_id")
        .agg(
            total_amount = sum("amount")
        )
    )

    final_df = (
        stg_customers
        .join(customer_orders, customers["customer_id"] == customer_orders["customer_id"], "left")
        .join(customer_payments, customers["customer_id"] == customer_payments["customer_id"], "left")
        .select("customers.customer_id",
                "customers.first_name",
                "customers.last_name",
                "customer_orders.first_order",
                "customer_orders.most_recent_order",
                "customer_orders.number_of_orders",
                col("customer_payments.total_amount").alias("customer_lifetime_value")
        )
    )

    return final_df


# This part is user provided model code
# you will need to copy the next section to run the code
# COMMAND ----------
# this part is dbt logic for get ref work, do not modify

def ref(*args,dbt_load_df_function):
    refs = {"stg_customers": "jaffle_shop.bruno.stg_customers", "stg_orders": "jaffle_shop.bruno.stg_orders", "stg_payments": "jaffle_shop.bruno.stg_payments"}
    key = ".".join(args)
    return dbt_load_df_function(refs[key])


def source(*args, dbt_load_df_function):
    sources = {}
    key = ".".join(args)
    return dbt_load_df_function(sources[key])


config_dict = {}


class config:
    def __init__(self, *args, **kwargs):
        pass

    @staticmethod
    def get(key, default=None):
        return config_dict.get(key, default)

class this:
    """dbt.this() or dbt.this.identifier"""
    database = 'jaffle_shop'
    schema = 'bruno'
    identifier = 'customers'
    def __repr__(self):
        return 'jaffle_shop.bruno.customers'


class dbtObj:
    def __init__(self, load_df_function) -> None:
        self.source = lambda *args: source(*args, dbt_load_df_function=load_df_function)
        self.ref = lambda *args: ref(*args, dbt_load_df_function=load_df_function)
        self.config = config
        self.this = this()
        self.is_incremental = False

# COMMAND ----------

# To run this in snowsight, you need to select entry point to be main
# And you may have to modify the return type to text to get the result back
# def main(session):
#     dbt = dbtObj(session.table)
#     df = model(dbt, session)
#     return df.collect()

# to run this in local notebook, you need to create a session following examples https://github.com/Snowflake-Labs/sfguide-getting-started-snowpark-python
# then you can do the following to run model
# dbt = dbtObj(session.table)
# df = model(dbt, session)


def materialize(session, df, target_relation):
    # make sure pandas exists
    import importlib.util
    package_name = 'pandas'
    if importlib.util.find_spec(package_name):
        import pandas
        if isinstance(df, pandas.core.frame.DataFrame):
          # session.write_pandas does not have overwrite function
          df = session.createDataFrame(df)
    df.write.mode("overwrite").save_as_table("jaffle_shop.bruno.customers", create_temp_table=False)

def main(session):
    dbt = dbtObj(session.table)
    df = model(dbt, session)
    materialize(session, df, dbt.this)
    return "OK"

  
$$;
[0m02:50:23.316512 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m02:50:28.812540 [debug] [Thread-1  ]: SQL status: SUCCESS 1 in 5.5 seconds
[0m02:50:28.813535 [debug] [Thread-1  ]: Using snowflake connection "model.jaffle_shop.customers"
[0m02:50:28.813905 [debug] [Thread-1  ]: On model.jaffle_shop.customers: /* {"app": "dbt", "dbt_version": "1.3.2", "profile_name": "jaffle_shop", "target_name": "dev", "node_id": "model.jaffle_shop.customers"} */
CALL jaffle_shop.bruno.customers__dbt_sp();
[0m02:50:29.737345 [debug] [Thread-1  ]: Snowflake adapter: Snowflake query id: 01a9daca-0000-0c56-0000-0000468d370d
[0m02:50:29.737578 [debug] [Thread-1  ]: Snowflake adapter: Snowflake error: 100357 (P0000): Python Interpreter Error:
Traceback (most recent call last):
  File "_udf_code.py", line 120, in main
  File "_udf_code.py", line 17, in model
NameError: name 'count' is not defined
 in function CUSTOMERS__DBT_SP with handler main
[0m02:50:29.737869 [debug] [Thread-1  ]: finished collecting timing info
[0m02:50:29.738029 [debug] [Thread-1  ]: On model.jaffle_shop.customers: Close
[0m02:50:30.079205 [debug] [Thread-1  ]: Database Error in model customers (models/customers.py)
  100357 (P0000): Python Interpreter Error:
  Traceback (most recent call last):
    File "_udf_code.py", line 120, in main
    File "_udf_code.py", line 17, in model
  NameError: name 'count' is not defined
   in function CUSTOMERS__DBT_SP with handler main
  compiled Code at target/run/jaffle_shop/models/customers.py
[0m02:50:30.080075 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'e9b2f45e-8b2e-4ab6-89b2-5e2b6de95f10', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1136dd820>]}
[0m02:50:30.080801 [error] [Thread-1  ]: 1 of 1 ERROR creating python table model bruno.customers ....................... [[31mERROR[0m in 6.83s]
[0m02:50:30.081787 [debug] [Thread-1  ]: Finished running node model.jaffle_shop.customers
[0m02:50:30.084615 [debug] [MainThread]: Acquiring new snowflake connection "master"
[0m02:50:30.085674 [info ] [MainThread]: 
[0m02:50:30.086205 [info ] [MainThread]: Finished running 1 table model in 0 hours 0 minutes and 9.58 seconds (9.58s).
[0m02:50:30.086674 [debug] [MainThread]: Connection 'master' was properly closed.
[0m02:50:30.086922 [debug] [MainThread]: Connection 'model.jaffle_shop.customers' was properly closed.
[0m02:50:30.101642 [info ] [MainThread]: 
[0m02:50:30.102073 [info ] [MainThread]: [31mCompleted with 1 error and 0 warnings:[0m
[0m02:50:30.102449 [info ] [MainThread]: 
[0m02:50:30.102762 [error] [MainThread]: [33mDatabase Error in model customers (models/customers.py)[0m
[0m02:50:30.103081 [error] [MainThread]:   100357 (P0000): Python Interpreter Error:
[0m02:50:30.103369 [error] [MainThread]:   Traceback (most recent call last):
[0m02:50:30.103660 [error] [MainThread]:     File "_udf_code.py", line 120, in main
[0m02:50:30.103942 [error] [MainThread]:     File "_udf_code.py", line 17, in model
[0m02:50:30.104223 [error] [MainThread]:   NameError: name 'count' is not defined
[0m02:50:30.104500 [error] [MainThread]:    in function CUSTOMERS__DBT_SP with handler main
[0m02:50:30.104779 [error] [MainThread]:   compiled Code at target/run/jaffle_shop/models/customers.py
[0m02:50:30.105086 [info ] [MainThread]: 
[0m02:50:30.105392 [info ] [MainThread]: Done. PASS=0 WARN=0 ERROR=1 SKIP=0 TOTAL=1
[0m02:50:30.105822 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x112461c40>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x112028b80>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1136dd070>]}
[0m02:50:30.106152 [debug] [MainThread]: Flushing usage events


============================== 2023-01-24 02:54:13.553044 | 2edb0cfd-8922-4d92-b6fc-f4e52dbf9db5 ==============================
[0m02:54:13.553124 [info ] [MainThread]: Running with dbt=1.3.2
[0m02:54:13.553925 [debug] [MainThread]: running dbt with arguments {'write_json': True, 'use_colors': True, 'printer_width': 80, 'version_check': True, 'partial_parse': True, 'static_parser': True, 'profiles_dir': '/Users/bruno/.dbt', 'send_anonymous_usage_stats': True, 'event_buffer_size': 100000, 'quiet': False, 'no_print': False, 'cache_selected_only': False, 'select': ['customers.py'], 'which': 'run', 'rpc_method': 'run', 'indirect_selection': 'eager'}
[0m02:54:13.554073 [debug] [MainThread]: Tracking: tracking
[0m02:54:13.554404 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10db4fb50>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10db4fbb0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10db4fc10>]}
[0m02:54:13.608370 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 0 files changed.
[0m02:54:13.608566 [debug] [MainThread]: Partial parsing enabled, no changes found, skipping parsing
[0m02:54:13.614482 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '2edb0cfd-8922-4d92-b6fc-f4e52dbf9db5', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10e0e8e50>]}
[0m02:54:13.621753 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '2edb0cfd-8922-4d92-b6fc-f4e52dbf9db5', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10dc304c0>]}
[0m02:54:13.622013 [info ] [MainThread]: Found 5 models, 10 tests, 0 snapshots, 0 analyses, 303 macros, 0 operations, 3 seed files, 0 sources, 0 exposures, 0 metrics
[0m02:54:13.622218 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '2edb0cfd-8922-4d92-b6fc-f4e52dbf9db5', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10d9d60d0>]}
[0m02:54:13.623461 [info ] [MainThread]: 
[0m02:54:13.623936 [debug] [MainThread]: Acquiring new snowflake connection "master"
[0m02:54:13.624664 [debug] [ThreadPool]: Acquiring new snowflake connection "list_jaffle_shop"
[0m02:54:13.636278 [debug] [ThreadPool]: Using snowflake connection "list_jaffle_shop"
[0m02:54:13.636490 [debug] [ThreadPool]: On list_jaffle_shop: /* {"app": "dbt", "dbt_version": "1.3.2", "profile_name": "jaffle_shop", "target_name": "dev", "connection_name": "list_jaffle_shop"} */
show terse schemas in database jaffle_shop
    limit 10000
[0m02:54:13.636587 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m02:54:14.795068 [debug] [ThreadPool]: SQL status: SUCCESS 3 in 1.16 seconds
[0m02:54:14.799567 [debug] [ThreadPool]: On list_jaffle_shop: Close
[0m02:54:15.151301 [debug] [ThreadPool]: Acquiring new snowflake connection "list_jaffle_shop_bruno"
[0m02:54:15.165701 [debug] [ThreadPool]: Using snowflake connection "list_jaffle_shop_bruno"
[0m02:54:15.165982 [debug] [ThreadPool]: On list_jaffle_shop_bruno: /* {"app": "dbt", "dbt_version": "1.3.2", "profile_name": "jaffle_shop", "target_name": "dev", "connection_name": "list_jaffle_shop_bruno"} */
show terse objects in jaffle_shop.bruno
[0m02:54:15.166195 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m02:54:15.985761 [debug] [ThreadPool]: SQL status: SUCCESS 6 in 0.82 seconds
[0m02:54:15.990907 [debug] [ThreadPool]: On list_jaffle_shop_bruno: Close
[0m02:54:16.329521 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '2edb0cfd-8922-4d92-b6fc-f4e52dbf9db5', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10dc30100>]}
[0m02:54:16.330905 [info ] [MainThread]: Concurrency: 1 threads (target='dev')
[0m02:54:16.331454 [info ] [MainThread]: 
[0m02:54:16.339021 [debug] [Thread-1  ]: Began running node model.jaffle_shop.customers
[0m02:54:16.339718 [info ] [Thread-1  ]: 1 of 1 START python table model bruno.customers ................................ [RUN]
[0m02:54:16.340872 [debug] [Thread-1  ]: Acquiring new snowflake connection "model.jaffle_shop.customers"
[0m02:54:16.341132 [debug] [Thread-1  ]: Began compiling node model.jaffle_shop.customers
[0m02:54:16.342040 [debug] [Thread-1  ]: Compiling model.jaffle_shop.customers
[0m02:54:16.374165 [debug] [Thread-1  ]: Writing injected SQL for node "model.jaffle_shop.customers"
[0m02:54:16.375213 [debug] [Thread-1  ]: finished collecting timing info
[0m02:54:16.375416 [debug] [Thread-1  ]: Began executing node model.jaffle_shop.customers
[0m02:54:16.410399 [debug] [Thread-1  ]: Writing runtime python for node "model.jaffle_shop.customers"
[0m02:54:16.412600 [debug] [Thread-1  ]: Using snowflake connection "model.jaffle_shop.customers"
[0m02:54:16.412716 [debug] [Thread-1  ]: On model.jaffle_shop.customers: /* {"app": "dbt", "dbt_version": "1.3.2", "profile_name": "jaffle_shop", "target_name": "dev", "node_id": "model.jaffle_shop.customers"} */
CREATE OR REPLACE PROCEDURE jaffle_shop.bruno.customers__dbt_sp ()

RETURNS STRING
LANGUAGE PYTHON
RUNTIME_VERSION = '3.8'
PACKAGES = ('snowflake-snowpark-python')

HANDLER = 'main'
EXECUTE AS CALLER
AS
$$

  
    
def model(dbt, session):

    stg_customers = dbt.ref('stg_customers')
    stg_orders = dbt.ref('stg_orders')
    stg_payments = dbt.ref('stg_payments')

    customer_orders = (
        stg_orders
        .group_by("customer_id")
        .agg(
            first_order = min("order_date"),
            most_recent_order = max("order_date"),
            number_of_orders = count("order_id")
        )
    )

    customer_payments = (
        stg_payments
        .join(orders, payments["order_id"] == orders["order_id"], "left")
        .group_by("orders.customer_id")
        .agg(
            total_amount = sum("amount")
        )
    )

    final_df = (
        stg_customers
        .join(customer_orders, customers["customer_id"] == customer_orders["customer_id"], "left")
        .join(customer_payments, customers["customer_id"] == customer_payments["customer_id"], "left")
        .select("customers.customer_id",
                "customers.first_name",
                "customers.last_name",
                "customer_orders.first_order",
                "customer_orders.most_recent_order",
                "customer_orders.number_of_orders",
                col("customer_payments.total_amount").alias("customer_lifetime_value")
        )
    )

    return final_df


# This part is user provided model code
# you will need to copy the next section to run the code
# COMMAND ----------
# this part is dbt logic for get ref work, do not modify

def ref(*args,dbt_load_df_function):
    refs = {"stg_customers": "jaffle_shop.bruno.stg_customers", "stg_orders": "jaffle_shop.bruno.stg_orders", "stg_payments": "jaffle_shop.bruno.stg_payments"}
    key = ".".join(args)
    return dbt_load_df_function(refs[key])


def source(*args, dbt_load_df_function):
    sources = {}
    key = ".".join(args)
    return dbt_load_df_function(sources[key])


config_dict = {}


class config:
    def __init__(self, *args, **kwargs):
        pass

    @staticmethod
    def get(key, default=None):
        return config_dict.get(key, default)

class this:
    """dbt.this() or dbt.this.identifier"""
    database = 'jaffle_shop'
    schema = 'bruno'
    identifier = 'customers'
    def __repr__(self):
        return 'jaffle_shop.bruno.customers'


class dbtObj:
    def __init__(self, load_df_function) -> None:
        self.source = lambda *args: source(*args, dbt_load_df_function=load_df_function)
        self.ref = lambda *args: ref(*args, dbt_load_df_function=load_df_function)
        self.config = config
        self.this = this()
        self.is_incremental = False

# COMMAND ----------

# To run this in snowsight, you need to select entry point to be main
# And you may have to modify the return type to text to get the result back
# def main(session):
#     dbt = dbtObj(session.table)
#     df = model(dbt, session)
#     return df.collect()

# to run this in local notebook, you need to create a session following examples https://github.com/Snowflake-Labs/sfguide-getting-started-snowpark-python
# then you can do the following to run model
# dbt = dbtObj(session.table)
# df = model(dbt, session)


def materialize(session, df, target_relation):
    # make sure pandas exists
    import importlib.util
    package_name = 'pandas'
    if importlib.util.find_spec(package_name):
        import pandas
        if isinstance(df, pandas.core.frame.DataFrame):
          # session.write_pandas does not have overwrite function
          df = session.createDataFrame(df)
    df.write.mode("overwrite").save_as_table("jaffle_shop.bruno.customers", create_temp_table=False)

def main(session):
    dbt = dbtObj(session.table)
    df = model(dbt, session)
    materialize(session, df, dbt.this)
    return "OK"

  
$$;
[0m02:54:16.412818 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m02:54:21.938806 [debug] [Thread-1  ]: SQL status: SUCCESS 1 in 5.53 seconds
[0m02:54:21.939762 [debug] [Thread-1  ]: Using snowflake connection "model.jaffle_shop.customers"
[0m02:54:21.939971 [debug] [Thread-1  ]: On model.jaffle_shop.customers: /* {"app": "dbt", "dbt_version": "1.3.2", "profile_name": "jaffle_shop", "target_name": "dev", "node_id": "model.jaffle_shop.customers"} */
CALL jaffle_shop.bruno.customers__dbt_sp();
[0m02:54:22.925752 [debug] [Thread-1  ]: Snowflake adapter: Snowflake query id: 01a9dace-0000-0c55-0000-0000468d2725
[0m02:54:22.925974 [debug] [Thread-1  ]: Snowflake adapter: Snowflake error: 100357 (P0000): Python Interpreter Error:
Traceback (most recent call last):
  File "_udf_code.py", line 120, in main
  File "_udf_code.py", line 17, in model
NameError: name 'count' is not defined
 in function CUSTOMERS__DBT_SP with handler main
[0m02:54:22.926276 [debug] [Thread-1  ]: finished collecting timing info
[0m02:54:22.926430 [debug] [Thread-1  ]: On model.jaffle_shop.customers: Close
[0m02:54:23.481396 [debug] [Thread-1  ]: Database Error in model customers (models/customers.py)
  100357 (P0000): Python Interpreter Error:
  Traceback (most recent call last):
    File "_udf_code.py", line 120, in main
    File "_udf_code.py", line 17, in model
  NameError: name 'count' is not defined
   in function CUSTOMERS__DBT_SP with handler main
  compiled Code at target/run/jaffle_shop/models/customers.py
[0m02:54:23.482230 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '2edb0cfd-8922-4d92-b6fc-f4e52dbf9db5', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10e61ed30>]}
[0m02:54:23.482960 [error] [Thread-1  ]: 1 of 1 ERROR creating python table model bruno.customers ....................... [[31mERROR[0m in 7.14s]
[0m02:54:23.483959 [debug] [Thread-1  ]: Finished running node model.jaffle_shop.customers
[0m02:54:23.486871 [debug] [MainThread]: Acquiring new snowflake connection "master"
[0m02:54:23.487858 [info ] [MainThread]: 
[0m02:54:23.488383 [info ] [MainThread]: Finished running 1 table model in 0 hours 0 minutes and 9.86 seconds (9.86s).
[0m02:54:23.488843 [debug] [MainThread]: Connection 'master' was properly closed.
[0m02:54:23.489087 [debug] [MainThread]: Connection 'model.jaffle_shop.customers' was properly closed.
[0m02:54:23.504076 [info ] [MainThread]: 
[0m02:54:23.504563 [info ] [MainThread]: [31mCompleted with 1 error and 0 warnings:[0m
[0m02:54:23.504958 [info ] [MainThread]: 
[0m02:54:23.505271 [error] [MainThread]: [33mDatabase Error in model customers (models/customers.py)[0m
[0m02:54:23.505581 [error] [MainThread]:   100357 (P0000): Python Interpreter Error:
[0m02:54:23.505868 [error] [MainThread]:   Traceback (most recent call last):
[0m02:54:23.506150 [error] [MainThread]:     File "_udf_code.py", line 120, in main
[0m02:54:23.506432 [error] [MainThread]:     File "_udf_code.py", line 17, in model
[0m02:54:23.506716 [error] [MainThread]:   NameError: name 'count' is not defined
[0m02:54:23.506997 [error] [MainThread]:    in function CUSTOMERS__DBT_SP with handler main
[0m02:54:23.507278 [error] [MainThread]:   compiled Code at target/run/jaffle_shop/models/customers.py
[0m02:54:23.507598 [info ] [MainThread]: 
[0m02:54:23.507897 [info ] [MainThread]: Done. PASS=0 WARN=0 ERROR=1 SKIP=0 TOTAL=1
[0m02:54:23.508413 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10e0a2280>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10db64ac0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10e61e070>]}
[0m02:54:23.508827 [debug] [MainThread]: Flushing usage events


============================== 2023-01-24 02:56:07.006054 | 05cc9f14-3c57-4f65-948d-f973751559c9 ==============================
[0m02:56:07.006176 [info ] [MainThread]: Running with dbt=1.3.2
[0m02:56:07.007470 [debug] [MainThread]: running dbt with arguments {'write_json': True, 'use_colors': True, 'printer_width': 80, 'version_check': True, 'partial_parse': True, 'static_parser': True, 'profiles_dir': '/Users/bruno/.dbt', 'send_anonymous_usage_stats': True, 'event_buffer_size': 100000, 'quiet': False, 'no_print': False, 'cache_selected_only': False, 'select': ['customers.py'], 'which': 'run', 'rpc_method': 'run', 'indirect_selection': 'eager'}
[0m02:56:07.007674 [debug] [MainThread]: Tracking: tracking
[0m02:56:07.008244 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x112581a90>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x112581af0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x112581b50>]}
[0m02:56:07.062896 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 1 files changed.
[0m02:56:07.063306 [debug] [MainThread]: Partial parsing: updated file: jaffle_shop://models/customers.py
[0m02:56:07.120167 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '05cc9f14-3c57-4f65-948d-f973751559c9', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x112afd0d0>]}
[0m02:56:07.131260 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '05cc9f14-3c57-4f65-948d-f973751559c9', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x112698400>]}
[0m02:56:07.131589 [info ] [MainThread]: Found 5 models, 10 tests, 0 snapshots, 0 analyses, 303 macros, 0 operations, 3 seed files, 0 sources, 0 exposures, 0 metrics
[0m02:56:07.131803 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '05cc9f14-3c57-4f65-948d-f973751559c9', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x112ad1f70>]}
[0m02:56:07.133224 [info ] [MainThread]: 
[0m02:56:07.133886 [debug] [MainThread]: Acquiring new snowflake connection "master"
[0m02:56:07.135745 [debug] [ThreadPool]: Acquiring new snowflake connection "list_jaffle_shop"
[0m02:56:07.148114 [debug] [ThreadPool]: Using snowflake connection "list_jaffle_shop"
[0m02:56:07.148303 [debug] [ThreadPool]: On list_jaffle_shop: /* {"app": "dbt", "dbt_version": "1.3.2", "profile_name": "jaffle_shop", "target_name": "dev", "connection_name": "list_jaffle_shop"} */
show terse schemas in database jaffle_shop
    limit 10000
[0m02:56:07.148401 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m02:56:08.277318 [debug] [ThreadPool]: SQL status: SUCCESS 3 in 1.13 seconds
[0m02:56:08.282064 [debug] [ThreadPool]: On list_jaffle_shop: Close
[0m02:56:08.635336 [debug] [ThreadPool]: Acquiring new snowflake connection "list_jaffle_shop_bruno"
[0m02:56:08.649698 [debug] [ThreadPool]: Using snowflake connection "list_jaffle_shop_bruno"
[0m02:56:08.649997 [debug] [ThreadPool]: On list_jaffle_shop_bruno: /* {"app": "dbt", "dbt_version": "1.3.2", "profile_name": "jaffle_shop", "target_name": "dev", "connection_name": "list_jaffle_shop_bruno"} */
show terse objects in jaffle_shop.bruno
[0m02:56:08.650224 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m02:56:09.569721 [debug] [ThreadPool]: SQL status: SUCCESS 6 in 0.92 seconds
[0m02:56:09.575094 [debug] [ThreadPool]: On list_jaffle_shop_bruno: Close
[0m02:56:09.982485 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '05cc9f14-3c57-4f65-948d-f973751559c9', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x112698070>]}
[0m02:56:09.984081 [info ] [MainThread]: Concurrency: 1 threads (target='dev')
[0m02:56:09.984653 [info ] [MainThread]: 
[0m02:56:09.992005 [debug] [Thread-1  ]: Began running node model.jaffle_shop.customers
[0m02:56:09.992694 [info ] [Thread-1  ]: 1 of 1 START python table model bruno.customers ................................ [RUN]
[0m02:56:09.993894 [debug] [Thread-1  ]: Acquiring new snowflake connection "model.jaffle_shop.customers"
[0m02:56:09.994153 [debug] [Thread-1  ]: Began compiling node model.jaffle_shop.customers
[0m02:56:09.995030 [debug] [Thread-1  ]: Compiling model.jaffle_shop.customers
[0m02:56:10.024878 [debug] [Thread-1  ]: Writing injected SQL for node "model.jaffle_shop.customers"
[0m02:56:10.025768 [debug] [Thread-1  ]: finished collecting timing info
[0m02:56:10.025978 [debug] [Thread-1  ]: Began executing node model.jaffle_shop.customers
[0m02:56:10.059121 [debug] [Thread-1  ]: Writing runtime python for node "model.jaffle_shop.customers"
[0m02:56:10.061280 [debug] [Thread-1  ]: Using snowflake connection "model.jaffle_shop.customers"
[0m02:56:10.061395 [debug] [Thread-1  ]: On model.jaffle_shop.customers: /* {"app": "dbt", "dbt_version": "1.3.2", "profile_name": "jaffle_shop", "target_name": "dev", "node_id": "model.jaffle_shop.customers"} */
CREATE OR REPLACE PROCEDURE jaffle_shop.bruno.customers__dbt_sp ()

RETURNS STRING
LANGUAGE PYTHON
RUNTIME_VERSION = '3.8'
PACKAGES = ('snowflake-snowpark-python')

HANDLER = 'main'
EXECUTE AS CALLER
AS
$$

  
    
import snowflake.snowpark.functions as F

def model(dbt, session):

    stg_customers = dbt.ref('stg_customers')
    stg_orders = dbt.ref('stg_orders')
    stg_payments = dbt.ref('stg_payments')

    customer_orders = (
        stg_orders
        .group_by("customer_id")
        .agg(
            first_order = F.min("order_date"),
            most_recent_order = F.max("order_date"),
            number_of_orders = F.count("order_id")
        )
    )

    customer_payments = (
        stg_payments
        .join(orders, payments["order_id"] == orders["order_id"], "left")
        .group_by("orders.customer_id")
        .agg(
            total_amount = F.sum("amount")
        )
    )

    final_df = (
        stg_customers
        .join(customer_orders, customers["customer_id"] == customer_orders["customer_id"], "left")
        .join(customer_payments, customers["customer_id"] == customer_payments["customer_id"], "left")
        .select("customers.customer_id",
                "customers.first_name",
                "customers.last_name",
                "customer_orders.first_order",
                "customer_orders.most_recent_order",
                "customer_orders.number_of_orders",
                F.col("customer_payments.total_amount").alias("customer_lifetime_value")
        )
    )

    return final_df


# This part is user provided model code
# you will need to copy the next section to run the code
# COMMAND ----------
# this part is dbt logic for get ref work, do not modify

def ref(*args,dbt_load_df_function):
    refs = {"stg_customers": "jaffle_shop.bruno.stg_customers", "stg_orders": "jaffle_shop.bruno.stg_orders", "stg_payments": "jaffle_shop.bruno.stg_payments"}
    key = ".".join(args)
    return dbt_load_df_function(refs[key])


def source(*args, dbt_load_df_function):
    sources = {}
    key = ".".join(args)
    return dbt_load_df_function(sources[key])


config_dict = {}


class config:
    def __init__(self, *args, **kwargs):
        pass

    @staticmethod
    def get(key, default=None):
        return config_dict.get(key, default)

class this:
    """dbt.this() or dbt.this.identifier"""
    database = 'jaffle_shop'
    schema = 'bruno'
    identifier = 'customers'
    def __repr__(self):
        return 'jaffle_shop.bruno.customers'


class dbtObj:
    def __init__(self, load_df_function) -> None:
        self.source = lambda *args: source(*args, dbt_load_df_function=load_df_function)
        self.ref = lambda *args: ref(*args, dbt_load_df_function=load_df_function)
        self.config = config
        self.this = this()
        self.is_incremental = False

# COMMAND ----------

# To run this in snowsight, you need to select entry point to be main
# And you may have to modify the return type to text to get the result back
# def main(session):
#     dbt = dbtObj(session.table)
#     df = model(dbt, session)
#     return df.collect()

# to run this in local notebook, you need to create a session following examples https://github.com/Snowflake-Labs/sfguide-getting-started-snowpark-python
# then you can do the following to run model
# dbt = dbtObj(session.table)
# df = model(dbt, session)


def materialize(session, df, target_relation):
    # make sure pandas exists
    import importlib.util
    package_name = 'pandas'
    if importlib.util.find_spec(package_name):
        import pandas
        if isinstance(df, pandas.core.frame.DataFrame):
          # session.write_pandas does not have overwrite function
          df = session.createDataFrame(df)
    df.write.mode("overwrite").save_as_table("jaffle_shop.bruno.customers", create_temp_table=False)

def main(session):
    dbt = dbtObj(session.table)
    df = model(dbt, session)
    materialize(session, df, dbt.this)
    return "OK"

  
$$;
[0m02:56:10.061500 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m02:56:15.494292 [debug] [Thread-1  ]: SQL status: SUCCESS 1 in 5.43 seconds
[0m02:56:15.495574 [debug] [Thread-1  ]: Using snowflake connection "model.jaffle_shop.customers"
[0m02:56:15.495903 [debug] [Thread-1  ]: On model.jaffle_shop.customers: /* {"app": "dbt", "dbt_version": "1.3.2", "profile_name": "jaffle_shop", "target_name": "dev", "node_id": "model.jaffle_shop.customers"} */
CALL jaffle_shop.bruno.customers__dbt_sp();
[0m02:56:16.487656 [debug] [Thread-1  ]: Snowflake adapter: Snowflake query id: 01a9dad0-0000-0c56-0000-0000468d3719
[0m02:56:16.487874 [debug] [Thread-1  ]: Snowflake adapter: Snowflake error: 100357 (P0000): Python Interpreter Error:
Traceback (most recent call last):
  File "_udf_code.py", line 122, in main
  File "_udf_code.py", line 14, in model
  File "/usr/lib/python_udf/6cd8c5edb748108566a6331991a1dbb5d219039edc8195c97d7681b3bda325d2/lib/python3.8/site-packages/snowflake/snowpark/_internal/telemetry.py", line 224, in wrap
    r = func(*args, **kwargs)
TypeError: agg() got an unexpected keyword argument 'first_order'
 in function CUSTOMERS__DBT_SP with handler main
[0m02:56:16.488169 [debug] [Thread-1  ]: finished collecting timing info
[0m02:56:16.488325 [debug] [Thread-1  ]: On model.jaffle_shop.customers: Close
[0m02:56:17.048141 [debug] [Thread-1  ]: Database Error in model customers (models/customers.py)
  100357 (P0000): Python Interpreter Error:
  Traceback (most recent call last):
    File "_udf_code.py", line 122, in main
    File "_udf_code.py", line 14, in model
    File "/usr/lib/python_udf/6cd8c5edb748108566a6331991a1dbb5d219039edc8195c97d7681b3bda325d2/lib/python3.8/site-packages/snowflake/snowpark/_internal/telemetry.py", line 224, in wrap
      r = func(*args, **kwargs)
  TypeError: agg() got an unexpected keyword argument 'first_order'
   in function CUSTOMERS__DBT_SP with handler main
  compiled Code at target/run/jaffle_shop/models/customers.py
[0m02:56:17.048843 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '05cc9f14-3c57-4f65-948d-f973751559c9', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x113d5ca00>]}
[0m02:56:17.049527 [error] [Thread-1  ]: 1 of 1 ERROR creating python table model bruno.customers ....................... [[31mERROR[0m in 7.06s]
[0m02:56:17.050521 [debug] [Thread-1  ]: Finished running node model.jaffle_shop.customers
[0m02:56:17.052920 [debug] [MainThread]: Acquiring new snowflake connection "master"
[0m02:56:17.053771 [info ] [MainThread]: 
[0m02:56:17.054206 [info ] [MainThread]: Finished running 1 table model in 0 hours 0 minutes and 9.92 seconds (9.92s).
[0m02:56:17.054607 [debug] [MainThread]: Connection 'master' was properly closed.
[0m02:56:17.054809 [debug] [MainThread]: Connection 'model.jaffle_shop.customers' was properly closed.
[0m02:56:17.068982 [info ] [MainThread]: 
[0m02:56:17.069471 [info ] [MainThread]: [31mCompleted with 1 error and 0 warnings:[0m
[0m02:56:17.069889 [info ] [MainThread]: 
[0m02:56:17.070214 [error] [MainThread]: [33mDatabase Error in model customers (models/customers.py)[0m
[0m02:56:17.070525 [error] [MainThread]:   100357 (P0000): Python Interpreter Error:
[0m02:56:17.070819 [error] [MainThread]:   Traceback (most recent call last):
[0m02:56:17.071091 [error] [MainThread]:     File "_udf_code.py", line 122, in main
[0m02:56:17.071340 [error] [MainThread]:     File "_udf_code.py", line 14, in model
[0m02:56:17.071585 [error] [MainThread]:     File "/usr/lib/python_udf/6cd8c5edb748108566a6331991a1dbb5d219039edc8195c97d7681b3bda325d2/lib/python3.8/site-packages/snowflake/snowpark/_internal/telemetry.py", line 224, in wrap
[0m02:56:17.071836 [error] [MainThread]:       r = func(*args, **kwargs)
[0m02:56:17.072083 [error] [MainThread]:   TypeError: agg() got an unexpected keyword argument 'first_order'
[0m02:56:17.072328 [error] [MainThread]:    in function CUSTOMERS__DBT_SP with handler main
[0m02:56:17.072571 [error] [MainThread]:   compiled Code at target/run/jaffle_shop/models/customers.py
[0m02:56:17.072828 [info ] [MainThread]: 
[0m02:56:17.073092 [info ] [MainThread]: Done. PASS=0 WARN=0 ERROR=1 SKIP=0 TOTAL=1
[0m02:56:17.073479 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1126980a0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x112baf250>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x113d5c520>]}
[0m02:56:17.073782 [debug] [MainThread]: Flushing usage events


============================== 2023-01-24 02:58:43.919649 | 2a2f7cce-76d4-419f-bfca-b7621b1ba1ff ==============================
[0m02:58:43.919738 [info ] [MainThread]: Running with dbt=1.3.2
[0m02:58:43.920903 [debug] [MainThread]: running dbt with arguments {'write_json': True, 'use_colors': True, 'printer_width': 80, 'version_check': True, 'partial_parse': True, 'static_parser': True, 'profiles_dir': '/Users/bruno/.dbt', 'send_anonymous_usage_stats': True, 'event_buffer_size': 100000, 'quiet': False, 'no_print': False, 'cache_selected_only': False, 'select': ['customers.py'], 'which': 'run', 'rpc_method': 'run', 'indirect_selection': 'eager'}
[0m02:58:43.921080 [debug] [MainThread]: Tracking: tracking
[0m02:58:43.921530 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x111e19b50>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x111e19bb0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x111e19c10>]}
[0m02:58:43.977023 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 1 files changed.
[0m02:58:43.977441 [debug] [MainThread]: Partial parsing: updated file: jaffle_shop://models/customers.py
[0m02:58:43.989838 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x111f01a60>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1123b2ac0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1123b2c40>]}
[0m02:58:43.990094 [debug] [MainThread]: Flushing usage events
[0m02:58:44.772931 [error] [MainThread]: Encountered an error:
Parsing Error in model customers (models/customers.py)
  expression cannot contain assignment, perhaps you meant "=="? (customers.py, line 13)
              'first_order' = F.min("order_date"),
  


============================== 2023-01-24 03:02:05.125555 | 1596ecda-549b-4aad-91a4-1bdbcaa2bdbf ==============================
[0m03:02:05.125709 [info ] [MainThread]: Running with dbt=1.3.2
[0m03:02:05.126828 [debug] [MainThread]: running dbt with arguments {'write_json': True, 'use_colors': True, 'printer_width': 80, 'version_check': True, 'partial_parse': True, 'static_parser': True, 'profiles_dir': '/Users/bruno/.dbt', 'send_anonymous_usage_stats': True, 'event_buffer_size': 100000, 'quiet': False, 'no_print': False, 'cache_selected_only': False, 'select': ['customers.py'], 'which': 'run', 'rpc_method': 'run', 'indirect_selection': 'eager'}
[0m03:02:05.127010 [debug] [MainThread]: Tracking: tracking
[0m03:02:05.127541 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x110949af0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x110949b50>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x110949bb0>]}
[0m03:02:05.181292 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 1 files changed.
[0m03:02:05.181682 [debug] [MainThread]: Partial parsing: updated file: jaffle_shop://models/customers.py
[0m03:02:05.193526 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x110a28a00>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x110ed9a60>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x110ed9be0>]}
[0m03:02:05.193734 [debug] [MainThread]: Flushing usage events
[0m03:02:06.338758 [error] [MainThread]: Encountered an error:
Parsing Error in model customers (models/customers.py)
  invalid syntax (customers.py, line 13)
              F.min("order_date").as('first_order'),
  


============================== 2023-01-24 03:04:34.282883 | 528cfbc4-1573-451e-b078-b2f46a9e26ac ==============================
[0m03:04:34.282930 [info ] [MainThread]: Running with dbt=1.3.2
[0m03:04:34.283703 [debug] [MainThread]: running dbt with arguments {'write_json': True, 'use_colors': True, 'printer_width': 80, 'version_check': True, 'partial_parse': True, 'static_parser': True, 'profiles_dir': '/Users/bruno/.dbt', 'send_anonymous_usage_stats': True, 'event_buffer_size': 100000, 'quiet': False, 'no_print': False, 'cache_selected_only': False, 'select': ['customers.py'], 'which': 'run', 'rpc_method': 'run', 'indirect_selection': 'eager'}
[0m03:04:34.283845 [debug] [MainThread]: Tracking: tracking
[0m03:04:34.284174 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10e86ebe0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10e86ec40>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10e86eca0>]}
[0m03:04:34.338106 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 1 files changed.
[0m03:04:34.338587 [debug] [MainThread]: Partial parsing: updated file: jaffle_shop://models/customers.py
[0m03:04:34.395818 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '528cfbc4-1573-451e-b078-b2f46a9e26ac', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10f001f40>]}
[0m03:04:34.402453 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '528cfbc4-1573-451e-b078-b2f46a9e26ac', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10e998490>]}
[0m03:04:34.402708 [info ] [MainThread]: Found 5 models, 10 tests, 0 snapshots, 0 analyses, 303 macros, 0 operations, 3 seed files, 0 sources, 0 exposures, 0 metrics
[0m03:04:34.402902 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '528cfbc4-1573-451e-b078-b2f46a9e26ac', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10edc6100>]}
[0m03:04:34.404055 [info ] [MainThread]: 
[0m03:04:34.404532 [debug] [MainThread]: Acquiring new snowflake connection "master"
[0m03:04:34.405290 [debug] [ThreadPool]: Acquiring new snowflake connection "list_jaffle_shop"
[0m03:04:34.417111 [debug] [ThreadPool]: Using snowflake connection "list_jaffle_shop"
[0m03:04:34.417421 [debug] [ThreadPool]: On list_jaffle_shop: /* {"app": "dbt", "dbt_version": "1.3.2", "profile_name": "jaffle_shop", "target_name": "dev", "connection_name": "list_jaffle_shop"} */
show terse schemas in database jaffle_shop
    limit 10000
[0m03:04:34.417525 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m03:04:35.631884 [debug] [ThreadPool]: SQL status: SUCCESS 3 in 1.21 seconds
[0m03:04:35.634597 [debug] [ThreadPool]: On list_jaffle_shop: Close
[0m03:04:35.976356 [debug] [ThreadPool]: Acquiring new snowflake connection "list_jaffle_shop_bruno"
[0m03:04:35.991627 [debug] [ThreadPool]: Using snowflake connection "list_jaffle_shop_bruno"
[0m03:04:35.992011 [debug] [ThreadPool]: On list_jaffle_shop_bruno: /* {"app": "dbt", "dbt_version": "1.3.2", "profile_name": "jaffle_shop", "target_name": "dev", "connection_name": "list_jaffle_shop_bruno"} */
show terse objects in jaffle_shop.bruno
[0m03:04:35.992233 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m03:04:36.604734 [debug] [ThreadPool]: SQL status: SUCCESS 6 in 0.61 seconds
[0m03:04:36.608614 [debug] [ThreadPool]: On list_jaffle_shop_bruno: Close
[0m03:04:36.958642 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '528cfbc4-1573-451e-b078-b2f46a9e26ac', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10e8864f0>]}
[0m03:04:36.960648 [info ] [MainThread]: Concurrency: 1 threads (target='dev')
[0m03:04:36.961627 [info ] [MainThread]: 
[0m03:04:36.969641 [debug] [Thread-1  ]: Began running node model.jaffle_shop.customers
[0m03:04:36.970408 [info ] [Thread-1  ]: 1 of 1 START python table model bruno.customers ................................ [RUN]
[0m03:04:36.971848 [debug] [Thread-1  ]: Acquiring new snowflake connection "model.jaffle_shop.customers"
[0m03:04:36.972004 [debug] [Thread-1  ]: Began compiling node model.jaffle_shop.customers
[0m03:04:36.972512 [debug] [Thread-1  ]: Compiling model.jaffle_shop.customers
[0m03:04:37.001708 [debug] [Thread-1  ]: Writing injected SQL for node "model.jaffle_shop.customers"
[0m03:04:37.002893 [debug] [Thread-1  ]: finished collecting timing info
[0m03:04:37.003139 [debug] [Thread-1  ]: Began executing node model.jaffle_shop.customers
[0m03:04:37.037690 [debug] [Thread-1  ]: Writing runtime python for node "model.jaffle_shop.customers"
[0m03:04:37.039977 [debug] [Thread-1  ]: Using snowflake connection "model.jaffle_shop.customers"
[0m03:04:37.040108 [debug] [Thread-1  ]: On model.jaffle_shop.customers: /* {"app": "dbt", "dbt_version": "1.3.2", "profile_name": "jaffle_shop", "target_name": "dev", "node_id": "model.jaffle_shop.customers"} */
CREATE OR REPLACE PROCEDURE jaffle_shop.bruno.customers__dbt_sp ()

RETURNS STRING
LANGUAGE PYTHON
RUNTIME_VERSION = '3.8'
PACKAGES = ('snowflake-snowpark-python')

HANDLER = 'main'
EXECUTE AS CALLER
AS
$$

  
    
import snowflake.snowpark.functions as F

def model(dbt, session):

    stg_customers = dbt.ref('stg_customers')
    stg_orders = dbt.ref('stg_orders')
    stg_payments = dbt.ref('stg_payments')

    customer_orders = (
        stg_orders
        .group_by("customer_id")
        .agg(
            min(col("order_date")).name('first_order'),
            max(col("order_date")).name('most_recent_order'),
            count(col("order_id")).name('number_of_orders')
        )
    )

    customer_payments = (
        stg_payments
        .join(orders, payments["order_id"] == orders["order_id"], "left")
        .group_by("orders.customer_id")
        .agg(
            total_amount = F.sum("amount")
        )
    )

    final_df = (
        stg_customers
        .join(customer_orders, customers["customer_id"] == customer_orders["customer_id"], "left")
        .join(customer_payments, customers["customer_id"] == customer_payments["customer_id"], "left")
        .select("customers.customer_id",
                "customers.first_name",
                "customers.last_name",
                "customer_orders.first_order",
                "customer_orders.most_recent_order",
                "customer_orders.number_of_orders",
                F.col("customer_payments.total_amount").alias("customer_lifetime_value")
        )
    )

    return final_df


# This part is user provided model code
# you will need to copy the next section to run the code
# COMMAND ----------
# this part is dbt logic for get ref work, do not modify

def ref(*args,dbt_load_df_function):
    refs = {"stg_customers": "jaffle_shop.bruno.stg_customers", "stg_orders": "jaffle_shop.bruno.stg_orders", "stg_payments": "jaffle_shop.bruno.stg_payments"}
    key = ".".join(args)
    return dbt_load_df_function(refs[key])


def source(*args, dbt_load_df_function):
    sources = {}
    key = ".".join(args)
    return dbt_load_df_function(sources[key])


config_dict = {}


class config:
    def __init__(self, *args, **kwargs):
        pass

    @staticmethod
    def get(key, default=None):
        return config_dict.get(key, default)

class this:
    """dbt.this() or dbt.this.identifier"""
    database = 'jaffle_shop'
    schema = 'bruno'
    identifier = 'customers'
    def __repr__(self):
        return 'jaffle_shop.bruno.customers'


class dbtObj:
    def __init__(self, load_df_function) -> None:
        self.source = lambda *args: source(*args, dbt_load_df_function=load_df_function)
        self.ref = lambda *args: ref(*args, dbt_load_df_function=load_df_function)
        self.config = config
        self.this = this()
        self.is_incremental = False

# COMMAND ----------

# To run this in snowsight, you need to select entry point to be main
# And you may have to modify the return type to text to get the result back
# def main(session):
#     dbt = dbtObj(session.table)
#     df = model(dbt, session)
#     return df.collect()

# to run this in local notebook, you need to create a session following examples https://github.com/Snowflake-Labs/sfguide-getting-started-snowpark-python
# then you can do the following to run model
# dbt = dbtObj(session.table)
# df = model(dbt, session)


def materialize(session, df, target_relation):
    # make sure pandas exists
    import importlib.util
    package_name = 'pandas'
    if importlib.util.find_spec(package_name):
        import pandas
        if isinstance(df, pandas.core.frame.DataFrame):
          # session.write_pandas does not have overwrite function
          df = session.createDataFrame(df)
    df.write.mode("overwrite").save_as_table("jaffle_shop.bruno.customers", create_temp_table=False)

def main(session):
    dbt = dbtObj(session.table)
    df = model(dbt, session)
    materialize(session, df, dbt.this)
    return "OK"

  
$$;
[0m03:04:37.040212 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m03:04:42.492223 [debug] [Thread-1  ]: SQL status: SUCCESS 1 in 5.45 seconds
[0m03:04:42.492604 [debug] [Thread-1  ]: Using snowflake connection "model.jaffle_shop.customers"
[0m03:04:42.492778 [debug] [Thread-1  ]: On model.jaffle_shop.customers: /* {"app": "dbt", "dbt_version": "1.3.2", "profile_name": "jaffle_shop", "target_name": "dev", "node_id": "model.jaffle_shop.customers"} */
CALL jaffle_shop.bruno.customers__dbt_sp();
[0m03:04:43.483525 [debug] [Thread-1  ]: Snowflake adapter: Snowflake query id: 01a9dad8-0000-0c56-0000-0000468d3729
[0m03:04:43.483745 [debug] [Thread-1  ]: Snowflake adapter: Snowflake error: 100357 (P0000): Python Interpreter Error:
Traceback (most recent call last):
  File "_udf_code.py", line 122, in main
  File "_udf_code.py", line 17, in model
NameError: name 'col' is not defined
 in function CUSTOMERS__DBT_SP with handler main
[0m03:04:43.484045 [debug] [Thread-1  ]: finished collecting timing info
[0m03:04:43.484206 [debug] [Thread-1  ]: On model.jaffle_shop.customers: Close
[0m03:04:43.950361 [debug] [Thread-1  ]: Database Error in model customers (models/customers.py)
  100357 (P0000): Python Interpreter Error:
  Traceback (most recent call last):
    File "_udf_code.py", line 122, in main
    File "_udf_code.py", line 17, in model
  NameError: name 'col' is not defined
   in function CUSTOMERS__DBT_SP with handler main
  compiled Code at target/run/jaffle_shop/models/customers.py
[0m03:04:43.951265 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '528cfbc4-1573-451e-b078-b2f46a9e26ac', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x110054460>]}
[0m03:04:43.952061 [error] [Thread-1  ]: 1 of 1 ERROR creating python table model bruno.customers ....................... [[31mERROR[0m in 6.98s]
[0m03:04:43.953127 [debug] [Thread-1  ]: Finished running node model.jaffle_shop.customers
[0m03:04:43.956667 [debug] [MainThread]: Acquiring new snowflake connection "master"
[0m03:04:43.957802 [info ] [MainThread]: 
[0m03:04:43.958357 [info ] [MainThread]: Finished running 1 table model in 0 hours 0 minutes and 9.55 seconds (9.55s).
[0m03:04:43.958824 [debug] [MainThread]: Connection 'master' was properly closed.
[0m03:04:43.959068 [debug] [MainThread]: Connection 'model.jaffle_shop.customers' was properly closed.
[0m03:04:43.974217 [info ] [MainThread]: 
[0m03:04:43.974711 [info ] [MainThread]: [31mCompleted with 1 error and 0 warnings:[0m
[0m03:04:43.975099 [info ] [MainThread]: 
[0m03:04:43.975414 [error] [MainThread]: [33mDatabase Error in model customers (models/customers.py)[0m
[0m03:04:43.975720 [error] [MainThread]:   100357 (P0000): Python Interpreter Error:
[0m03:04:43.976006 [error] [MainThread]:   Traceback (most recent call last):
[0m03:04:43.976292 [error] [MainThread]:     File "_udf_code.py", line 122, in main
[0m03:04:43.976682 [error] [MainThread]:     File "_udf_code.py", line 17, in model
[0m03:04:43.977042 [error] [MainThread]:   NameError: name 'col' is not defined
[0m03:04:43.977347 [error] [MainThread]:    in function CUSTOMERS__DBT_SP with handler main
[0m03:04:43.977639 [error] [MainThread]:   compiled Code at target/run/jaffle_shop/models/customers.py
[0m03:04:43.977968 [info ] [MainThread]: 
[0m03:04:43.978288 [info ] [MainThread]: Done. PASS=0 WARN=0 ERROR=1 SKIP=0 TOTAL=1
[0m03:04:43.978752 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10edc60a0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10e858820>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x110054700>]}
[0m03:04:43.979105 [debug] [MainThread]: Flushing usage events


============================== 2023-01-24 03:06:16.365112 | bd26bc3b-cdcf-4ec6-a7d8-709856e4dd52 ==============================
[0m03:06:16.365183 [info ] [MainThread]: Running with dbt=1.3.2
[0m03:06:16.366076 [debug] [MainThread]: running dbt with arguments {'write_json': True, 'use_colors': True, 'printer_width': 80, 'version_check': True, 'partial_parse': True, 'static_parser': True, 'profiles_dir': '/Users/bruno/.dbt', 'send_anonymous_usage_stats': True, 'event_buffer_size': 100000, 'quiet': False, 'no_print': False, 'cache_selected_only': False, 'select': ['customers.py'], 'which': 'run', 'rpc_method': 'run', 'indirect_selection': 'eager'}
[0m03:06:16.366217 [debug] [MainThread]: Tracking: tracking
[0m03:06:16.366564 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x110939b80>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x110939be0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x110939c40>]}
[0m03:06:16.419805 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 1 files changed.
[0m03:06:16.420210 [debug] [MainThread]: Partial parsing: updated file: jaffle_shop://models/customers.py
[0m03:06:16.474868 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': 'bd26bc3b-cdcf-4ec6-a7d8-709856e4dd52', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x110ebc970>]}
[0m03:06:16.481218 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': 'bd26bc3b-cdcf-4ec6-a7d8-709856e4dd52', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x110a5e400>]}
[0m03:06:16.481419 [info ] [MainThread]: Found 5 models, 10 tests, 0 snapshots, 0 analyses, 303 macros, 0 operations, 3 seed files, 0 sources, 0 exposures, 0 metrics
[0m03:06:16.481609 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'bd26bc3b-cdcf-4ec6-a7d8-709856e4dd52', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x110e8b0a0>]}
[0m03:06:16.482699 [info ] [MainThread]: 
[0m03:06:16.483163 [debug] [MainThread]: Acquiring new snowflake connection "master"
[0m03:06:16.483865 [debug] [ThreadPool]: Acquiring new snowflake connection "list_jaffle_shop"
[0m03:06:16.494667 [debug] [ThreadPool]: Using snowflake connection "list_jaffle_shop"
[0m03:06:16.494794 [debug] [ThreadPool]: On list_jaffle_shop: /* {"app": "dbt", "dbt_version": "1.3.2", "profile_name": "jaffle_shop", "target_name": "dev", "connection_name": "list_jaffle_shop"} */
show terse schemas in database jaffle_shop
    limit 10000
[0m03:06:16.494890 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m03:06:17.482125 [debug] [ThreadPool]: SQL status: SUCCESS 3 in 0.99 seconds
[0m03:06:17.487476 [debug] [ThreadPool]: On list_jaffle_shop: Close
[0m03:06:17.824313 [debug] [ThreadPool]: Acquiring new snowflake connection "list_jaffle_shop_bruno"
[0m03:06:17.838924 [debug] [ThreadPool]: Using snowflake connection "list_jaffle_shop_bruno"
[0m03:06:17.839224 [debug] [ThreadPool]: On list_jaffle_shop_bruno: /* {"app": "dbt", "dbt_version": "1.3.2", "profile_name": "jaffle_shop", "target_name": "dev", "connection_name": "list_jaffle_shop_bruno"} */
show terse objects in jaffle_shop.bruno
[0m03:06:17.839446 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m03:06:18.512317 [debug] [ThreadPool]: SQL status: SUCCESS 6 in 0.67 seconds
[0m03:06:18.517985 [debug] [ThreadPool]: On list_jaffle_shop_bruno: Close
[0m03:06:18.932420 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'bd26bc3b-cdcf-4ec6-a7d8-709856e4dd52', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x11091f820>]}
[0m03:06:18.933801 [info ] [MainThread]: Concurrency: 1 threads (target='dev')
[0m03:06:18.934355 [info ] [MainThread]: 
[0m03:06:18.941319 [debug] [Thread-1  ]: Began running node model.jaffle_shop.customers
[0m03:06:18.942013 [info ] [Thread-1  ]: 1 of 1 START python table model bruno.customers ................................ [RUN]
[0m03:06:18.943210 [debug] [Thread-1  ]: Acquiring new snowflake connection "model.jaffle_shop.customers"
[0m03:06:18.943475 [debug] [Thread-1  ]: Began compiling node model.jaffle_shop.customers
[0m03:06:18.944310 [debug] [Thread-1  ]: Compiling model.jaffle_shop.customers
[0m03:06:18.974694 [debug] [Thread-1  ]: Writing injected SQL for node "model.jaffle_shop.customers"
[0m03:06:18.975841 [debug] [Thread-1  ]: finished collecting timing info
[0m03:06:18.976060 [debug] [Thread-1  ]: Began executing node model.jaffle_shop.customers
[0m03:06:19.009443 [debug] [Thread-1  ]: Writing runtime python for node "model.jaffle_shop.customers"
[0m03:06:19.011616 [debug] [Thread-1  ]: Using snowflake connection "model.jaffle_shop.customers"
[0m03:06:19.011736 [debug] [Thread-1  ]: On model.jaffle_shop.customers: /* {"app": "dbt", "dbt_version": "1.3.2", "profile_name": "jaffle_shop", "target_name": "dev", "node_id": "model.jaffle_shop.customers"} */
CREATE OR REPLACE PROCEDURE jaffle_shop.bruno.customers__dbt_sp ()

RETURNS STRING
LANGUAGE PYTHON
RUNTIME_VERSION = '3.8'
PACKAGES = ('snowflake-snowpark-python')

HANDLER = 'main'
EXECUTE AS CALLER
AS
$$

  
    
import snowflake.snowpark.functions as F

def model(dbt, session):

    stg_customers = dbt.ref('stg_customers')
    stg_orders = dbt.ref('stg_orders')
    stg_payments = dbt.ref('stg_payments')

    customer_orders = (
        stg_orders
        .group_by("customer_id")
        .agg(
            F.min(F.col("order_date")).name('first_order'),
            F.max(F.col("order_date")).name('most_recent_order'),
            F.count(F.col("order_id")).name('number_of_orders')
        )
    )

    customer_payments = (
        stg_payments
        .join(orders, payments["order_id"] == orders["order_id"], "left")
        .group_by("orders.customer_id")
        .agg(
            total_amount = F.sum("amount")
        )
    )

    final_df = (
        stg_customers
        .join(customer_orders, customers["customer_id"] == customer_orders["customer_id"], "left")
        .join(customer_payments, customers["customer_id"] == customer_payments["customer_id"], "left")
        .select("customers.customer_id",
                "customers.first_name",
                "customers.last_name",
                "customer_orders.first_order",
                "customer_orders.most_recent_order",
                "customer_orders.number_of_orders",
                F.col("customer_payments.total_amount").alias("customer_lifetime_value")
        )
    )

    return final_df


# This part is user provided model code
# you will need to copy the next section to run the code
# COMMAND ----------
# this part is dbt logic for get ref work, do not modify

def ref(*args,dbt_load_df_function):
    refs = {"stg_customers": "jaffle_shop.bruno.stg_customers", "stg_orders": "jaffle_shop.bruno.stg_orders", "stg_payments": "jaffle_shop.bruno.stg_payments"}
    key = ".".join(args)
    return dbt_load_df_function(refs[key])


def source(*args, dbt_load_df_function):
    sources = {}
    key = ".".join(args)
    return dbt_load_df_function(sources[key])


config_dict = {}


class config:
    def __init__(self, *args, **kwargs):
        pass

    @staticmethod
    def get(key, default=None):
        return config_dict.get(key, default)

class this:
    """dbt.this() or dbt.this.identifier"""
    database = 'jaffle_shop'
    schema = 'bruno'
    identifier = 'customers'
    def __repr__(self):
        return 'jaffle_shop.bruno.customers'


class dbtObj:
    def __init__(self, load_df_function) -> None:
        self.source = lambda *args: source(*args, dbt_load_df_function=load_df_function)
        self.ref = lambda *args: ref(*args, dbt_load_df_function=load_df_function)
        self.config = config
        self.this = this()
        self.is_incremental = False

# COMMAND ----------

# To run this in snowsight, you need to select entry point to be main
# And you may have to modify the return type to text to get the result back
# def main(session):
#     dbt = dbtObj(session.table)
#     df = model(dbt, session)
#     return df.collect()

# to run this in local notebook, you need to create a session following examples https://github.com/Snowflake-Labs/sfguide-getting-started-snowpark-python
# then you can do the following to run model
# dbt = dbtObj(session.table)
# df = model(dbt, session)


def materialize(session, df, target_relation):
    # make sure pandas exists
    import importlib.util
    package_name = 'pandas'
    if importlib.util.find_spec(package_name):
        import pandas
        if isinstance(df, pandas.core.frame.DataFrame):
          # session.write_pandas does not have overwrite function
          df = session.createDataFrame(df)
    df.write.mode("overwrite").save_as_table("jaffle_shop.bruno.customers", create_temp_table=False)

def main(session):
    dbt = dbtObj(session.table)
    df = model(dbt, session)
    materialize(session, df, dbt.this)
    return "OK"

  
$$;
[0m03:06:19.011839 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m03:06:24.451406 [debug] [Thread-1  ]: SQL status: SUCCESS 1 in 5.44 seconds
[0m03:06:24.452283 [debug] [Thread-1  ]: Using snowflake connection "model.jaffle_shop.customers"
[0m03:06:24.452621 [debug] [Thread-1  ]: On model.jaffle_shop.customers: /* {"app": "dbt", "dbt_version": "1.3.2", "profile_name": "jaffle_shop", "target_name": "dev", "node_id": "model.jaffle_shop.customers"} */
CALL jaffle_shop.bruno.customers__dbt_sp();
[0m03:06:25.541844 [debug] [Thread-1  ]: Snowflake adapter: Snowflake query id: 01a9dada-0000-0c55-0000-0000468d273d
[0m03:06:25.542068 [debug] [Thread-1  ]: Snowflake adapter: Snowflake error: 100357 (P0000): Python Interpreter Error:
Traceback (most recent call last):
  File "_udf_code.py", line 122, in main
  File "_udf_code.py", line 25, in model
NameError: name 'orders' is not defined
 in function CUSTOMERS__DBT_SP with handler main
[0m03:06:25.542379 [debug] [Thread-1  ]: finished collecting timing info
[0m03:06:25.542535 [debug] [Thread-1  ]: On model.jaffle_shop.customers: Close
[0m03:06:26.099725 [debug] [Thread-1  ]: Database Error in model customers (models/customers.py)
  100357 (P0000): Python Interpreter Error:
  Traceback (most recent call last):
    File "_udf_code.py", line 122, in main
    File "_udf_code.py", line 25, in model
  NameError: name 'orders' is not defined
   in function CUSTOMERS__DBT_SP with handler main
  compiled Code at target/run/jaffle_shop/models/customers.py
[0m03:06:26.100534 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'bd26bc3b-cdcf-4ec6-a7d8-709856e4dd52', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x112112e20>]}
[0m03:06:26.101262 [error] [Thread-1  ]: 1 of 1 ERROR creating python table model bruno.customers ....................... [[31mERROR[0m in 7.16s]
[0m03:06:26.102273 [debug] [Thread-1  ]: Finished running node model.jaffle_shop.customers
[0m03:06:26.105517 [debug] [MainThread]: Acquiring new snowflake connection "master"
[0m03:06:26.106572 [info ] [MainThread]: 
[0m03:06:26.107096 [info ] [MainThread]: Finished running 1 table model in 0 hours 0 minutes and 9.62 seconds (9.62s).
[0m03:06:26.107582 [debug] [MainThread]: Connection 'master' was properly closed.
[0m03:06:26.107827 [debug] [MainThread]: Connection 'model.jaffle_shop.customers' was properly closed.
[0m03:06:26.123227 [info ] [MainThread]: 
[0m03:06:26.123686 [info ] [MainThread]: [31mCompleted with 1 error and 0 warnings:[0m
[0m03:06:26.124085 [info ] [MainThread]: 
[0m03:06:26.124411 [error] [MainThread]: [33mDatabase Error in model customers (models/customers.py)[0m
[0m03:06:26.124728 [error] [MainThread]:   100357 (P0000): Python Interpreter Error:
[0m03:06:26.125017 [error] [MainThread]:   Traceback (most recent call last):
[0m03:06:26.125302 [error] [MainThread]:     File "_udf_code.py", line 122, in main
[0m03:06:26.125596 [error] [MainThread]:     File "_udf_code.py", line 25, in model
[0m03:06:26.125876 [error] [MainThread]:   NameError: name 'orders' is not defined
[0m03:06:26.126160 [error] [MainThread]:    in function CUSTOMERS__DBT_SP with handler main
[0m03:06:26.126444 [error] [MainThread]:   compiled Code at target/run/jaffle_shop/models/customers.py
[0m03:06:26.126758 [info ] [MainThread]: 
[0m03:06:26.127071 [info ] [MainThread]: Done. PASS=0 WARN=0 ERROR=1 SKIP=0 TOTAL=1
[0m03:06:26.127534 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x110a5e2e0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x110f67520>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x112112d00>]}
[0m03:06:26.127904 [debug] [MainThread]: Flushing usage events


============================== 2023-01-24 03:06:54.781925 | 7e9596d2-9a22-489f-9b89-f88179733fc6 ==============================
[0m03:06:54.781990 [info ] [MainThread]: Running with dbt=1.3.2
[0m03:06:54.782854 [debug] [MainThread]: running dbt with arguments {'write_json': True, 'use_colors': True, 'printer_width': 80, 'version_check': True, 'partial_parse': True, 'static_parser': True, 'profiles_dir': '/Users/bruno/.dbt', 'send_anonymous_usage_stats': True, 'event_buffer_size': 100000, 'quiet': False, 'no_print': False, 'cache_selected_only': False, 'select': ['customers.py'], 'which': 'run', 'rpc_method': 'run', 'indirect_selection': 'eager'}
[0m03:06:54.782980 [debug] [MainThread]: Tracking: tracking
[0m03:06:54.783357 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10e723b50>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10e723bb0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10e723c10>]}
[0m03:06:54.834032 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 1 files changed.
[0m03:06:54.834486 [debug] [MainThread]: Partial parsing: updated file: jaffle_shop://models/customers.py
[0m03:06:54.890097 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '7e9596d2-9a22-489f-9b89-f88179733fc6', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10ed32fa0>]}
[0m03:06:54.896763 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '7e9596d2-9a22-489f-9b89-f88179733fc6', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10e849400>]}
[0m03:06:54.896974 [info ] [MainThread]: Found 5 models, 10 tests, 0 snapshots, 0 analyses, 303 macros, 0 operations, 3 seed files, 0 sources, 0 exposures, 0 metrics
[0m03:06:54.897162 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '7e9596d2-9a22-489f-9b89-f88179733fc6', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10ec73fd0>]}
[0m03:06:54.898393 [info ] [MainThread]: 
[0m03:06:54.898897 [debug] [MainThread]: Acquiring new snowflake connection "master"
[0m03:06:54.899666 [debug] [ThreadPool]: Acquiring new snowflake connection "list_jaffle_shop"
[0m03:06:54.911548 [debug] [ThreadPool]: Using snowflake connection "list_jaffle_shop"
[0m03:06:54.911735 [debug] [ThreadPool]: On list_jaffle_shop: /* {"app": "dbt", "dbt_version": "1.3.2", "profile_name": "jaffle_shop", "target_name": "dev", "connection_name": "list_jaffle_shop"} */
show terse schemas in database jaffle_shop
    limit 10000
[0m03:06:54.911832 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m03:06:55.995765 [debug] [ThreadPool]: SQL status: SUCCESS 3 in 1.08 seconds
[0m03:06:55.998891 [debug] [ThreadPool]: On list_jaffle_shop: Close
[0m03:06:56.329466 [debug] [ThreadPool]: Acquiring new snowflake connection "list_jaffle_shop_bruno"
[0m03:06:56.341698 [debug] [ThreadPool]: Using snowflake connection "list_jaffle_shop_bruno"
[0m03:06:56.342078 [debug] [ThreadPool]: On list_jaffle_shop_bruno: /* {"app": "dbt", "dbt_version": "1.3.2", "profile_name": "jaffle_shop", "target_name": "dev", "connection_name": "list_jaffle_shop_bruno"} */
show terse objects in jaffle_shop.bruno
[0m03:06:56.342271 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m03:06:57.327559 [debug] [ThreadPool]: SQL status: SUCCESS 6 in 0.99 seconds
[0m03:06:57.332138 [debug] [ThreadPool]: On list_jaffle_shop_bruno: Close
[0m03:06:57.655618 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '7e9596d2-9a22-489f-9b89-f88179733fc6', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10e849910>]}
[0m03:06:57.656610 [info ] [MainThread]: Concurrency: 1 threads (target='dev')
[0m03:06:57.657000 [info ] [MainThread]: 
[0m03:06:57.661631 [debug] [Thread-1  ]: Began running node model.jaffle_shop.customers
[0m03:06:57.662000 [info ] [Thread-1  ]: 1 of 1 START python table model bruno.customers ................................ [RUN]
[0m03:06:57.662765 [debug] [Thread-1  ]: Acquiring new snowflake connection "model.jaffle_shop.customers"
[0m03:06:57.662942 [debug] [Thread-1  ]: Began compiling node model.jaffle_shop.customers
[0m03:06:57.663534 [debug] [Thread-1  ]: Compiling model.jaffle_shop.customers
[0m03:06:57.686808 [debug] [Thread-1  ]: Writing injected SQL for node "model.jaffle_shop.customers"
[0m03:06:57.687925 [debug] [Thread-1  ]: finished collecting timing info
[0m03:06:57.688115 [debug] [Thread-1  ]: Began executing node model.jaffle_shop.customers
[0m03:06:57.717445 [debug] [Thread-1  ]: Writing runtime python for node "model.jaffle_shop.customers"
[0m03:06:57.719605 [debug] [Thread-1  ]: Using snowflake connection "model.jaffle_shop.customers"
[0m03:06:57.719747 [debug] [Thread-1  ]: On model.jaffle_shop.customers: /* {"app": "dbt", "dbt_version": "1.3.2", "profile_name": "jaffle_shop", "target_name": "dev", "node_id": "model.jaffle_shop.customers"} */
CREATE OR REPLACE PROCEDURE jaffle_shop.bruno.customers__dbt_sp ()

RETURNS STRING
LANGUAGE PYTHON
RUNTIME_VERSION = '3.8'
PACKAGES = ('snowflake-snowpark-python')

HANDLER = 'main'
EXECUTE AS CALLER
AS
$$

  
    
import snowflake.snowpark.functions as F

def model(dbt, session):

    stg_customers = dbt.ref('stg_customers')
    stg_orders = dbt.ref('stg_orders')
    stg_payments = dbt.ref('stg_payments')

    customer_orders = (
        stg_orders
        .group_by("customer_id")
        .agg(
            F.min(F.col("order_date")).name('first_order'),
            F.max(F.col("order_date")).name('most_recent_order'),
            F.count(F.col("order_id")).name('number_of_orders')
        )
    )

    customer_payments = (
        stg_payments
        .join(stg_orders, stg_payments["order_id"] == orders["order_id"], "left")
        .group_by("orders.customer_id")
        .agg(
            total_amount = F.sum("amount")
        )
    )

    final_df = (
        stg_customers
        .join(customer_orders, customers["customer_id"] == customer_orders["customer_id"], "left")
        .join(customer_payments, customers["customer_id"] == customer_payments["customer_id"], "left")
        .select("customers.customer_id",
                "customers.first_name",
                "customers.last_name",
                "customer_orders.first_order",
                "customer_orders.most_recent_order",
                "customer_orders.number_of_orders",
                F.col("customer_payments.total_amount").alias("customer_lifetime_value")
        )
    )

    return final_df


# This part is user provided model code
# you will need to copy the next section to run the code
# COMMAND ----------
# this part is dbt logic for get ref work, do not modify

def ref(*args,dbt_load_df_function):
    refs = {"stg_customers": "jaffle_shop.bruno.stg_customers", "stg_orders": "jaffle_shop.bruno.stg_orders", "stg_payments": "jaffle_shop.bruno.stg_payments"}
    key = ".".join(args)
    return dbt_load_df_function(refs[key])


def source(*args, dbt_load_df_function):
    sources = {}
    key = ".".join(args)
    return dbt_load_df_function(sources[key])


config_dict = {}


class config:
    def __init__(self, *args, **kwargs):
        pass

    @staticmethod
    def get(key, default=None):
        return config_dict.get(key, default)

class this:
    """dbt.this() or dbt.this.identifier"""
    database = 'jaffle_shop'
    schema = 'bruno'
    identifier = 'customers'
    def __repr__(self):
        return 'jaffle_shop.bruno.customers'


class dbtObj:
    def __init__(self, load_df_function) -> None:
        self.source = lambda *args: source(*args, dbt_load_df_function=load_df_function)
        self.ref = lambda *args: ref(*args, dbt_load_df_function=load_df_function)
        self.config = config
        self.this = this()
        self.is_incremental = False

# COMMAND ----------

# To run this in snowsight, you need to select entry point to be main
# And you may have to modify the return type to text to get the result back
# def main(session):
#     dbt = dbtObj(session.table)
#     df = model(dbt, session)
#     return df.collect()

# to run this in local notebook, you need to create a session following examples https://github.com/Snowflake-Labs/sfguide-getting-started-snowpark-python
# then you can do the following to run model
# dbt = dbtObj(session.table)
# df = model(dbt, session)


def materialize(session, df, target_relation):
    # make sure pandas exists
    import importlib.util
    package_name = 'pandas'
    if importlib.util.find_spec(package_name):
        import pandas
        if isinstance(df, pandas.core.frame.DataFrame):
          # session.write_pandas does not have overwrite function
          df = session.createDataFrame(df)
    df.write.mode("overwrite").save_as_table("jaffle_shop.bruno.customers", create_temp_table=False)

def main(session):
    dbt = dbtObj(session.table)
    df = model(dbt, session)
    materialize(session, df, dbt.this)
    return "OK"

  
$$;
[0m03:06:57.719850 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m03:07:03.261547 [debug] [Thread-1  ]: SQL status: SUCCESS 1 in 5.54 seconds
[0m03:07:03.262572 [debug] [Thread-1  ]: Using snowflake connection "model.jaffle_shop.customers"
[0m03:07:03.262713 [debug] [Thread-1  ]: On model.jaffle_shop.customers: /* {"app": "dbt", "dbt_version": "1.3.2", "profile_name": "jaffle_shop", "target_name": "dev", "node_id": "model.jaffle_shop.customers"} */
CALL jaffle_shop.bruno.customers__dbt_sp();
[0m03:07:04.246234 [debug] [Thread-1  ]: Snowflake adapter: Snowflake query id: 01a9dadb-0000-0c55-0000-0000468d274d
[0m03:07:04.246442 [debug] [Thread-1  ]: Snowflake adapter: Snowflake error: 100357 (P0000): Python Interpreter Error:
Traceback (most recent call last):
  File "_udf_code.py", line 122, in main
  File "_udf_code.py", line 25, in model
NameError: name 'orders' is not defined
 in function CUSTOMERS__DBT_SP with handler main
[0m03:07:04.246718 [debug] [Thread-1  ]: finished collecting timing info
[0m03:07:04.246862 [debug] [Thread-1  ]: On model.jaffle_shop.customers: Close
[0m03:07:04.602012 [debug] [Thread-1  ]: Database Error in model customers (models/customers.py)
  100357 (P0000): Python Interpreter Error:
  Traceback (most recent call last):
    File "_udf_code.py", line 122, in main
    File "_udf_code.py", line 25, in model
  NameError: name 'orders' is not defined
   in function CUSTOMERS__DBT_SP with handler main
  compiled Code at target/run/jaffle_shop/models/customers.py
[0m03:07:04.602787 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '7e9596d2-9a22-489f-9b89-f88179733fc6', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10fefcf70>]}
[0m03:07:04.603482 [error] [Thread-1  ]: 1 of 1 ERROR creating python table model bruno.customers ....................... [[31mERROR[0m in 6.94s]
[0m03:07:04.604417 [debug] [Thread-1  ]: Finished running node model.jaffle_shop.customers
[0m03:07:04.607282 [debug] [MainThread]: Acquiring new snowflake connection "master"
[0m03:07:04.608267 [info ] [MainThread]: 
[0m03:07:04.608783 [info ] [MainThread]: Finished running 1 table model in 0 hours 0 minutes and 9.71 seconds (9.71s).
[0m03:07:04.609246 [debug] [MainThread]: Connection 'master' was properly closed.
[0m03:07:04.609485 [debug] [MainThread]: Connection 'model.jaffle_shop.customers' was properly closed.
[0m03:07:04.624556 [info ] [MainThread]: 
[0m03:07:04.625014 [info ] [MainThread]: [31mCompleted with 1 error and 0 warnings:[0m
[0m03:07:04.625404 [info ] [MainThread]: 
[0m03:07:04.625711 [error] [MainThread]: [33mDatabase Error in model customers (models/customers.py)[0m
[0m03:07:04.626015 [error] [MainThread]:   100357 (P0000): Python Interpreter Error:
[0m03:07:04.626302 [error] [MainThread]:   Traceback (most recent call last):
[0m03:07:04.626581 [error] [MainThread]:     File "_udf_code.py", line 122, in main
[0m03:07:04.626860 [error] [MainThread]:     File "_udf_code.py", line 25, in model
[0m03:07:04.627138 [error] [MainThread]:   NameError: name 'orders' is not defined
[0m03:07:04.627413 [error] [MainThread]:    in function CUSTOMERS__DBT_SP with handler main
[0m03:07:04.627686 [error] [MainThread]:   compiled Code at target/run/jaffle_shop/models/customers.py
[0m03:07:04.627974 [info ] [MainThread]: 
[0m03:07:04.628266 [info ] [MainThread]: Done. PASS=0 WARN=0 ERROR=1 SKIP=0 TOTAL=1
[0m03:07:04.628678 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10ecdc940>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10e5a3160>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10fefc130>]}
[0m03:07:04.629003 [debug] [MainThread]: Flushing usage events


============================== 2023-01-24 03:08:00.813541 | b714f6aa-a2b4-45c2-a087-057ee09c031d ==============================
[0m03:08:00.813603 [info ] [MainThread]: Running with dbt=1.3.2
[0m03:08:00.814377 [debug] [MainThread]: running dbt with arguments {'write_json': True, 'use_colors': True, 'printer_width': 80, 'version_check': True, 'partial_parse': True, 'static_parser': True, 'profiles_dir': '/Users/bruno/.dbt', 'send_anonymous_usage_stats': True, 'event_buffer_size': 100000, 'quiet': False, 'no_print': False, 'cache_selected_only': False, 'select': ['customers.py'], 'which': 'run', 'rpc_method': 'run', 'indirect_selection': 'eager'}
[0m03:08:00.814569 [debug] [MainThread]: Tracking: tracking
[0m03:08:00.814998 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10dbf2b20>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10dbf2b80>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10dbf2be0>]}
[0m03:08:00.867909 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 1 files changed.
[0m03:08:00.868356 [debug] [MainThread]: Partial parsing: updated file: jaffle_shop://models/customers.py
[0m03:08:00.923177 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': 'b714f6aa-a2b4-45c2-a087-057ee09c031d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10e418f70>]}
[0m03:08:00.929553 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': 'b714f6aa-a2b4-45c2-a087-057ee09c031d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10dd1c400>]}
[0m03:08:00.929762 [info ] [MainThread]: Found 5 models, 10 tests, 0 snapshots, 0 analyses, 303 macros, 0 operations, 3 seed files, 0 sources, 0 exposures, 0 metrics
[0m03:08:00.929946 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'b714f6aa-a2b4-45c2-a087-057ee09c031d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10da86850>]}
[0m03:08:00.931043 [info ] [MainThread]: 
[0m03:08:00.931522 [debug] [MainThread]: Acquiring new snowflake connection "master"
[0m03:08:00.932285 [debug] [ThreadPool]: Acquiring new snowflake connection "list_jaffle_shop"
[0m03:08:00.943966 [debug] [ThreadPool]: Using snowflake connection "list_jaffle_shop"
[0m03:08:00.944149 [debug] [ThreadPool]: On list_jaffle_shop: /* {"app": "dbt", "dbt_version": "1.3.2", "profile_name": "jaffle_shop", "target_name": "dev", "connection_name": "list_jaffle_shop"} */
show terse schemas in database jaffle_shop
    limit 10000
[0m03:08:00.944245 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m03:08:02.042195 [debug] [ThreadPool]: SQL status: SUCCESS 3 in 1.1 seconds
[0m03:08:02.047520 [debug] [ThreadPool]: On list_jaffle_shop: Close
[0m03:08:02.406461 [debug] [ThreadPool]: Acquiring new snowflake connection "list_jaffle_shop_bruno"
[0m03:08:02.420687 [debug] [ThreadPool]: Using snowflake connection "list_jaffle_shop_bruno"
[0m03:08:02.420994 [debug] [ThreadPool]: On list_jaffle_shop_bruno: /* {"app": "dbt", "dbt_version": "1.3.2", "profile_name": "jaffle_shop", "target_name": "dev", "connection_name": "list_jaffle_shop_bruno"} */
show terse objects in jaffle_shop.bruno
[0m03:08:02.421227 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m03:08:03.064846 [debug] [ThreadPool]: SQL status: SUCCESS 6 in 0.64 seconds
[0m03:08:03.068080 [debug] [ThreadPool]: On list_jaffle_shop_bruno: Close
[0m03:08:03.507152 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'b714f6aa-a2b4-45c2-a087-057ee09c031d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10e14a070>]}
[0m03:08:03.508046 [info ] [MainThread]: Concurrency: 1 threads (target='dev')
[0m03:08:03.508406 [info ] [MainThread]: 
[0m03:08:03.513159 [debug] [Thread-1  ]: Began running node model.jaffle_shop.customers
[0m03:08:03.513534 [info ] [Thread-1  ]: 1 of 1 START python table model bruno.customers ................................ [RUN]
[0m03:08:03.514301 [debug] [Thread-1  ]: Acquiring new snowflake connection "model.jaffle_shop.customers"
[0m03:08:03.514489 [debug] [Thread-1  ]: Began compiling node model.jaffle_shop.customers
[0m03:08:03.515068 [debug] [Thread-1  ]: Compiling model.jaffle_shop.customers
[0m03:08:03.537164 [debug] [Thread-1  ]: Writing injected SQL for node "model.jaffle_shop.customers"
[0m03:08:03.538133 [debug] [Thread-1  ]: finished collecting timing info
[0m03:08:03.538315 [debug] [Thread-1  ]: Began executing node model.jaffle_shop.customers
[0m03:08:03.566412 [debug] [Thread-1  ]: Writing runtime python for node "model.jaffle_shop.customers"
[0m03:08:03.568421 [debug] [Thread-1  ]: Using snowflake connection "model.jaffle_shop.customers"
[0m03:08:03.568532 [debug] [Thread-1  ]: On model.jaffle_shop.customers: /* {"app": "dbt", "dbt_version": "1.3.2", "profile_name": "jaffle_shop", "target_name": "dev", "node_id": "model.jaffle_shop.customers"} */
CREATE OR REPLACE PROCEDURE jaffle_shop.bruno.customers__dbt_sp ()

RETURNS STRING
LANGUAGE PYTHON
RUNTIME_VERSION = '3.8'
PACKAGES = ('snowflake-snowpark-python')

HANDLER = 'main'
EXECUTE AS CALLER
AS
$$

  
    
import snowflake.snowpark.functions as F

def model(dbt, session):

    stg_customers = dbt.ref('stg_customers')
    stg_orders = dbt.ref('stg_orders')
    stg_payments = dbt.ref('stg_payments')

    customer_orders = (
        stg_orders
        .group_by("customer_id")
        .agg(
            F.min(F.col("order_date")).name('first_order'),
            F.max(F.col("order_date")).name('most_recent_order'),
            F.count(F.col("order_id")).name('number_of_orders')
        )
    )

    customer_payments = (
        stg_payments
        .join(stg_orders, stg_payments["order_id"] == stg_orders["order_id"], "left")
        .group_by("stg_orders.customer_id")
        .agg(
            F.sum(F.col("amount")).name('total_amount')
        )
    )

    final_df = (
        stg_customers
        .join(customer_orders, customers["customer_id"] == customer_orders["customer_id"], "left")
        .join(customer_payments, customers["customer_id"] == customer_payments["customer_id"], "left")
        .select("customer_orders.customer_id",
                "customer_orders.first_name",
                "customer_orders.last_name",
                "customer_orders.first_order",
                "customer_orders.most_recent_order",
                "customer_orders.number_of_orders",
                F.col("customer_payments.total_amount").alias("customer_lifetime_value")
        )
    )

    return final_df


# This part is user provided model code
# you will need to copy the next section to run the code
# COMMAND ----------
# this part is dbt logic for get ref work, do not modify

def ref(*args,dbt_load_df_function):
    refs = {"stg_customers": "jaffle_shop.bruno.stg_customers", "stg_orders": "jaffle_shop.bruno.stg_orders", "stg_payments": "jaffle_shop.bruno.stg_payments"}
    key = ".".join(args)
    return dbt_load_df_function(refs[key])


def source(*args, dbt_load_df_function):
    sources = {}
    key = ".".join(args)
    return dbt_load_df_function(sources[key])


config_dict = {}


class config:
    def __init__(self, *args, **kwargs):
        pass

    @staticmethod
    def get(key, default=None):
        return config_dict.get(key, default)

class this:
    """dbt.this() or dbt.this.identifier"""
    database = 'jaffle_shop'
    schema = 'bruno'
    identifier = 'customers'
    def __repr__(self):
        return 'jaffle_shop.bruno.customers'


class dbtObj:
    def __init__(self, load_df_function) -> None:
        self.source = lambda *args: source(*args, dbt_load_df_function=load_df_function)
        self.ref = lambda *args: ref(*args, dbt_load_df_function=load_df_function)
        self.config = config
        self.this = this()
        self.is_incremental = False

# COMMAND ----------

# To run this in snowsight, you need to select entry point to be main
# And you may have to modify the return type to text to get the result back
# def main(session):
#     dbt = dbtObj(session.table)
#     df = model(dbt, session)
#     return df.collect()

# to run this in local notebook, you need to create a session following examples https://github.com/Snowflake-Labs/sfguide-getting-started-snowpark-python
# then you can do the following to run model
# dbt = dbtObj(session.table)
# df = model(dbt, session)


def materialize(session, df, target_relation):
    # make sure pandas exists
    import importlib.util
    package_name = 'pandas'
    if importlib.util.find_spec(package_name):
        import pandas
        if isinstance(df, pandas.core.frame.DataFrame):
          # session.write_pandas does not have overwrite function
          df = session.createDataFrame(df)
    df.write.mode("overwrite").save_as_table("jaffle_shop.bruno.customers", create_temp_table=False)

def main(session):
    dbt = dbtObj(session.table)
    df = model(dbt, session)
    materialize(session, df, dbt.this)
    return "OK"

  
$$;
[0m03:08:03.568628 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m03:08:09.311303 [debug] [Thread-1  ]: SQL status: SUCCESS 1 in 5.74 seconds
[0m03:08:09.312523 [debug] [Thread-1  ]: Using snowflake connection "model.jaffle_shop.customers"
[0m03:08:09.312708 [debug] [Thread-1  ]: On model.jaffle_shop.customers: /* {"app": "dbt", "dbt_version": "1.3.2", "profile_name": "jaffle_shop", "target_name": "dev", "node_id": "model.jaffle_shop.customers"} */
CALL jaffle_shop.bruno.customers__dbt_sp();
[0m03:08:10.380774 [debug] [Thread-1  ]: Snowflake adapter: Snowflake query id: 01a9dadc-0000-0c56-0000-0000468d3745
[0m03:08:10.380984 [debug] [Thread-1  ]: Snowflake adapter: Snowflake error: 100357 (P0000): Python Interpreter Error:
Traceback (most recent call last):
  File "_udf_code.py", line 122, in main
  File "_udf_code.py", line 24, in model
  File "/usr/lib/python_udf/6cd8c5edb748108566a6331991a1dbb5d219039edc8195c97d7681b3bda325d2/lib/python3.8/site-packages/snowflake/snowpark/_internal/telemetry.py", line 213, in wrap
    r = func(*args, **kwargs)
  File "/usr/lib/python_udf/6cd8c5edb748108566a6331991a1dbb5d219039edc8195c97d7681b3bda325d2/lib/python3.8/site-packages/snowflake/snowpark/dataframe.py", line 1314, in group_by
    grouping_exprs = self._convert_cols_to_exprs("group_by()", *cols)
  File "/usr/lib/python_udf/6cd8c5edb748108566a6331991a1dbb5d219039edc8195c97d7681b3bda325d2/lib/python3.8/site-packages/snowflake/snowpark/dataframe.py", line 3427, in _convert_cols_to_exprs
    exprs = [convert(col) for col in parse_positional_args_to_list(*cols)]
  File "/usr/lib/python_udf/6cd8c5edb748108566a6331991a1dbb5d219039edc8195c97d7681b3bda325d2/lib/python3.8/site-packages/snowflake/snowpark/dataframe.py", line 3427, in <listcomp>
    exprs = [convert(col) for col in parse_positional_args_to_list(*cols)]
  File "/usr/lib/python_udf/6cd8c5edb748108566a6331991a1dbb5d219039edc8195c97d7681b3bda325d2/lib/python3.8/site-packages/snowflake/snowpark/dataframe.py", line 3418, in convert
    return self._resolve(col)
  File "/usr/lib/python_udf/6cd8c5edb748108566a6331991a1dbb5d219039edc8195c97d7681b3bda325d2/lib/python3.8/site-packages/snowflake/snowpark/dataframe.py", line 3387, in _resolve
    raise SnowparkClientExceptionMessages.DF_CANNOT_RESOLVE_COLUMN_NAME(
snowflake.snowpark.exceptions.SnowparkColumnException: (1105): The DataFrame does not contain the column named stg_orders.customer_id.
 in function CUSTOMERS__DBT_SP with handler main
[0m03:08:10.381273 [debug] [Thread-1  ]: finished collecting timing info
[0m03:08:10.381419 [debug] [Thread-1  ]: On model.jaffle_shop.customers: Close
[0m03:08:10.699271 [debug] [Thread-1  ]: Database Error in model customers (models/customers.py)
  100357 (P0000): Python Interpreter Error:
  Traceback (most recent call last):
    File "_udf_code.py", line 122, in main
    File "_udf_code.py", line 24, in model
    File "/usr/lib/python_udf/6cd8c5edb748108566a6331991a1dbb5d219039edc8195c97d7681b3bda325d2/lib/python3.8/site-packages/snowflake/snowpark/_internal/telemetry.py", line 213, in wrap
      r = func(*args, **kwargs)
    File "/usr/lib/python_udf/6cd8c5edb748108566a6331991a1dbb5d219039edc8195c97d7681b3bda325d2/lib/python3.8/site-packages/snowflake/snowpark/dataframe.py", line 1314, in group_by
      grouping_exprs = self._convert_cols_to_exprs("group_by()", *cols)
    File "/usr/lib/python_udf/6cd8c5edb748108566a6331991a1dbb5d219039edc8195c97d7681b3bda325d2/lib/python3.8/site-packages/snowflake/snowpark/dataframe.py", line 3427, in _convert_cols_to_exprs
      exprs = [convert(col) for col in parse_positional_args_to_list(*cols)]
    File "/usr/lib/python_udf/6cd8c5edb748108566a6331991a1dbb5d219039edc8195c97d7681b3bda325d2/lib/python3.8/site-packages/snowflake/snowpark/dataframe.py", line 3427, in <listcomp>
      exprs = [convert(col) for col in parse_positional_args_to_list(*cols)]
    File "/usr/lib/python_udf/6cd8c5edb748108566a6331991a1dbb5d219039edc8195c97d7681b3bda325d2/lib/python3.8/site-packages/snowflake/snowpark/dataframe.py", line 3418, in convert
      return self._resolve(col)
    File "/usr/lib/python_udf/6cd8c5edb748108566a6331991a1dbb5d219039edc8195c97d7681b3bda325d2/lib/python3.8/site-packages/snowflake/snowpark/dataframe.py", line 3387, in _resolve
      raise SnowparkClientExceptionMessages.DF_CANNOT_RESOLVE_COLUMN_NAME(
  snowflake.snowpark.exceptions.SnowparkColumnException: (1105): The DataFrame does not contain the column named stg_orders.customer_id.
   in function CUSTOMERS__DBT_SP with handler main
  compiled Code at target/run/jaffle_shop/models/customers.py
[0m03:08:10.700276 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'b714f6aa-a2b4-45c2-a087-057ee09c031d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10f3d4580>]}
[0m03:08:10.701139 [error] [Thread-1  ]: 1 of 1 ERROR creating python table model bruno.customers ....................... [[31mERROR[0m in 7.19s]
[0m03:08:10.703385 [debug] [Thread-1  ]: Finished running node model.jaffle_shop.customers
[0m03:08:10.709147 [debug] [MainThread]: Acquiring new snowflake connection "master"
[0m03:08:10.710079 [info ] [MainThread]: 
[0m03:08:10.710530 [info ] [MainThread]: Finished running 1 table model in 0 hours 0 minutes and 9.78 seconds (9.78s).
[0m03:08:10.710870 [debug] [MainThread]: Connection 'master' was properly closed.
[0m03:08:10.711001 [debug] [MainThread]: Connection 'model.jaffle_shop.customers' was properly closed.
[0m03:08:10.722753 [info ] [MainThread]: 
[0m03:08:10.723095 [info ] [MainThread]: [31mCompleted with 1 error and 0 warnings:[0m
[0m03:08:10.723428 [info ] [MainThread]: 
[0m03:08:10.723637 [error] [MainThread]: [33mDatabase Error in model customers (models/customers.py)[0m
[0m03:08:10.723827 [error] [MainThread]:   100357 (P0000): Python Interpreter Error:
[0m03:08:10.724000 [error] [MainThread]:   Traceback (most recent call last):
[0m03:08:10.724289 [error] [MainThread]:     File "_udf_code.py", line 122, in main
[0m03:08:10.724457 [error] [MainThread]:     File "_udf_code.py", line 24, in model
[0m03:08:10.724613 [error] [MainThread]:     File "/usr/lib/python_udf/6cd8c5edb748108566a6331991a1dbb5d219039edc8195c97d7681b3bda325d2/lib/python3.8/site-packages/snowflake/snowpark/_internal/telemetry.py", line 213, in wrap
[0m03:08:10.724783 [error] [MainThread]:       r = func(*args, **kwargs)
[0m03:08:10.724940 [error] [MainThread]:     File "/usr/lib/python_udf/6cd8c5edb748108566a6331991a1dbb5d219039edc8195c97d7681b3bda325d2/lib/python3.8/site-packages/snowflake/snowpark/dataframe.py", line 1314, in group_by
[0m03:08:10.725098 [error] [MainThread]:       grouping_exprs = self._convert_cols_to_exprs("group_by()", *cols)
[0m03:08:10.725253 [error] [MainThread]:     File "/usr/lib/python_udf/6cd8c5edb748108566a6331991a1dbb5d219039edc8195c97d7681b3bda325d2/lib/python3.8/site-packages/snowflake/snowpark/dataframe.py", line 3427, in _convert_cols_to_exprs
[0m03:08:10.725413 [error] [MainThread]:       exprs = [convert(col) for col in parse_positional_args_to_list(*cols)]
[0m03:08:10.725566 [error] [MainThread]:     File "/usr/lib/python_udf/6cd8c5edb748108566a6331991a1dbb5d219039edc8195c97d7681b3bda325d2/lib/python3.8/site-packages/snowflake/snowpark/dataframe.py", line 3427, in <listcomp>
[0m03:08:10.725758 [error] [MainThread]:       exprs = [convert(col) for col in parse_positional_args_to_list(*cols)]
[0m03:08:10.725914 [error] [MainThread]:     File "/usr/lib/python_udf/6cd8c5edb748108566a6331991a1dbb5d219039edc8195c97d7681b3bda325d2/lib/python3.8/site-packages/snowflake/snowpark/dataframe.py", line 3418, in convert
[0m03:08:10.726068 [error] [MainThread]:       return self._resolve(col)
[0m03:08:10.726222 [error] [MainThread]:     File "/usr/lib/python_udf/6cd8c5edb748108566a6331991a1dbb5d219039edc8195c97d7681b3bda325d2/lib/python3.8/site-packages/snowflake/snowpark/dataframe.py", line 3387, in _resolve
[0m03:08:10.726458 [error] [MainThread]:       raise SnowparkClientExceptionMessages.DF_CANNOT_RESOLVE_COLUMN_NAME(
[0m03:08:10.726641 [error] [MainThread]:   snowflake.snowpark.exceptions.SnowparkColumnException: (1105): The DataFrame does not contain the column named stg_orders.customer_id.
[0m03:08:10.726812 [error] [MainThread]:    in function CUSTOMERS__DBT_SP with handler main
[0m03:08:10.726972 [error] [MainThread]:   compiled Code at target/run/jaffle_shop/models/customers.py
[0m03:08:10.727170 [info ] [MainThread]: 
[0m03:08:10.727359 [info ] [MainThread]: Done. PASS=0 WARN=0 ERROR=1 SKIP=0 TOTAL=1
[0m03:08:10.727651 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10956e790>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10e155b50>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10f3b99a0>]}
[0m03:08:10.727897 [debug] [MainThread]: Flushing usage events


============================== 2023-01-24 03:08:48.692040 | e2c0bea5-8b1f-48af-afdb-5f1a1091b1c9 ==============================
[0m03:08:48.692097 [info ] [MainThread]: Running with dbt=1.3.2
[0m03:08:48.692973 [debug] [MainThread]: running dbt with arguments {'write_json': True, 'use_colors': True, 'printer_width': 80, 'version_check': True, 'partial_parse': True, 'static_parser': True, 'profiles_dir': '/Users/bruno/.dbt', 'send_anonymous_usage_stats': True, 'event_buffer_size': 100000, 'quiet': False, 'no_print': False, 'cache_selected_only': False, 'select': ['customers.py'], 'which': 'run', 'rpc_method': 'run', 'indirect_selection': 'eager'}
[0m03:08:48.693123 [debug] [MainThread]: Tracking: tracking
[0m03:08:48.693566 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x112545bb0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x112545c10>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x112545c70>]}
[0m03:08:48.746210 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 1 files changed.
[0m03:08:48.746627 [debug] [MainThread]: Partial parsing: updated file: jaffle_shop://models/customers.py
[0m03:08:48.804197 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': 'e2c0bea5-8b1f-48af-afdb-5f1a1091b1c9', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x112ace9a0>]}
[0m03:08:48.811130 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': 'e2c0bea5-8b1f-48af-afdb-5f1a1091b1c9', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x11266f430>]}
[0m03:08:48.811355 [info ] [MainThread]: Found 5 models, 10 tests, 0 snapshots, 0 analyses, 303 macros, 0 operations, 3 seed files, 0 sources, 0 exposures, 0 metrics
[0m03:08:48.811547 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'e2c0bea5-8b1f-48af-afdb-5f1a1091b1c9', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x112a9d0d0>]}
[0m03:08:48.812732 [info ] [MainThread]: 
[0m03:08:48.813208 [debug] [MainThread]: Acquiring new snowflake connection "master"
[0m03:08:48.813911 [debug] [ThreadPool]: Acquiring new snowflake connection "list_jaffle_shop"
[0m03:08:48.826211 [debug] [ThreadPool]: Using snowflake connection "list_jaffle_shop"
[0m03:08:48.826422 [debug] [ThreadPool]: On list_jaffle_shop: /* {"app": "dbt", "dbt_version": "1.3.2", "profile_name": "jaffle_shop", "target_name": "dev", "connection_name": "list_jaffle_shop"} */
show terse schemas in database jaffle_shop
    limit 10000
[0m03:08:48.826522 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m03:08:49.749762 [debug] [ThreadPool]: SQL status: SUCCESS 3 in 0.92 seconds
[0m03:08:49.754624 [debug] [ThreadPool]: On list_jaffle_shop: Close
[0m03:08:50.181155 [debug] [ThreadPool]: Acquiring new snowflake connection "list_jaffle_shop_bruno"
[0m03:08:50.195881 [debug] [ThreadPool]: Using snowflake connection "list_jaffle_shop_bruno"
[0m03:08:50.196173 [debug] [ThreadPool]: On list_jaffle_shop_bruno: /* {"app": "dbt", "dbt_version": "1.3.2", "profile_name": "jaffle_shop", "target_name": "dev", "connection_name": "list_jaffle_shop_bruno"} */
show terse objects in jaffle_shop.bruno
[0m03:08:50.196404 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m03:08:51.090804 [debug] [ThreadPool]: SQL status: SUCCESS 6 in 0.89 seconds
[0m03:08:51.098038 [debug] [ThreadPool]: On list_jaffle_shop_bruno: Close
[0m03:08:51.437420 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'e2c0bea5-8b1f-48af-afdb-5f1a1091b1c9', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x112aa8f40>]}
[0m03:08:51.438392 [info ] [MainThread]: Concurrency: 1 threads (target='dev')
[0m03:08:51.438757 [info ] [MainThread]: 
[0m03:08:51.443873 [debug] [Thread-1  ]: Began running node model.jaffle_shop.customers
[0m03:08:51.444279 [info ] [Thread-1  ]: 1 of 1 START python table model bruno.customers ................................ [RUN]
[0m03:08:51.445044 [debug] [Thread-1  ]: Acquiring new snowflake connection "model.jaffle_shop.customers"
[0m03:08:51.445207 [debug] [Thread-1  ]: Began compiling node model.jaffle_shop.customers
[0m03:08:51.445728 [debug] [Thread-1  ]: Compiling model.jaffle_shop.customers
[0m03:08:51.468303 [debug] [Thread-1  ]: Writing injected SQL for node "model.jaffle_shop.customers"
[0m03:08:51.469270 [debug] [Thread-1  ]: finished collecting timing info
[0m03:08:51.469445 [debug] [Thread-1  ]: Began executing node model.jaffle_shop.customers
[0m03:08:51.498212 [debug] [Thread-1  ]: Writing runtime python for node "model.jaffle_shop.customers"
[0m03:08:51.500309 [debug] [Thread-1  ]: Using snowflake connection "model.jaffle_shop.customers"
[0m03:08:51.500454 [debug] [Thread-1  ]: On model.jaffle_shop.customers: /* {"app": "dbt", "dbt_version": "1.3.2", "profile_name": "jaffle_shop", "target_name": "dev", "node_id": "model.jaffle_shop.customers"} */
CREATE OR REPLACE PROCEDURE jaffle_shop.bruno.customers__dbt_sp ()

RETURNS STRING
LANGUAGE PYTHON
RUNTIME_VERSION = '3.8'
PACKAGES = ('snowflake-snowpark-python')

HANDLER = 'main'
EXECUTE AS CALLER
AS
$$

  
    
import snowflake.snowpark.functions as F

def model(dbt, session):

    stg_customers = dbt.ref('stg_customers')
    stg_orders = dbt.ref('stg_orders')
    stg_payments = dbt.ref('stg_payments')

    customer_orders = (
        stg_orders
        .group_by("customer_id")
        .agg(
            F.min(F.col("order_date")).name('first_order'),
            F.max(F.col("order_date")).name('most_recent_order'),
            F.count(F.col("order_id")).name('number_of_orders')
        )
    )

    customer_payments = (
        stg_payments
        .join(stg_orders, stg_payments["order_id"] == stg_orders["order_id"], "left")
        .group_by("stg_orders.customer_id")
        .agg(
            F.sum(F.col("amount")).name('total_amount')
        )
    )

    final_df = (
        stg_customers
        .join(customer_orders, customers["customer_id"] == customer_orders["customer_id"], "left")
        .join(customer_payments, customers["customer_id"] == customer_payments["customer_id"], "left")
        .select("customer_orders.customer_id",
                "customer_orders.first_name",
                "customer_orders.last_name",
                "customer_orders.first_order",
                "customer_orders.most_recent_order",
                "customer_orders.number_of_orders",
                F.col("customer_payments.total_amount").name("customer_lifetime_value")
        )
    )

    return final_df


# This part is user provided model code
# you will need to copy the next section to run the code
# COMMAND ----------
# this part is dbt logic for get ref work, do not modify

def ref(*args,dbt_load_df_function):
    refs = {"stg_customers": "jaffle_shop.bruno.stg_customers", "stg_orders": "jaffle_shop.bruno.stg_orders", "stg_payments": "jaffle_shop.bruno.stg_payments"}
    key = ".".join(args)
    return dbt_load_df_function(refs[key])


def source(*args, dbt_load_df_function):
    sources = {}
    key = ".".join(args)
    return dbt_load_df_function(sources[key])


config_dict = {}


class config:
    def __init__(self, *args, **kwargs):
        pass

    @staticmethod
    def get(key, default=None):
        return config_dict.get(key, default)

class this:
    """dbt.this() or dbt.this.identifier"""
    database = 'jaffle_shop'
    schema = 'bruno'
    identifier = 'customers'
    def __repr__(self):
        return 'jaffle_shop.bruno.customers'


class dbtObj:
    def __init__(self, load_df_function) -> None:
        self.source = lambda *args: source(*args, dbt_load_df_function=load_df_function)
        self.ref = lambda *args: ref(*args, dbt_load_df_function=load_df_function)
        self.config = config
        self.this = this()
        self.is_incremental = False

# COMMAND ----------

# To run this in snowsight, you need to select entry point to be main
# And you may have to modify the return type to text to get the result back
# def main(session):
#     dbt = dbtObj(session.table)
#     df = model(dbt, session)
#     return df.collect()

# to run this in local notebook, you need to create a session following examples https://github.com/Snowflake-Labs/sfguide-getting-started-snowpark-python
# then you can do the following to run model
# dbt = dbtObj(session.table)
# df = model(dbt, session)


def materialize(session, df, target_relation):
    # make sure pandas exists
    import importlib.util
    package_name = 'pandas'
    if importlib.util.find_spec(package_name):
        import pandas
        if isinstance(df, pandas.core.frame.DataFrame):
          # session.write_pandas does not have overwrite function
          df = session.createDataFrame(df)
    df.write.mode("overwrite").save_as_table("jaffle_shop.bruno.customers", create_temp_table=False)

def main(session):
    dbt = dbtObj(session.table)
    df = model(dbt, session)
    materialize(session, df, dbt.this)
    return "OK"

  
$$;
[0m03:08:51.500553 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m03:08:56.944202 [debug] [Thread-1  ]: SQL status: SUCCESS 1 in 5.44 seconds
[0m03:08:56.945681 [debug] [Thread-1  ]: Using snowflake connection "model.jaffle_shop.customers"
[0m03:08:56.946262 [debug] [Thread-1  ]: On model.jaffle_shop.customers: /* {"app": "dbt", "dbt_version": "1.3.2", "profile_name": "jaffle_shop", "target_name": "dev", "node_id": "model.jaffle_shop.customers"} */
CALL jaffle_shop.bruno.customers__dbt_sp();
[0m03:08:58.009916 [debug] [Thread-1  ]: Snowflake adapter: Snowflake query id: 01a9dadc-0000-0c55-0000-0000468d2765
[0m03:08:58.010139 [debug] [Thread-1  ]: Snowflake adapter: Snowflake error: 100357 (P0000): Python Interpreter Error:
Traceback (most recent call last):
  File "_udf_code.py", line 122, in main
  File "_udf_code.py", line 24, in model
  File "/usr/lib/python_udf/6cd8c5edb748108566a6331991a1dbb5d219039edc8195c97d7681b3bda325d2/lib/python3.8/site-packages/snowflake/snowpark/_internal/telemetry.py", line 213, in wrap
    r = func(*args, **kwargs)
  File "/usr/lib/python_udf/6cd8c5edb748108566a6331991a1dbb5d219039edc8195c97d7681b3bda325d2/lib/python3.8/site-packages/snowflake/snowpark/dataframe.py", line 1314, in group_by
    grouping_exprs = self._convert_cols_to_exprs("group_by()", *cols)
  File "/usr/lib/python_udf/6cd8c5edb748108566a6331991a1dbb5d219039edc8195c97d7681b3bda325d2/lib/python3.8/site-packages/snowflake/snowpark/dataframe.py", line 3427, in _convert_cols_to_exprs
    exprs = [convert(col) for col in parse_positional_args_to_list(*cols)]
  File "/usr/lib/python_udf/6cd8c5edb748108566a6331991a1dbb5d219039edc8195c97d7681b3bda325d2/lib/python3.8/site-packages/snowflake/snowpark/dataframe.py", line 3427, in <listcomp>
    exprs = [convert(col) for col in parse_positional_args_to_list(*cols)]
  File "/usr/lib/python_udf/6cd8c5edb748108566a6331991a1dbb5d219039edc8195c97d7681b3bda325d2/lib/python3.8/site-packages/snowflake/snowpark/dataframe.py", line 3418, in convert
    return self._resolve(col)
  File "/usr/lib/python_udf/6cd8c5edb748108566a6331991a1dbb5d219039edc8195c97d7681b3bda325d2/lib/python3.8/site-packages/snowflake/snowpark/dataframe.py", line 3387, in _resolve
    raise SnowparkClientExceptionMessages.DF_CANNOT_RESOLVE_COLUMN_NAME(
snowflake.snowpark.exceptions.SnowparkColumnException: (1105): The DataFrame does not contain the column named stg_orders.customer_id.
 in function CUSTOMERS__DBT_SP with handler main
[0m03:08:58.010441 [debug] [Thread-1  ]: finished collecting timing info
[0m03:08:58.010595 [debug] [Thread-1  ]: On model.jaffle_shop.customers: Close
[0m03:08:58.345069 [debug] [Thread-1  ]: Database Error in model customers (models/customers.py)
  100357 (P0000): Python Interpreter Error:
  Traceback (most recent call last):
    File "_udf_code.py", line 122, in main
    File "_udf_code.py", line 24, in model
    File "/usr/lib/python_udf/6cd8c5edb748108566a6331991a1dbb5d219039edc8195c97d7681b3bda325d2/lib/python3.8/site-packages/snowflake/snowpark/_internal/telemetry.py", line 213, in wrap
      r = func(*args, **kwargs)
    File "/usr/lib/python_udf/6cd8c5edb748108566a6331991a1dbb5d219039edc8195c97d7681b3bda325d2/lib/python3.8/site-packages/snowflake/snowpark/dataframe.py", line 1314, in group_by
      grouping_exprs = self._convert_cols_to_exprs("group_by()", *cols)
    File "/usr/lib/python_udf/6cd8c5edb748108566a6331991a1dbb5d219039edc8195c97d7681b3bda325d2/lib/python3.8/site-packages/snowflake/snowpark/dataframe.py", line 3427, in _convert_cols_to_exprs
      exprs = [convert(col) for col in parse_positional_args_to_list(*cols)]
    File "/usr/lib/python_udf/6cd8c5edb748108566a6331991a1dbb5d219039edc8195c97d7681b3bda325d2/lib/python3.8/site-packages/snowflake/snowpark/dataframe.py", line 3427, in <listcomp>
      exprs = [convert(col) for col in parse_positional_args_to_list(*cols)]
    File "/usr/lib/python_udf/6cd8c5edb748108566a6331991a1dbb5d219039edc8195c97d7681b3bda325d2/lib/python3.8/site-packages/snowflake/snowpark/dataframe.py", line 3418, in convert
      return self._resolve(col)
    File "/usr/lib/python_udf/6cd8c5edb748108566a6331991a1dbb5d219039edc8195c97d7681b3bda325d2/lib/python3.8/site-packages/snowflake/snowpark/dataframe.py", line 3387, in _resolve
      raise SnowparkClientExceptionMessages.DF_CANNOT_RESOLVE_COLUMN_NAME(
  snowflake.snowpark.exceptions.SnowparkColumnException: (1105): The DataFrame does not contain the column named stg_orders.customer_id.
   in function CUSTOMERS__DBT_SP with handler main
  compiled Code at target/run/jaffle_shop/models/customers.py
[0m03:08:58.345827 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'e2c0bea5-8b1f-48af-afdb-5f1a1091b1c9', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x113037310>]}
[0m03:08:58.346563 [error] [Thread-1  ]: 1 of 1 ERROR creating python table model bruno.customers ....................... [[31mERROR[0m in 6.90s]
[0m03:08:58.347547 [debug] [Thread-1  ]: Finished running node model.jaffle_shop.customers
[0m03:08:58.350466 [debug] [MainThread]: Acquiring new snowflake connection "master"
[0m03:08:58.351464 [info ] [MainThread]: 
[0m03:08:58.352001 [info ] [MainThread]: Finished running 1 table model in 0 hours 0 minutes and 9.54 seconds (9.54s).
[0m03:08:58.352478 [debug] [MainThread]: Connection 'master' was properly closed.
[0m03:08:58.352717 [debug] [MainThread]: Connection 'model.jaffle_shop.customers' was properly closed.
[0m03:08:58.367605 [info ] [MainThread]: 
[0m03:08:58.368031 [info ] [MainThread]: [31mCompleted with 1 error and 0 warnings:[0m
[0m03:08:58.368409 [info ] [MainThread]: 
[0m03:08:58.368712 [error] [MainThread]: [33mDatabase Error in model customers (models/customers.py)[0m
[0m03:08:58.369020 [error] [MainThread]:   100357 (P0000): Python Interpreter Error:
[0m03:08:58.369308 [error] [MainThread]:   Traceback (most recent call last):
[0m03:08:58.369594 [error] [MainThread]:     File "_udf_code.py", line 122, in main
[0m03:08:58.369885 [error] [MainThread]:     File "_udf_code.py", line 24, in model
[0m03:08:58.370170 [error] [MainThread]:     File "/usr/lib/python_udf/6cd8c5edb748108566a6331991a1dbb5d219039edc8195c97d7681b3bda325d2/lib/python3.8/site-packages/snowflake/snowpark/_internal/telemetry.py", line 213, in wrap
[0m03:08:58.370464 [error] [MainThread]:       r = func(*args, **kwargs)
[0m03:08:58.370748 [error] [MainThread]:     File "/usr/lib/python_udf/6cd8c5edb748108566a6331991a1dbb5d219039edc8195c97d7681b3bda325d2/lib/python3.8/site-packages/snowflake/snowpark/dataframe.py", line 1314, in group_by
[0m03:08:58.371032 [error] [MainThread]:       grouping_exprs = self._convert_cols_to_exprs("group_by()", *cols)
[0m03:08:58.371319 [error] [MainThread]:     File "/usr/lib/python_udf/6cd8c5edb748108566a6331991a1dbb5d219039edc8195c97d7681b3bda325d2/lib/python3.8/site-packages/snowflake/snowpark/dataframe.py", line 3427, in _convert_cols_to_exprs
[0m03:08:58.371602 [error] [MainThread]:       exprs = [convert(col) for col in parse_positional_args_to_list(*cols)]
[0m03:08:58.371888 [error] [MainThread]:     File "/usr/lib/python_udf/6cd8c5edb748108566a6331991a1dbb5d219039edc8195c97d7681b3bda325d2/lib/python3.8/site-packages/snowflake/snowpark/dataframe.py", line 3427, in <listcomp>
[0m03:08:58.372306 [error] [MainThread]:       exprs = [convert(col) for col in parse_positional_args_to_list(*cols)]
[0m03:08:58.372588 [error] [MainThread]:     File "/usr/lib/python_udf/6cd8c5edb748108566a6331991a1dbb5d219039edc8195c97d7681b3bda325d2/lib/python3.8/site-packages/snowflake/snowpark/dataframe.py", line 3418, in convert
[0m03:08:58.372872 [error] [MainThread]:       return self._resolve(col)
[0m03:08:58.373154 [error] [MainThread]:     File "/usr/lib/python_udf/6cd8c5edb748108566a6331991a1dbb5d219039edc8195c97d7681b3bda325d2/lib/python3.8/site-packages/snowflake/snowpark/dataframe.py", line 3387, in _resolve
[0m03:08:58.373437 [error] [MainThread]:       raise SnowparkClientExceptionMessages.DF_CANNOT_RESOLVE_COLUMN_NAME(
[0m03:08:58.373718 [error] [MainThread]:   snowflake.snowpark.exceptions.SnowparkColumnException: (1105): The DataFrame does not contain the column named stg_orders.customer_id.
[0m03:08:58.374000 [error] [MainThread]:    in function CUSTOMERS__DBT_SP with handler main
[0m03:08:58.374283 [error] [MainThread]:   compiled Code at target/run/jaffle_shop/models/customers.py
[0m03:08:58.374595 [info ] [MainThread]: 
[0m03:08:58.374914 [info ] [MainThread]: Done. PASS=0 WARN=0 ERROR=1 SKIP=0 TOTAL=1
[0m03:08:58.375398 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x112a9d070>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x11255d100>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x113037130>]}
[0m03:08:58.375774 [debug] [MainThread]: Flushing usage events


============================== 2023-01-24 03:10:52.560843 | b799ff73-311a-4098-ac2b-ea17c4d61492 ==============================
[0m03:10:52.560902 [info ] [MainThread]: Running with dbt=1.3.2
[0m03:10:52.561752 [debug] [MainThread]: running dbt with arguments {'write_json': True, 'use_colors': True, 'printer_width': 80, 'version_check': True, 'partial_parse': True, 'static_parser': True, 'profiles_dir': '/Users/bruno/.dbt', 'send_anonymous_usage_stats': True, 'event_buffer_size': 100000, 'quiet': False, 'no_print': False, 'cache_selected_only': False, 'select': ['customers.py'], 'which': 'run', 'rpc_method': 'run', 'indirect_selection': 'eager'}
[0m03:10:52.561882 [debug] [MainThread]: Tracking: tracking
[0m03:10:52.562270 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x112a30bb0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x112a30c10>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x112a30c70>]}
[0m03:10:52.618211 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 1 files changed.
[0m03:10:52.618830 [debug] [MainThread]: Partial parsing: updated file: jaffle_shop://models/customers.py
[0m03:10:52.676038 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': 'b799ff73-311a-4098-ac2b-ea17c4d61492', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x112fb89a0>]}
[0m03:10:52.682624 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': 'b799ff73-311a-4098-ac2b-ea17c4d61492', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x112b58430>]}
[0m03:10:52.682856 [info ] [MainThread]: Found 5 models, 10 tests, 0 snapshots, 0 analyses, 303 macros, 0 operations, 3 seed files, 0 sources, 0 exposures, 0 metrics
[0m03:10:52.683048 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'b799ff73-311a-4098-ac2b-ea17c4d61492', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x112f860d0>]}
[0m03:10:52.684445 [info ] [MainThread]: 
[0m03:10:52.685356 [debug] [MainThread]: Acquiring new snowflake connection "master"
[0m03:10:52.686290 [debug] [ThreadPool]: Acquiring new snowflake connection "list_jaffle_shop"
[0m03:10:52.697447 [debug] [ThreadPool]: Using snowflake connection "list_jaffle_shop"
[0m03:10:52.697585 [debug] [ThreadPool]: On list_jaffle_shop: /* {"app": "dbt", "dbt_version": "1.3.2", "profile_name": "jaffle_shop", "target_name": "dev", "connection_name": "list_jaffle_shop"} */
show terse schemas in database jaffle_shop
    limit 10000
[0m03:10:52.697681 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m03:10:53.921875 [debug] [ThreadPool]: SQL status: SUCCESS 3 in 1.22 seconds
[0m03:10:53.929031 [debug] [ThreadPool]: On list_jaffle_shop: Close
[0m03:10:54.267689 [debug] [ThreadPool]: Acquiring new snowflake connection "list_jaffle_shop_bruno"
[0m03:10:54.287018 [debug] [ThreadPool]: Using snowflake connection "list_jaffle_shop_bruno"
[0m03:10:54.287447 [debug] [ThreadPool]: On list_jaffle_shop_bruno: /* {"app": "dbt", "dbt_version": "1.3.2", "profile_name": "jaffle_shop", "target_name": "dev", "connection_name": "list_jaffle_shop_bruno"} */
show terse objects in jaffle_shop.bruno
[0m03:10:54.287680 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m03:10:54.898013 [debug] [ThreadPool]: SQL status: SUCCESS 6 in 0.61 seconds
[0m03:10:54.901953 [debug] [ThreadPool]: On list_jaffle_shop_bruno: Close
[0m03:10:55.243204 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'b799ff73-311a-4098-ac2b-ea17c4d61492', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x112f91f40>]}
[0m03:10:55.244722 [info ] [MainThread]: Concurrency: 1 threads (target='dev')
[0m03:10:55.245270 [info ] [MainThread]: 
[0m03:10:55.253253 [debug] [Thread-1  ]: Began running node model.jaffle_shop.customers
[0m03:10:55.254015 [info ] [Thread-1  ]: 1 of 1 START python table model bruno.customers ................................ [RUN]
[0m03:10:55.255506 [debug] [Thread-1  ]: Acquiring new snowflake connection "model.jaffle_shop.customers"
[0m03:10:55.256127 [debug] [Thread-1  ]: Began compiling node model.jaffle_shop.customers
[0m03:10:55.257843 [debug] [Thread-1  ]: Compiling model.jaffle_shop.customers
[0m03:10:55.294472 [debug] [Thread-1  ]: Writing injected SQL for node "model.jaffle_shop.customers"
[0m03:10:55.295489 [debug] [Thread-1  ]: finished collecting timing info
[0m03:10:55.295738 [debug] [Thread-1  ]: Began executing node model.jaffle_shop.customers
[0m03:10:55.329453 [debug] [Thread-1  ]: Writing runtime python for node "model.jaffle_shop.customers"
[0m03:10:55.331520 [debug] [Thread-1  ]: Using snowflake connection "model.jaffle_shop.customers"
[0m03:10:55.331632 [debug] [Thread-1  ]: On model.jaffle_shop.customers: /* {"app": "dbt", "dbt_version": "1.3.2", "profile_name": "jaffle_shop", "target_name": "dev", "node_id": "model.jaffle_shop.customers"} */
CREATE OR REPLACE PROCEDURE jaffle_shop.bruno.customers__dbt_sp ()

RETURNS STRING
LANGUAGE PYTHON
RUNTIME_VERSION = '3.8'
PACKAGES = ('snowflake-snowpark-python')

HANDLER = 'main'
EXECUTE AS CALLER
AS
$$

  
    
import snowflake.snowpark.functions as F

def model(dbt, session):

    stg_customers = dbt.ref('stg_customers')
    stg_orders = dbt.ref('stg_orders')
    stg_payments = dbt.ref('stg_payments')

    customer_orders = (
        stg_orders
        .group_by("customer_id")
        .agg(
            F.min(F.col("order_date")).name('first_order'),
            F.max(F.col("order_date")).name('most_recent_order'),
            F.count(F.col("order_id")).name('number_of_orders')
        )
    )

    customer_payments = (
        stg_payments
        .join(stg_orders, stg_payments.order_id == stg_orders.order_id, "left")
        .group_by(stg_orders.customer_id)
        .agg(
            F.sum(F.col("amount")).name('total_amount')
        )
    )

    final_df = (
        stg_customers
        .join(customer_orders, customers["customer_id"] == customer_orders["customer_id"], "left")
        .join(customer_payments, customers["customer_id"] == customer_payments["customer_id"], "left")
        .select("customer_orders.customer_id",
                "customer_orders.first_name",
                "customer_orders.last_name",
                "customer_orders.first_order",
                "customer_orders.most_recent_order",
                "customer_orders.number_of_orders",
                F.col("customer_payments.total_amount").name("customer_lifetime_value")
        )
    )

    return final_df


# This part is user provided model code
# you will need to copy the next section to run the code
# COMMAND ----------
# this part is dbt logic for get ref work, do not modify

def ref(*args,dbt_load_df_function):
    refs = {"stg_customers": "jaffle_shop.bruno.stg_customers", "stg_orders": "jaffle_shop.bruno.stg_orders", "stg_payments": "jaffle_shop.bruno.stg_payments"}
    key = ".".join(args)
    return dbt_load_df_function(refs[key])


def source(*args, dbt_load_df_function):
    sources = {}
    key = ".".join(args)
    return dbt_load_df_function(sources[key])


config_dict = {}


class config:
    def __init__(self, *args, **kwargs):
        pass

    @staticmethod
    def get(key, default=None):
        return config_dict.get(key, default)

class this:
    """dbt.this() or dbt.this.identifier"""
    database = 'jaffle_shop'
    schema = 'bruno'
    identifier = 'customers'
    def __repr__(self):
        return 'jaffle_shop.bruno.customers'


class dbtObj:
    def __init__(self, load_df_function) -> None:
        self.source = lambda *args: source(*args, dbt_load_df_function=load_df_function)
        self.ref = lambda *args: ref(*args, dbt_load_df_function=load_df_function)
        self.config = config
        self.this = this()
        self.is_incremental = False

# COMMAND ----------

# To run this in snowsight, you need to select entry point to be main
# And you may have to modify the return type to text to get the result back
# def main(session):
#     dbt = dbtObj(session.table)
#     df = model(dbt, session)
#     return df.collect()

# to run this in local notebook, you need to create a session following examples https://github.com/Snowflake-Labs/sfguide-getting-started-snowpark-python
# then you can do the following to run model
# dbt = dbtObj(session.table)
# df = model(dbt, session)


def materialize(session, df, target_relation):
    # make sure pandas exists
    import importlib.util
    package_name = 'pandas'
    if importlib.util.find_spec(package_name):
        import pandas
        if isinstance(df, pandas.core.frame.DataFrame):
          # session.write_pandas does not have overwrite function
          df = session.createDataFrame(df)
    df.write.mode("overwrite").save_as_table("jaffle_shop.bruno.customers", create_temp_table=False)

def main(session):
    dbt = dbtObj(session.table)
    df = model(dbt, session)
    materialize(session, df, dbt.this)
    return "OK"

  
$$;
[0m03:10:55.331780 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m03:11:00.938659 [debug] [Thread-1  ]: SQL status: SUCCESS 1 in 5.61 seconds
[0m03:11:00.940979 [debug] [Thread-1  ]: Using snowflake connection "model.jaffle_shop.customers"
[0m03:11:00.941631 [debug] [Thread-1  ]: On model.jaffle_shop.customers: /* {"app": "dbt", "dbt_version": "1.3.2", "profile_name": "jaffle_shop", "target_name": "dev", "node_id": "model.jaffle_shop.customers"} */
CALL jaffle_shop.bruno.customers__dbt_sp();
[0m03:11:02.026488 [debug] [Thread-1  ]: Snowflake adapter: Snowflake query id: 01a9dadf-0000-0c55-0000-0000468d2785
[0m03:11:02.026729 [debug] [Thread-1  ]: Snowflake adapter: Snowflake error: 100357 (P0000): Python Interpreter Error:
Traceback (most recent call last):
  File "_udf_code.py", line 122, in main
  File "_udf_code.py", line 34, in model
NameError: name 'customers' is not defined
 in function CUSTOMERS__DBT_SP with handler main
[0m03:11:02.027062 [debug] [Thread-1  ]: finished collecting timing info
[0m03:11:02.027219 [debug] [Thread-1  ]: On model.jaffle_shop.customers: Close
[0m03:11:02.359972 [debug] [Thread-1  ]: Database Error in model customers (models/customers.py)
  100357 (P0000): Python Interpreter Error:
  Traceback (most recent call last):
    File "_udf_code.py", line 122, in main
    File "_udf_code.py", line 34, in model
  NameError: name 'customers' is not defined
   in function CUSTOMERS__DBT_SP with handler main
  compiled Code at target/run/jaffle_shop/models/customers.py
[0m03:11:02.361152 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'b799ff73-311a-4098-ac2b-ea17c4d61492', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x11463f790>]}
[0m03:11:02.362204 [error] [Thread-1  ]: 1 of 1 ERROR creating python table model bruno.customers ....................... [[31mERROR[0m in 7.11s]
[0m03:11:02.363753 [debug] [Thread-1  ]: Finished running node model.jaffle_shop.customers
[0m03:11:02.366918 [debug] [MainThread]: Acquiring new snowflake connection "master"
[0m03:11:02.368372 [info ] [MainThread]: 
[0m03:11:02.369117 [info ] [MainThread]: Finished running 1 table model in 0 hours 0 minutes and 9.68 seconds (9.68s).
[0m03:11:02.369908 [debug] [MainThread]: Connection 'master' was properly closed.
[0m03:11:02.370376 [debug] [MainThread]: Connection 'model.jaffle_shop.customers' was properly closed.
[0m03:11:02.385547 [info ] [MainThread]: 
[0m03:11:02.386004 [info ] [MainThread]: [31mCompleted with 1 error and 0 warnings:[0m
[0m03:11:02.386333 [info ] [MainThread]: 
[0m03:11:02.386593 [error] [MainThread]: [33mDatabase Error in model customers (models/customers.py)[0m
[0m03:11:02.386920 [error] [MainThread]:   100357 (P0000): Python Interpreter Error:
[0m03:11:02.387350 [error] [MainThread]:   Traceback (most recent call last):
[0m03:11:02.387682 [error] [MainThread]:     File "_udf_code.py", line 122, in main
[0m03:11:02.387925 [error] [MainThread]:     File "_udf_code.py", line 34, in model
[0m03:11:02.388152 [error] [MainThread]:   NameError: name 'customers' is not defined
[0m03:11:02.388375 [error] [MainThread]:    in function CUSTOMERS__DBT_SP with handler main
[0m03:11:02.388713 [error] [MainThread]:   compiled Code at target/run/jaffle_shop/models/customers.py
[0m03:11:02.388965 [info ] [MainThread]: 
[0m03:11:02.389214 [info ] [MainThread]: Done. PASS=0 WARN=0 ERROR=1 SKIP=0 TOTAL=1
[0m03:11:02.389565 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x112f86070>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x112a47160>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x11463f910>]}
[0m03:11:02.389878 [debug] [MainThread]: Flushing usage events


============================== 2023-01-24 03:12:49.531262 | 781d3df1-7cdb-4263-a9c7-2f316f87418e ==============================
[0m03:12:49.531318 [info ] [MainThread]: Running with dbt=1.3.2
[0m03:12:49.532077 [debug] [MainThread]: running dbt with arguments {'write_json': True, 'use_colors': True, 'printer_width': 80, 'version_check': True, 'partial_parse': True, 'static_parser': True, 'profiles_dir': '/Users/bruno/.dbt', 'send_anonymous_usage_stats': True, 'event_buffer_size': 100000, 'quiet': False, 'no_print': False, 'cache_selected_only': False, 'select': ['customers.py'], 'which': 'run', 'rpc_method': 'run', 'indirect_selection': 'eager'}
[0m03:12:49.532225 [debug] [MainThread]: Tracking: tracking
[0m03:12:49.532570 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x111d01bb0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x111d01c10>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x111d01c70>]}
[0m03:12:49.588015 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 1 files changed.
[0m03:12:49.588414 [debug] [MainThread]: Partial parsing: updated file: jaffle_shop://models/customers.py
[0m03:12:49.642680 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '781d3df1-7cdb-4263-a9c7-2f316f87418e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x11227d9a0>]}
[0m03:12:49.648980 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '781d3df1-7cdb-4263-a9c7-2f316f87418e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x111e2a430>]}
[0m03:12:49.649182 [info ] [MainThread]: Found 5 models, 10 tests, 0 snapshots, 0 analyses, 303 macros, 0 operations, 3 seed files, 0 sources, 0 exposures, 0 metrics
[0m03:12:49.649366 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '781d3df1-7cdb-4263-a9c7-2f316f87418e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1122580d0>]}
[0m03:12:49.650471 [info ] [MainThread]: 
[0m03:12:49.650972 [debug] [MainThread]: Acquiring new snowflake connection "master"
[0m03:12:49.651740 [debug] [ThreadPool]: Acquiring new snowflake connection "list_jaffle_shop"
[0m03:12:49.663666 [debug] [ThreadPool]: Using snowflake connection "list_jaffle_shop"
[0m03:12:49.663845 [debug] [ThreadPool]: On list_jaffle_shop: /* {"app": "dbt", "dbt_version": "1.3.2", "profile_name": "jaffle_shop", "target_name": "dev", "connection_name": "list_jaffle_shop"} */
show terse schemas in database jaffle_shop
    limit 10000
[0m03:12:49.663950 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m03:12:50.717571 [debug] [ThreadPool]: SQL status: SUCCESS 3 in 1.05 seconds
[0m03:12:50.722929 [debug] [ThreadPool]: On list_jaffle_shop: Close
[0m03:12:51.235993 [debug] [ThreadPool]: Acquiring new snowflake connection "list_jaffle_shop_bruno"
[0m03:12:51.250640 [debug] [ThreadPool]: Using snowflake connection "list_jaffle_shop_bruno"
[0m03:12:51.250947 [debug] [ThreadPool]: On list_jaffle_shop_bruno: /* {"app": "dbt", "dbt_version": "1.3.2", "profile_name": "jaffle_shop", "target_name": "dev", "connection_name": "list_jaffle_shop_bruno"} */
show terse objects in jaffle_shop.bruno
[0m03:12:51.251182 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m03:12:52.141213 [debug] [ThreadPool]: SQL status: SUCCESS 6 in 0.89 seconds
[0m03:12:52.146302 [debug] [ThreadPool]: On list_jaffle_shop_bruno: Close
[0m03:12:52.477606 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '781d3df1-7cdb-4263-a9c7-2f316f87418e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x112264f40>]}
[0m03:12:52.478918 [info ] [MainThread]: Concurrency: 1 threads (target='dev')
[0m03:12:52.479484 [info ] [MainThread]: 
[0m03:12:52.486690 [debug] [Thread-1  ]: Began running node model.jaffle_shop.customers
[0m03:12:52.487385 [info ] [Thread-1  ]: 1 of 1 START python table model bruno.customers ................................ [RUN]
[0m03:12:52.488786 [debug] [Thread-1  ]: Acquiring new snowflake connection "model.jaffle_shop.customers"
[0m03:12:52.489035 [debug] [Thread-1  ]: Began compiling node model.jaffle_shop.customers
[0m03:12:52.489509 [debug] [Thread-1  ]: Compiling model.jaffle_shop.customers
[0m03:12:52.509677 [debug] [Thread-1  ]: Writing injected SQL for node "model.jaffle_shop.customers"
[0m03:12:52.510941 [debug] [Thread-1  ]: finished collecting timing info
[0m03:12:52.511177 [debug] [Thread-1  ]: Began executing node model.jaffle_shop.customers
[0m03:12:52.548056 [debug] [Thread-1  ]: Writing runtime python for node "model.jaffle_shop.customers"
[0m03:12:52.550374 [debug] [Thread-1  ]: Using snowflake connection "model.jaffle_shop.customers"
[0m03:12:52.550505 [debug] [Thread-1  ]: On model.jaffle_shop.customers: /* {"app": "dbt", "dbt_version": "1.3.2", "profile_name": "jaffle_shop", "target_name": "dev", "node_id": "model.jaffle_shop.customers"} */
CREATE OR REPLACE PROCEDURE jaffle_shop.bruno.customers__dbt_sp ()

RETURNS STRING
LANGUAGE PYTHON
RUNTIME_VERSION = '3.8'
PACKAGES = ('snowflake-snowpark-python')

HANDLER = 'main'
EXECUTE AS CALLER
AS
$$

  
    
import snowflake.snowpark.functions as F

def model(dbt, session):

    stg_customers = dbt.ref('stg_customers')
    stg_orders = dbt.ref('stg_orders')
    stg_payments = dbt.ref('stg_payments')

    customer_orders = (
        stg_orders
        .group_by("customer_id")
        .agg(
            F.min(F.col("order_date")).alias('first_order'),
            F.max(F.col("order_date")).alias('most_recent_order'),
            F.count(F.col("order_id")).alias('number_of_orders')
        )
    )

    customer_payments = (
        stg_payments
        .join(stg_orders, stg_payments.order_id == stg_orders.order_id, "left")
        .group_by(stg_orders.customer_id)
        .agg(
            F.sum(F.col("amount")).alias('total_amount')
        )
    )

    final_df = (
        stg_customers
        .join(customer_orders, stg_customers.customer_id == customer_orders.customer_id, "left")
        .join(customer_payments, stg_customers.customer_id == customer_payments.customer_id, "left")
        .select(customer_orders.customer_id,
                customer_orders.first_name,
                customer_orders.last_name,
                customer_orders.first_order,
                customer_orders.most_recent_order,
                customer_orders.number_of_orders,
                F.col("customer_payments.total_amount").alias("customer_lifetime_value")
        )
    )

    return final_df


# This part is user provided model code
# you will need to copy the next section to run the code
# COMMAND ----------
# this part is dbt logic for get ref work, do not modify

def ref(*args,dbt_load_df_function):
    refs = {"stg_customers": "jaffle_shop.bruno.stg_customers", "stg_orders": "jaffle_shop.bruno.stg_orders", "stg_payments": "jaffle_shop.bruno.stg_payments"}
    key = ".".join(args)
    return dbt_load_df_function(refs[key])


def source(*args, dbt_load_df_function):
    sources = {}
    key = ".".join(args)
    return dbt_load_df_function(sources[key])


config_dict = {}


class config:
    def __init__(self, *args, **kwargs):
        pass

    @staticmethod
    def get(key, default=None):
        return config_dict.get(key, default)

class this:
    """dbt.this() or dbt.this.identifier"""
    database = 'jaffle_shop'
    schema = 'bruno'
    identifier = 'customers'
    def __repr__(self):
        return 'jaffle_shop.bruno.customers'


class dbtObj:
    def __init__(self, load_df_function) -> None:
        self.source = lambda *args: source(*args, dbt_load_df_function=load_df_function)
        self.ref = lambda *args: ref(*args, dbt_load_df_function=load_df_function)
        self.config = config
        self.this = this()
        self.is_incremental = False

# COMMAND ----------

# To run this in snowsight, you need to select entry point to be main
# And you may have to modify the return type to text to get the result back
# def main(session):
#     dbt = dbtObj(session.table)
#     df = model(dbt, session)
#     return df.collect()

# to run this in local notebook, you need to create a session following examples https://github.com/Snowflake-Labs/sfguide-getting-started-snowpark-python
# then you can do the following to run model
# dbt = dbtObj(session.table)
# df = model(dbt, session)


def materialize(session, df, target_relation):
    # make sure pandas exists
    import importlib.util
    package_name = 'pandas'
    if importlib.util.find_spec(package_name):
        import pandas
        if isinstance(df, pandas.core.frame.DataFrame):
          # session.write_pandas does not have overwrite function
          df = session.createDataFrame(df)
    df.write.mode("overwrite").save_as_table("jaffle_shop.bruno.customers", create_temp_table=False)

def main(session):
    dbt = dbtObj(session.table)
    df = model(dbt, session)
    materialize(session, df, dbt.this)
    return "OK"

  
$$;
[0m03:12:52.550616 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m03:12:58.000185 [debug] [Thread-1  ]: SQL status: SUCCESS 1 in 5.45 seconds
[0m03:12:58.001895 [debug] [Thread-1  ]: Using snowflake connection "model.jaffle_shop.customers"
[0m03:12:58.002492 [debug] [Thread-1  ]: On model.jaffle_shop.customers: /* {"app": "dbt", "dbt_version": "1.3.2", "profile_name": "jaffle_shop", "target_name": "dev", "node_id": "model.jaffle_shop.customers"} */
CALL jaffle_shop.bruno.customers__dbt_sp();
[0m03:12:59.308665 [debug] [Thread-1  ]: Snowflake adapter: Snowflake query id: 01a9dae0-0000-0c55-0000-0000468d27a1
[0m03:12:59.308874 [debug] [Thread-1  ]: Snowflake adapter: Snowflake error: 100357 (P0000): Python Interpreter Error:
Traceback (most recent call last):
  File "_udf_code.py", line 122, in main
  File "_udf_code.py", line 37, in model
  File "/usr/lib/python_udf/6cd8c5edb748108566a6331991a1dbb5d219039edc8195c97d7681b3bda325d2/lib/python3.8/site-packages/snowflake/snowpark/dataframe.py", line 848, in __getattr__
    raise AttributeError(
AttributeError: DataFrame object has no attribute first_name
 in function CUSTOMERS__DBT_SP with handler main
[0m03:12:59.309166 [debug] [Thread-1  ]: finished collecting timing info
[0m03:12:59.309318 [debug] [Thread-1  ]: On model.jaffle_shop.customers: Close
[0m03:12:59.659279 [debug] [Thread-1  ]: Database Error in model customers (models/customers.py)
  100357 (P0000): Python Interpreter Error:
  Traceback (most recent call last):
    File "_udf_code.py", line 122, in main
    File "_udf_code.py", line 37, in model
    File "/usr/lib/python_udf/6cd8c5edb748108566a6331991a1dbb5d219039edc8195c97d7681b3bda325d2/lib/python3.8/site-packages/snowflake/snowpark/dataframe.py", line 848, in __getattr__
      raise AttributeError(
  AttributeError: DataFrame object has no attribute first_name
   in function CUSTOMERS__DBT_SP with handler main
  compiled Code at target/run/jaffle_shop/models/customers.py
[0m03:12:59.660283 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '781d3df1-7cdb-4263-a9c7-2f316f87418e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1134e0460>]}
[0m03:12:59.661196 [error] [Thread-1  ]: 1 of 1 ERROR creating python table model bruno.customers ....................... [[31mERROR[0m in 7.17s]
[0m03:12:59.662252 [debug] [Thread-1  ]: Finished running node model.jaffle_shop.customers
[0m03:12:59.665190 [debug] [MainThread]: Acquiring new snowflake connection "master"
[0m03:12:59.666215 [info ] [MainThread]: 
[0m03:12:59.666726 [info ] [MainThread]: Finished running 1 table model in 0 hours 0 minutes and 10.02 seconds (10.02s).
[0m03:12:59.667203 [debug] [MainThread]: Connection 'master' was properly closed.
[0m03:12:59.667445 [debug] [MainThread]: Connection 'model.jaffle_shop.customers' was properly closed.
[0m03:12:59.682491 [info ] [MainThread]: 
[0m03:12:59.682969 [info ] [MainThread]: [31mCompleted with 1 error and 0 warnings:[0m
[0m03:12:59.683393 [info ] [MainThread]: 
[0m03:12:59.683701 [error] [MainThread]: [33mDatabase Error in model customers (models/customers.py)[0m
[0m03:12:59.683997 [error] [MainThread]:   100357 (P0000): Python Interpreter Error:
[0m03:12:59.684279 [error] [MainThread]:   Traceback (most recent call last):
[0m03:12:59.684561 [error] [MainThread]:     File "_udf_code.py", line 122, in main
[0m03:12:59.684844 [error] [MainThread]:     File "_udf_code.py", line 37, in model
[0m03:12:59.685126 [error] [MainThread]:     File "/usr/lib/python_udf/6cd8c5edb748108566a6331991a1dbb5d219039edc8195c97d7681b3bda325d2/lib/python3.8/site-packages/snowflake/snowpark/dataframe.py", line 848, in __getattr__
[0m03:12:59.685409 [error] [MainThread]:       raise AttributeError(
[0m03:12:59.685687 [error] [MainThread]:   AttributeError: DataFrame object has no attribute first_name
[0m03:12:59.685966 [error] [MainThread]:    in function CUSTOMERS__DBT_SP with handler main
[0m03:12:59.686244 [error] [MainThread]:   compiled Code at target/run/jaffle_shop/models/customers.py
[0m03:12:59.686545 [info ] [MainThread]: 
[0m03:12:59.686845 [info ] [MainThread]: Done. PASS=0 WARN=0 ERROR=1 SKIP=0 TOTAL=1
[0m03:12:59.687286 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x112258070>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x111d19130>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1134e05e0>]}
[0m03:12:59.687668 [debug] [MainThread]: Flushing usage events


============================== 2023-01-24 03:13:31.783977 | 396ac1c1-6e2f-4b1c-bbb9-beb292b94b18 ==============================
[0m03:13:31.784026 [info ] [MainThread]: Running with dbt=1.3.2
[0m03:13:31.784758 [debug] [MainThread]: running dbt with arguments {'write_json': True, 'use_colors': True, 'printer_width': 80, 'version_check': True, 'partial_parse': True, 'static_parser': True, 'profiles_dir': '/Users/bruno/.dbt', 'send_anonymous_usage_stats': True, 'event_buffer_size': 100000, 'quiet': False, 'no_print': False, 'cache_selected_only': False, 'select': ['customers.py'], 'which': 'run', 'rpc_method': 'run', 'indirect_selection': 'eager'}
[0m03:13:31.784908 [debug] [MainThread]: Tracking: tracking
[0m03:13:31.785243 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x111b39b80>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x111b39be0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x111b39c40>]}
[0m03:13:31.836413 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 1 files changed.
[0m03:13:31.836836 [debug] [MainThread]: Partial parsing: updated file: jaffle_shop://models/customers.py
[0m03:13:31.891040 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '396ac1c1-6e2f-4b1c-bbb9-beb292b94b18', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1120b6970>]}
[0m03:13:31.897486 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '396ac1c1-6e2f-4b1c-bbb9-beb292b94b18', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x111c63400>]}
[0m03:13:31.897680 [info ] [MainThread]: Found 5 models, 10 tests, 0 snapshots, 0 analyses, 303 macros, 0 operations, 3 seed files, 0 sources, 0 exposures, 0 metrics
[0m03:13:31.897867 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '396ac1c1-6e2f-4b1c-bbb9-beb292b94b18', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1120910a0>]}
[0m03:13:31.899212 [info ] [MainThread]: 
[0m03:13:31.899739 [debug] [MainThread]: Acquiring new snowflake connection "master"
[0m03:13:31.900584 [debug] [ThreadPool]: Acquiring new snowflake connection "list_jaffle_shop"
[0m03:13:31.912280 [debug] [ThreadPool]: Using snowflake connection "list_jaffle_shop"
[0m03:13:31.912459 [debug] [ThreadPool]: On list_jaffle_shop: /* {"app": "dbt", "dbt_version": "1.3.2", "profile_name": "jaffle_shop", "target_name": "dev", "connection_name": "list_jaffle_shop"} */
show terse schemas in database jaffle_shop
    limit 10000
[0m03:13:31.912560 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m03:13:32.794390 [debug] [ThreadPool]: SQL status: SUCCESS 3 in 0.88 seconds
[0m03:13:32.798750 [debug] [ThreadPool]: On list_jaffle_shop: Close
[0m03:13:33.217966 [debug] [ThreadPool]: Acquiring new snowflake connection "list_jaffle_shop_bruno"
[0m03:13:33.232456 [debug] [ThreadPool]: Using snowflake connection "list_jaffle_shop_bruno"
[0m03:13:33.232805 [debug] [ThreadPool]: On list_jaffle_shop_bruno: /* {"app": "dbt", "dbt_version": "1.3.2", "profile_name": "jaffle_shop", "target_name": "dev", "connection_name": "list_jaffle_shop_bruno"} */
show terse objects in jaffle_shop.bruno
[0m03:13:33.233029 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m03:13:34.029497 [debug] [ThreadPool]: SQL status: SUCCESS 6 in 0.8 seconds
[0m03:13:34.035421 [debug] [ThreadPool]: On list_jaffle_shop_bruno: Close
[0m03:13:34.445229 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '396ac1c1-6e2f-4b1c-bbb9-beb292b94b18', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x111b24820>]}
[0m03:13:34.446492 [info ] [MainThread]: Concurrency: 1 threads (target='dev')
[0m03:13:34.447037 [info ] [MainThread]: 
[0m03:13:34.454067 [debug] [Thread-1  ]: Began running node model.jaffle_shop.customers
[0m03:13:34.454761 [info ] [Thread-1  ]: 1 of 1 START python table model bruno.customers ................................ [RUN]
[0m03:13:34.455984 [debug] [Thread-1  ]: Acquiring new snowflake connection "model.jaffle_shop.customers"
[0m03:13:34.456263 [debug] [Thread-1  ]: Began compiling node model.jaffle_shop.customers
[0m03:13:34.457113 [debug] [Thread-1  ]: Compiling model.jaffle_shop.customers
[0m03:13:34.488430 [debug] [Thread-1  ]: Writing injected SQL for node "model.jaffle_shop.customers"
[0m03:13:34.489255 [debug] [Thread-1  ]: finished collecting timing info
[0m03:13:34.489475 [debug] [Thread-1  ]: Began executing node model.jaffle_shop.customers
[0m03:13:34.522774 [debug] [Thread-1  ]: Writing runtime python for node "model.jaffle_shop.customers"
[0m03:13:34.524967 [debug] [Thread-1  ]: Using snowflake connection "model.jaffle_shop.customers"
[0m03:13:34.525084 [debug] [Thread-1  ]: On model.jaffle_shop.customers: /* {"app": "dbt", "dbt_version": "1.3.2", "profile_name": "jaffle_shop", "target_name": "dev", "node_id": "model.jaffle_shop.customers"} */
CREATE OR REPLACE PROCEDURE jaffle_shop.bruno.customers__dbt_sp ()

RETURNS STRING
LANGUAGE PYTHON
RUNTIME_VERSION = '3.8'
PACKAGES = ('snowflake-snowpark-python')

HANDLER = 'main'
EXECUTE AS CALLER
AS
$$

  
    
import snowflake.snowpark.functions as F

def model(dbt, session):

    stg_customers = dbt.ref('stg_customers')
    stg_orders = dbt.ref('stg_orders')
    stg_payments = dbt.ref('stg_payments')

    customer_orders = (
        stg_orders
        .group_by("customer_id")
        .agg(
            F.min(F.col("order_date")).alias('first_order'),
            F.max(F.col("order_date")).alias('most_recent_order'),
            F.count(F.col("order_id")).alias('number_of_orders')
        )
    )

    customer_payments = (
        stg_payments
        .join(stg_orders, stg_payments.order_id == stg_orders.order_id, "left")
        .group_by(stg_orders.customer_id)
        .agg(
            F.sum(F.col("amount")).alias('total_amount')
        )
    )

    final_df = (
        stg_customers
        .join(customer_orders, stg_customers.customer_id == customer_orders.customer_id, "left")
        .join(customer_payments, stg_customers.customer_id == customer_payments.customer_id, "left")
        .select(stg_customers.customer_id,
                stg_customers.first_name,
                stg_customers.last_name,
                customer_orders.first_order,
                customer_orders.most_recent_order,
                customer_orders.number_of_orders,
                F.col("customer_payments.total_amount").alias("customer_lifetime_value")
        )
    )

    return final_df


# This part is user provided model code
# you will need to copy the next section to run the code
# COMMAND ----------
# this part is dbt logic for get ref work, do not modify

def ref(*args,dbt_load_df_function):
    refs = {"stg_customers": "jaffle_shop.bruno.stg_customers", "stg_orders": "jaffle_shop.bruno.stg_orders", "stg_payments": "jaffle_shop.bruno.stg_payments"}
    key = ".".join(args)
    return dbt_load_df_function(refs[key])


def source(*args, dbt_load_df_function):
    sources = {}
    key = ".".join(args)
    return dbt_load_df_function(sources[key])


config_dict = {}


class config:
    def __init__(self, *args, **kwargs):
        pass

    @staticmethod
    def get(key, default=None):
        return config_dict.get(key, default)

class this:
    """dbt.this() or dbt.this.identifier"""
    database = 'jaffle_shop'
    schema = 'bruno'
    identifier = 'customers'
    def __repr__(self):
        return 'jaffle_shop.bruno.customers'


class dbtObj:
    def __init__(self, load_df_function) -> None:
        self.source = lambda *args: source(*args, dbt_load_df_function=load_df_function)
        self.ref = lambda *args: ref(*args, dbt_load_df_function=load_df_function)
        self.config = config
        self.this = this()
        self.is_incremental = False

# COMMAND ----------

# To run this in snowsight, you need to select entry point to be main
# And you may have to modify the return type to text to get the result back
# def main(session):
#     dbt = dbtObj(session.table)
#     df = model(dbt, session)
#     return df.collect()

# to run this in local notebook, you need to create a session following examples https://github.com/Snowflake-Labs/sfguide-getting-started-snowpark-python
# then you can do the following to run model
# dbt = dbtObj(session.table)
# df = model(dbt, session)


def materialize(session, df, target_relation):
    # make sure pandas exists
    import importlib.util
    package_name = 'pandas'
    if importlib.util.find_spec(package_name):
        import pandas
        if isinstance(df, pandas.core.frame.DataFrame):
          # session.write_pandas does not have overwrite function
          df = session.createDataFrame(df)
    df.write.mode("overwrite").save_as_table("jaffle_shop.bruno.customers", create_temp_table=False)

def main(session):
    dbt = dbtObj(session.table)
    df = model(dbt, session)
    materialize(session, df, dbt.this)
    return "OK"

  
$$;
[0m03:13:34.525191 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m03:13:39.927314 [debug] [Thread-1  ]: SQL status: SUCCESS 1 in 5.4 seconds
[0m03:13:39.928319 [debug] [Thread-1  ]: Using snowflake connection "model.jaffle_shop.customers"
[0m03:13:39.928670 [debug] [Thread-1  ]: On model.jaffle_shop.customers: /* {"app": "dbt", "dbt_version": "1.3.2", "profile_name": "jaffle_shop", "target_name": "dev", "node_id": "model.jaffle_shop.customers"} */
CALL jaffle_shop.bruno.customers__dbt_sp();
[0m03:13:41.299243 [debug] [Thread-1  ]: Snowflake adapter: Snowflake query id: 01a9dae1-0000-0c56-0000-0000468d3775
[0m03:13:41.299444 [debug] [Thread-1  ]: Snowflake adapter: Snowflake error: 100357 (P0000): Python Interpreter Error:
Traceback (most recent call last):
  File "_udf_code.py", line 123, in main
  File "_udf_code.py", line 118, in materialize
  File "/usr/lib/python_udf/6cd8c5edb748108566a6331991a1dbb5d219039edc8195c97d7681b3bda325d2/lib/python3.8/site-packages/snowflake/snowpark/_internal/telemetry.py", line 161, in wrap
    result = func(*args, **kwargs)
  File "/usr/lib/python_udf/6cd8c5edb748108566a6331991a1dbb5d219039edc8195c97d7681b3bda325d2/lib/python3.8/site-packages/snowflake/snowpark/dataframe_writer.py", line 193, in save_as_table
    result = session._conn.execute(
  File "/usr/lib/python_udf/6cd8c5edb748108566a6331991a1dbb5d219039edc8195c97d7681b3bda325d2/lib/python3.8/site-packages/snowflake/snowpark/_internal/server_connection.py", line 406, in execute
    result_set, result_meta = self.get_result_set(
  File "/usr/lib/python_udf/6cd8c5edb748108566a6331991a1dbb5d219039edc8195c97d7681b3bda325d2/lib/python3.8/site-packages/snowflake/snowpark/_internal/analyzer/snowflake_plan.py", line 149, in wrap
    raise ne.with_traceback(tb) from None
  File "/usr/lib/python_udf/6cd8c5edb748108566a6331991a1dbb5d219039edc8195c97d7681b3bda325d2/lib/python3.8/site-packages/snowflake/snowpark/_internal/analyzer/snowflake_plan.py", line 87, in wrap
    return func(*args, **kwargs)
  File "/usr/lib/python_udf/6cd8c5edb748108566a6331991a1dbb5d219039edc8195c97d7681b3bda325d2/lib/python3.8/site-packages/snowflake/snowpark/_internal/server_connection.py", line 494, in get_result_set
    result = self.run_query(
  File "/usr/lib/python_udf/6cd8c5edb748108566a6331991a1dbb5d219039edc8195c97d7681b3bda325d2/lib/python3.8/site-packages/snowflake/snowpark/_internal/server_connection.py", line 104, in wrap
    raise ex
  File "/usr/lib/python_udf/6cd8c5edb748108566a6331991a1dbb5d219039edc8195c97d7681b3bda325d2/lib/python3.8/site-packages/snowflake/snowpark/_internal/server_connection.py", line 98, in wrap
    return func(*args, **kwargs)
  File "/usr/lib/python_udf/6cd8c5edb748108566a6331991a1dbb5d219039edc8195c97d7681b3bda325d2/lib/python3.8/site-packages/snowflake/snowpark/_internal/server_connection.py", line 333, in run_query
    raise ex
  File "/usr/lib/python_udf/6cd8c5edb748108566a6331991a1dbb5d219039edc8195c97d7681b3bda325d2/lib/python3.8/site-packages/snowflake/snowpark/_internal/server_connection.py", line 317, in run_query
    results_cursor = self._cursor.execute(query, **kwargs)
  File "/usr/lib/python_udf/6cd8c5edb748108566a6331991a1dbb5d219039edc8195c97d7681b3bda325d2/lib/python3.8/site-packages/snowflake/connector/cursor.py", line 822, in execute
    Error.errorhandler_wrapper(
  File "/usr/lib/python_udf/6cd8c5edb748108566a6331991a1dbb5d219039edc8195c97d7681b3bda325d2/lib/python3.8/site-packages/snowflake/connector/errors.py", line 229, in errorhandler_wrapper
    handed_over = Error.hand_to_other_handler(
  File "/usr/lib/python_udf/6cd8c5edb748108566a6331991a1dbb5d219039edc8195c97d7681b3bda325d2/lib/python3.8/site-packages/snowflake/connector/errors.py", line 284, in hand_to_other_handler
    cursor.errorhandler(connection, cursor, error_class, error_value)
  File "/usr/lib/python_udf/6cd8c5edb748108566a6331991a1dbb5d219039edc8195c97d7681b3bda325d2/lib/python3.8/site-packages/snowflake/connector/errors.py", line 163, in default_errorhandler
    raise error_class(
snowflake.snowpark.exceptions.SnowparkSQLException: (1304): 01a9dae1-0000-0c56-0000-0000468d37a9: 000904 (42000): SQL compilation error: error line 1 at position 192
invalid identifier '"customer_payments.total_amount"'
 in function CUSTOMERS__DBT_SP with handler main
[0m03:13:41.299713 [debug] [Thread-1  ]: finished collecting timing info
[0m03:13:41.299845 [debug] [Thread-1  ]: On model.jaffle_shop.customers: Close
[0m03:13:41.645327 [debug] [Thread-1  ]: Database Error in model customers (models/customers.py)
  100357 (P0000): Python Interpreter Error:
  Traceback (most recent call last):
    File "_udf_code.py", line 123, in main
    File "_udf_code.py", line 118, in materialize
    File "/usr/lib/python_udf/6cd8c5edb748108566a6331991a1dbb5d219039edc8195c97d7681b3bda325d2/lib/python3.8/site-packages/snowflake/snowpark/_internal/telemetry.py", line 161, in wrap
      result = func(*args, **kwargs)
    File "/usr/lib/python_udf/6cd8c5edb748108566a6331991a1dbb5d219039edc8195c97d7681b3bda325d2/lib/python3.8/site-packages/snowflake/snowpark/dataframe_writer.py", line 193, in save_as_table
      result = session._conn.execute(
    File "/usr/lib/python_udf/6cd8c5edb748108566a6331991a1dbb5d219039edc8195c97d7681b3bda325d2/lib/python3.8/site-packages/snowflake/snowpark/_internal/server_connection.py", line 406, in execute
      result_set, result_meta = self.get_result_set(
    File "/usr/lib/python_udf/6cd8c5edb748108566a6331991a1dbb5d219039edc8195c97d7681b3bda325d2/lib/python3.8/site-packages/snowflake/snowpark/_internal/analyzer/snowflake_plan.py", line 149, in wrap
      raise ne.with_traceback(tb) from None
    File "/usr/lib/python_udf/6cd8c5edb748108566a6331991a1dbb5d219039edc8195c97d7681b3bda325d2/lib/python3.8/site-packages/snowflake/snowpark/_internal/analyzer/snowflake_plan.py", line 87, in wrap
      return func(*args, **kwargs)
    File "/usr/lib/python_udf/6cd8c5edb748108566a6331991a1dbb5d219039edc8195c97d7681b3bda325d2/lib/python3.8/site-packages/snowflake/snowpark/_internal/server_connection.py", line 494, in get_result_set
      result = self.run_query(
    File "/usr/lib/python_udf/6cd8c5edb748108566a6331991a1dbb5d219039edc8195c97d7681b3bda325d2/lib/python3.8/site-packages/snowflake/snowpark/_internal/server_connection.py", line 104, in wrap
      raise ex
    File "/usr/lib/python_udf/6cd8c5edb748108566a6331991a1dbb5d219039edc8195c97d7681b3bda325d2/lib/python3.8/site-packages/snowflake/snowpark/_internal/server_connection.py", line 98, in wrap
      return func(*args, **kwargs)
    File "/usr/lib/python_udf/6cd8c5edb748108566a6331991a1dbb5d219039edc8195c97d7681b3bda325d2/lib/python3.8/site-packages/snowflake/snowpark/_internal/server_connection.py", line 333, in run_query
      raise ex
    File "/usr/lib/python_udf/6cd8c5edb748108566a6331991a1dbb5d219039edc8195c97d7681b3bda325d2/lib/python3.8/site-packages/snowflake/snowpark/_internal/server_connection.py", line 317, in run_query
      results_cursor = self._cursor.execute(query, **kwargs)
    File "/usr/lib/python_udf/6cd8c5edb748108566a6331991a1dbb5d219039edc8195c97d7681b3bda325d2/lib/python3.8/site-packages/snowflake/connector/cursor.py", line 822, in execute
      Error.errorhandler_wrapper(
    File "/usr/lib/python_udf/6cd8c5edb748108566a6331991a1dbb5d219039edc8195c97d7681b3bda325d2/lib/python3.8/site-packages/snowflake/connector/errors.py", line 229, in errorhandler_wrapper
      handed_over = Error.hand_to_other_handler(
    File "/usr/lib/python_udf/6cd8c5edb748108566a6331991a1dbb5d219039edc8195c97d7681b3bda325d2/lib/python3.8/site-packages/snowflake/connector/errors.py", line 284, in hand_to_other_handler
      cursor.errorhandler(connection, cursor, error_class, error_value)
    File "/usr/lib/python_udf/6cd8c5edb748108566a6331991a1dbb5d219039edc8195c97d7681b3bda325d2/lib/python3.8/site-packages/snowflake/connector/errors.py", line 163, in default_errorhandler
      raise error_class(
  snowflake.snowpark.exceptions.SnowparkSQLException: (1304): 01a9dae1-0000-0c56-0000-0000468d37a9: 000904 (42000): SQL compilation error: error line 1 at position 192
  invalid identifier '"customer_payments.total_amount"'
   in function CUSTOMERS__DBT_SP with handler main
  compiled Code at target/run/jaffle_shop/models/customers.py
[0m03:13:41.646316 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '396ac1c1-6e2f-4b1c-bbb9-beb292b94b18', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x113320280>]}
[0m03:13:41.647037 [error] [Thread-1  ]: 1 of 1 ERROR creating python table model bruno.customers ....................... [[31mERROR[0m in 7.19s]
[0m03:13:41.648067 [debug] [Thread-1  ]: Finished running node model.jaffle_shop.customers
[0m03:13:41.650972 [debug] [MainThread]: Acquiring new snowflake connection "master"
[0m03:13:41.652072 [info ] [MainThread]: 
[0m03:13:41.652629 [info ] [MainThread]: Finished running 1 table model in 0 hours 0 minutes and 9.75 seconds (9.75s).
[0m03:13:41.653135 [debug] [MainThread]: Connection 'master' was properly closed.
[0m03:13:41.653385 [debug] [MainThread]: Connection 'model.jaffle_shop.customers' was properly closed.
[0m03:13:41.668302 [info ] [MainThread]: 
[0m03:13:41.668714 [info ] [MainThread]: [31mCompleted with 1 error and 0 warnings:[0m
[0m03:13:41.669092 [info ] [MainThread]: 
[0m03:13:41.669409 [error] [MainThread]: [33mDatabase Error in model customers (models/customers.py)[0m
[0m03:13:41.669720 [error] [MainThread]:   100357 (P0000): Python Interpreter Error:
[0m03:13:41.670017 [error] [MainThread]:   Traceback (most recent call last):
[0m03:13:41.670304 [error] [MainThread]:     File "_udf_code.py", line 123, in main
[0m03:13:41.670593 [error] [MainThread]:     File "_udf_code.py", line 118, in materialize
[0m03:13:41.670879 [error] [MainThread]:     File "/usr/lib/python_udf/6cd8c5edb748108566a6331991a1dbb5d219039edc8195c97d7681b3bda325d2/lib/python3.8/site-packages/snowflake/snowpark/_internal/telemetry.py", line 161, in wrap
[0m03:13:41.671165 [error] [MainThread]:       result = func(*args, **kwargs)
[0m03:13:41.671538 [error] [MainThread]:     File "/usr/lib/python_udf/6cd8c5edb748108566a6331991a1dbb5d219039edc8195c97d7681b3bda325d2/lib/python3.8/site-packages/snowflake/snowpark/dataframe_writer.py", line 193, in save_as_table
[0m03:13:41.671879 [error] [MainThread]:       result = session._conn.execute(
[0m03:13:41.672183 [error] [MainThread]:     File "/usr/lib/python_udf/6cd8c5edb748108566a6331991a1dbb5d219039edc8195c97d7681b3bda325d2/lib/python3.8/site-packages/snowflake/snowpark/_internal/server_connection.py", line 406, in execute
[0m03:13:41.672479 [error] [MainThread]:       result_set, result_meta = self.get_result_set(
[0m03:13:41.672771 [error] [MainThread]:     File "/usr/lib/python_udf/6cd8c5edb748108566a6331991a1dbb5d219039edc8195c97d7681b3bda325d2/lib/python3.8/site-packages/snowflake/snowpark/_internal/analyzer/snowflake_plan.py", line 149, in wrap
[0m03:13:41.673069 [error] [MainThread]:       raise ne.with_traceback(tb) from None
[0m03:13:41.673368 [error] [MainThread]:     File "/usr/lib/python_udf/6cd8c5edb748108566a6331991a1dbb5d219039edc8195c97d7681b3bda325d2/lib/python3.8/site-packages/snowflake/snowpark/_internal/analyzer/snowflake_plan.py", line 87, in wrap
[0m03:13:41.673662 [error] [MainThread]:       return func(*args, **kwargs)
[0m03:13:41.673948 [error] [MainThread]:     File "/usr/lib/python_udf/6cd8c5edb748108566a6331991a1dbb5d219039edc8195c97d7681b3bda325d2/lib/python3.8/site-packages/snowflake/snowpark/_internal/server_connection.py", line 494, in get_result_set
[0m03:13:41.674234 [error] [MainThread]:       result = self.run_query(
[0m03:13:41.674524 [error] [MainThread]:     File "/usr/lib/python_udf/6cd8c5edb748108566a6331991a1dbb5d219039edc8195c97d7681b3bda325d2/lib/python3.8/site-packages/snowflake/snowpark/_internal/server_connection.py", line 104, in wrap
[0m03:13:41.674808 [error] [MainThread]:       raise ex
[0m03:13:41.675091 [error] [MainThread]:     File "/usr/lib/python_udf/6cd8c5edb748108566a6331991a1dbb5d219039edc8195c97d7681b3bda325d2/lib/python3.8/site-packages/snowflake/snowpark/_internal/server_connection.py", line 98, in wrap
[0m03:13:41.675373 [error] [MainThread]:       return func(*args, **kwargs)
[0m03:13:41.675655 [error] [MainThread]:     File "/usr/lib/python_udf/6cd8c5edb748108566a6331991a1dbb5d219039edc8195c97d7681b3bda325d2/lib/python3.8/site-packages/snowflake/snowpark/_internal/server_connection.py", line 333, in run_query
[0m03:13:41.675936 [error] [MainThread]:       raise ex
[0m03:13:41.676218 [error] [MainThread]:     File "/usr/lib/python_udf/6cd8c5edb748108566a6331991a1dbb5d219039edc8195c97d7681b3bda325d2/lib/python3.8/site-packages/snowflake/snowpark/_internal/server_connection.py", line 317, in run_query
[0m03:13:41.676501 [error] [MainThread]:       results_cursor = self._cursor.execute(query, **kwargs)
[0m03:13:41.676782 [error] [MainThread]:     File "/usr/lib/python_udf/6cd8c5edb748108566a6331991a1dbb5d219039edc8195c97d7681b3bda325d2/lib/python3.8/site-packages/snowflake/connector/cursor.py", line 822, in execute
[0m03:13:41.677065 [error] [MainThread]:       Error.errorhandler_wrapper(
[0m03:13:41.677347 [error] [MainThread]:     File "/usr/lib/python_udf/6cd8c5edb748108566a6331991a1dbb5d219039edc8195c97d7681b3bda325d2/lib/python3.8/site-packages/snowflake/connector/errors.py", line 229, in errorhandler_wrapper
[0m03:13:41.677629 [error] [MainThread]:       handed_over = Error.hand_to_other_handler(
[0m03:13:41.677881 [error] [MainThread]:     File "/usr/lib/python_udf/6cd8c5edb748108566a6331991a1dbb5d219039edc8195c97d7681b3bda325d2/lib/python3.8/site-packages/snowflake/connector/errors.py", line 284, in hand_to_other_handler
[0m03:13:41.678132 [error] [MainThread]:       cursor.errorhandler(connection, cursor, error_class, error_value)
[0m03:13:41.678383 [error] [MainThread]:     File "/usr/lib/python_udf/6cd8c5edb748108566a6331991a1dbb5d219039edc8195c97d7681b3bda325d2/lib/python3.8/site-packages/snowflake/connector/errors.py", line 163, in default_errorhandler
[0m03:13:41.678633 [error] [MainThread]:       raise error_class(
[0m03:13:41.678910 [error] [MainThread]:   snowflake.snowpark.exceptions.SnowparkSQLException: (1304): 01a9dae1-0000-0c56-0000-0000468d37a9: 000904 (42000): SQL compilation error: error line 1 at position 192
[0m03:13:41.679157 [error] [MainThread]:   invalid identifier '"customer_payments.total_amount"'
[0m03:13:41.679406 [error] [MainThread]:    in function CUSTOMERS__DBT_SP with handler main
[0m03:13:41.679758 [error] [MainThread]:   compiled Code at target/run/jaffle_shop/models/customers.py
[0m03:13:41.680033 [info ] [MainThread]: 
[0m03:13:41.680309 [info ] [MainThread]: Done. PASS=0 WARN=0 ERROR=1 SKIP=0 TOTAL=1
[0m03:13:41.680702 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1120da4c0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x111c1e310>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x11337e490>]}
[0m03:13:41.681007 [debug] [MainThread]: Flushing usage events


============================== 2023-01-24 03:13:55.175242 | 1731049e-aeb6-458d-914c-a087ad974d10 ==============================
[0m03:13:55.175315 [info ] [MainThread]: Running with dbt=1.3.2
[0m03:13:55.176220 [debug] [MainThread]: running dbt with arguments {'write_json': True, 'use_colors': True, 'printer_width': 80, 'version_check': True, 'partial_parse': True, 'static_parser': True, 'profiles_dir': '/Users/bruno/.dbt', 'send_anonymous_usage_stats': True, 'event_buffer_size': 100000, 'quiet': False, 'no_print': False, 'cache_selected_only': False, 'select': ['customers.py'], 'which': 'run', 'rpc_method': 'run', 'indirect_selection': 'eager'}
[0m03:13:55.176359 [debug] [MainThread]: Tracking: tracking
[0m03:13:55.176700 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x11294bbe0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x11294bc40>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x11294bca0>]}
[0m03:13:55.228245 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 1 files changed.
[0m03:13:55.228639 [debug] [MainThread]: Partial parsing: updated file: jaffle_shop://models/customers.py
[0m03:13:55.291465 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '1731049e-aeb6-458d-914c-a087ad974d10', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x112ec7f40>]}
[0m03:13:55.298067 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '1731049e-aeb6-458d-914c-a087ad974d10', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x112a75490>]}
[0m03:13:55.298311 [info ] [MainThread]: Found 5 models, 10 tests, 0 snapshots, 0 analyses, 303 macros, 0 operations, 3 seed files, 0 sources, 0 exposures, 0 metrics
[0m03:13:55.298519 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '1731049e-aeb6-458d-914c-a087ad974d10', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x112ea3100>]}
[0m03:13:55.299689 [info ] [MainThread]: 
[0m03:13:55.300153 [debug] [MainThread]: Acquiring new snowflake connection "master"
[0m03:13:55.300845 [debug] [ThreadPool]: Acquiring new snowflake connection "list_jaffle_shop"
[0m03:13:55.311596 [debug] [ThreadPool]: Using snowflake connection "list_jaffle_shop"
[0m03:13:55.311726 [debug] [ThreadPool]: On list_jaffle_shop: /* {"app": "dbt", "dbt_version": "1.3.2", "profile_name": "jaffle_shop", "target_name": "dev", "connection_name": "list_jaffle_shop"} */
show terse schemas in database jaffle_shop
    limit 10000
[0m03:13:55.311822 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m03:13:56.658903 [debug] [ThreadPool]: SQL status: SUCCESS 3 in 1.35 seconds
[0m03:13:56.663207 [debug] [ThreadPool]: On list_jaffle_shop: Close
[0m03:13:57.039979 [debug] [ThreadPool]: Acquiring new snowflake connection "list_jaffle_shop_bruno"
[0m03:13:57.050260 [debug] [ThreadPool]: Using snowflake connection "list_jaffle_shop_bruno"
[0m03:13:57.050527 [debug] [ThreadPool]: On list_jaffle_shop_bruno: /* {"app": "dbt", "dbt_version": "1.3.2", "profile_name": "jaffle_shop", "target_name": "dev", "connection_name": "list_jaffle_shop_bruno"} */
show terse objects in jaffle_shop.bruno
[0m03:13:57.050690 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m03:13:57.623282 [debug] [ThreadPool]: SQL status: SUCCESS 6 in 0.57 seconds
[0m03:13:57.625036 [debug] [ThreadPool]: On list_jaffle_shop_bruno: Close
[0m03:13:58.091978 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '1731049e-aeb6-458d-914c-a087ad974d10', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1129644f0>]}
[0m03:13:58.093003 [info ] [MainThread]: Concurrency: 1 threads (target='dev')
[0m03:13:58.093373 [info ] [MainThread]: 
[0m03:13:58.097333 [debug] [Thread-1  ]: Began running node model.jaffle_shop.customers
[0m03:13:58.097732 [info ] [Thread-1  ]: 1 of 1 START python table model bruno.customers ................................ [RUN]
[0m03:13:58.098547 [debug] [Thread-1  ]: Acquiring new snowflake connection "model.jaffle_shop.customers"
[0m03:13:58.098732 [debug] [Thread-1  ]: Began compiling node model.jaffle_shop.customers
[0m03:13:58.099344 [debug] [Thread-1  ]: Compiling model.jaffle_shop.customers
[0m03:13:58.122258 [debug] [Thread-1  ]: Writing injected SQL for node "model.jaffle_shop.customers"
[0m03:13:58.123490 [debug] [Thread-1  ]: finished collecting timing info
[0m03:13:58.123666 [debug] [Thread-1  ]: Began executing node model.jaffle_shop.customers
[0m03:13:58.152577 [debug] [Thread-1  ]: Writing runtime python for node "model.jaffle_shop.customers"
[0m03:13:58.154903 [debug] [Thread-1  ]: Using snowflake connection "model.jaffle_shop.customers"
[0m03:13:58.155023 [debug] [Thread-1  ]: On model.jaffle_shop.customers: /* {"app": "dbt", "dbt_version": "1.3.2", "profile_name": "jaffle_shop", "target_name": "dev", "node_id": "model.jaffle_shop.customers"} */
CREATE OR REPLACE PROCEDURE jaffle_shop.bruno.customers__dbt_sp ()

RETURNS STRING
LANGUAGE PYTHON
RUNTIME_VERSION = '3.8'
PACKAGES = ('snowflake-snowpark-python')

HANDLER = 'main'
EXECUTE AS CALLER
AS
$$

  
    
import snowflake.snowpark.functions as F

def model(dbt, session):

    stg_customers = dbt.ref('stg_customers')
    stg_orders = dbt.ref('stg_orders')
    stg_payments = dbt.ref('stg_payments')

    customer_orders = (
        stg_orders
        .group_by("customer_id")
        .agg(
            F.min(F.col("order_date")).alias('first_order'),
            F.max(F.col("order_date")).alias('most_recent_order'),
            F.count(F.col("order_id")).alias('number_of_orders')
        )
    )

    customer_payments = (
        stg_payments
        .join(stg_orders, stg_payments.order_id == stg_orders.order_id, "left")
        .group_by(stg_orders.customer_id)
        .agg(
            F.sum(F.col("amount")).alias('total_amount')
        )
    )

    final_df = (
        stg_customers
        .join(customer_orders, stg_customers.customer_id == customer_orders.customer_id, "left")
        .join(customer_payments, stg_customers.customer_id == customer_payments.customer_id, "left")
        .select(stg_customers.customer_id,
                stg_customers.first_name,
                stg_customers.last_name,
                customer_orders.first_order,
                customer_orders.most_recent_order,
                customer_orders.number_of_orders,
                F.col(customer_payments.total_amount).alias("customer_lifetime_value")
        )
    )

    return final_df


# This part is user provided model code
# you will need to copy the next section to run the code
# COMMAND ----------
# this part is dbt logic for get ref work, do not modify

def ref(*args,dbt_load_df_function):
    refs = {"stg_customers": "jaffle_shop.bruno.stg_customers", "stg_orders": "jaffle_shop.bruno.stg_orders", "stg_payments": "jaffle_shop.bruno.stg_payments"}
    key = ".".join(args)
    return dbt_load_df_function(refs[key])


def source(*args, dbt_load_df_function):
    sources = {}
    key = ".".join(args)
    return dbt_load_df_function(sources[key])


config_dict = {}


class config:
    def __init__(self, *args, **kwargs):
        pass

    @staticmethod
    def get(key, default=None):
        return config_dict.get(key, default)

class this:
    """dbt.this() or dbt.this.identifier"""
    database = 'jaffle_shop'
    schema = 'bruno'
    identifier = 'customers'
    def __repr__(self):
        return 'jaffle_shop.bruno.customers'


class dbtObj:
    def __init__(self, load_df_function) -> None:
        self.source = lambda *args: source(*args, dbt_load_df_function=load_df_function)
        self.ref = lambda *args: ref(*args, dbt_load_df_function=load_df_function)
        self.config = config
        self.this = this()
        self.is_incremental = False

# COMMAND ----------

# To run this in snowsight, you need to select entry point to be main
# And you may have to modify the return type to text to get the result back
# def main(session):
#     dbt = dbtObj(session.table)
#     df = model(dbt, session)
#     return df.collect()

# to run this in local notebook, you need to create a session following examples https://github.com/Snowflake-Labs/sfguide-getting-started-snowpark-python
# then you can do the following to run model
# dbt = dbtObj(session.table)
# df = model(dbt, session)


def materialize(session, df, target_relation):
    # make sure pandas exists
    import importlib.util
    package_name = 'pandas'
    if importlib.util.find_spec(package_name):
        import pandas
        if isinstance(df, pandas.core.frame.DataFrame):
          # session.write_pandas does not have overwrite function
          df = session.createDataFrame(df)
    df.write.mode("overwrite").save_as_table("jaffle_shop.bruno.customers", create_temp_table=False)

def main(session):
    dbt = dbtObj(session.table)
    df = model(dbt, session)
    materialize(session, df, dbt.this)
    return "OK"

  
$$;
[0m03:13:58.155119 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m03:14:03.537532 [debug] [Thread-1  ]: SQL status: SUCCESS 1 in 5.38 seconds
[0m03:14:03.538090 [debug] [Thread-1  ]: Using snowflake connection "model.jaffle_shop.customers"
[0m03:14:03.538373 [debug] [Thread-1  ]: On model.jaffle_shop.customers: /* {"app": "dbt", "dbt_version": "1.3.2", "profile_name": "jaffle_shop", "target_name": "dev", "node_id": "model.jaffle_shop.customers"} */
CALL jaffle_shop.bruno.customers__dbt_sp();
[0m03:14:04.914208 [debug] [Thread-1  ]: Snowflake adapter: Snowflake query id: 01a9dae2-0000-0c55-0000-0000468d27d9
[0m03:14:04.914432 [debug] [Thread-1  ]: Snowflake adapter: Snowflake error: 100357 (P0000): Python Interpreter Error:
Traceback (most recent call last):
  File "_udf_code.py", line 122, in main
  File "_udf_code.py", line 42, in model
  File "/usr/lib/python_udf/6cd8c5edb748108566a6331991a1dbb5d219039edc8195c97d7681b3bda325d2/lib/python3.8/site-packages/snowflake/snowpark/functions.py", line 207, in col
    return Column(col_name)
  File "/usr/lib/python_udf/6cd8c5edb748108566a6331991a1dbb5d219039edc8195c97d7681b3bda325d2/lib/python3.8/site-packages/snowflake/snowpark/column.py", line 222, in __init__
    raise TypeError("Column constructor only accepts str or expression.")
TypeError: Column constructor only accepts str or expression.
 in function CUSTOMERS__DBT_SP with handler main
[0m03:14:04.914727 [debug] [Thread-1  ]: finished collecting timing info
[0m03:14:04.914884 [debug] [Thread-1  ]: On model.jaffle_shop.customers: Close
[0m03:14:05.368391 [debug] [Thread-1  ]: Database Error in model customers (models/customers.py)
  100357 (P0000): Python Interpreter Error:
  Traceback (most recent call last):
    File "_udf_code.py", line 122, in main
    File "_udf_code.py", line 42, in model
    File "/usr/lib/python_udf/6cd8c5edb748108566a6331991a1dbb5d219039edc8195c97d7681b3bda325d2/lib/python3.8/site-packages/snowflake/snowpark/functions.py", line 207, in col
      return Column(col_name)
    File "/usr/lib/python_udf/6cd8c5edb748108566a6331991a1dbb5d219039edc8195c97d7681b3bda325d2/lib/python3.8/site-packages/snowflake/snowpark/column.py", line 222, in __init__
      raise TypeError("Column constructor only accepts str or expression.")
  TypeError: Column constructor only accepts str or expression.
   in function CUSTOMERS__DBT_SP with handler main
  compiled Code at target/run/jaffle_shop/models/customers.py
[0m03:14:05.369322 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '1731049e-aeb6-458d-914c-a087ad974d10', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x11412af70>]}
[0m03:14:05.370103 [error] [Thread-1  ]: 1 of 1 ERROR creating python table model bruno.customers ....................... [[31mERROR[0m in 7.27s]
[0m03:14:05.371117 [debug] [Thread-1  ]: Finished running node model.jaffle_shop.customers
[0m03:14:05.374021 [debug] [MainThread]: Acquiring new snowflake connection "master"
[0m03:14:05.375115 [info ] [MainThread]: 
[0m03:14:05.375665 [info ] [MainThread]: Finished running 1 table model in 0 hours 0 minutes and 10.08 seconds (10.08s).
[0m03:14:05.376161 [debug] [MainThread]: Connection 'master' was properly closed.
[0m03:14:05.376405 [debug] [MainThread]: Connection 'model.jaffle_shop.customers' was properly closed.
[0m03:14:05.391551 [info ] [MainThread]: 
[0m03:14:05.391994 [info ] [MainThread]: [31mCompleted with 1 error and 0 warnings:[0m
[0m03:14:05.392378 [info ] [MainThread]: 
[0m03:14:05.392693 [error] [MainThread]: [33mDatabase Error in model customers (models/customers.py)[0m
[0m03:14:05.392989 [error] [MainThread]:   100357 (P0000): Python Interpreter Error:
[0m03:14:05.393272 [error] [MainThread]:   Traceback (most recent call last):
[0m03:14:05.393550 [error] [MainThread]:     File "_udf_code.py", line 122, in main
[0m03:14:05.393829 [error] [MainThread]:     File "_udf_code.py", line 42, in model
[0m03:14:05.394104 [error] [MainThread]:     File "/usr/lib/python_udf/6cd8c5edb748108566a6331991a1dbb5d219039edc8195c97d7681b3bda325d2/lib/python3.8/site-packages/snowflake/snowpark/functions.py", line 207, in col
[0m03:14:05.394381 [error] [MainThread]:       return Column(col_name)
[0m03:14:05.394659 [error] [MainThread]:     File "/usr/lib/python_udf/6cd8c5edb748108566a6331991a1dbb5d219039edc8195c97d7681b3bda325d2/lib/python3.8/site-packages/snowflake/snowpark/column.py", line 222, in __init__
[0m03:14:05.394933 [error] [MainThread]:       raise TypeError("Column constructor only accepts str or expression.")
[0m03:14:05.395211 [error] [MainThread]:   TypeError: Column constructor only accepts str or expression.
[0m03:14:05.395494 [error] [MainThread]:    in function CUSTOMERS__DBT_SP with handler main
[0m03:14:05.395768 [error] [MainThread]:   compiled Code at target/run/jaffle_shop/models/customers.py
[0m03:14:05.396052 [info ] [MainThread]: 
[0m03:14:05.396347 [info ] [MainThread]: Done. PASS=0 WARN=0 ERROR=1 SKIP=0 TOTAL=1
[0m03:14:05.396750 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x112935880>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x112a75160>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x114130070>]}
[0m03:14:05.397073 [debug] [MainThread]: Flushing usage events


============================== 2023-01-24 03:14:17.444023 | 21bf5df4-9aa9-4357-b751-295f69cd5610 ==============================
[0m03:14:17.444108 [info ] [MainThread]: Running with dbt=1.3.2
[0m03:14:17.445203 [debug] [MainThread]: running dbt with arguments {'write_json': True, 'use_colors': True, 'printer_width': 80, 'version_check': True, 'partial_parse': True, 'static_parser': True, 'profiles_dir': '/Users/bruno/.dbt', 'send_anonymous_usage_stats': True, 'event_buffer_size': 100000, 'quiet': False, 'no_print': False, 'cache_selected_only': False, 'select': ['customers.py'], 'which': 'run', 'rpc_method': 'run', 'indirect_selection': 'eager'}
[0m03:14:17.445362 [debug] [MainThread]: Tracking: tracking
[0m03:14:17.445745 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x110a45b80>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x110a45be0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x110a45c40>]}
[0m03:14:17.495609 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 1 files changed.
[0m03:14:17.496028 [debug] [MainThread]: Partial parsing: updated file: jaffle_shop://models/customers.py
[0m03:14:17.549122 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '21bf5df4-9aa9-4357-b751-295f69cd5610', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x110fce970>]}
[0m03:14:17.555590 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '21bf5df4-9aa9-4357-b751-295f69cd5610', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x110b6f400>]}
[0m03:14:17.555789 [info ] [MainThread]: Found 5 models, 10 tests, 0 snapshots, 0 analyses, 303 macros, 0 operations, 3 seed files, 0 sources, 0 exposures, 0 metrics
[0m03:14:17.555972 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '21bf5df4-9aa9-4357-b751-295f69cd5610', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x110f9c0a0>]}
[0m03:14:17.557136 [info ] [MainThread]: 
[0m03:14:17.557585 [debug] [MainThread]: Acquiring new snowflake connection "master"
[0m03:14:17.558333 [debug] [ThreadPool]: Acquiring new snowflake connection "list_jaffle_shop"
[0m03:14:17.570485 [debug] [ThreadPool]: Using snowflake connection "list_jaffle_shop"
[0m03:14:17.570682 [debug] [ThreadPool]: On list_jaffle_shop: /* {"app": "dbt", "dbt_version": "1.3.2", "profile_name": "jaffle_shop", "target_name": "dev", "connection_name": "list_jaffle_shop"} */
show terse schemas in database jaffle_shop
    limit 10000
[0m03:14:17.570779 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m03:14:18.375275 [debug] [ThreadPool]: SQL status: SUCCESS 3 in 0.8 seconds
[0m03:14:18.381306 [debug] [ThreadPool]: On list_jaffle_shop: Close
[0m03:14:18.780719 [debug] [ThreadPool]: Acquiring new snowflake connection "list_jaffle_shop_bruno"
[0m03:14:18.793994 [debug] [ThreadPool]: Using snowflake connection "list_jaffle_shop_bruno"
[0m03:14:18.794246 [debug] [ThreadPool]: On list_jaffle_shop_bruno: /* {"app": "dbt", "dbt_version": "1.3.2", "profile_name": "jaffle_shop", "target_name": "dev", "connection_name": "list_jaffle_shop_bruno"} */
show terse objects in jaffle_shop.bruno
[0m03:14:18.794434 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m03:14:19.486811 [debug] [ThreadPool]: SQL status: SUCCESS 6 in 0.69 seconds
[0m03:14:19.491087 [debug] [ThreadPool]: On list_jaffle_shop_bruno: Close
[0m03:14:19.823215 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '21bf5df4-9aa9-4357-b751-295f69cd5610', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x110a2f820>]}
[0m03:14:19.824639 [info ] [MainThread]: Concurrency: 1 threads (target='dev')
[0m03:14:19.825221 [info ] [MainThread]: 
[0m03:14:19.832159 [debug] [Thread-1  ]: Began running node model.jaffle_shop.customers
[0m03:14:19.832769 [info ] [Thread-1  ]: 1 of 1 START python table model bruno.customers ................................ [RUN]
[0m03:14:19.834065 [debug] [Thread-1  ]: Acquiring new snowflake connection "model.jaffle_shop.customers"
[0m03:14:19.834346 [debug] [Thread-1  ]: Began compiling node model.jaffle_shop.customers
[0m03:14:19.835327 [debug] [Thread-1  ]: Compiling model.jaffle_shop.customers
[0m03:14:19.865512 [debug] [Thread-1  ]: Writing injected SQL for node "model.jaffle_shop.customers"
[0m03:14:19.866074 [debug] [Thread-1  ]: finished collecting timing info
[0m03:14:19.866262 [debug] [Thread-1  ]: Began executing node model.jaffle_shop.customers
[0m03:14:19.899430 [debug] [Thread-1  ]: Writing runtime python for node "model.jaffle_shop.customers"
[0m03:14:19.901747 [debug] [Thread-1  ]: Using snowflake connection "model.jaffle_shop.customers"
[0m03:14:19.901942 [debug] [Thread-1  ]: On model.jaffle_shop.customers: /* {"app": "dbt", "dbt_version": "1.3.2", "profile_name": "jaffle_shop", "target_name": "dev", "node_id": "model.jaffle_shop.customers"} */
CREATE OR REPLACE PROCEDURE jaffle_shop.bruno.customers__dbt_sp ()

RETURNS STRING
LANGUAGE PYTHON
RUNTIME_VERSION = '3.8'
PACKAGES = ('snowflake-snowpark-python')

HANDLER = 'main'
EXECUTE AS CALLER
AS
$$

  
    
import snowflake.snowpark.functions as F

def model(dbt, session):

    stg_customers = dbt.ref('stg_customers')
    stg_orders = dbt.ref('stg_orders')
    stg_payments = dbt.ref('stg_payments')

    customer_orders = (
        stg_orders
        .group_by("customer_id")
        .agg(
            F.min(F.col("order_date")).alias('first_order'),
            F.max(F.col("order_date")).alias('most_recent_order'),
            F.count(F.col("order_id")).alias('number_of_orders')
        )
    )

    customer_payments = (
        stg_payments
        .join(stg_orders, stg_payments.order_id == stg_orders.order_id, "left")
        .group_by(stg_orders.customer_id)
        .agg(
            F.sum(F.col("amount")).alias('total_amount')
        )
    )

    final_df = (
        stg_customers
        .join(customer_orders, stg_customers.customer_id == customer_orders.customer_id, "left")
        .join(customer_payments, stg_customers.customer_id == customer_payments.customer_id, "left")
        .select(stg_customers.customer_id,
                stg_customers.first_name,
                stg_customers.last_name,
                customer_orders.first_order,
                customer_orders.most_recent_order,
                customer_orders.number_of_orders,
                customer_payments.total_amount.alias("customer_lifetime_value")
        )
    )

    return final_df


# This part is user provided model code
# you will need to copy the next section to run the code
# COMMAND ----------
# this part is dbt logic for get ref work, do not modify

def ref(*args,dbt_load_df_function):
    refs = {"stg_customers": "jaffle_shop.bruno.stg_customers", "stg_orders": "jaffle_shop.bruno.stg_orders", "stg_payments": "jaffle_shop.bruno.stg_payments"}
    key = ".".join(args)
    return dbt_load_df_function(refs[key])


def source(*args, dbt_load_df_function):
    sources = {}
    key = ".".join(args)
    return dbt_load_df_function(sources[key])


config_dict = {}


class config:
    def __init__(self, *args, **kwargs):
        pass

    @staticmethod
    def get(key, default=None):
        return config_dict.get(key, default)

class this:
    """dbt.this() or dbt.this.identifier"""
    database = 'jaffle_shop'
    schema = 'bruno'
    identifier = 'customers'
    def __repr__(self):
        return 'jaffle_shop.bruno.customers'


class dbtObj:
    def __init__(self, load_df_function) -> None:
        self.source = lambda *args: source(*args, dbt_load_df_function=load_df_function)
        self.ref = lambda *args: ref(*args, dbt_load_df_function=load_df_function)
        self.config = config
        self.this = this()
        self.is_incremental = False

# COMMAND ----------

# To run this in snowsight, you need to select entry point to be main
# And you may have to modify the return type to text to get the result back
# def main(session):
#     dbt = dbtObj(session.table)
#     df = model(dbt, session)
#     return df.collect()

# to run this in local notebook, you need to create a session following examples https://github.com/Snowflake-Labs/sfguide-getting-started-snowpark-python
# then you can do the following to run model
# dbt = dbtObj(session.table)
# df = model(dbt, session)


def materialize(session, df, target_relation):
    # make sure pandas exists
    import importlib.util
    package_name = 'pandas'
    if importlib.util.find_spec(package_name):
        import pandas
        if isinstance(df, pandas.core.frame.DataFrame):
          # session.write_pandas does not have overwrite function
          df = session.createDataFrame(df)
    df.write.mode("overwrite").save_as_table("jaffle_shop.bruno.customers", create_temp_table=False)

def main(session):
    dbt = dbtObj(session.table)
    df = model(dbt, session)
    materialize(session, df, dbt.this)
    return "OK"

  
$$;
[0m03:14:19.902067 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m03:14:25.537672 [debug] [Thread-1  ]: SQL status: SUCCESS 1 in 5.64 seconds
[0m03:14:25.539034 [debug] [Thread-1  ]: Using snowflake connection "model.jaffle_shop.customers"
[0m03:14:25.539560 [debug] [Thread-1  ]: On model.jaffle_shop.customers: /* {"app": "dbt", "dbt_version": "1.3.2", "profile_name": "jaffle_shop", "target_name": "dev", "node_id": "model.jaffle_shop.customers"} */
CALL jaffle_shop.bruno.customers__dbt_sp();
[0m03:14:27.888633 [debug] [Thread-1  ]: SQL status: SUCCESS 1 in 2.35 seconds
[0m03:14:27.891134 [debug] [Thread-1  ]: Using snowflake connection "model.jaffle_shop.customers"
[0m03:14:27.891361 [debug] [Thread-1  ]: On model.jaffle_shop.customers: /* {"app": "dbt", "dbt_version": "1.3.2", "profile_name": "jaffle_shop", "target_name": "dev", "node_id": "model.jaffle_shop.customers"} */
drop procedure if exists jaffle_shop.bruno.customers__dbt_sp()
[0m03:14:28.096556 [debug] [Thread-1  ]: SQL status: SUCCESS 1 in 0.2 seconds
[0m03:14:28.139985 [debug] [Thread-1  ]: finished collecting timing info
[0m03:14:28.140386 [debug] [Thread-1  ]: On model.jaffle_shop.customers: Close
[0m03:14:28.561601 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '21bf5df4-9aa9-4357-b751-295f69cd5610', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1126a0760>]}
[0m03:14:28.562558 [info ] [Thread-1  ]: 1 of 1 OK created python table model bruno.customers ........................... [[32mSUCCESS 1[0m in 8.73s]
[0m03:14:28.563646 [debug] [Thread-1  ]: Finished running node model.jaffle_shop.customers
[0m03:14:28.566473 [debug] [MainThread]: Acquiring new snowflake connection "master"
[0m03:14:28.567489 [info ] [MainThread]: 
[0m03:14:28.567992 [info ] [MainThread]: Finished running 1 table model in 0 hours 0 minutes and 11.01 seconds (11.01s).
[0m03:14:28.568462 [debug] [MainThread]: Connection 'master' was properly closed.
[0m03:14:28.568702 [debug] [MainThread]: Connection 'model.jaffle_shop.customers' was properly closed.
[0m03:14:28.584345 [info ] [MainThread]: 
[0m03:14:28.584854 [info ] [MainThread]: [32mCompleted successfully[0m
[0m03:14:28.585266 [info ] [MainThread]: 
[0m03:14:28.585591 [info ] [MainThread]: Done. PASS=1 WARN=0 ERROR=0 SKIP=0 TOTAL=1
[0m03:14:28.586062 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x110b6f2e0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x110b2d490>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x11263ee20>]}
[0m03:14:28.586447 [debug] [MainThread]: Flushing usage events


============================== 2023-01-24 03:17:40.403450 | e045ab28-3eeb-4871-86e2-5b6dca794a4f ==============================
[0m03:17:40.403509 [info ] [MainThread]: Running with dbt=1.3.2
[0m03:17:40.404349 [debug] [MainThread]: running dbt with arguments {'write_json': True, 'use_colors': True, 'printer_width': 80, 'version_check': True, 'partial_parse': True, 'static_parser': True, 'profiles_dir': '/Users/bruno/.dbt', 'send_anonymous_usage_stats': True, 'event_buffer_size': 100000, 'quiet': False, 'no_print': False, 'cache_selected_only': False, 'select': ['customers.py'], 'which': 'run', 'rpc_method': 'run', 'indirect_selection': 'eager'}
[0m03:17:40.404505 [debug] [MainThread]: Tracking: tracking
[0m03:17:40.404846 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x112114b80>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x112114be0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x112114c40>]}
[0m03:17:40.460391 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 1 files changed.
[0m03:17:40.460796 [debug] [MainThread]: Partial parsing: updated file: jaffle_shop://models/customers.py
[0m03:17:40.515609 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': 'e045ab28-3eeb-4871-86e2-5b6dca794a4f', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x112696970>]}
[0m03:17:40.522247 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': 'e045ab28-3eeb-4871-86e2-5b6dca794a4f', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x11223a400>]}
[0m03:17:40.522444 [info ] [MainThread]: Found 5 models, 10 tests, 0 snapshots, 0 analyses, 303 macros, 0 operations, 3 seed files, 0 sources, 0 exposures, 0 metrics
[0m03:17:40.522627 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'e045ab28-3eeb-4871-86e2-5b6dca794a4f', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1126680a0>]}
[0m03:17:40.523759 [info ] [MainThread]: 
[0m03:17:40.524224 [debug] [MainThread]: Acquiring new snowflake connection "master"
[0m03:17:40.524968 [debug] [ThreadPool]: Acquiring new snowflake connection "list_jaffle_shop"
[0m03:17:40.536866 [debug] [ThreadPool]: Using snowflake connection "list_jaffle_shop"
[0m03:17:40.537060 [debug] [ThreadPool]: On list_jaffle_shop: /* {"app": "dbt", "dbt_version": "1.3.2", "profile_name": "jaffle_shop", "target_name": "dev", "connection_name": "list_jaffle_shop"} */
show terse schemas in database jaffle_shop
    limit 10000
[0m03:17:40.537157 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m03:17:41.779248 [debug] [ThreadPool]: SQL status: SUCCESS 3 in 1.24 seconds
[0m03:17:41.783879 [debug] [ThreadPool]: On list_jaffle_shop: Close
[0m03:17:42.145444 [debug] [ThreadPool]: Acquiring new snowflake connection "list_jaffle_shop_bruno"
[0m03:17:42.159809 [debug] [ThreadPool]: Using snowflake connection "list_jaffle_shop_bruno"
[0m03:17:42.160100 [debug] [ThreadPool]: On list_jaffle_shop_bruno: /* {"app": "dbt", "dbt_version": "1.3.2", "profile_name": "jaffle_shop", "target_name": "dev", "connection_name": "list_jaffle_shop_bruno"} */
show terse objects in jaffle_shop.bruno
[0m03:17:42.160322 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m03:17:42.750092 [debug] [ThreadPool]: SQL status: SUCCESS 7 in 0.59 seconds
[0m03:17:42.755082 [debug] [ThreadPool]: On list_jaffle_shop_bruno: Close
[0m03:17:43.093164 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'e045ab28-3eeb-4871-86e2-5b6dca794a4f', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1120fb820>]}
[0m03:17:43.094707 [info ] [MainThread]: Concurrency: 1 threads (target='dev')
[0m03:17:43.095264 [info ] [MainThread]: 
[0m03:17:43.101730 [debug] [Thread-1  ]: Began running node model.jaffle_shop.customers
[0m03:17:43.102304 [info ] [Thread-1  ]: 1 of 1 START python table model bruno.customers ................................ [RUN]
[0m03:17:43.103427 [debug] [Thread-1  ]: Acquiring new snowflake connection "model.jaffle_shop.customers"
[0m03:17:43.103687 [debug] [Thread-1  ]: Began compiling node model.jaffle_shop.customers
[0m03:17:43.104512 [debug] [Thread-1  ]: Compiling model.jaffle_shop.customers
[0m03:17:43.132803 [debug] [Thread-1  ]: Writing injected SQL for node "model.jaffle_shop.customers"
[0m03:17:43.134039 [debug] [Thread-1  ]: finished collecting timing info
[0m03:17:43.134234 [debug] [Thread-1  ]: Began executing node model.jaffle_shop.customers
[0m03:17:43.165596 [debug] [Thread-1  ]: Writing runtime python for node "model.jaffle_shop.customers"
[0m03:17:43.167833 [debug] [Thread-1  ]: Using snowflake connection "model.jaffle_shop.customers"
[0m03:17:43.167949 [debug] [Thread-1  ]: On model.jaffle_shop.customers: /* {"app": "dbt", "dbt_version": "1.3.2", "profile_name": "jaffle_shop", "target_name": "dev", "node_id": "model.jaffle_shop.customers"} */
CREATE OR REPLACE PROCEDURE jaffle_shop.bruno.customers__dbt_sp ()

RETURNS STRING
LANGUAGE PYTHON
RUNTIME_VERSION = '3.8'
PACKAGES = ('snowflake-snowpark-python')

HANDLER = 'main'
EXECUTE AS CALLER
AS
$$

  
    
import snowflake.snowpark.functions as F

def model(dbt, session):

    stg_customers = dbt.ref('stg_customers')
    stg_orders = dbt.ref('stg_orders')
    stg_payments = dbt.ref('stg_payments')

    customer_orders = (
        stg_orders
        .group_by("customer_id")
        .agg(
            F.min(F.col("order_date")).alias('first_order'),
            F.max(F.col("order_date")).alias('most_recent_order'),
            F.count(F.col("order_id")).alias('number_of_orders')
        )
    )

    customer_payments = (
        stg_payments
        .join(stg_orders, stg_payments.order_id == stg_orders.order_id, "left")
        .group_by(stg_orders.customer_id)
        .agg(
            F.sum(F.col("amount")).alias('total_amount')
        )
    )

    final_df = (
        stg_customers
        .join(customer_orders, stg_customers.customer_id == customer_orders.customer_id, "left")
        .join(customer_payments, stg_customers.customer_id == customer_payments.customer_id, "left")
        .select(stg_customers.customer_id.alias("customer_id"),
                stg_customers.first_name.alias("first_name"),
                stg_customers.last_name.alias("last_name"),
                customer_orders.first_order.alias("first_order"),
                customer_orders.most_recent_order.alias("most_recent_order"),
                customer_orders.number_of_orders.alias("number_of_orders"),
                customer_payments.total_amount.alias("customer_lifetime_value")
        )
    )

    return final_df


# This part is user provided model code
# you will need to copy the next section to run the code
# COMMAND ----------
# this part is dbt logic for get ref work, do not modify

def ref(*args,dbt_load_df_function):
    refs = {"stg_customers": "jaffle_shop.bruno.stg_customers", "stg_orders": "jaffle_shop.bruno.stg_orders", "stg_payments": "jaffle_shop.bruno.stg_payments"}
    key = ".".join(args)
    return dbt_load_df_function(refs[key])


def source(*args, dbt_load_df_function):
    sources = {}
    key = ".".join(args)
    return dbt_load_df_function(sources[key])


config_dict = {}


class config:
    def __init__(self, *args, **kwargs):
        pass

    @staticmethod
    def get(key, default=None):
        return config_dict.get(key, default)

class this:
    """dbt.this() or dbt.this.identifier"""
    database = 'jaffle_shop'
    schema = 'bruno'
    identifier = 'customers'
    def __repr__(self):
        return 'jaffle_shop.bruno.customers'


class dbtObj:
    def __init__(self, load_df_function) -> None:
        self.source = lambda *args: source(*args, dbt_load_df_function=load_df_function)
        self.ref = lambda *args: ref(*args, dbt_load_df_function=load_df_function)
        self.config = config
        self.this = this()
        self.is_incremental = False

# COMMAND ----------

# To run this in snowsight, you need to select entry point to be main
# And you may have to modify the return type to text to get the result back
# def main(session):
#     dbt = dbtObj(session.table)
#     df = model(dbt, session)
#     return df.collect()

# to run this in local notebook, you need to create a session following examples https://github.com/Snowflake-Labs/sfguide-getting-started-snowpark-python
# then you can do the following to run model
# dbt = dbtObj(session.table)
# df = model(dbt, session)


def materialize(session, df, target_relation):
    # make sure pandas exists
    import importlib.util
    package_name = 'pandas'
    if importlib.util.find_spec(package_name):
        import pandas
        if isinstance(df, pandas.core.frame.DataFrame):
          # session.write_pandas does not have overwrite function
          df = session.createDataFrame(df)
    df.write.mode("overwrite").save_as_table("jaffle_shop.bruno.customers", create_temp_table=False)

def main(session):
    dbt = dbtObj(session.table)
    df = model(dbt, session)
    materialize(session, df, dbt.this)
    return "OK"

  
$$;
[0m03:17:43.168052 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m03:17:48.706518 [debug] [Thread-1  ]: SQL status: SUCCESS 1 in 5.54 seconds
[0m03:17:48.707566 [debug] [Thread-1  ]: Using snowflake connection "model.jaffle_shop.customers"
[0m03:17:48.708215 [debug] [Thread-1  ]: On model.jaffle_shop.customers: /* {"app": "dbt", "dbt_version": "1.3.2", "profile_name": "jaffle_shop", "target_name": "dev", "node_id": "model.jaffle_shop.customers"} */
CALL jaffle_shop.bruno.customers__dbt_sp();
[0m03:17:50.918784 [debug] [Thread-1  ]: SQL status: SUCCESS 1 in 2.21 seconds
[0m03:17:50.922930 [debug] [Thread-1  ]: Using snowflake connection "model.jaffle_shop.customers"
[0m03:17:50.923463 [debug] [Thread-1  ]: On model.jaffle_shop.customers: /* {"app": "dbt", "dbt_version": "1.3.2", "profile_name": "jaffle_shop", "target_name": "dev", "node_id": "model.jaffle_shop.customers"} */
drop procedure if exists jaffle_shop.bruno.customers__dbt_sp()
[0m03:17:51.104636 [debug] [Thread-1  ]: SQL status: SUCCESS 1 in 0.18 seconds
[0m03:17:51.151654 [debug] [Thread-1  ]: finished collecting timing info
[0m03:17:51.151951 [debug] [Thread-1  ]: On model.jaffle_shop.customers: Close
[0m03:17:51.496279 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'e045ab28-3eeb-4871-86e2-5b6dca794a4f', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1138f69a0>]}
[0m03:17:51.496974 [info ] [Thread-1  ]: 1 of 1 OK created python table model bruno.customers ........................... [[32mSUCCESS 1[0m in 8.39s]
[0m03:17:51.497857 [debug] [Thread-1  ]: Finished running node model.jaffle_shop.customers
[0m03:17:51.500426 [debug] [MainThread]: Acquiring new snowflake connection "master"
[0m03:17:51.501268 [info ] [MainThread]: 
[0m03:17:51.501682 [info ] [MainThread]: Finished running 1 table model in 0 hours 0 minutes and 10.98 seconds (10.98s).
[0m03:17:51.502071 [debug] [MainThread]: Connection 'master' was properly closed.
[0m03:17:51.502261 [debug] [MainThread]: Connection 'model.jaffle_shop.customers' was properly closed.
[0m03:17:51.516219 [info ] [MainThread]: 
[0m03:17:51.516624 [info ] [MainThread]: [32mCompleted successfully[0m
[0m03:17:51.516964 [info ] [MainThread]: 
[0m03:17:51.517234 [info ] [MainThread]: Done. PASS=1 WARN=0 ERROR=0 SKIP=0 TOTAL=1
[0m03:17:51.517616 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1120f3190>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1127425b0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x11394aeb0>]}
[0m03:17:51.517939 [debug] [MainThread]: Flushing usage events


============================== 2023-01-24 03:23:37.919535 | 3634acb7-181b-48bd-b2ab-cc77405806f7 ==============================
[0m03:23:37.919600 [info ] [MainThread]: Running with dbt=1.3.2
[0m03:23:37.920583 [debug] [MainThread]: running dbt with arguments {'write_json': True, 'use_colors': True, 'printer_width': 80, 'version_check': True, 'partial_parse': True, 'static_parser': True, 'profiles_dir': '/Users/bruno/.dbt', 'send_anonymous_usage_stats': True, 'event_buffer_size': 100000, 'quiet': False, 'no_print': False, 'cache_selected_only': False, 'select': ['orders.py'], 'which': 'run', 'rpc_method': 'run', 'indirect_selection': 'eager'}
[0m03:23:37.920727 [debug] [MainThread]: Tracking: tracking
[0m03:23:37.921083 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10e68bbb0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10e68bc10>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10e68bc70>]}
[0m03:23:37.976249 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 1 files changed.
[0m03:23:37.976639 [debug] [MainThread]: Partial parsing: updated file: jaffle_shop://models/orders.py
[0m03:23:38.014065 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '3634acb7-181b-48bd-b2ab-cc77405806f7', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10ee440a0>]}
[0m03:23:38.020300 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '3634acb7-181b-48bd-b2ab-cc77405806f7', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10e6757f0>]}
[0m03:23:38.020500 [info ] [MainThread]: Found 5 models, 10 tests, 0 snapshots, 0 analyses, 303 macros, 0 operations, 3 seed files, 0 sources, 0 exposures, 0 metrics
[0m03:23:38.020678 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '3634acb7-181b-48bd-b2ab-cc77405806f7', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10ee1c1c0>]}
[0m03:23:38.021823 [info ] [MainThread]: 
[0m03:23:38.022270 [debug] [MainThread]: Acquiring new snowflake connection "master"
[0m03:23:38.023016 [debug] [ThreadPool]: Acquiring new snowflake connection "list_jaffle_shop"
[0m03:23:38.035254 [debug] [ThreadPool]: Using snowflake connection "list_jaffle_shop"
[0m03:23:38.035438 [debug] [ThreadPool]: On list_jaffle_shop: /* {"app": "dbt", "dbt_version": "1.3.2", "profile_name": "jaffle_shop", "target_name": "dev", "connection_name": "list_jaffle_shop"} */
show terse schemas in database jaffle_shop
    limit 10000
[0m03:23:38.035535 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m03:23:39.093258 [debug] [ThreadPool]: SQL status: SUCCESS 3 in 1.06 seconds
[0m03:23:39.097719 [debug] [ThreadPool]: On list_jaffle_shop: Close
[0m03:23:39.449939 [debug] [ThreadPool]: Acquiring new snowflake connection "list_jaffle_shop_bruno"
[0m03:23:39.460120 [debug] [ThreadPool]: Using snowflake connection "list_jaffle_shop_bruno"
[0m03:23:39.460332 [debug] [ThreadPool]: On list_jaffle_shop_bruno: /* {"app": "dbt", "dbt_version": "1.3.2", "profile_name": "jaffle_shop", "target_name": "dev", "connection_name": "list_jaffle_shop_bruno"} */
show terse objects in jaffle_shop.bruno
[0m03:23:39.460500 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m03:23:40.142234 [debug] [ThreadPool]: SQL status: SUCCESS 7 in 0.68 seconds
[0m03:23:40.147874 [debug] [ThreadPool]: On list_jaffle_shop_bruno: Close
[0m03:23:40.484718 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '3634acb7-181b-48bd-b2ab-cc77405806f7', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10eef5730>]}
[0m03:23:40.486355 [info ] [MainThread]: Concurrency: 1 threads (target='dev')
[0m03:23:40.486921 [info ] [MainThread]: 
[0m03:23:40.494200 [debug] [Thread-1  ]: Began running node model.jaffle_shop.orders
[0m03:23:40.494884 [info ] [Thread-1  ]: 1 of 1 START python table model bruno.orders ................................... [RUN]
[0m03:23:40.496108 [debug] [Thread-1  ]: Acquiring new snowflake connection "model.jaffle_shop.orders"
[0m03:23:40.496376 [debug] [Thread-1  ]: Began compiling node model.jaffle_shop.orders
[0m03:23:40.497309 [debug] [Thread-1  ]: Compiling model.jaffle_shop.orders
[0m03:23:40.527525 [debug] [Thread-1  ]: Writing injected SQL for node "model.jaffle_shop.orders"
[0m03:23:40.528707 [debug] [Thread-1  ]: finished collecting timing info
[0m03:23:40.528920 [debug] [Thread-1  ]: Began executing node model.jaffle_shop.orders
[0m03:23:40.562850 [debug] [Thread-1  ]: Writing runtime python for node "model.jaffle_shop.orders"
[0m03:23:40.564959 [debug] [Thread-1  ]: Using snowflake connection "model.jaffle_shop.orders"
[0m03:23:40.565074 [debug] [Thread-1  ]: On model.jaffle_shop.orders: /* {"app": "dbt", "dbt_version": "1.3.2", "profile_name": "jaffle_shop", "target_name": "dev", "node_id": "model.jaffle_shop.orders"} */
CREATE OR REPLACE PROCEDURE jaffle_shop.bruno.orders__dbt_sp ()

RETURNS STRING
LANGUAGE PYTHON
RUNTIME_VERSION = '3.8'
PACKAGES = ('snowflake-snowpark-python')

HANDLER = 'main'
EXECUTE AS CALLER
AS
$$

  
    
import snowflake.snowpark.functions as F

def model(dbt, session):

    stg_orders = dbt.ref('stg_orders')
    stg_payments = dbt.ref('stg_payments')

    payment_methods = ['credit_card', 'coupon', 'bank_transfer', 'gift_card']

    agg_list = [F.sum(F.when(stg_payments.payment_method == payment_method, stg_payments.amount).otherwise(0)).alias(payment_method + "_amount") for payment_method in payment_methods]

    agg_list.append(F.sum(F.col("amount")).alias("total_amount"))

    order_payments = (
        stg_payments
        .groupby("order_id")
        .agg(*agg_list)
    )

    final_df = (
        stg_orders
        .join(order_payments, stg_orders.order_id == order_payments.order_id, "left")
        .select(stg_orders.order_id.alias("order_id"),
                stg_orders.customer_id.alias("customer_id"),
                stg_orders.order_date.alias("order_date"),
                stg_orders.status.alias("status"),
                *[F.col(payment_method + "_amount") for payment_method in payment_methods],
                order_payments.total_amount.alias("amount")
        )
    )

    return final_df


# This part is user provided model code
# you will need to copy the next section to run the code
# COMMAND ----------
# this part is dbt logic for get ref work, do not modify

def ref(*args,dbt_load_df_function):
    refs = {"stg_orders": "jaffle_shop.bruno.stg_orders", "stg_payments": "jaffle_shop.bruno.stg_payments"}
    key = ".".join(args)
    return dbt_load_df_function(refs[key])


def source(*args, dbt_load_df_function):
    sources = {}
    key = ".".join(args)
    return dbt_load_df_function(sources[key])


config_dict = {}


class config:
    def __init__(self, *args, **kwargs):
        pass

    @staticmethod
    def get(key, default=None):
        return config_dict.get(key, default)

class this:
    """dbt.this() or dbt.this.identifier"""
    database = 'jaffle_shop'
    schema = 'bruno'
    identifier = 'orders'
    def __repr__(self):
        return 'jaffle_shop.bruno.orders'


class dbtObj:
    def __init__(self, load_df_function) -> None:
        self.source = lambda *args: source(*args, dbt_load_df_function=load_df_function)
        self.ref = lambda *args: ref(*args, dbt_load_df_function=load_df_function)
        self.config = config
        self.this = this()
        self.is_incremental = False

# COMMAND ----------

# To run this in snowsight, you need to select entry point to be main
# And you may have to modify the return type to text to get the result back
# def main(session):
#     dbt = dbtObj(session.table)
#     df = model(dbt, session)
#     return df.collect()

# to run this in local notebook, you need to create a session following examples https://github.com/Snowflake-Labs/sfguide-getting-started-snowpark-python
# then you can do the following to run model
# dbt = dbtObj(session.table)
# df = model(dbt, session)


def materialize(session, df, target_relation):
    # make sure pandas exists
    import importlib.util
    package_name = 'pandas'
    if importlib.util.find_spec(package_name):
        import pandas
        if isinstance(df, pandas.core.frame.DataFrame):
          # session.write_pandas does not have overwrite function
          df = session.createDataFrame(df)
    df.write.mode("overwrite").save_as_table("jaffle_shop.bruno.orders", create_temp_table=False)

def main(session):
    dbt = dbtObj(session.table)
    df = model(dbt, session)
    materialize(session, df, dbt.this)
    return "OK"

  
$$;
[0m03:23:40.565181 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m03:23:46.285572 [debug] [Thread-1  ]: SQL status: SUCCESS 1 in 5.72 seconds
[0m03:23:46.286825 [debug] [Thread-1  ]: Using snowflake connection "model.jaffle_shop.orders"
[0m03:23:46.287145 [debug] [Thread-1  ]: On model.jaffle_shop.orders: /* {"app": "dbt", "dbt_version": "1.3.2", "profile_name": "jaffle_shop", "target_name": "dev", "node_id": "model.jaffle_shop.orders"} */
CALL jaffle_shop.bruno.orders__dbt_sp();
[0m03:23:47.240306 [debug] [Thread-1  ]: Snowflake adapter: Snowflake query id: 01a9daeb-0000-0c55-0000-0000468d2899
[0m03:23:47.240526 [debug] [Thread-1  ]: Snowflake adapter: Snowflake error: 100357 (P0000): Python Interpreter Error:
Traceback (most recent call last):
  File "_udf_code.py", line 112, in main
  File "_udf_code.py", line 19, in model
  File "/usr/lib/python_udf/6cd8c5edb748108566a6331991a1dbb5d219039edc8195c97d7681b3bda325d2/lib/python3.8/site-packages/snowflake/snowpark/dataframe.py", line 848, in __getattr__
    raise AttributeError(
AttributeError: Table object has no attribute groupby
 in function ORDERS__DBT_SP with handler main
[0m03:23:47.240824 [debug] [Thread-1  ]: finished collecting timing info
[0m03:23:47.240977 [debug] [Thread-1  ]: On model.jaffle_shop.orders: Close
[0m03:23:47.620927 [debug] [Thread-1  ]: Database Error in model orders (models/orders.py)
  100357 (P0000): Python Interpreter Error:
  Traceback (most recent call last):
    File "_udf_code.py", line 112, in main
    File "_udf_code.py", line 19, in model
    File "/usr/lib/python_udf/6cd8c5edb748108566a6331991a1dbb5d219039edc8195c97d7681b3bda325d2/lib/python3.8/site-packages/snowflake/snowpark/dataframe.py", line 848, in __getattr__
      raise AttributeError(
  AttributeError: Table object has no attribute groupby
   in function ORDERS__DBT_SP with handler main
  compiled Code at target/run/jaffle_shop/models/orders.py
[0m03:23:47.621780 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '3634acb7-181b-48bd-b2ab-cc77405806f7', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10fe63d30>]}
[0m03:23:47.622483 [error] [Thread-1  ]: 1 of 1 ERROR creating python table model bruno.orders .......................... [[31mERROR[0m in 7.13s]
[0m03:23:47.623378 [debug] [Thread-1  ]: Finished running node model.jaffle_shop.orders
[0m03:23:47.626567 [debug] [MainThread]: Acquiring new snowflake connection "master"
[0m03:23:47.627614 [info ] [MainThread]: 
[0m03:23:47.628141 [info ] [MainThread]: Finished running 1 table model in 0 hours 0 minutes and 9.61 seconds (9.61s).
[0m03:23:47.628615 [debug] [MainThread]: Connection 'master' was properly closed.
[0m03:23:47.628856 [debug] [MainThread]: Connection 'model.jaffle_shop.orders' was properly closed.
[0m03:23:47.643789 [info ] [MainThread]: 
[0m03:23:47.644237 [info ] [MainThread]: [31mCompleted with 1 error and 0 warnings:[0m
[0m03:23:47.644619 [info ] [MainThread]: 
[0m03:23:47.644934 [error] [MainThread]: [33mDatabase Error in model orders (models/orders.py)[0m
[0m03:23:47.645233 [error] [MainThread]:   100357 (P0000): Python Interpreter Error:
[0m03:23:47.645511 [error] [MainThread]:   Traceback (most recent call last):
[0m03:23:47.645789 [error] [MainThread]:     File "_udf_code.py", line 112, in main
[0m03:23:47.646064 [error] [MainThread]:     File "_udf_code.py", line 19, in model
[0m03:23:47.646339 [error] [MainThread]:     File "/usr/lib/python_udf/6cd8c5edb748108566a6331991a1dbb5d219039edc8195c97d7681b3bda325d2/lib/python3.8/site-packages/snowflake/snowpark/dataframe.py", line 848, in __getattr__
[0m03:23:47.646620 [error] [MainThread]:       raise AttributeError(
[0m03:23:47.646896 [error] [MainThread]:   AttributeError: Table object has no attribute groupby
[0m03:23:47.647172 [error] [MainThread]:    in function ORDERS__DBT_SP with handler main
[0m03:23:47.647447 [error] [MainThread]:   compiled Code at target/run/jaffle_shop/models/orders.py
[0m03:23:47.647745 [info ] [MainThread]: 
[0m03:23:47.648057 [info ] [MainThread]: Done. PASS=0 WARN=0 ERROR=1 SKIP=0 TOTAL=1
[0m03:23:47.648509 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10e6c7760>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10fe52610>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10fe63f40>]}
[0m03:23:47.648851 [debug] [MainThread]: Flushing usage events


============================== 2023-01-24 03:24:05.914571 | 84a5a658-43b4-4bf7-993b-8f20cc8e3e7c ==============================
[0m03:24:05.914659 [info ] [MainThread]: Running with dbt=1.3.2
[0m03:24:05.915709 [debug] [MainThread]: running dbt with arguments {'write_json': True, 'use_colors': True, 'printer_width': 80, 'version_check': True, 'partial_parse': True, 'static_parser': True, 'profiles_dir': '/Users/bruno/.dbt', 'send_anonymous_usage_stats': True, 'event_buffer_size': 100000, 'quiet': False, 'no_print': False, 'cache_selected_only': False, 'select': ['orders.py'], 'which': 'run', 'rpc_method': 'run', 'indirect_selection': 'eager'}
[0m03:24:05.915868 [debug] [MainThread]: Tracking: tracking
[0m03:24:05.916268 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10fcfdbb0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10fcfdc10>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10fcfdc70>]}
[0m03:24:05.970412 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 1 files changed.
[0m03:24:05.970782 [debug] [MainThread]: Partial parsing: updated file: jaffle_shop://models/orders.py
[0m03:24:06.007217 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '84a5a658-43b4-4bf7-993b-8f20cc8e3e7c', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x11027a7c0>]}
[0m03:24:06.013474 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '84a5a658-43b4-4bf7-993b-8f20cc8e3e7c', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10fe28430>]}
[0m03:24:06.013669 [info ] [MainThread]: Found 5 models, 10 tests, 0 snapshots, 0 analyses, 303 macros, 0 operations, 3 seed files, 0 sources, 0 exposures, 0 metrics
[0m03:24:06.013855 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '84a5a658-43b4-4bf7-993b-8f20cc8e3e7c', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1102561c0>]}
[0m03:24:06.014975 [info ] [MainThread]: 
[0m03:24:06.015446 [debug] [MainThread]: Acquiring new snowflake connection "master"
[0m03:24:06.016203 [debug] [ThreadPool]: Acquiring new snowflake connection "list_jaffle_shop"
[0m03:24:06.028017 [debug] [ThreadPool]: Using snowflake connection "list_jaffle_shop"
[0m03:24:06.028232 [debug] [ThreadPool]: On list_jaffle_shop: /* {"app": "dbt", "dbt_version": "1.3.2", "profile_name": "jaffle_shop", "target_name": "dev", "connection_name": "list_jaffle_shop"} */
show terse schemas in database jaffle_shop
    limit 10000
[0m03:24:06.028343 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m03:24:07.066660 [debug] [ThreadPool]: SQL status: SUCCESS 3 in 1.04 seconds
[0m03:24:07.071708 [debug] [ThreadPool]: On list_jaffle_shop: Close
[0m03:24:07.489835 [debug] [ThreadPool]: Acquiring new snowflake connection "list_jaffle_shop_bruno"
[0m03:24:07.503750 [debug] [ThreadPool]: Using snowflake connection "list_jaffle_shop_bruno"
[0m03:24:07.504037 [debug] [ThreadPool]: On list_jaffle_shop_bruno: /* {"app": "dbt", "dbt_version": "1.3.2", "profile_name": "jaffle_shop", "target_name": "dev", "connection_name": "list_jaffle_shop_bruno"} */
show terse objects in jaffle_shop.bruno
[0m03:24:07.504269 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m03:24:08.295414 [debug] [ThreadPool]: SQL status: SUCCESS 7 in 0.79 seconds
[0m03:24:08.301134 [debug] [ThreadPool]: On list_jaffle_shop_bruno: Close
[0m03:24:08.630491 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '84a5a658-43b4-4bf7-993b-8f20cc8e3e7c', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1102eb220>]}
[0m03:24:08.631957 [info ] [MainThread]: Concurrency: 1 threads (target='dev')
[0m03:24:08.632547 [info ] [MainThread]: 
[0m03:24:08.639572 [debug] [Thread-1  ]: Began running node model.jaffle_shop.orders
[0m03:24:08.640079 [info ] [Thread-1  ]: 1 of 1 START python table model bruno.orders ................................... [RUN]
[0m03:24:08.641157 [debug] [Thread-1  ]: Acquiring new snowflake connection "model.jaffle_shop.orders"
[0m03:24:08.641410 [debug] [Thread-1  ]: Began compiling node model.jaffle_shop.orders
[0m03:24:08.642226 [debug] [Thread-1  ]: Compiling model.jaffle_shop.orders
[0m03:24:08.671765 [debug] [Thread-1  ]: Writing injected SQL for node "model.jaffle_shop.orders"
[0m03:24:08.672374 [debug] [Thread-1  ]: finished collecting timing info
[0m03:24:08.672556 [debug] [Thread-1  ]: Began executing node model.jaffle_shop.orders
[0m03:24:08.705980 [debug] [Thread-1  ]: Writing runtime python for node "model.jaffle_shop.orders"
[0m03:24:08.708023 [debug] [Thread-1  ]: Using snowflake connection "model.jaffle_shop.orders"
[0m03:24:08.708137 [debug] [Thread-1  ]: On model.jaffle_shop.orders: /* {"app": "dbt", "dbt_version": "1.3.2", "profile_name": "jaffle_shop", "target_name": "dev", "node_id": "model.jaffle_shop.orders"} */
CREATE OR REPLACE PROCEDURE jaffle_shop.bruno.orders__dbt_sp ()

RETURNS STRING
LANGUAGE PYTHON
RUNTIME_VERSION = '3.8'
PACKAGES = ('snowflake-snowpark-python')

HANDLER = 'main'
EXECUTE AS CALLER
AS
$$

  
    
import snowflake.snowpark.functions as F

def model(dbt, session):

    stg_orders = dbt.ref('stg_orders')
    stg_payments = dbt.ref('stg_payments')

    payment_methods = ['credit_card', 'coupon', 'bank_transfer', 'gift_card']

    agg_list = [F.sum(F.when(stg_payments.payment_method == payment_method, stg_payments.amount).otherwise(0)).alias(payment_method + "_amount") for payment_method in payment_methods]

    agg_list.append(F.sum(F.col("amount")).alias("total_amount"))

    order_payments = (
        stg_payments
        .group_by("order_id")
        .agg(*agg_list)
    )

    final_df = (
        stg_orders
        .join(order_payments, stg_orders.order_id == order_payments.order_id, "left")
        .select(stg_orders.order_id.alias("order_id"),
                stg_orders.customer_id.alias("customer_id"),
                stg_orders.order_date.alias("order_date"),
                stg_orders.status.alias("status"),
                *[F.col(payment_method + "_amount") for payment_method in payment_methods],
                order_payments.total_amount.alias("amount")
        )
    )

    return final_df


# This part is user provided model code
# you will need to copy the next section to run the code
# COMMAND ----------
# this part is dbt logic for get ref work, do not modify

def ref(*args,dbt_load_df_function):
    refs = {"stg_orders": "jaffle_shop.bruno.stg_orders", "stg_payments": "jaffle_shop.bruno.stg_payments"}
    key = ".".join(args)
    return dbt_load_df_function(refs[key])


def source(*args, dbt_load_df_function):
    sources = {}
    key = ".".join(args)
    return dbt_load_df_function(sources[key])


config_dict = {}


class config:
    def __init__(self, *args, **kwargs):
        pass

    @staticmethod
    def get(key, default=None):
        return config_dict.get(key, default)

class this:
    """dbt.this() or dbt.this.identifier"""
    database = 'jaffle_shop'
    schema = 'bruno'
    identifier = 'orders'
    def __repr__(self):
        return 'jaffle_shop.bruno.orders'


class dbtObj:
    def __init__(self, load_df_function) -> None:
        self.source = lambda *args: source(*args, dbt_load_df_function=load_df_function)
        self.ref = lambda *args: ref(*args, dbt_load_df_function=load_df_function)
        self.config = config
        self.this = this()
        self.is_incremental = False

# COMMAND ----------

# To run this in snowsight, you need to select entry point to be main
# And you may have to modify the return type to text to get the result back
# def main(session):
#     dbt = dbtObj(session.table)
#     df = model(dbt, session)
#     return df.collect()

# to run this in local notebook, you need to create a session following examples https://github.com/Snowflake-Labs/sfguide-getting-started-snowpark-python
# then you can do the following to run model
# dbt = dbtObj(session.table)
# df = model(dbt, session)


def materialize(session, df, target_relation):
    # make sure pandas exists
    import importlib.util
    package_name = 'pandas'
    if importlib.util.find_spec(package_name):
        import pandas
        if isinstance(df, pandas.core.frame.DataFrame):
          # session.write_pandas does not have overwrite function
          df = session.createDataFrame(df)
    df.write.mode("overwrite").save_as_table("jaffle_shop.bruno.orders", create_temp_table=False)

def main(session):
    dbt = dbtObj(session.table)
    df = model(dbt, session)
    materialize(session, df, dbt.this)
    return "OK"

  
$$;
[0m03:24:08.708238 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m03:24:14.159124 [debug] [Thread-1  ]: SQL status: SUCCESS 1 in 5.45 seconds
[0m03:24:14.160350 [debug] [Thread-1  ]: Using snowflake connection "model.jaffle_shop.orders"
[0m03:24:14.160805 [debug] [Thread-1  ]: On model.jaffle_shop.orders: /* {"app": "dbt", "dbt_version": "1.3.2", "profile_name": "jaffle_shop", "target_name": "dev", "node_id": "model.jaffle_shop.orders"} */
CALL jaffle_shop.bruno.orders__dbt_sp();
[0m03:24:15.981672 [debug] [Thread-1  ]: SQL status: SUCCESS 1 in 1.82 seconds
[0m03:24:15.985143 [debug] [Thread-1  ]: Using snowflake connection "model.jaffle_shop.orders"
[0m03:24:15.985948 [debug] [Thread-1  ]: On model.jaffle_shop.orders: /* {"app": "dbt", "dbt_version": "1.3.2", "profile_name": "jaffle_shop", "target_name": "dev", "node_id": "model.jaffle_shop.orders"} */
drop procedure if exists jaffle_shop.bruno.orders__dbt_sp()
[0m03:24:16.286429 [debug] [Thread-1  ]: SQL status: SUCCESS 1 in 0.3 seconds
[0m03:24:16.325674 [debug] [Thread-1  ]: finished collecting timing info
[0m03:24:16.325964 [debug] [Thread-1  ]: On model.jaffle_shop.orders: Close
[0m03:24:16.783429 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '84a5a658-43b4-4bf7-993b-8f20cc8e3e7c', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x111522160>]}
[0m03:24:16.784365 [info ] [Thread-1  ]: 1 of 1 OK created python table model bruno.orders .............................. [[32mSUCCESS 1[0m in 8.14s]
[0m03:24:16.785326 [debug] [Thread-1  ]: Finished running node model.jaffle_shop.orders
[0m03:24:16.788053 [debug] [MainThread]: Acquiring new snowflake connection "master"
[0m03:24:16.789114 [info ] [MainThread]: 
[0m03:24:16.789638 [info ] [MainThread]: Finished running 1 table model in 0 hours 0 minutes and 10.77 seconds (10.77s).
[0m03:24:16.790114 [debug] [MainThread]: Connection 'master' was properly closed.
[0m03:24:16.790360 [debug] [MainThread]: Connection 'model.jaffle_shop.orders' was properly closed.
[0m03:24:16.805570 [info ] [MainThread]: 
[0m03:24:16.806048 [info ] [MainThread]: [32mCompleted successfully[0m
[0m03:24:16.806431 [info ] [MainThread]: 
[0m03:24:16.806749 [info ] [MainThread]: Done. PASS=1 WARN=0 ERROR=0 SKIP=0 TOTAL=1
[0m03:24:16.807165 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10fd39760>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x110262f10>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1114d0d00>]}
[0m03:24:16.807582 [debug] [MainThread]: Flushing usage events


============================== 2023-01-24 03:36:49.447428 | aef5d30e-1a6a-4c81-bdfe-668c4d18ddc6 ==============================
[0m03:36:49.447493 [info ] [MainThread]: Running with dbt=1.3.2
[0m03:36:49.448508 [debug] [MainThread]: running dbt with arguments {'write_json': True, 'use_colors': True, 'printer_width': 80, 'version_check': True, 'partial_parse': True, 'static_parser': True, 'profiles_dir': '/Users/bruno/.dbt', 'send_anonymous_usage_stats': True, 'event_buffer_size': 100000, 'quiet': False, 'no_print': False, 'cache_selected_only': False, 'indirect_selection': 'eager', 'resource_types': [], 'which': 'build', 'rpc_method': 'build'}
[0m03:36:49.448667 [debug] [MainThread]: Tracking: tracking
[0m03:36:49.449120 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10e59db50>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10e59dbb0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10e59dc10>]}
[0m03:36:49.502971 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 0 files changed.
[0m03:36:49.503175 [debug] [MainThread]: Partial parsing enabled, no changes found, skipping parsing
[0m03:36:49.509377 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': 'aef5d30e-1a6a-4c81-bdfe-668c4d18ddc6', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10eb36e50>]}
[0m03:36:49.516945 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': 'aef5d30e-1a6a-4c81-bdfe-668c4d18ddc6', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10e684430>]}
[0m03:36:49.517181 [info ] [MainThread]: Found 5 models, 10 tests, 0 snapshots, 0 analyses, 303 macros, 0 operations, 3 seed files, 0 sources, 0 exposures, 0 metrics
[0m03:36:49.517366 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'aef5d30e-1a6a-4c81-bdfe-668c4d18ddc6', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10e41d160>]}
[0m03:36:49.518900 [info ] [MainThread]: 
[0m03:36:49.519405 [debug] [MainThread]: Acquiring new snowflake connection "master"
[0m03:36:49.520367 [debug] [ThreadPool]: Acquiring new snowflake connection "list_jaffle_shop"
[0m03:36:49.531587 [debug] [ThreadPool]: Using snowflake connection "list_jaffle_shop"
[0m03:36:49.531716 [debug] [ThreadPool]: On list_jaffle_shop: /* {"app": "dbt", "dbt_version": "1.3.2", "profile_name": "jaffle_shop", "target_name": "dev", "connection_name": "list_jaffle_shop"} */
show terse schemas in database jaffle_shop
    limit 10000
[0m03:36:49.531808 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m03:36:50.663524 [debug] [ThreadPool]: SQL status: SUCCESS 3 in 1.13 seconds
[0m03:36:50.665697 [debug] [ThreadPool]: On list_jaffle_shop: Close
[0m03:36:51.014843 [debug] [ThreadPool]: Acquiring new snowflake connection "list_jaffle_shop_bruno"
[0m03:36:51.023083 [debug] [ThreadPool]: Using snowflake connection "list_jaffle_shop_bruno"
[0m03:36:51.023491 [debug] [ThreadPool]: On list_jaffle_shop_bruno: /* {"app": "dbt", "dbt_version": "1.3.2", "profile_name": "jaffle_shop", "target_name": "dev", "connection_name": "list_jaffle_shop_bruno"} */
show terse objects in jaffle_shop.bruno
[0m03:36:51.023598 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m03:36:51.765272 [debug] [ThreadPool]: SQL status: SUCCESS 8 in 0.74 seconds
[0m03:36:51.768855 [debug] [ThreadPool]: On list_jaffle_shop_bruno: Close
[0m03:36:52.115388 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'aef5d30e-1a6a-4c81-bdfe-668c4d18ddc6', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10e684340>]}
[0m03:36:52.116575 [info ] [MainThread]: Concurrency: 1 threads (target='dev')
[0m03:36:52.117028 [info ] [MainThread]: 
[0m03:36:52.123119 [debug] [Thread-1  ]: Began running node seed.jaffle_shop.raw_customers
[0m03:36:52.123509 [info ] [Thread-1  ]: 1 of 18 START seed file bruno.raw_customers .................................... [RUN]
[0m03:36:52.124883 [debug] [Thread-1  ]: Acquiring new snowflake connection "seed.jaffle_shop.raw_customers"
[0m03:36:52.125095 [debug] [Thread-1  ]: Began compiling node seed.jaffle_shop.raw_customers
[0m03:36:52.125325 [debug] [Thread-1  ]: finished collecting timing info
[0m03:36:52.125527 [debug] [Thread-1  ]: Began executing node seed.jaffle_shop.raw_customers
[0m03:36:52.175432 [debug] [Thread-1  ]: Using snowflake connection "seed.jaffle_shop.raw_customers"
[0m03:36:52.175623 [debug] [Thread-1  ]: On seed.jaffle_shop.raw_customers: /* {"app": "dbt", "dbt_version": "1.3.2", "profile_name": "jaffle_shop", "target_name": "dev", "node_id": "seed.jaffle_shop.raw_customers"} */
BEGIN
[0m03:36:52.175733 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m03:36:52.821295 [debug] [Thread-1  ]: SQL status: SUCCESS 1 in 0.65 seconds
[0m03:36:52.822444 [debug] [Thread-1  ]: Using snowflake connection "seed.jaffle_shop.raw_customers"
[0m03:36:52.822985 [debug] [Thread-1  ]: On seed.jaffle_shop.raw_customers: /* {"app": "dbt", "dbt_version": "1.3.2", "profile_name": "jaffle_shop", "target_name": "dev", "node_id": "seed.jaffle_shop.raw_customers"} */
truncate table "JAFFLE_SHOP"."BRUNO"."RAW_CUSTOMERS"
  ;
[0m03:36:53.332190 [debug] [Thread-1  ]: SQL status: SUCCESS 1 in 0.51 seconds
[0m03:36:53.333340 [debug] [Thread-1  ]: Using snowflake connection "seed.jaffle_shop.raw_customers"
[0m03:36:53.333736 [debug] [Thread-1  ]: On seed.jaffle_shop.raw_customers: /* {"app": "dbt", "dbt_version": "1.3.2", "profile_name": "jaffle_shop", "target_name": "dev", "node_id": "seed.jaffle_shop.raw_customers"} */
COMMIT
[0m03:36:53.718295 [debug] [Thread-1  ]: SQL status: SUCCESS 1 in 0.38 seconds
[0m03:36:53.755510 [debug] [Thread-1  ]: Using snowflake connection "seed.jaffle_shop.raw_customers"
[0m03:36:53.755824 [debug] [Thread-1  ]: On seed.jaffle_shop.raw_customers: /* {"app": "dbt", "dbt_version": "1.3.2", "profile_name": "jaffle_shop", "target_name": "dev", "node_id": "seed.jaffle_shop.raw_customers"} */
BEGIN
[0m03:36:53.946578 [debug] [Thread-1  ]: SQL status: SUCCESS 1 in 0.19 seconds
[0m03:36:53.953644 [debug] [Thread-1  ]: Using snowflake connection "seed.jaffle_shop.raw_customers"
[0m03:36:53.954123 [debug] [Thread-1  ]: On seed.jaffle_shop.raw_customers: /* {"app": "dbt", "dbt_version": "1.3.2", "profile_name": "jaffle_shop", "target_name": "dev", "node_id": "seed.jaffle_shop.raw_customers"} */
insert into jaffle_shop.bruno.raw_customers (id, first_name, last_name) values
            (%s,%s,%s),(%s,%s,%s),(%s,%s,%s),(%s,%s,%s),(%s,%s,%s),(%s,%s,%s),(%s,%s,%s),(%s,%s,%s),(%s,%s,%s),(%s,%s,%s),(%s,%s,%s),(%s,%s,%s),(%s,%s,%s),(%s,%s,%s),(%s,%s,%s),(%s,%s,%s),(%s,%s,%s),(%s,%s,%s),(%s,%s,%s),(%s,%s,%s),(%s,%s,%s),(%s,%s,%s),(%s,%s,%s),(%s,%s,%s),(%s,%s,%s),(%s...
[0m03:36:55.180783 [debug] [Thread-1  ]: SQL status: SUCCESS 100 in 1.23 seconds
[0m03:36:55.182121 [debug] [Thread-1  ]: Using snowflake connection "seed.jaffle_shop.raw_customers"
[0m03:36:55.182590 [debug] [Thread-1  ]: On seed.jaffle_shop.raw_customers: /* {"app": "dbt", "dbt_version": "1.3.2", "profile_name": "jaffle_shop", "target_name": "dev", "node_id": "seed.jaffle_shop.raw_customers"} */
COMMIT
[0m03:36:55.462025 [debug] [Thread-1  ]: SQL status: SUCCESS 1 in 0.28 seconds
[0m03:36:55.479137 [debug] [Thread-1  ]: Writing runtime SQL for node "seed.jaffle_shop.raw_customers"
[0m03:36:55.513283 [debug] [Thread-1  ]: finished collecting timing info
[0m03:36:55.513497 [debug] [Thread-1  ]: On seed.jaffle_shop.raw_customers: Close
[0m03:36:55.898036 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'aef5d30e-1a6a-4c81-bdfe-668c4d18ddc6', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10e684340>]}
[0m03:36:55.898929 [info ] [Thread-1  ]: 1 of 18 OK loaded seed file bruno.raw_customers ................................ [[32mINSERT 100[0m in 3.77s]
[0m03:36:55.899863 [debug] [Thread-1  ]: Finished running node seed.jaffle_shop.raw_customers
[0m03:36:55.900265 [debug] [Thread-1  ]: Began running node seed.jaffle_shop.raw_orders
[0m03:36:55.901228 [info ] [Thread-1  ]: 2 of 18 START seed file bruno.raw_orders ....................................... [RUN]
[0m03:36:55.902856 [debug] [Thread-1  ]: Acquiring new snowflake connection "seed.jaffle_shop.raw_orders"
[0m03:36:55.903201 [debug] [Thread-1  ]: Began compiling node seed.jaffle_shop.raw_orders
[0m03:36:55.903493 [debug] [Thread-1  ]: finished collecting timing info
[0m03:36:55.903764 [debug] [Thread-1  ]: Began executing node seed.jaffle_shop.raw_orders
[0m03:36:55.923058 [debug] [Thread-1  ]: Using snowflake connection "seed.jaffle_shop.raw_orders"
[0m03:36:55.923375 [debug] [Thread-1  ]: On seed.jaffle_shop.raw_orders: /* {"app": "dbt", "dbt_version": "1.3.2", "profile_name": "jaffle_shop", "target_name": "dev", "node_id": "seed.jaffle_shop.raw_orders"} */
BEGIN
[0m03:36:55.923563 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m03:36:56.707584 [debug] [Thread-1  ]: SQL status: SUCCESS 1 in 0.78 seconds
[0m03:36:56.708840 [debug] [Thread-1  ]: Using snowflake connection "seed.jaffle_shop.raw_orders"
[0m03:36:56.709067 [debug] [Thread-1  ]: On seed.jaffle_shop.raw_orders: /* {"app": "dbt", "dbt_version": "1.3.2", "profile_name": "jaffle_shop", "target_name": "dev", "node_id": "seed.jaffle_shop.raw_orders"} */
truncate table "JAFFLE_SHOP"."BRUNO"."RAW_ORDERS"
  ;
[0m03:36:57.219561 [debug] [Thread-1  ]: SQL status: SUCCESS 1 in 0.51 seconds
[0m03:36:57.220448 [debug] [Thread-1  ]: Using snowflake connection "seed.jaffle_shop.raw_orders"
[0m03:36:57.220991 [debug] [Thread-1  ]: On seed.jaffle_shop.raw_orders: /* {"app": "dbt", "dbt_version": "1.3.2", "profile_name": "jaffle_shop", "target_name": "dev", "node_id": "seed.jaffle_shop.raw_orders"} */
COMMIT
[0m03:36:57.498338 [debug] [Thread-1  ]: SQL status: SUCCESS 1 in 0.28 seconds
[0m03:36:57.509475 [debug] [Thread-1  ]: Using snowflake connection "seed.jaffle_shop.raw_orders"
[0m03:36:57.509975 [debug] [Thread-1  ]: On seed.jaffle_shop.raw_orders: /* {"app": "dbt", "dbt_version": "1.3.2", "profile_name": "jaffle_shop", "target_name": "dev", "node_id": "seed.jaffle_shop.raw_orders"} */
BEGIN
[0m03:36:57.834960 [debug] [Thread-1  ]: SQL status: SUCCESS 1 in 0.32 seconds
[0m03:36:57.843116 [debug] [Thread-1  ]: Using snowflake connection "seed.jaffle_shop.raw_orders"
[0m03:36:57.843665 [debug] [Thread-1  ]: On seed.jaffle_shop.raw_orders: /* {"app": "dbt", "dbt_version": "1.3.2", "profile_name": "jaffle_shop", "target_name": "dev", "node_id": "seed.jaffle_shop.raw_orders"} */
insert into jaffle_shop.bruno.raw_orders (id, user_id, order_date, status) values
            (%s,%s,%s,%s),(%s,%s,%s,%s),(%s,%s,%s,%s),(%s,%s,%s,%s),(%s,%s,%s,%s),(%s,%s,%s,%s),(%s,%s,%s,%s),(%s,%s,%s,%s),(%s,%s,%s,%s),(%s,%s,%s,%s),(%s,%s,%s,%s),(%s,%s,%s,%s),(%s,%s,%s,%s),(%s,%s,%s,%s),(%s,%s,%s,%s),(%s,%s,%s,%s),(%s,%s,%s,%s),(%s,%s,%s,%s),(%s,%s,%s,%s),(%s,%s,%s,%s...
[0m03:36:58.635520 [debug] [Thread-1  ]: SQL status: SUCCESS 99 in 0.79 seconds
[0m03:36:58.636737 [debug] [Thread-1  ]: Using snowflake connection "seed.jaffle_shop.raw_orders"
[0m03:36:58.637138 [debug] [Thread-1  ]: On seed.jaffle_shop.raw_orders: /* {"app": "dbt", "dbt_version": "1.3.2", "profile_name": "jaffle_shop", "target_name": "dev", "node_id": "seed.jaffle_shop.raw_orders"} */
COMMIT
[0m03:36:58.918856 [debug] [Thread-1  ]: SQL status: SUCCESS 1 in 0.28 seconds
[0m03:36:58.922192 [debug] [Thread-1  ]: Writing runtime SQL for node "seed.jaffle_shop.raw_orders"
[0m03:36:58.929382 [debug] [Thread-1  ]: finished collecting timing info
[0m03:36:58.929809 [debug] [Thread-1  ]: On seed.jaffle_shop.raw_orders: Close
[0m03:36:59.273738 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'aef5d30e-1a6a-4c81-bdfe-668c4d18ddc6', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10f06deb0>]}
[0m03:36:59.274973 [info ] [Thread-1  ]: 2 of 18 OK loaded seed file bruno.raw_orders ................................... [[32mINSERT 99[0m in 3.37s]
[0m03:36:59.276313 [debug] [Thread-1  ]: Finished running node seed.jaffle_shop.raw_orders
[0m03:36:59.276801 [debug] [Thread-1  ]: Began running node seed.jaffle_shop.raw_payments
[0m03:36:59.277509 [info ] [Thread-1  ]: 3 of 18 START seed file bruno.raw_payments ..................................... [RUN]
[0m03:36:59.279222 [debug] [Thread-1  ]: Acquiring new snowflake connection "seed.jaffle_shop.raw_payments"
[0m03:36:59.279595 [debug] [Thread-1  ]: Began compiling node seed.jaffle_shop.raw_payments
[0m03:36:59.279899 [debug] [Thread-1  ]: finished collecting timing info
[0m03:36:59.280174 [debug] [Thread-1  ]: Began executing node seed.jaffle_shop.raw_payments
[0m03:36:59.300450 [debug] [Thread-1  ]: Using snowflake connection "seed.jaffle_shop.raw_payments"
[0m03:36:59.300768 [debug] [Thread-1  ]: On seed.jaffle_shop.raw_payments: /* {"app": "dbt", "dbt_version": "1.3.2", "profile_name": "jaffle_shop", "target_name": "dev", "node_id": "seed.jaffle_shop.raw_payments"} */
BEGIN
[0m03:36:59.300956 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m03:37:00.089370 [debug] [Thread-1  ]: SQL status: SUCCESS 1 in 0.79 seconds
[0m03:37:00.090367 [debug] [Thread-1  ]: Using snowflake connection "seed.jaffle_shop.raw_payments"
[0m03:37:00.090808 [debug] [Thread-1  ]: On seed.jaffle_shop.raw_payments: /* {"app": "dbt", "dbt_version": "1.3.2", "profile_name": "jaffle_shop", "target_name": "dev", "node_id": "seed.jaffle_shop.raw_payments"} */
truncate table "JAFFLE_SHOP"."BRUNO"."RAW_PAYMENTS"
  ;
[0m03:37:00.570306 [debug] [Thread-1  ]: SQL status: SUCCESS 1 in 0.48 seconds
[0m03:37:00.571327 [debug] [Thread-1  ]: Using snowflake connection "seed.jaffle_shop.raw_payments"
[0m03:37:00.571679 [debug] [Thread-1  ]: On seed.jaffle_shop.raw_payments: /* {"app": "dbt", "dbt_version": "1.3.2", "profile_name": "jaffle_shop", "target_name": "dev", "node_id": "seed.jaffle_shop.raw_payments"} */
COMMIT
[0m03:37:00.905740 [debug] [Thread-1  ]: SQL status: SUCCESS 1 in 0.33 seconds
[0m03:37:00.916868 [debug] [Thread-1  ]: Using snowflake connection "seed.jaffle_shop.raw_payments"
[0m03:37:00.917312 [debug] [Thread-1  ]: On seed.jaffle_shop.raw_payments: /* {"app": "dbt", "dbt_version": "1.3.2", "profile_name": "jaffle_shop", "target_name": "dev", "node_id": "seed.jaffle_shop.raw_payments"} */
BEGIN
[0m03:37:01.215252 [debug] [Thread-1  ]: SQL status: SUCCESS 1 in 0.3 seconds
[0m03:37:01.224820 [debug] [Thread-1  ]: Using snowflake connection "seed.jaffle_shop.raw_payments"
[0m03:37:01.225282 [debug] [Thread-1  ]: On seed.jaffle_shop.raw_payments: /* {"app": "dbt", "dbt_version": "1.3.2", "profile_name": "jaffle_shop", "target_name": "dev", "node_id": "seed.jaffle_shop.raw_payments"} */
insert into jaffle_shop.bruno.raw_payments (id, order_id, payment_method, amount) values
            (%s,%s,%s,%s),(%s,%s,%s,%s),(%s,%s,%s,%s),(%s,%s,%s,%s),(%s,%s,%s,%s),(%s,%s,%s,%s),(%s,%s,%s,%s),(%s,%s,%s,%s),(%s,%s,%s,%s),(%s,%s,%s,%s),(%s,%s,%s,%s),(%s,%s,%s,%s),(%s,%s,%s,%s),(%s,%s,%s,%s),(%s,%s,%s,%s),(%s,%s,%s,%s),(%s,%s,%s,%s),(%s,%s,%s,%s),(%s,%s,%s,%s),(%s...
[0m03:37:02.134572 [debug] [Thread-1  ]: SQL status: SUCCESS 113 in 0.91 seconds
[0m03:37:02.135282 [debug] [Thread-1  ]: Using snowflake connection "seed.jaffle_shop.raw_payments"
[0m03:37:02.135566 [debug] [Thread-1  ]: On seed.jaffle_shop.raw_payments: /* {"app": "dbt", "dbt_version": "1.3.2", "profile_name": "jaffle_shop", "target_name": "dev", "node_id": "seed.jaffle_shop.raw_payments"} */
COMMIT
[0m03:37:02.428648 [debug] [Thread-1  ]: SQL status: SUCCESS 1 in 0.29 seconds
[0m03:37:02.431604 [debug] [Thread-1  ]: Writing runtime SQL for node "seed.jaffle_shop.raw_payments"
[0m03:37:02.438209 [debug] [Thread-1  ]: finished collecting timing info
[0m03:37:02.438698 [debug] [Thread-1  ]: On seed.jaffle_shop.raw_payments: Close
[0m03:37:02.774495 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'aef5d30e-1a6a-4c81-bdfe-668c4d18ddc6', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10fdccdf0>]}
[0m03:37:02.775463 [info ] [Thread-1  ]: 3 of 18 OK loaded seed file bruno.raw_payments ................................. [[32mINSERT 113[0m in 3.50s]
[0m03:37:02.776321 [debug] [Thread-1  ]: Finished running node seed.jaffle_shop.raw_payments
[0m03:37:02.776750 [debug] [Thread-1  ]: Began running node model.jaffle_shop.stg_customers
[0m03:37:02.777441 [info ] [Thread-1  ]: 4 of 18 START sql view model bruno.stg_customers ............................... [RUN]
[0m03:37:02.779146 [debug] [Thread-1  ]: Acquiring new snowflake connection "model.jaffle_shop.stg_customers"
[0m03:37:02.779516 [debug] [Thread-1  ]: Began compiling node model.jaffle_shop.stg_customers
[0m03:37:02.779811 [debug] [Thread-1  ]: Compiling model.jaffle_shop.stg_customers
[0m03:37:02.787266 [debug] [Thread-1  ]: Writing injected SQL for node "model.jaffle_shop.stg_customers"
[0m03:37:02.788515 [debug] [Thread-1  ]: finished collecting timing info
[0m03:37:02.788887 [debug] [Thread-1  ]: Began executing node model.jaffle_shop.stg_customers
[0m03:37:02.820336 [debug] [Thread-1  ]: Writing runtime sql for node "model.jaffle_shop.stg_customers"
[0m03:37:02.821462 [debug] [Thread-1  ]: Using snowflake connection "model.jaffle_shop.stg_customers"
[0m03:37:02.821625 [debug] [Thread-1  ]: On model.jaffle_shop.stg_customers: /* {"app": "dbt", "dbt_version": "1.3.2", "profile_name": "jaffle_shop", "target_name": "dev", "node_id": "model.jaffle_shop.stg_customers"} */
create or replace  view jaffle_shop.bruno.stg_customers
  
   as (
    with source as (
    select * from jaffle_shop.bruno.raw_customers

),

renamed as (

    select
        id as customer_id,
        first_name,
        last_name

    from source

)

select * from renamed
  );
[0m03:37:02.821766 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m03:37:03.775016 [debug] [Thread-1  ]: SQL status: SUCCESS 1 in 0.95 seconds
[0m03:37:03.787710 [debug] [Thread-1  ]: finished collecting timing info
[0m03:37:03.788187 [debug] [Thread-1  ]: On model.jaffle_shop.stg_customers: Close
[0m03:37:04.291796 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'aef5d30e-1a6a-4c81-bdfe-668c4d18ddc6', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10fda4ee0>]}
[0m03:37:04.292774 [info ] [Thread-1  ]: 4 of 18 OK created sql view model bruno.stg_customers .......................... [[32mSUCCESS 1[0m in 1.51s]
[0m03:37:04.293640 [debug] [Thread-1  ]: Finished running node model.jaffle_shop.stg_customers
[0m03:37:04.294013 [debug] [Thread-1  ]: Began running node model.jaffle_shop.stg_orders
[0m03:37:04.294605 [info ] [Thread-1  ]: 5 of 18 START sql view model bruno.stg_orders .................................. [RUN]
[0m03:37:04.296079 [debug] [Thread-1  ]: Acquiring new snowflake connection "model.jaffle_shop.stg_orders"
[0m03:37:04.296391 [debug] [Thread-1  ]: Began compiling node model.jaffle_shop.stg_orders
[0m03:37:04.296670 [debug] [Thread-1  ]: Compiling model.jaffle_shop.stg_orders
[0m03:37:04.303056 [debug] [Thread-1  ]: Writing injected SQL for node "model.jaffle_shop.stg_orders"
[0m03:37:04.305022 [debug] [Thread-1  ]: finished collecting timing info
[0m03:37:04.305372 [debug] [Thread-1  ]: Began executing node model.jaffle_shop.stg_orders
[0m03:37:04.310984 [debug] [Thread-1  ]: Writing runtime sql for node "model.jaffle_shop.stg_orders"
[0m03:37:04.312525 [debug] [Thread-1  ]: Using snowflake connection "model.jaffle_shop.stg_orders"
[0m03:37:04.312760 [debug] [Thread-1  ]: On model.jaffle_shop.stg_orders: /* {"app": "dbt", "dbt_version": "1.3.2", "profile_name": "jaffle_shop", "target_name": "dev", "node_id": "model.jaffle_shop.stg_orders"} */
create or replace  view jaffle_shop.bruno.stg_orders
  
   as (
    with source as (
    select * from jaffle_shop.bruno.raw_orders

),

renamed as (

    select
        id as order_id,
        user_id as customer_id,
        order_date,
        status

    from source

)

select * from renamed
  );
[0m03:37:04.312969 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m03:37:05.184131 [debug] [Thread-1  ]: SQL status: SUCCESS 1 in 0.87 seconds
[0m03:37:05.191433 [debug] [Thread-1  ]: finished collecting timing info
[0m03:37:05.191997 [debug] [Thread-1  ]: On model.jaffle_shop.stg_orders: Close
[0m03:37:05.725325 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'aef5d30e-1a6a-4c81-bdfe-668c4d18ddc6', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10f06dfd0>]}
[0m03:37:05.726104 [info ] [Thread-1  ]: 5 of 18 OK created sql view model bruno.stg_orders ............................. [[32mSUCCESS 1[0m in 1.43s]
[0m03:37:05.726943 [debug] [Thread-1  ]: Finished running node model.jaffle_shop.stg_orders
[0m03:37:05.727303 [debug] [Thread-1  ]: Began running node model.jaffle_shop.stg_payments
[0m03:37:05.727901 [info ] [Thread-1  ]: 6 of 18 START sql view model bruno.stg_payments ................................ [RUN]
[0m03:37:05.729401 [debug] [Thread-1  ]: Acquiring new snowflake connection "model.jaffle_shop.stg_payments"
[0m03:37:05.729719 [debug] [Thread-1  ]: Began compiling node model.jaffle_shop.stg_payments
[0m03:37:05.730041 [debug] [Thread-1  ]: Compiling model.jaffle_shop.stg_payments
[0m03:37:05.736481 [debug] [Thread-1  ]: Writing injected SQL for node "model.jaffle_shop.stg_payments"
[0m03:37:05.737369 [debug] [Thread-1  ]: finished collecting timing info
[0m03:37:05.737655 [debug] [Thread-1  ]: Began executing node model.jaffle_shop.stg_payments
[0m03:37:05.743196 [debug] [Thread-1  ]: Writing runtime sql for node "model.jaffle_shop.stg_payments"
[0m03:37:05.744855 [debug] [Thread-1  ]: Using snowflake connection "model.jaffle_shop.stg_payments"
[0m03:37:05.745088 [debug] [Thread-1  ]: On model.jaffle_shop.stg_payments: /* {"app": "dbt", "dbt_version": "1.3.2", "profile_name": "jaffle_shop", "target_name": "dev", "node_id": "model.jaffle_shop.stg_payments"} */
create or replace  view jaffle_shop.bruno.stg_payments
  
   as (
    with source as (
    select * from jaffle_shop.bruno.raw_payments

),

renamed as (

    select
        id as payment_id,
        order_id,
        payment_method,

        -- `amount` is currently stored in cents, so we convert it to dollars
        amount / 100 as amount

    from source

)

select * from renamed
  );
[0m03:37:05.745314 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m03:37:06.493835 [debug] [Thread-1  ]: SQL status: SUCCESS 1 in 0.75 seconds
[0m03:37:06.497394 [debug] [Thread-1  ]: finished collecting timing info
[0m03:37:06.497682 [debug] [Thread-1  ]: On model.jaffle_shop.stg_payments: Close
[0m03:37:06.828556 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'aef5d30e-1a6a-4c81-bdfe-668c4d18ddc6', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10f06dfa0>]}
[0m03:37:06.829104 [info ] [Thread-1  ]: 6 of 18 OK created sql view model bruno.stg_payments ........................... [[32mSUCCESS 1[0m in 1.10s]
[0m03:37:06.829603 [debug] [Thread-1  ]: Finished running node model.jaffle_shop.stg_payments
[0m03:37:06.829829 [debug] [Thread-1  ]: Began running node test.jaffle_shop.not_null_stg_customers_customer_id.e2cfb1f9aa
[0m03:37:06.830115 [info ] [Thread-1  ]: 7 of 18 START test not_null_stg_customers_customer_id .......................... [RUN]
[0m03:37:06.830939 [debug] [Thread-1  ]: Acquiring new snowflake connection "test.jaffle_shop.not_null_stg_customers_customer_id.e2cfb1f9aa"
[0m03:37:06.831106 [debug] [Thread-1  ]: Began compiling node test.jaffle_shop.not_null_stg_customers_customer_id.e2cfb1f9aa
[0m03:37:06.831256 [debug] [Thread-1  ]: Compiling test.jaffle_shop.not_null_stg_customers_customer_id.e2cfb1f9aa
[0m03:37:06.852275 [debug] [Thread-1  ]: Writing injected SQL for node "test.jaffle_shop.not_null_stg_customers_customer_id.e2cfb1f9aa"
[0m03:37:06.852933 [debug] [Thread-1  ]: finished collecting timing info
[0m03:37:06.853161 [debug] [Thread-1  ]: Began executing node test.jaffle_shop.not_null_stg_customers_customer_id.e2cfb1f9aa
[0m03:37:06.875966 [debug] [Thread-1  ]: Writing runtime sql for node "test.jaffle_shop.not_null_stg_customers_customer_id.e2cfb1f9aa"
[0m03:37:06.877017 [debug] [Thread-1  ]: Using snowflake connection "test.jaffle_shop.not_null_stg_customers_customer_id.e2cfb1f9aa"
[0m03:37:06.877180 [debug] [Thread-1  ]: On test.jaffle_shop.not_null_stg_customers_customer_id.e2cfb1f9aa: /* {"app": "dbt", "dbt_version": "1.3.2", "profile_name": "jaffle_shop", "target_name": "dev", "node_id": "test.jaffle_shop.not_null_stg_customers_customer_id.e2cfb1f9aa"} */
select
      count(*) as failures,
      count(*) != 0 as should_warn,
      count(*) != 0 as should_error
    from (
      
    
    



select customer_id
from jaffle_shop.bruno.stg_customers
where customer_id is null



      
    ) dbt_internal_test
[0m03:37:06.877321 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m03:37:08.074729 [debug] [Thread-1  ]: SQL status: SUCCESS 1 in 1.2 seconds
[0m03:37:08.090862 [debug] [Thread-1  ]: finished collecting timing info
[0m03:37:08.091202 [debug] [Thread-1  ]: On test.jaffle_shop.not_null_stg_customers_customer_id.e2cfb1f9aa: Close
[0m03:37:08.490934 [info ] [Thread-1  ]: 7 of 18 PASS not_null_stg_customers_customer_id ................................ [[32mPASS[0m in 1.66s]
[0m03:37:08.491979 [debug] [Thread-1  ]: Finished running node test.jaffle_shop.not_null_stg_customers_customer_id.e2cfb1f9aa
[0m03:37:08.492361 [debug] [Thread-1  ]: Began running node test.jaffle_shop.unique_stg_customers_customer_id.c7614daada
[0m03:37:08.492803 [info ] [Thread-1  ]: 8 of 18 START test unique_stg_customers_customer_id ............................ [RUN]
[0m03:37:08.494082 [debug] [Thread-1  ]: Acquiring new snowflake connection "test.jaffle_shop.unique_stg_customers_customer_id.c7614daada"
[0m03:37:08.494392 [debug] [Thread-1  ]: Began compiling node test.jaffle_shop.unique_stg_customers_customer_id.c7614daada
[0m03:37:08.494670 [debug] [Thread-1  ]: Compiling test.jaffle_shop.unique_stg_customers_customer_id.c7614daada
[0m03:37:08.508613 [debug] [Thread-1  ]: Writing injected SQL for node "test.jaffle_shop.unique_stg_customers_customer_id.c7614daada"
[0m03:37:08.510675 [debug] [Thread-1  ]: finished collecting timing info
[0m03:37:08.510942 [debug] [Thread-1  ]: Began executing node test.jaffle_shop.unique_stg_customers_customer_id.c7614daada
[0m03:37:08.515207 [debug] [Thread-1  ]: Writing runtime sql for node "test.jaffle_shop.unique_stg_customers_customer_id.c7614daada"
[0m03:37:08.516600 [debug] [Thread-1  ]: Using snowflake connection "test.jaffle_shop.unique_stg_customers_customer_id.c7614daada"
[0m03:37:08.516797 [debug] [Thread-1  ]: On test.jaffle_shop.unique_stg_customers_customer_id.c7614daada: /* {"app": "dbt", "dbt_version": "1.3.2", "profile_name": "jaffle_shop", "target_name": "dev", "node_id": "test.jaffle_shop.unique_stg_customers_customer_id.c7614daada"} */
select
      count(*) as failures,
      count(*) != 0 as should_warn,
      count(*) != 0 as should_error
    from (
      
    
    

select
    customer_id as unique_field,
    count(*) as n_records

from jaffle_shop.bruno.stg_customers
where customer_id is not null
group by customer_id
having count(*) > 1



      
    ) dbt_internal_test
[0m03:37:08.516975 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m03:37:09.202094 [debug] [Thread-1  ]: SQL status: SUCCESS 1 in 0.69 seconds
[0m03:37:09.207704 [debug] [Thread-1  ]: finished collecting timing info
[0m03:37:09.208200 [debug] [Thread-1  ]: On test.jaffle_shop.unique_stg_customers_customer_id.c7614daada: Close
[0m03:37:09.549196 [info ] [Thread-1  ]: 8 of 18 PASS unique_stg_customers_customer_id .................................. [[32mPASS[0m in 1.06s]
[0m03:37:09.550204 [debug] [Thread-1  ]: Finished running node test.jaffle_shop.unique_stg_customers_customer_id.c7614daada
[0m03:37:09.550575 [debug] [Thread-1  ]: Began running node test.jaffle_shop.accepted_values_stg_orders_status__placed__shipped__completed__return_pending__returned.080fb20aad
[0m03:37:09.550995 [info ] [Thread-1  ]: 9 of 18 START test accepted_values_stg_orders_status__placed__shipped__completed__return_pending__returned  [RUN]
[0m03:37:09.552211 [debug] [Thread-1  ]: Acquiring new snowflake connection "test.jaffle_shop.accepted_values_stg_orders_status__placed__shipped__completed__return_pending__returned.080fb20aad"
[0m03:37:09.552530 [debug] [Thread-1  ]: Began compiling node test.jaffle_shop.accepted_values_stg_orders_status__placed__shipped__completed__return_pending__returned.080fb20aad
[0m03:37:09.552821 [debug] [Thread-1  ]: Compiling test.jaffle_shop.accepted_values_stg_orders_status__placed__shipped__completed__return_pending__returned.080fb20aad
[0m03:37:09.574140 [debug] [Thread-1  ]: Writing injected SQL for node "test.jaffle_shop.accepted_values_stg_orders_status__placed__shipped__completed__return_pending__returned.080fb20aad"
[0m03:37:09.574884 [debug] [Thread-1  ]: finished collecting timing info
[0m03:37:09.575114 [debug] [Thread-1  ]: Began executing node test.jaffle_shop.accepted_values_stg_orders_status__placed__shipped__completed__return_pending__returned.080fb20aad
[0m03:37:09.579232 [debug] [Thread-1  ]: Writing runtime sql for node "test.jaffle_shop.accepted_values_stg_orders_status__placed__shipped__completed__return_pending__returned.080fb20aad"
[0m03:37:09.580683 [debug] [Thread-1  ]: Using snowflake connection "test.jaffle_shop.accepted_values_stg_orders_status__placed__shipped__completed__return_pending__returned.080fb20aad"
[0m03:37:09.580879 [debug] [Thread-1  ]: On test.jaffle_shop.accepted_values_stg_orders_status__placed__shipped__completed__return_pending__returned.080fb20aad: /* {"app": "dbt", "dbt_version": "1.3.2", "profile_name": "jaffle_shop", "target_name": "dev", "node_id": "test.jaffle_shop.accepted_values_stg_orders_status__placed__shipped__completed__return_pending__returned.080fb20aad"} */
select
      count(*) as failures,
      count(*) != 0 as should_warn,
      count(*) != 0 as should_error
    from (
      
    
    

with all_values as (

    select
        status as value_field,
        count(*) as n_records

    from jaffle_shop.bruno.stg_orders
    group by status

)

select *
from all_values
where value_field not in (
    'placed','shipped','completed','return_pending','returned'
)



      
    ) dbt_internal_test
[0m03:37:09.581059 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m03:37:10.429233 [debug] [Thread-1  ]: SQL status: SUCCESS 1 in 0.85 seconds
[0m03:37:10.431946 [debug] [Thread-1  ]: finished collecting timing info
[0m03:37:10.432146 [debug] [Thread-1  ]: On test.jaffle_shop.accepted_values_stg_orders_status__placed__shipped__completed__return_pending__returned.080fb20aad: Close
[0m03:37:10.948694 [info ] [Thread-1  ]: 9 of 18 PASS accepted_values_stg_orders_status__placed__shipped__completed__return_pending__returned  [[32mPASS[0m in 1.40s]
[0m03:37:10.949981 [debug] [Thread-1  ]: Finished running node test.jaffle_shop.accepted_values_stg_orders_status__placed__shipped__completed__return_pending__returned.080fb20aad
[0m03:37:10.950385 [debug] [Thread-1  ]: Began running node test.jaffle_shop.not_null_stg_orders_order_id.81cfe2fe64
[0m03:37:10.950857 [info ] [Thread-1  ]: 10 of 18 START test not_null_stg_orders_order_id ............................... [RUN]
[0m03:37:10.952168 [debug] [Thread-1  ]: Acquiring new snowflake connection "test.jaffle_shop.not_null_stg_orders_order_id.81cfe2fe64"
[0m03:37:10.952485 [debug] [Thread-1  ]: Began compiling node test.jaffle_shop.not_null_stg_orders_order_id.81cfe2fe64
[0m03:37:10.952778 [debug] [Thread-1  ]: Compiling test.jaffle_shop.not_null_stg_orders_order_id.81cfe2fe64
[0m03:37:10.962617 [debug] [Thread-1  ]: Writing injected SQL for node "test.jaffle_shop.not_null_stg_orders_order_id.81cfe2fe64"
[0m03:37:10.963445 [debug] [Thread-1  ]: finished collecting timing info
[0m03:37:10.963703 [debug] [Thread-1  ]: Began executing node test.jaffle_shop.not_null_stg_orders_order_id.81cfe2fe64
[0m03:37:10.968298 [debug] [Thread-1  ]: Writing runtime sql for node "test.jaffle_shop.not_null_stg_orders_order_id.81cfe2fe64"
[0m03:37:10.969730 [debug] [Thread-1  ]: Using snowflake connection "test.jaffle_shop.not_null_stg_orders_order_id.81cfe2fe64"
[0m03:37:10.969962 [debug] [Thread-1  ]: On test.jaffle_shop.not_null_stg_orders_order_id.81cfe2fe64: /* {"app": "dbt", "dbt_version": "1.3.2", "profile_name": "jaffle_shop", "target_name": "dev", "node_id": "test.jaffle_shop.not_null_stg_orders_order_id.81cfe2fe64"} */
select
      count(*) as failures,
      count(*) != 0 as should_warn,
      count(*) != 0 as should_error
    from (
      
    
    



select order_id
from jaffle_shop.bruno.stg_orders
where order_id is null



      
    ) dbt_internal_test
[0m03:37:10.970182 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m03:37:11.968004 [debug] [Thread-1  ]: SQL status: SUCCESS 1 in 1.0 seconds
[0m03:37:11.974320 [debug] [Thread-1  ]: finished collecting timing info
[0m03:37:11.974826 [debug] [Thread-1  ]: On test.jaffle_shop.not_null_stg_orders_order_id.81cfe2fe64: Close
[0m03:37:12.393039 [info ] [Thread-1  ]: 10 of 18 PASS not_null_stg_orders_order_id ..................................... [[32mPASS[0m in 1.44s]
[0m03:37:12.394435 [debug] [Thread-1  ]: Finished running node test.jaffle_shop.not_null_stg_orders_order_id.81cfe2fe64
[0m03:37:12.394840 [debug] [Thread-1  ]: Began running node test.jaffle_shop.unique_stg_orders_order_id.e3b841c71a
[0m03:37:12.395286 [info ] [Thread-1  ]: 11 of 18 START test unique_stg_orders_order_id ................................. [RUN]
[0m03:37:12.396653 [debug] [Thread-1  ]: Acquiring new snowflake connection "test.jaffle_shop.unique_stg_orders_order_id.e3b841c71a"
[0m03:37:12.396961 [debug] [Thread-1  ]: Began compiling node test.jaffle_shop.unique_stg_orders_order_id.e3b841c71a
[0m03:37:12.397235 [debug] [Thread-1  ]: Compiling test.jaffle_shop.unique_stg_orders_order_id.e3b841c71a
[0m03:37:12.406514 [debug] [Thread-1  ]: Writing injected SQL for node "test.jaffle_shop.unique_stg_orders_order_id.e3b841c71a"
[0m03:37:12.408305 [debug] [Thread-1  ]: finished collecting timing info
[0m03:37:12.408602 [debug] [Thread-1  ]: Began executing node test.jaffle_shop.unique_stg_orders_order_id.e3b841c71a
[0m03:37:12.413308 [debug] [Thread-1  ]: Writing runtime sql for node "test.jaffle_shop.unique_stg_orders_order_id.e3b841c71a"
[0m03:37:12.415011 [debug] [Thread-1  ]: Using snowflake connection "test.jaffle_shop.unique_stg_orders_order_id.e3b841c71a"
[0m03:37:12.415246 [debug] [Thread-1  ]: On test.jaffle_shop.unique_stg_orders_order_id.e3b841c71a: /* {"app": "dbt", "dbt_version": "1.3.2", "profile_name": "jaffle_shop", "target_name": "dev", "node_id": "test.jaffle_shop.unique_stg_orders_order_id.e3b841c71a"} */
select
      count(*) as failures,
      count(*) != 0 as should_warn,
      count(*) != 0 as should_error
    from (
      
    
    

select
    order_id as unique_field,
    count(*) as n_records

from jaffle_shop.bruno.stg_orders
where order_id is not null
group by order_id
having count(*) > 1



      
    ) dbt_internal_test
[0m03:37:12.415461 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m03:37:13.199797 [debug] [Thread-1  ]: SQL status: SUCCESS 1 in 0.78 seconds
[0m03:37:13.206095 [debug] [Thread-1  ]: finished collecting timing info
[0m03:37:13.206582 [debug] [Thread-1  ]: On test.jaffle_shop.unique_stg_orders_order_id.e3b841c71a: Close
[0m03:37:13.612027 [info ] [Thread-1  ]: 11 of 18 PASS unique_stg_orders_order_id ....................................... [[32mPASS[0m in 1.22s]
[0m03:37:13.613003 [debug] [Thread-1  ]: Finished running node test.jaffle_shop.unique_stg_orders_order_id.e3b841c71a
[0m03:37:13.613383 [debug] [Thread-1  ]: Began running node test.jaffle_shop.accepted_values_stg_payments_payment_method__credit_card__coupon__bank_transfer__gift_card.3c3820f278
[0m03:37:13.613833 [info ] [Thread-1  ]: 12 of 18 START test accepted_values_stg_payments_payment_method__credit_card__coupon__bank_transfer__gift_card  [RUN]
[0m03:37:13.615048 [debug] [Thread-1  ]: Acquiring new snowflake connection "test.jaffle_shop.accepted_values_stg_payments_payment_method__credit_card__coupon__bank_transfer__gift_card.3c3820f278"
[0m03:37:13.615314 [debug] [Thread-1  ]: Began compiling node test.jaffle_shop.accepted_values_stg_payments_payment_method__credit_card__coupon__bank_transfer__gift_card.3c3820f278
[0m03:37:13.615537 [debug] [Thread-1  ]: Compiling test.jaffle_shop.accepted_values_stg_payments_payment_method__credit_card__coupon__bank_transfer__gift_card.3c3820f278
[0m03:37:13.627153 [debug] [Thread-1  ]: Writing injected SQL for node "test.jaffle_shop.accepted_values_stg_payments_payment_method__credit_card__coupon__bank_transfer__gift_card.3c3820f278"
[0m03:37:13.628511 [debug] [Thread-1  ]: finished collecting timing info
[0m03:37:13.628733 [debug] [Thread-1  ]: Began executing node test.jaffle_shop.accepted_values_stg_payments_payment_method__credit_card__coupon__bank_transfer__gift_card.3c3820f278
[0m03:37:13.632543 [debug] [Thread-1  ]: Writing runtime sql for node "test.jaffle_shop.accepted_values_stg_payments_payment_method__credit_card__coupon__bank_transfer__gift_card.3c3820f278"
[0m03:37:13.634006 [debug] [Thread-1  ]: Using snowflake connection "test.jaffle_shop.accepted_values_stg_payments_payment_method__credit_card__coupon__bank_transfer__gift_card.3c3820f278"
[0m03:37:13.634202 [debug] [Thread-1  ]: On test.jaffle_shop.accepted_values_stg_payments_payment_method__credit_card__coupon__bank_transfer__gift_card.3c3820f278: /* {"app": "dbt", "dbt_version": "1.3.2", "profile_name": "jaffle_shop", "target_name": "dev", "node_id": "test.jaffle_shop.accepted_values_stg_payments_payment_method__credit_card__coupon__bank_transfer__gift_card.3c3820f278"} */
select
      count(*) as failures,
      count(*) != 0 as should_warn,
      count(*) != 0 as should_error
    from (
      
    
    

with all_values as (

    select
        payment_method as value_field,
        count(*) as n_records

    from jaffle_shop.bruno.stg_payments
    group by payment_method

)

select *
from all_values
where value_field not in (
    'credit_card','coupon','bank_transfer','gift_card'
)



      
    ) dbt_internal_test
[0m03:37:13.634377 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m03:37:14.833256 [debug] [Thread-1  ]: SQL status: SUCCESS 1 in 1.2 seconds
[0m03:37:14.836857 [debug] [Thread-1  ]: finished collecting timing info
[0m03:37:14.837115 [debug] [Thread-1  ]: On test.jaffle_shop.accepted_values_stg_payments_payment_method__credit_card__coupon__bank_transfer__gift_card.3c3820f278: Close
[0m03:37:15.250636 [info ] [Thread-1  ]: 12 of 18 PASS accepted_values_stg_payments_payment_method__credit_card__coupon__bank_transfer__gift_card  [[32mPASS[0m in 1.64s]
[0m03:37:15.251755 [debug] [Thread-1  ]: Finished running node test.jaffle_shop.accepted_values_stg_payments_payment_method__credit_card__coupon__bank_transfer__gift_card.3c3820f278
[0m03:37:15.252162 [debug] [Thread-1  ]: Began running node test.jaffle_shop.not_null_stg_payments_payment_id.c19cc50075
[0m03:37:15.252683 [info ] [Thread-1  ]: 13 of 18 START test not_null_stg_payments_payment_id ........................... [RUN]
[0m03:37:15.254024 [debug] [Thread-1  ]: Acquiring new snowflake connection "test.jaffle_shop.not_null_stg_payments_payment_id.c19cc50075"
[0m03:37:15.254329 [debug] [Thread-1  ]: Began compiling node test.jaffle_shop.not_null_stg_payments_payment_id.c19cc50075
[0m03:37:15.254640 [debug] [Thread-1  ]: Compiling test.jaffle_shop.not_null_stg_payments_payment_id.c19cc50075
[0m03:37:15.264334 [debug] [Thread-1  ]: Writing injected SQL for node "test.jaffle_shop.not_null_stg_payments_payment_id.c19cc50075"
[0m03:37:15.265172 [debug] [Thread-1  ]: finished collecting timing info
[0m03:37:15.265424 [debug] [Thread-1  ]: Began executing node test.jaffle_shop.not_null_stg_payments_payment_id.c19cc50075
[0m03:37:15.270234 [debug] [Thread-1  ]: Writing runtime sql for node "test.jaffle_shop.not_null_stg_payments_payment_id.c19cc50075"
[0m03:37:15.271780 [debug] [Thread-1  ]: Using snowflake connection "test.jaffle_shop.not_null_stg_payments_payment_id.c19cc50075"
[0m03:37:15.272042 [debug] [Thread-1  ]: On test.jaffle_shop.not_null_stg_payments_payment_id.c19cc50075: /* {"app": "dbt", "dbt_version": "1.3.2", "profile_name": "jaffle_shop", "target_name": "dev", "node_id": "test.jaffle_shop.not_null_stg_payments_payment_id.c19cc50075"} */
select
      count(*) as failures,
      count(*) != 0 as should_warn,
      count(*) != 0 as should_error
    from (
      
    
    



select payment_id
from jaffle_shop.bruno.stg_payments
where payment_id is null



      
    ) dbt_internal_test
[0m03:37:15.272258 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m03:37:16.167446 [debug] [Thread-1  ]: SQL status: SUCCESS 1 in 0.9 seconds
[0m03:37:16.174076 [debug] [Thread-1  ]: finished collecting timing info
[0m03:37:16.174567 [debug] [Thread-1  ]: On test.jaffle_shop.not_null_stg_payments_payment_id.c19cc50075: Close
[0m03:37:16.550665 [info ] [Thread-1  ]: 13 of 18 PASS not_null_stg_payments_payment_id ................................. [[32mPASS[0m in 1.30s]
[0m03:37:16.552021 [debug] [Thread-1  ]: Finished running node test.jaffle_shop.not_null_stg_payments_payment_id.c19cc50075
[0m03:37:16.552549 [debug] [Thread-1  ]: Began running node test.jaffle_shop.unique_stg_payments_payment_id.3744510712
[0m03:37:16.552967 [info ] [Thread-1  ]: 14 of 18 START test unique_stg_payments_payment_id ............................. [RUN]
[0m03:37:16.554417 [debug] [Thread-1  ]: Acquiring new snowflake connection "test.jaffle_shop.unique_stg_payments_payment_id.3744510712"
[0m03:37:16.554946 [debug] [Thread-1  ]: Began compiling node test.jaffle_shop.unique_stg_payments_payment_id.3744510712
[0m03:37:16.555317 [debug] [Thread-1  ]: Compiling test.jaffle_shop.unique_stg_payments_payment_id.3744510712
[0m03:37:16.564794 [debug] [Thread-1  ]: Writing injected SQL for node "test.jaffle_shop.unique_stg_payments_payment_id.3744510712"
[0m03:37:16.565620 [debug] [Thread-1  ]: finished collecting timing info
[0m03:37:16.565885 [debug] [Thread-1  ]: Began executing node test.jaffle_shop.unique_stg_payments_payment_id.3744510712
[0m03:37:16.570568 [debug] [Thread-1  ]: Writing runtime sql for node "test.jaffle_shop.unique_stg_payments_payment_id.3744510712"
[0m03:37:16.572440 [debug] [Thread-1  ]: Using snowflake connection "test.jaffle_shop.unique_stg_payments_payment_id.3744510712"
[0m03:37:16.572767 [debug] [Thread-1  ]: On test.jaffle_shop.unique_stg_payments_payment_id.3744510712: /* {"app": "dbt", "dbt_version": "1.3.2", "profile_name": "jaffle_shop", "target_name": "dev", "node_id": "test.jaffle_shop.unique_stg_payments_payment_id.3744510712"} */
select
      count(*) as failures,
      count(*) != 0 as should_warn,
      count(*) != 0 as should_error
    from (
      
    
    

select
    payment_id as unique_field,
    count(*) as n_records

from jaffle_shop.bruno.stg_payments
where payment_id is not null
group by payment_id
having count(*) > 1



      
    ) dbt_internal_test
[0m03:37:16.572989 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m03:37:17.394773 [debug] [Thread-1  ]: SQL status: SUCCESS 1 in 0.82 seconds
[0m03:37:17.400772 [debug] [Thread-1  ]: finished collecting timing info
[0m03:37:17.401220 [debug] [Thread-1  ]: On test.jaffle_shop.unique_stg_payments_payment_id.3744510712: Close
[0m03:37:17.808983 [info ] [Thread-1  ]: 14 of 18 PASS unique_stg_payments_payment_id ................................... [[32mPASS[0m in 1.26s]
[0m03:37:17.810075 [debug] [Thread-1  ]: Finished running node test.jaffle_shop.unique_stg_payments_payment_id.3744510712
[0m03:37:17.811518 [debug] [Thread-1  ]: Began running node model.jaffle_shop.customers
[0m03:37:17.812162 [info ] [Thread-1  ]: 15 of 18 START python table model bruno.customers .............................. [RUN]
[0m03:37:17.813333 [debug] [Thread-1  ]: Acquiring new snowflake connection "model.jaffle_shop.customers"
[0m03:37:17.813617 [debug] [Thread-1  ]: Began compiling node model.jaffle_shop.customers
[0m03:37:17.813887 [debug] [Thread-1  ]: Compiling model.jaffle_shop.customers
[0m03:37:17.847578 [debug] [Thread-1  ]: Writing injected SQL for node "model.jaffle_shop.customers"
[0m03:37:17.849283 [debug] [Thread-1  ]: finished collecting timing info
[0m03:37:17.849569 [debug] [Thread-1  ]: Began executing node model.jaffle_shop.customers
[0m03:37:17.876208 [debug] [Thread-1  ]: Writing runtime python for node "model.jaffle_shop.customers"
[0m03:37:17.878565 [debug] [Thread-1  ]: Using snowflake connection "model.jaffle_shop.customers"
[0m03:37:17.878685 [debug] [Thread-1  ]: On model.jaffle_shop.customers: /* {"app": "dbt", "dbt_version": "1.3.2", "profile_name": "jaffle_shop", "target_name": "dev", "node_id": "model.jaffle_shop.customers"} */
CREATE OR REPLACE PROCEDURE jaffle_shop.bruno.customers__dbt_sp ()

RETURNS STRING
LANGUAGE PYTHON
RUNTIME_VERSION = '3.8'
PACKAGES = ('snowflake-snowpark-python')

HANDLER = 'main'
EXECUTE AS CALLER
AS
$$

  
    
import snowflake.snowpark.functions as F

def model(dbt, session):

    stg_customers = dbt.ref('stg_customers')
    stg_orders = dbt.ref('stg_orders')
    stg_payments = dbt.ref('stg_payments')

    customer_orders = (
        stg_orders
        .group_by("customer_id")
        .agg(
            F.min(F.col("order_date")).alias('first_order'),
            F.max(F.col("order_date")).alias('most_recent_order'),
            F.count(F.col("order_id")).alias('number_of_orders')
        )
    )

    customer_payments = (
        stg_payments
        .join(stg_orders, stg_payments.order_id == stg_orders.order_id, "left")
        .group_by(stg_orders.customer_id)
        .agg(
            F.sum(F.col("amount")).alias('total_amount')
        )
    )

    final_df = (
        stg_customers
        .join(customer_orders, stg_customers.customer_id == customer_orders.customer_id, "left")
        .join(customer_payments, stg_customers.customer_id == customer_payments.customer_id, "left")
        .select(stg_customers.customer_id.alias("customer_id"),
                stg_customers.first_name.alias("first_name"),
                stg_customers.last_name.alias("last_name"),
                customer_orders.first_order.alias("first_order"),
                customer_orders.most_recent_order.alias("most_recent_order"),
                customer_orders.number_of_orders.alias("number_of_orders"),
                customer_payments.total_amount.alias("customer_lifetime_value")
        )
    )

    return final_df


# This part is user provided model code
# you will need to copy the next section to run the code
# COMMAND ----------
# this part is dbt logic for get ref work, do not modify

def ref(*args,dbt_load_df_function):
    refs = {"stg_customers": "jaffle_shop.bruno.stg_customers", "stg_orders": "jaffle_shop.bruno.stg_orders", "stg_payments": "jaffle_shop.bruno.stg_payments"}
    key = ".".join(args)
    return dbt_load_df_function(refs[key])


def source(*args, dbt_load_df_function):
    sources = {}
    key = ".".join(args)
    return dbt_load_df_function(sources[key])


config_dict = {}


class config:
    def __init__(self, *args, **kwargs):
        pass

    @staticmethod
    def get(key, default=None):
        return config_dict.get(key, default)

class this:
    """dbt.this() or dbt.this.identifier"""
    database = 'jaffle_shop'
    schema = 'bruno'
    identifier = 'customers'
    def __repr__(self):
        return 'jaffle_shop.bruno.customers'


class dbtObj:
    def __init__(self, load_df_function) -> None:
        self.source = lambda *args: source(*args, dbt_load_df_function=load_df_function)
        self.ref = lambda *args: ref(*args, dbt_load_df_function=load_df_function)
        self.config = config
        self.this = this()
        self.is_incremental = False

# COMMAND ----------

# To run this in snowsight, you need to select entry point to be main
# And you may have to modify the return type to text to get the result back
# def main(session):
#     dbt = dbtObj(session.table)
#     df = model(dbt, session)
#     return df.collect()

# to run this in local notebook, you need to create a session following examples https://github.com/Snowflake-Labs/sfguide-getting-started-snowpark-python
# then you can do the following to run model
# dbt = dbtObj(session.table)
# df = model(dbt, session)


def materialize(session, df, target_relation):
    # make sure pandas exists
    import importlib.util
    package_name = 'pandas'
    if importlib.util.find_spec(package_name):
        import pandas
        if isinstance(df, pandas.core.frame.DataFrame):
          # session.write_pandas does not have overwrite function
          df = session.createDataFrame(df)
    df.write.mode("overwrite").save_as_table("jaffle_shop.bruno.customers", create_temp_table=False)

def main(session):
    dbt = dbtObj(session.table)
    df = model(dbt, session)
    materialize(session, df, dbt.this)
    return "OK"

  
$$;
[0m03:37:17.878796 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m03:37:23.539495 [debug] [Thread-1  ]: SQL status: SUCCESS 1 in 5.66 seconds
[0m03:37:23.541206 [debug] [Thread-1  ]: Using snowflake connection "model.jaffle_shop.customers"
[0m03:37:23.541591 [debug] [Thread-1  ]: On model.jaffle_shop.customers: /* {"app": "dbt", "dbt_version": "1.3.2", "profile_name": "jaffle_shop", "target_name": "dev", "node_id": "model.jaffle_shop.customers"} */
CALL jaffle_shop.bruno.customers__dbt_sp();
[0m03:37:25.690985 [debug] [Thread-1  ]: SQL status: SUCCESS 1 in 2.15 seconds
[0m03:37:25.694888 [debug] [Thread-1  ]: Using snowflake connection "model.jaffle_shop.customers"
[0m03:37:25.695530 [debug] [Thread-1  ]: On model.jaffle_shop.customers: /* {"app": "dbt", "dbt_version": "1.3.2", "profile_name": "jaffle_shop", "target_name": "dev", "node_id": "model.jaffle_shop.customers"} */
drop procedure if exists jaffle_shop.bruno.customers__dbt_sp()
[0m03:37:25.998145 [debug] [Thread-1  ]: SQL status: SUCCESS 1 in 0.3 seconds
[0m03:37:26.006791 [debug] [Thread-1  ]: finished collecting timing info
[0m03:37:26.007197 [debug] [Thread-1  ]: On model.jaffle_shop.customers: Close
[0m03:37:26.411326 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'aef5d30e-1a6a-4c81-bdfe-668c4d18ddc6', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10f069760>]}
[0m03:37:26.412267 [info ] [Thread-1  ]: 15 of 18 OK created python table model bruno.customers ......................... [[32mSUCCESS 1[0m in 8.60s]
[0m03:37:26.413155 [debug] [Thread-1  ]: Finished running node model.jaffle_shop.customers
[0m03:37:26.413532 [debug] [Thread-1  ]: Began running node model.jaffle_shop.orders
[0m03:37:26.414105 [info ] [Thread-1  ]: 16 of 18 START python table model bruno.orders ................................. [RUN]
[0m03:37:26.415538 [debug] [Thread-1  ]: Acquiring new snowflake connection "model.jaffle_shop.orders"
[0m03:37:26.415901 [debug] [Thread-1  ]: Began compiling node model.jaffle_shop.orders
[0m03:37:26.416288 [debug] [Thread-1  ]: Compiling model.jaffle_shop.orders
[0m03:37:26.424126 [debug] [Thread-1  ]: Writing injected SQL for node "model.jaffle_shop.orders"
[0m03:37:26.425821 [debug] [Thread-1  ]: finished collecting timing info
[0m03:37:26.426092 [debug] [Thread-1  ]: Began executing node model.jaffle_shop.orders
[0m03:37:26.431041 [debug] [Thread-1  ]: Writing runtime python for node "model.jaffle_shop.orders"
[0m03:37:26.434835 [debug] [Thread-1  ]: Using snowflake connection "model.jaffle_shop.orders"
[0m03:37:26.435131 [debug] [Thread-1  ]: On model.jaffle_shop.orders: /* {"app": "dbt", "dbt_version": "1.3.2", "profile_name": "jaffle_shop", "target_name": "dev", "node_id": "model.jaffle_shop.orders"} */
CREATE OR REPLACE PROCEDURE jaffle_shop.bruno.orders__dbt_sp ()

RETURNS STRING
LANGUAGE PYTHON
RUNTIME_VERSION = '3.8'
PACKAGES = ('snowflake-snowpark-python')

HANDLER = 'main'
EXECUTE AS CALLER
AS
$$

  
    
import snowflake.snowpark.functions as F

def model(dbt, session):

    stg_orders = dbt.ref('stg_orders')
    stg_payments = dbt.ref('stg_payments')

    payment_methods = ['credit_card', 'coupon', 'bank_transfer', 'gift_card']

    agg_list = [F.sum(F.when(stg_payments.payment_method == payment_method, stg_payments.amount).otherwise(0)).alias(payment_method + "_amount") for payment_method in payment_methods]

    agg_list.append(F.sum(F.col("amount")).alias("total_amount"))

    order_payments = (
        stg_payments
        .group_by("order_id")
        .agg(*agg_list)
    )

    final_df = (
        stg_orders
        .join(order_payments, stg_orders.order_id == order_payments.order_id, "left")
        .select(stg_orders.order_id.alias("order_id"),
                stg_orders.customer_id.alias("customer_id"),
                stg_orders.order_date.alias("order_date"),
                stg_orders.status.alias("status"),
                *[F.col(payment_method + "_amount") for payment_method in payment_methods],
                order_payments.total_amount.alias("amount")
        )
    )

    return final_df


# This part is user provided model code
# you will need to copy the next section to run the code
# COMMAND ----------
# this part is dbt logic for get ref work, do not modify

def ref(*args,dbt_load_df_function):
    refs = {"stg_orders": "jaffle_shop.bruno.stg_orders", "stg_payments": "jaffle_shop.bruno.stg_payments"}
    key = ".".join(args)
    return dbt_load_df_function(refs[key])


def source(*args, dbt_load_df_function):
    sources = {}
    key = ".".join(args)
    return dbt_load_df_function(sources[key])


config_dict = {}


class config:
    def __init__(self, *args, **kwargs):
        pass

    @staticmethod
    def get(key, default=None):
        return config_dict.get(key, default)

class this:
    """dbt.this() or dbt.this.identifier"""
    database = 'jaffle_shop'
    schema = 'bruno'
    identifier = 'orders'
    def __repr__(self):
        return 'jaffle_shop.bruno.orders'


class dbtObj:
    def __init__(self, load_df_function) -> None:
        self.source = lambda *args: source(*args, dbt_load_df_function=load_df_function)
        self.ref = lambda *args: ref(*args, dbt_load_df_function=load_df_function)
        self.config = config
        self.this = this()
        self.is_incremental = False

# COMMAND ----------

# To run this in snowsight, you need to select entry point to be main
# And you may have to modify the return type to text to get the result back
# def main(session):
#     dbt = dbtObj(session.table)
#     df = model(dbt, session)
#     return df.collect()

# to run this in local notebook, you need to create a session following examples https://github.com/Snowflake-Labs/sfguide-getting-started-snowpark-python
# then you can do the following to run model
# dbt = dbtObj(session.table)
# df = model(dbt, session)


def materialize(session, df, target_relation):
    # make sure pandas exists
    import importlib.util
    package_name = 'pandas'
    if importlib.util.find_spec(package_name):
        import pandas
        if isinstance(df, pandas.core.frame.DataFrame):
          # session.write_pandas does not have overwrite function
          df = session.createDataFrame(df)
    df.write.mode("overwrite").save_as_table("jaffle_shop.bruno.orders", create_temp_table=False)

def main(session):
    dbt = dbtObj(session.table)
    df = model(dbt, session)
    materialize(session, df, dbt.this)
    return "OK"

  
$$;
[0m03:37:26.435330 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m03:37:32.039237 [debug] [Thread-1  ]: SQL status: SUCCESS 1 in 5.6 seconds
[0m03:37:32.039968 [debug] [Thread-1  ]: Using snowflake connection "model.jaffle_shop.orders"
[0m03:37:32.040309 [debug] [Thread-1  ]: On model.jaffle_shop.orders: /* {"app": "dbt", "dbt_version": "1.3.2", "profile_name": "jaffle_shop", "target_name": "dev", "node_id": "model.jaffle_shop.orders"} */
CALL jaffle_shop.bruno.orders__dbt_sp();
[0m03:37:33.881457 [debug] [Thread-1  ]: SQL status: SUCCESS 1 in 1.84 seconds
[0m03:37:33.884825 [debug] [Thread-1  ]: Using snowflake connection "model.jaffle_shop.orders"
[0m03:37:33.885515 [debug] [Thread-1  ]: On model.jaffle_shop.orders: /* {"app": "dbt", "dbt_version": "1.3.2", "profile_name": "jaffle_shop", "target_name": "dev", "node_id": "model.jaffle_shop.orders"} */
drop procedure if exists jaffle_shop.bruno.orders__dbt_sp()
[0m03:37:34.187187 [debug] [Thread-1  ]: SQL status: SUCCESS 1 in 0.3 seconds
[0m03:37:34.196095 [debug] [Thread-1  ]: finished collecting timing info
[0m03:37:34.196592 [debug] [Thread-1  ]: On model.jaffle_shop.orders: Close
[0m03:37:34.546093 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'aef5d30e-1a6a-4c81-bdfe-668c4d18ddc6', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1102a6b80>]}
[0m03:37:34.547152 [info ] [Thread-1  ]: 16 of 18 OK created python table model bruno.orders ............................ [[32mSUCCESS 1[0m in 8.13s]
[0m03:37:34.547988 [debug] [Thread-1  ]: Finished running node model.jaffle_shop.orders
[0m03:37:34.548373 [debug] [Thread-1  ]: Began running node test.jaffle_shop.not_null_customers_customer_id.5c9bf9911d
[0m03:37:34.548807 [info ] [Thread-1  ]: 17 of 18 START test not_null_customers_customer_id ............................. [RUN]
[0m03:37:34.550083 [debug] [Thread-1  ]: Acquiring new snowflake connection "test.jaffle_shop.not_null_customers_customer_id.5c9bf9911d"
[0m03:37:34.550390 [debug] [Thread-1  ]: Began compiling node test.jaffle_shop.not_null_customers_customer_id.5c9bf9911d
[0m03:37:34.550668 [debug] [Thread-1  ]: Compiling test.jaffle_shop.not_null_customers_customer_id.5c9bf9911d
[0m03:37:34.559961 [debug] [Thread-1  ]: Writing injected SQL for node "test.jaffle_shop.not_null_customers_customer_id.5c9bf9911d"
[0m03:37:34.560901 [debug] [Thread-1  ]: finished collecting timing info
[0m03:37:34.561316 [debug] [Thread-1  ]: Began executing node test.jaffle_shop.not_null_customers_customer_id.5c9bf9911d
[0m03:37:34.566090 [debug] [Thread-1  ]: Writing runtime sql for node "test.jaffle_shop.not_null_customers_customer_id.5c9bf9911d"
[0m03:37:34.567567 [debug] [Thread-1  ]: Using snowflake connection "test.jaffle_shop.not_null_customers_customer_id.5c9bf9911d"
[0m03:37:34.567806 [debug] [Thread-1  ]: On test.jaffle_shop.not_null_customers_customer_id.5c9bf9911d: /* {"app": "dbt", "dbt_version": "1.3.2", "profile_name": "jaffle_shop", "target_name": "dev", "node_id": "test.jaffle_shop.not_null_customers_customer_id.5c9bf9911d"} */
select
      count(*) as failures,
      count(*) != 0 as should_warn,
      count(*) != 0 as should_error
    from (
      
    
    



select customer_id
from jaffle_shop.bruno.customers
where customer_id is null



      
    ) dbt_internal_test
[0m03:37:34.568022 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m03:37:35.417326 [debug] [Thread-1  ]: SQL status: SUCCESS 1 in 0.85 seconds
[0m03:37:35.424268 [debug] [Thread-1  ]: finished collecting timing info
[0m03:37:35.424811 [debug] [Thread-1  ]: On test.jaffle_shop.not_null_customers_customer_id.5c9bf9911d: Close
[0m03:37:35.812821 [info ] [Thread-1  ]: 17 of 18 PASS not_null_customers_customer_id ................................... [[32mPASS[0m in 1.26s]
[0m03:37:35.813777 [debug] [Thread-1  ]: Finished running node test.jaffle_shop.not_null_customers_customer_id.5c9bf9911d
[0m03:37:35.814156 [debug] [Thread-1  ]: Began running node test.jaffle_shop.unique_customers_customer_id.c5af1ff4b1
[0m03:37:35.814612 [info ] [Thread-1  ]: 18 of 18 START test unique_customers_customer_id ............................... [RUN]
[0m03:37:35.815903 [debug] [Thread-1  ]: Acquiring new snowflake connection "test.jaffle_shop.unique_customers_customer_id.c5af1ff4b1"
[0m03:37:35.816218 [debug] [Thread-1  ]: Began compiling node test.jaffle_shop.unique_customers_customer_id.c5af1ff4b1
[0m03:37:35.816499 [debug] [Thread-1  ]: Compiling test.jaffle_shop.unique_customers_customer_id.c5af1ff4b1
[0m03:37:35.825183 [debug] [Thread-1  ]: Writing injected SQL for node "test.jaffle_shop.unique_customers_customer_id.c5af1ff4b1"
[0m03:37:35.825942 [debug] [Thread-1  ]: finished collecting timing info
[0m03:37:35.826208 [debug] [Thread-1  ]: Began executing node test.jaffle_shop.unique_customers_customer_id.c5af1ff4b1
[0m03:37:35.830692 [debug] [Thread-1  ]: Writing runtime sql for node "test.jaffle_shop.unique_customers_customer_id.c5af1ff4b1"
[0m03:37:35.832037 [debug] [Thread-1  ]: Using snowflake connection "test.jaffle_shop.unique_customers_customer_id.c5af1ff4b1"
[0m03:37:35.832251 [debug] [Thread-1  ]: On test.jaffle_shop.unique_customers_customer_id.c5af1ff4b1: /* {"app": "dbt", "dbt_version": "1.3.2", "profile_name": "jaffle_shop", "target_name": "dev", "node_id": "test.jaffle_shop.unique_customers_customer_id.c5af1ff4b1"} */
select
      count(*) as failures,
      count(*) != 0 as should_warn,
      count(*) != 0 as should_error
    from (
      
    
    

select
    customer_id as unique_field,
    count(*) as n_records

from jaffle_shop.bruno.customers
where customer_id is not null
group by customer_id
having count(*) > 1



      
    ) dbt_internal_test
[0m03:37:35.832431 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m03:37:36.750224 [debug] [Thread-1  ]: SQL status: SUCCESS 1 in 0.92 seconds
[0m03:37:36.757010 [debug] [Thread-1  ]: finished collecting timing info
[0m03:37:36.757486 [debug] [Thread-1  ]: On test.jaffle_shop.unique_customers_customer_id.c5af1ff4b1: Close
[0m03:37:37.133390 [info ] [Thread-1  ]: 18 of 18 PASS unique_customers_customer_id ..................................... [[32mPASS[0m in 1.32s]
[0m03:37:37.134348 [debug] [Thread-1  ]: Finished running node test.jaffle_shop.unique_customers_customer_id.c5af1ff4b1
[0m03:37:37.136709 [debug] [MainThread]: Acquiring new snowflake connection "master"
[0m03:37:37.137916 [info ] [MainThread]: 
[0m03:37:37.138473 [info ] [MainThread]: Finished running 3 seeds, 3 view models, 10 tests, 2 table models in 0 hours 0 minutes and 47.62 seconds (47.62s).
[0m03:37:37.138958 [debug] [MainThread]: Connection 'master' was properly closed.
[0m03:37:37.139199 [debug] [MainThread]: Connection 'test.jaffle_shop.unique_customers_customer_id.c5af1ff4b1' was properly closed.
[0m03:37:37.156740 [info ] [MainThread]: 
[0m03:37:37.157319 [info ] [MainThread]: [32mCompleted successfully[0m
[0m03:37:37.157759 [info ] [MainThread]: 
[0m03:37:37.158095 [info ] [MainThread]: Done. PASS=18 WARN=0 ERROR=0 SKIP=0 TOTAL=18
[0m03:37:37.158666 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1102770a0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10f065be0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10ee60550>]}
[0m03:37:37.159061 [debug] [MainThread]: Flushing usage events


============================== 2023-01-24 03:41:20.675313 | f50e8d1b-f442-4902-ac19-2d430a329182 ==============================
[0m03:41:20.675365 [info ] [MainThread]: Running with dbt=1.3.2
[0m03:41:20.676165 [debug] [MainThread]: running dbt with arguments {'write_json': True, 'use_colors': True, 'printer_width': 80, 'version_check': True, 'partial_parse': True, 'static_parser': True, 'profiles_dir': '/Users/bruno/.dbt', 'send_anonymous_usage_stats': True, 'event_buffer_size': 100000, 'quiet': False, 'no_print': False, 'cache_selected_only': False, 'indirect_selection': 'eager', 'resource_types': [], 'which': 'build', 'rpc_method': 'build'}
[0m03:41:20.676295 [debug] [MainThread]: Tracking: tracking
[0m03:41:20.676596 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1129ccb20>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1129ccb80>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1129ccbe0>]}
[0m03:41:20.708863 [info ] [MainThread]: Unable to do partial parsing because a project config has changed
[0m03:41:20.709169 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'partial_parser', 'label': 'f50e8d1b-f442-4902-ac19-2d430a329182', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x112861790>]}
[0m03:41:20.730942 [debug] [MainThread]: Parsing macros/catalog.sql
[0m03:41:20.732982 [debug] [MainThread]: Parsing macros/adapters.sql
[0m03:41:20.768609 [debug] [MainThread]: Parsing macros/apply_grants.sql
[0m03:41:20.769512 [debug] [MainThread]: Parsing macros/materializations/test.sql
[0m03:41:20.770228 [debug] [MainThread]: Parsing macros/materializations/merge.sql
[0m03:41:20.773052 [debug] [MainThread]: Parsing macros/materializations/seed.sql
[0m03:41:20.776943 [debug] [MainThread]: Parsing macros/materializations/view.sql
[0m03:41:20.777887 [debug] [MainThread]: Parsing macros/materializations/table.sql
[0m03:41:20.782260 [debug] [MainThread]: Parsing macros/materializations/incremental.sql
[0m03:41:20.789878 [debug] [MainThread]: Parsing macros/materializations/snapshot.sql
[0m03:41:20.790540 [debug] [MainThread]: Parsing macros/utils/timestamps.sql
[0m03:41:20.791866 [debug] [MainThread]: Parsing macros/utils/escape_single_quotes.sql
[0m03:41:20.792251 [debug] [MainThread]: Parsing macros/utils/right.sql
[0m03:41:20.792695 [debug] [MainThread]: Parsing macros/utils/safe_cast.sql
[0m03:41:20.793039 [debug] [MainThread]: Parsing macros/utils/bool_or.sql
[0m03:41:20.793332 [debug] [MainThread]: Parsing macros/utils/array_construct.sql
[0m03:41:20.793691 [debug] [MainThread]: Parsing macros/materializations/hooks.sql
[0m03:41:20.796573 [debug] [MainThread]: Parsing macros/materializations/configs.sql
[0m03:41:20.798307 [debug] [MainThread]: Parsing macros/materializations/snapshots/snapshot_merge.sql
[0m03:41:20.799495 [debug] [MainThread]: Parsing macros/materializations/snapshots/strategies.sql
[0m03:41:20.811538 [debug] [MainThread]: Parsing macros/materializations/snapshots/helpers.sql
[0m03:41:20.822120 [debug] [MainThread]: Parsing macros/materializations/snapshots/snapshot.sql
[0m03:41:20.831808 [debug] [MainThread]: Parsing macros/materializations/tests/test.sql
[0m03:41:20.835123 [debug] [MainThread]: Parsing macros/materializations/tests/helpers.sql
[0m03:41:20.836392 [debug] [MainThread]: Parsing macros/materializations/tests/where_subquery.sql
[0m03:41:20.837652 [debug] [MainThread]: Parsing macros/materializations/models/incremental/column_helpers.sql
[0m03:41:20.843585 [debug] [MainThread]: Parsing macros/materializations/models/incremental/merge.sql
[0m03:41:20.856311 [debug] [MainThread]: Parsing macros/materializations/models/incremental/is_incremental.sql
[0m03:41:20.857399 [debug] [MainThread]: Parsing macros/materializations/models/incremental/strategies.sql
[0m03:41:20.862310 [debug] [MainThread]: Parsing macros/materializations/models/incremental/incremental.sql
[0m03:41:20.870260 [debug] [MainThread]: Parsing macros/materializations/models/incremental/on_schema_change.sql
[0m03:41:20.884163 [debug] [MainThread]: Parsing macros/materializations/models/table/table.sql
[0m03:41:20.888317 [debug] [MainThread]: Parsing macros/materializations/models/table/create_table_as.sql
[0m03:41:20.890805 [debug] [MainThread]: Parsing macros/materializations/models/view/view.sql
[0m03:41:20.894943 [debug] [MainThread]: Parsing macros/materializations/models/view/helpers.sql
[0m03:41:20.895844 [debug] [MainThread]: Parsing macros/materializations/models/view/create_or_replace_view.sql
[0m03:41:20.898297 [debug] [MainThread]: Parsing macros/materializations/models/view/create_view_as.sql
[0m03:41:20.899887 [debug] [MainThread]: Parsing macros/materializations/seeds/seed.sql
[0m03:41:20.905189 [debug] [MainThread]: Parsing macros/materializations/seeds/helpers.sql
[0m03:41:20.919938 [debug] [MainThread]: Parsing macros/get_custom_name/get_custom_alias.sql
[0m03:41:20.920978 [debug] [MainThread]: Parsing macros/get_custom_name/get_custom_schema.sql
[0m03:41:20.922762 [debug] [MainThread]: Parsing macros/get_custom_name/get_custom_database.sql
[0m03:41:20.923864 [debug] [MainThread]: Parsing macros/generic_test_sql/relationships.sql
[0m03:41:20.924487 [debug] [MainThread]: Parsing macros/generic_test_sql/not_null.sql
[0m03:41:20.925039 [debug] [MainThread]: Parsing macros/generic_test_sql/unique.sql
[0m03:41:20.925507 [debug] [MainThread]: Parsing macros/generic_test_sql/accepted_values.sql
[0m03:41:20.926478 [debug] [MainThread]: Parsing macros/etc/statement.sql
[0m03:41:20.930312 [debug] [MainThread]: Parsing macros/etc/datetime.sql
[0m03:41:20.936720 [debug] [MainThread]: Parsing macros/utils/except.sql
[0m03:41:20.937308 [debug] [MainThread]: Parsing macros/utils/replace.sql
[0m03:41:20.938167 [debug] [MainThread]: Parsing macros/utils/concat.sql
[0m03:41:20.938825 [debug] [MainThread]: Parsing macros/utils/length.sql
[0m03:41:20.939478 [debug] [MainThread]: Parsing macros/utils/dateadd.sql
[0m03:41:20.940360 [debug] [MainThread]: Parsing macros/utils/intersect.sql
[0m03:41:20.940924 [debug] [MainThread]: Parsing macros/utils/escape_single_quotes.sql
[0m03:41:20.941643 [debug] [MainThread]: Parsing macros/utils/right.sql
[0m03:41:20.942661 [debug] [MainThread]: Parsing macros/utils/listagg.sql
[0m03:41:20.944370 [debug] [MainThread]: Parsing macros/utils/datediff.sql
[0m03:41:20.945232 [debug] [MainThread]: Parsing macros/utils/safe_cast.sql
[0m03:41:20.945973 [debug] [MainThread]: Parsing macros/utils/hash.sql
[0m03:41:20.946703 [debug] [MainThread]: Parsing macros/utils/cast_bool_to_text.sql
[0m03:41:20.947413 [debug] [MainThread]: Parsing macros/utils/any_value.sql
[0m03:41:20.948045 [debug] [MainThread]: Parsing macros/utils/position.sql
[0m03:41:20.948790 [debug] [MainThread]: Parsing macros/utils/literal.sql
[0m03:41:20.949415 [debug] [MainThread]: Parsing macros/utils/data_types.sql
[0m03:41:20.955290 [debug] [MainThread]: Parsing macros/utils/array_concat.sql
[0m03:41:20.956024 [debug] [MainThread]: Parsing macros/utils/bool_or.sql
[0m03:41:20.956659 [debug] [MainThread]: Parsing macros/utils/last_day.sql
[0m03:41:20.957925 [debug] [MainThread]: Parsing macros/utils/split_part.sql
[0m03:41:20.959598 [debug] [MainThread]: Parsing macros/utils/date_trunc.sql
[0m03:41:20.960310 [debug] [MainThread]: Parsing macros/utils/array_construct.sql
[0m03:41:20.961343 [debug] [MainThread]: Parsing macros/utils/array_append.sql
[0m03:41:20.962065 [debug] [MainThread]: Parsing macros/adapters/schema.sql
[0m03:41:20.963543 [debug] [MainThread]: Parsing macros/adapters/timestamps.sql
[0m03:41:20.965872 [debug] [MainThread]: Parsing macros/adapters/indexes.sql
[0m03:41:20.967812 [debug] [MainThread]: Parsing macros/adapters/relation.sql
[0m03:41:20.978947 [debug] [MainThread]: Parsing macros/adapters/freshness.sql
[0m03:41:20.980322 [debug] [MainThread]: Parsing macros/adapters/apply_grants.sql
[0m03:41:20.990085 [debug] [MainThread]: Parsing macros/adapters/persist_docs.sql
[0m03:41:20.993220 [debug] [MainThread]: Parsing macros/adapters/metadata.sql
[0m03:41:20.998456 [debug] [MainThread]: Parsing macros/adapters/columns.sql
[0m03:41:21.005669 [debug] [MainThread]: Parsing macros/python_model/python.sql
[0m03:41:21.010156 [debug] [MainThread]: Parsing tests/generic/builtin.sql
[0m03:41:21.204271 [debug] [MainThread]: 1699: static parser successfully parsed staging/stg_customers.sql
[0m03:41:21.213085 [debug] [MainThread]: 1699: static parser successfully parsed staging/stg_payments.sql
[0m03:41:21.215057 [debug] [MainThread]: 1699: static parser successfully parsed staging/stg_orders.sql
[0m03:41:21.370529 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': 'f50e8d1b-f442-4902-ac19-2d430a329182', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x112a7a9a0>]}
[0m03:41:21.377700 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': 'f50e8d1b-f442-4902-ac19-2d430a329182', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x112f83c70>]}
[0m03:41:21.377900 [info ] [MainThread]: Found 5 models, 20 tests, 0 snapshots, 0 analyses, 303 macros, 0 operations, 3 seed files, 0 sources, 0 exposures, 0 metrics
[0m03:41:21.378074 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'f50e8d1b-f442-4902-ac19-2d430a329182', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10d630790>]}
[0m03:41:21.379628 [info ] [MainThread]: 
[0m03:41:21.380155 [debug] [MainThread]: Acquiring new snowflake connection "master"
[0m03:41:21.381137 [debug] [ThreadPool]: Acquiring new snowflake connection "list_jaffle_shop"
[0m03:41:21.392681 [debug] [ThreadPool]: Using snowflake connection "list_jaffle_shop"
[0m03:41:21.392862 [debug] [ThreadPool]: On list_jaffle_shop: /* {"app": "dbt", "dbt_version": "1.3.2", "profile_name": "jaffle_shop", "target_name": "dev", "connection_name": "list_jaffle_shop"} */
show terse schemas in database jaffle_shop
    limit 10000
[0m03:41:21.392962 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m03:41:22.452505 [debug] [ThreadPool]: SQL status: SUCCESS 3 in 1.06 seconds
[0m03:41:22.456962 [debug] [ThreadPool]: On list_jaffle_shop: Close
[0m03:41:22.795013 [debug] [ThreadPool]: Acquiring new snowflake connection "list_jaffle_shop_bruno"
[0m03:41:22.808064 [debug] [ThreadPool]: Using snowflake connection "list_jaffle_shop_bruno"
[0m03:41:22.808399 [debug] [ThreadPool]: On list_jaffle_shop_bruno: /* {"app": "dbt", "dbt_version": "1.3.2", "profile_name": "jaffle_shop", "target_name": "dev", "connection_name": "list_jaffle_shop_bruno"} */
show terse objects in jaffle_shop.bruno
[0m03:41:22.808589 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m03:41:23.768590 [debug] [ThreadPool]: SQL status: SUCCESS 8 in 0.96 seconds
[0m03:41:23.770521 [debug] [ThreadPool]: On list_jaffle_shop_bruno: Close
[0m03:41:24.287829 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'f50e8d1b-f442-4902-ac19-2d430a329182', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1132001c0>]}
[0m03:41:24.289484 [info ] [MainThread]: Concurrency: 1 threads (target='dev')
[0m03:41:24.289951 [info ] [MainThread]: 
[0m03:41:24.296335 [debug] [Thread-1  ]: Began running node seed.jaffle_shop.raw_customers
[0m03:41:24.297117 [info ] [Thread-1  ]: 1 of 28 START seed file bruno.raw_customers .................................... [RUN]
[0m03:41:24.297881 [debug] [Thread-1  ]: Acquiring new snowflake connection "seed.jaffle_shop.raw_customers"
[0m03:41:24.298084 [debug] [Thread-1  ]: Began compiling node seed.jaffle_shop.raw_customers
[0m03:41:24.298288 [debug] [Thread-1  ]: finished collecting timing info
[0m03:41:24.298461 [debug] [Thread-1  ]: Began executing node seed.jaffle_shop.raw_customers
[0m03:41:24.354667 [debug] [Thread-1  ]: Using snowflake connection "seed.jaffle_shop.raw_customers"
[0m03:41:24.354879 [debug] [Thread-1  ]: On seed.jaffle_shop.raw_customers: /* {"app": "dbt", "dbt_version": "1.3.2", "profile_name": "jaffle_shop", "target_name": "dev", "node_id": "seed.jaffle_shop.raw_customers"} */
BEGIN
[0m03:41:24.354998 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m03:41:25.103107 [debug] [Thread-1  ]: SQL status: SUCCESS 1 in 0.75 seconds
[0m03:41:25.103933 [debug] [Thread-1  ]: Using snowflake connection "seed.jaffle_shop.raw_customers"
[0m03:41:25.104272 [debug] [Thread-1  ]: On seed.jaffle_shop.raw_customers: /* {"app": "dbt", "dbt_version": "1.3.2", "profile_name": "jaffle_shop", "target_name": "dev", "node_id": "seed.jaffle_shop.raw_customers"} */
truncate table "JAFFLE_SHOP"."BRUNO"."RAW_CUSTOMERS"
  ;
[0m03:41:25.611281 [debug] [Thread-1  ]: SQL status: SUCCESS 1 in 0.51 seconds
[0m03:41:25.611801 [debug] [Thread-1  ]: Using snowflake connection "seed.jaffle_shop.raw_customers"
[0m03:41:25.612042 [debug] [Thread-1  ]: On seed.jaffle_shop.raw_customers: /* {"app": "dbt", "dbt_version": "1.3.2", "profile_name": "jaffle_shop", "target_name": "dev", "node_id": "seed.jaffle_shop.raw_customers"} */
COMMIT
[0m03:41:25.919625 [debug] [Thread-1  ]: SQL status: SUCCESS 1 in 0.31 seconds
[0m03:41:25.956322 [debug] [Thread-1  ]: Using snowflake connection "seed.jaffle_shop.raw_customers"
[0m03:41:25.956633 [debug] [Thread-1  ]: On seed.jaffle_shop.raw_customers: /* {"app": "dbt", "dbt_version": "1.3.2", "profile_name": "jaffle_shop", "target_name": "dev", "node_id": "seed.jaffle_shop.raw_customers"} */
BEGIN
[0m03:41:26.152041 [debug] [Thread-1  ]: SQL status: SUCCESS 1 in 0.2 seconds
[0m03:41:26.158499 [debug] [Thread-1  ]: Using snowflake connection "seed.jaffle_shop.raw_customers"
[0m03:41:26.159023 [debug] [Thread-1  ]: On seed.jaffle_shop.raw_customers: /* {"app": "dbt", "dbt_version": "1.3.2", "profile_name": "jaffle_shop", "target_name": "dev", "node_id": "seed.jaffle_shop.raw_customers"} */
insert into jaffle_shop.bruno.raw_customers (id, first_name, last_name) values
            (%s,%s,%s),(%s,%s,%s),(%s,%s,%s),(%s,%s,%s),(%s,%s,%s),(%s,%s,%s),(%s,%s,%s),(%s,%s,%s),(%s,%s,%s),(%s,%s,%s),(%s,%s,%s),(%s,%s,%s),(%s,%s,%s),(%s,%s,%s),(%s,%s,%s),(%s,%s,%s),(%s,%s,%s),(%s,%s,%s),(%s,%s,%s),(%s,%s,%s),(%s,%s,%s),(%s,%s,%s),(%s,%s,%s),(%s,%s,%s),(%s,%s,%s),(%s...
[0m03:41:26.842624 [debug] [Thread-1  ]: SQL status: SUCCESS 100 in 0.68 seconds
[0m03:41:26.844905 [debug] [Thread-1  ]: Using snowflake connection "seed.jaffle_shop.raw_customers"
[0m03:41:26.845382 [debug] [Thread-1  ]: On seed.jaffle_shop.raw_customers: /* {"app": "dbt", "dbt_version": "1.3.2", "profile_name": "jaffle_shop", "target_name": "dev", "node_id": "seed.jaffle_shop.raw_customers"} */
COMMIT
[0m03:41:27.148186 [debug] [Thread-1  ]: SQL status: SUCCESS 1 in 0.3 seconds
[0m03:41:27.159925 [debug] [Thread-1  ]: Writing runtime SQL for node "seed.jaffle_shop.raw_customers"
[0m03:41:27.187837 [debug] [Thread-1  ]: finished collecting timing info
[0m03:41:27.188071 [debug] [Thread-1  ]: On seed.jaffle_shop.raw_customers: Close
[0m03:41:27.616806 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'f50e8d1b-f442-4902-ac19-2d430a329182', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x113200130>]}
[0m03:41:27.617411 [info ] [Thread-1  ]: 1 of 28 OK loaded seed file bruno.raw_customers ................................ [[32mINSERT 100[0m in 3.32s]
[0m03:41:27.617811 [debug] [Thread-1  ]: Finished running node seed.jaffle_shop.raw_customers
[0m03:41:27.617974 [debug] [Thread-1  ]: Began running node seed.jaffle_shop.raw_orders
[0m03:41:27.618430 [info ] [Thread-1  ]: 2 of 28 START seed file bruno.raw_orders ....................................... [RUN]
[0m03:41:27.619087 [debug] [Thread-1  ]: Acquiring new snowflake connection "seed.jaffle_shop.raw_orders"
[0m03:41:27.619270 [debug] [Thread-1  ]: Began compiling node seed.jaffle_shop.raw_orders
[0m03:41:27.619394 [debug] [Thread-1  ]: finished collecting timing info
[0m03:41:27.619504 [debug] [Thread-1  ]: Began executing node seed.jaffle_shop.raw_orders
[0m03:41:27.628505 [debug] [Thread-1  ]: Using snowflake connection "seed.jaffle_shop.raw_orders"
[0m03:41:27.628679 [debug] [Thread-1  ]: On seed.jaffle_shop.raw_orders: /* {"app": "dbt", "dbt_version": "1.3.2", "profile_name": "jaffle_shop", "target_name": "dev", "node_id": "seed.jaffle_shop.raw_orders"} */
BEGIN
[0m03:41:27.628785 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m03:41:28.179905 [debug] [Thread-1  ]: SQL status: SUCCESS 1 in 0.55 seconds
[0m03:41:28.180191 [debug] [Thread-1  ]: Using snowflake connection "seed.jaffle_shop.raw_orders"
[0m03:41:28.180309 [debug] [Thread-1  ]: On seed.jaffle_shop.raw_orders: /* {"app": "dbt", "dbt_version": "1.3.2", "profile_name": "jaffle_shop", "target_name": "dev", "node_id": "seed.jaffle_shop.raw_orders"} */
truncate table "JAFFLE_SHOP"."BRUNO"."RAW_ORDERS"
  ;
[0m03:41:28.576107 [debug] [Thread-1  ]: SQL status: SUCCESS 1 in 0.4 seconds
[0m03:41:28.576763 [debug] [Thread-1  ]: Using snowflake connection "seed.jaffle_shop.raw_orders"
[0m03:41:28.577047 [debug] [Thread-1  ]: On seed.jaffle_shop.raw_orders: /* {"app": "dbt", "dbt_version": "1.3.2", "profile_name": "jaffle_shop", "target_name": "dev", "node_id": "seed.jaffle_shop.raw_orders"} */
COMMIT
[0m03:41:28.857860 [debug] [Thread-1  ]: SQL status: SUCCESS 1 in 0.28 seconds
[0m03:41:28.865366 [debug] [Thread-1  ]: Using snowflake connection "seed.jaffle_shop.raw_orders"
[0m03:41:28.865622 [debug] [Thread-1  ]: On seed.jaffle_shop.raw_orders: /* {"app": "dbt", "dbt_version": "1.3.2", "profile_name": "jaffle_shop", "target_name": "dev", "node_id": "seed.jaffle_shop.raw_orders"} */
BEGIN
[0m03:41:29.057297 [debug] [Thread-1  ]: SQL status: SUCCESS 1 in 0.19 seconds
[0m03:41:29.065943 [debug] [Thread-1  ]: Using snowflake connection "seed.jaffle_shop.raw_orders"
[0m03:41:29.066373 [debug] [Thread-1  ]: On seed.jaffle_shop.raw_orders: /* {"app": "dbt", "dbt_version": "1.3.2", "profile_name": "jaffle_shop", "target_name": "dev", "node_id": "seed.jaffle_shop.raw_orders"} */
insert into jaffle_shop.bruno.raw_orders (id, user_id, order_date, status) values
            (%s,%s,%s,%s),(%s,%s,%s,%s),(%s,%s,%s,%s),(%s,%s,%s,%s),(%s,%s,%s,%s),(%s,%s,%s,%s),(%s,%s,%s,%s),(%s,%s,%s,%s),(%s,%s,%s,%s),(%s,%s,%s,%s),(%s,%s,%s,%s),(%s,%s,%s,%s),(%s,%s,%s,%s),(%s,%s,%s,%s),(%s,%s,%s,%s),(%s,%s,%s,%s),(%s,%s,%s,%s),(%s,%s,%s,%s),(%s,%s,%s,%s),(%s,%s,%s,%s...
[0m03:41:29.814244 [debug] [Thread-1  ]: SQL status: SUCCESS 99 in 0.75 seconds
[0m03:41:29.815430 [debug] [Thread-1  ]: Using snowflake connection "seed.jaffle_shop.raw_orders"
[0m03:41:29.815921 [debug] [Thread-1  ]: On seed.jaffle_shop.raw_orders: /* {"app": "dbt", "dbt_version": "1.3.2", "profile_name": "jaffle_shop", "target_name": "dev", "node_id": "seed.jaffle_shop.raw_orders"} */
COMMIT
[0m03:41:30.110474 [debug] [Thread-1  ]: SQL status: SUCCESS 1 in 0.29 seconds
[0m03:41:30.112721 [debug] [Thread-1  ]: Writing runtime SQL for node "seed.jaffle_shop.raw_orders"
[0m03:41:30.120338 [debug] [Thread-1  ]: finished collecting timing info
[0m03:41:30.120840 [debug] [Thread-1  ]: On seed.jaffle_shop.raw_orders: Close
[0m03:41:30.456559 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'f50e8d1b-f442-4902-ac19-2d430a329182', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x114601250>]}
[0m03:41:30.456996 [info ] [Thread-1  ]: 2 of 28 OK loaded seed file bruno.raw_orders ................................... [[32mINSERT 99[0m in 2.84s]
[0m03:41:30.457487 [debug] [Thread-1  ]: Finished running node seed.jaffle_shop.raw_orders
[0m03:41:30.457718 [debug] [Thread-1  ]: Began running node seed.jaffle_shop.raw_payments
[0m03:41:30.458137 [info ] [Thread-1  ]: 3 of 28 START seed file bruno.raw_payments ..................................... [RUN]
[0m03:41:30.459159 [debug] [Thread-1  ]: Acquiring new snowflake connection "seed.jaffle_shop.raw_payments"
[0m03:41:30.459339 [debug] [Thread-1  ]: Began compiling node seed.jaffle_shop.raw_payments
[0m03:41:30.459512 [debug] [Thread-1  ]: finished collecting timing info
[0m03:41:30.459672 [debug] [Thread-1  ]: Began executing node seed.jaffle_shop.raw_payments
[0m03:41:30.471774 [debug] [Thread-1  ]: Using snowflake connection "seed.jaffle_shop.raw_payments"
[0m03:41:30.471994 [debug] [Thread-1  ]: On seed.jaffle_shop.raw_payments: /* {"app": "dbt", "dbt_version": "1.3.2", "profile_name": "jaffle_shop", "target_name": "dev", "node_id": "seed.jaffle_shop.raw_payments"} */
BEGIN
[0m03:41:30.472127 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m03:41:31.135521 [debug] [Thread-1  ]: SQL status: SUCCESS 1 in 0.66 seconds
[0m03:41:31.136065 [debug] [Thread-1  ]: Using snowflake connection "seed.jaffle_shop.raw_payments"
[0m03:41:31.136371 [debug] [Thread-1  ]: On seed.jaffle_shop.raw_payments: /* {"app": "dbt", "dbt_version": "1.3.2", "profile_name": "jaffle_shop", "target_name": "dev", "node_id": "seed.jaffle_shop.raw_payments"} */
truncate table "JAFFLE_SHOP"."BRUNO"."RAW_PAYMENTS"
  ;
[0m03:41:31.548939 [debug] [Thread-1  ]: SQL status: SUCCESS 1 in 0.41 seconds
[0m03:41:31.550196 [debug] [Thread-1  ]: Using snowflake connection "seed.jaffle_shop.raw_payments"
[0m03:41:31.550924 [debug] [Thread-1  ]: On seed.jaffle_shop.raw_payments: /* {"app": "dbt", "dbt_version": "1.3.2", "profile_name": "jaffle_shop", "target_name": "dev", "node_id": "seed.jaffle_shop.raw_payments"} */
COMMIT
[0m03:41:31.839067 [debug] [Thread-1  ]: SQL status: SUCCESS 1 in 0.29 seconds
[0m03:41:31.850082 [debug] [Thread-1  ]: Using snowflake connection "seed.jaffle_shop.raw_payments"
[0m03:41:31.850516 [debug] [Thread-1  ]: On seed.jaffle_shop.raw_payments: /* {"app": "dbt", "dbt_version": "1.3.2", "profile_name": "jaffle_shop", "target_name": "dev", "node_id": "seed.jaffle_shop.raw_payments"} */
BEGIN
[0m03:41:32.040847 [debug] [Thread-1  ]: SQL status: SUCCESS 1 in 0.19 seconds
[0m03:41:32.049045 [debug] [Thread-1  ]: Using snowflake connection "seed.jaffle_shop.raw_payments"
[0m03:41:32.049400 [debug] [Thread-1  ]: On seed.jaffle_shop.raw_payments: /* {"app": "dbt", "dbt_version": "1.3.2", "profile_name": "jaffle_shop", "target_name": "dev", "node_id": "seed.jaffle_shop.raw_payments"} */
insert into jaffle_shop.bruno.raw_payments (id, order_id, payment_method, amount) values
            (%s,%s,%s,%s),(%s,%s,%s,%s),(%s,%s,%s,%s),(%s,%s,%s,%s),(%s,%s,%s,%s),(%s,%s,%s,%s),(%s,%s,%s,%s),(%s,%s,%s,%s),(%s,%s,%s,%s),(%s,%s,%s,%s),(%s,%s,%s,%s),(%s,%s,%s,%s),(%s,%s,%s,%s),(%s,%s,%s,%s),(%s,%s,%s,%s),(%s,%s,%s,%s),(%s,%s,%s,%s),(%s,%s,%s,%s),(%s,%s,%s,%s),(%s...
[0m03:41:32.782948 [debug] [Thread-1  ]: SQL status: SUCCESS 113 in 0.73 seconds
[0m03:41:32.784308 [debug] [Thread-1  ]: Using snowflake connection "seed.jaffle_shop.raw_payments"
[0m03:41:32.784757 [debug] [Thread-1  ]: On seed.jaffle_shop.raw_payments: /* {"app": "dbt", "dbt_version": "1.3.2", "profile_name": "jaffle_shop", "target_name": "dev", "node_id": "seed.jaffle_shop.raw_payments"} */
COMMIT
[0m03:41:33.189371 [debug] [Thread-1  ]: SQL status: SUCCESS 1 in 0.4 seconds
[0m03:41:33.191617 [debug] [Thread-1  ]: Writing runtime SQL for node "seed.jaffle_shop.raw_payments"
[0m03:41:33.197379 [debug] [Thread-1  ]: finished collecting timing info
[0m03:41:33.197784 [debug] [Thread-1  ]: On seed.jaffle_shop.raw_payments: Close
[0m03:41:33.603571 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'f50e8d1b-f442-4902-ac19-2d430a329182', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1146015e0>]}
[0m03:41:33.604674 [info ] [Thread-1  ]: 3 of 28 OK loaded seed file bruno.raw_payments ................................. [[32mINSERT 113[0m in 3.14s]
[0m03:41:33.605511 [debug] [Thread-1  ]: Finished running node seed.jaffle_shop.raw_payments
[0m03:41:33.605902 [debug] [Thread-1  ]: Began running node model.jaffle_shop.stg_customers
[0m03:41:33.606517 [info ] [Thread-1  ]: 4 of 28 START sql view model bruno.stg_customers ............................... [RUN]
[0m03:41:33.607914 [debug] [Thread-1  ]: Acquiring new snowflake connection "model.jaffle_shop.stg_customers"
[0m03:41:33.608229 [debug] [Thread-1  ]: Began compiling node model.jaffle_shop.stg_customers
[0m03:41:33.608502 [debug] [Thread-1  ]: Compiling model.jaffle_shop.stg_customers
[0m03:41:33.616225 [debug] [Thread-1  ]: Writing injected SQL for node "model.jaffle_shop.stg_customers"
[0m03:41:33.617290 [debug] [Thread-1  ]: finished collecting timing info
[0m03:41:33.617578 [debug] [Thread-1  ]: Began executing node model.jaffle_shop.stg_customers
[0m03:41:33.647573 [debug] [Thread-1  ]: Writing runtime sql for node "model.jaffle_shop.stg_customers"
[0m03:41:33.649084 [debug] [Thread-1  ]: Using snowflake connection "model.jaffle_shop.stg_customers"
[0m03:41:33.649271 [debug] [Thread-1  ]: On model.jaffle_shop.stg_customers: /* {"app": "dbt", "dbt_version": "1.3.2", "profile_name": "jaffle_shop", "target_name": "dev", "node_id": "model.jaffle_shop.stg_customers"} */
create or replace  view jaffle_shop.bruno.stg_customers
  
   as (
    with source as (
    select * from jaffle_shop.bruno.raw_customers

),

renamed as (

    select
        id as customer_id,
        first_name,
        last_name

    from source

)

select * from renamed
  );
[0m03:41:33.649420 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m03:41:34.627357 [debug] [Thread-1  ]: SQL status: SUCCESS 1 in 0.98 seconds
[0m03:41:34.639869 [debug] [Thread-1  ]: finished collecting timing info
[0m03:41:34.640399 [debug] [Thread-1  ]: On model.jaffle_shop.stg_customers: Close
[0m03:41:35.137812 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'f50e8d1b-f442-4902-ac19-2d430a329182', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x114601460>]}
[0m03:41:35.138574 [info ] [Thread-1  ]: 4 of 28 OK created sql view model bruno.stg_customers .......................... [[32mSUCCESS 1[0m in 1.53s]
[0m03:41:35.139138 [debug] [Thread-1  ]: Finished running node model.jaffle_shop.stg_customers
[0m03:41:35.139398 [debug] [Thread-1  ]: Began running node model.jaffle_shop.stg_orders
[0m03:41:35.139879 [info ] [Thread-1  ]: 5 of 28 START sql view model bruno.stg_orders .................................. [RUN]
[0m03:41:35.141002 [debug] [Thread-1  ]: Acquiring new snowflake connection "model.jaffle_shop.stg_orders"
[0m03:41:35.141338 [debug] [Thread-1  ]: Began compiling node model.jaffle_shop.stg_orders
[0m03:41:35.141544 [debug] [Thread-1  ]: Compiling model.jaffle_shop.stg_orders
[0m03:41:35.145868 [debug] [Thread-1  ]: Writing injected SQL for node "model.jaffle_shop.stg_orders"
[0m03:41:35.146680 [debug] [Thread-1  ]: finished collecting timing info
[0m03:41:35.146941 [debug] [Thread-1  ]: Began executing node model.jaffle_shop.stg_orders
[0m03:41:35.152267 [debug] [Thread-1  ]: Writing runtime sql for node "model.jaffle_shop.stg_orders"
[0m03:41:35.153495 [debug] [Thread-1  ]: Using snowflake connection "model.jaffle_shop.stg_orders"
[0m03:41:35.153671 [debug] [Thread-1  ]: On model.jaffle_shop.stg_orders: /* {"app": "dbt", "dbt_version": "1.3.2", "profile_name": "jaffle_shop", "target_name": "dev", "node_id": "model.jaffle_shop.stg_orders"} */
create or replace  view jaffle_shop.bruno.stg_orders
  
   as (
    with source as (
    select * from jaffle_shop.bruno.raw_orders

),

renamed as (

    select
        id as order_id,
        user_id as customer_id,
        order_date,
        status

    from source

)

select * from renamed
  );
[0m03:41:35.153813 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m03:41:36.013890 [debug] [Thread-1  ]: SQL status: SUCCESS 1 in 0.86 seconds
[0m03:41:36.020707 [debug] [Thread-1  ]: finished collecting timing info
[0m03:41:36.021166 [debug] [Thread-1  ]: On model.jaffle_shop.stg_orders: Close
[0m03:41:36.399164 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'f50e8d1b-f442-4902-ac19-2d430a329182', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x114601160>]}
[0m03:41:36.400562 [info ] [Thread-1  ]: 5 of 28 OK created sql view model bruno.stg_orders ............................. [[32mSUCCESS 1[0m in 1.26s]
[0m03:41:36.401606 [debug] [Thread-1  ]: Finished running node model.jaffle_shop.stg_orders
[0m03:41:36.401988 [debug] [Thread-1  ]: Began running node model.jaffle_shop.stg_payments
[0m03:41:36.402600 [info ] [Thread-1  ]: 6 of 28 START sql view model bruno.stg_payments ................................ [RUN]
[0m03:41:36.404080 [debug] [Thread-1  ]: Acquiring new snowflake connection "model.jaffle_shop.stg_payments"
[0m03:41:36.404381 [debug] [Thread-1  ]: Began compiling node model.jaffle_shop.stg_payments
[0m03:41:36.404649 [debug] [Thread-1  ]: Compiling model.jaffle_shop.stg_payments
[0m03:41:36.411260 [debug] [Thread-1  ]: Writing injected SQL for node "model.jaffle_shop.stg_payments"
[0m03:41:36.412266 [debug] [Thread-1  ]: finished collecting timing info
[0m03:41:36.412527 [debug] [Thread-1  ]: Began executing node model.jaffle_shop.stg_payments
[0m03:41:36.417977 [debug] [Thread-1  ]: Writing runtime sql for node "model.jaffle_shop.stg_payments"
[0m03:41:36.419901 [debug] [Thread-1  ]: Using snowflake connection "model.jaffle_shop.stg_payments"
[0m03:41:36.420217 [debug] [Thread-1  ]: On model.jaffle_shop.stg_payments: /* {"app": "dbt", "dbt_version": "1.3.2", "profile_name": "jaffle_shop", "target_name": "dev", "node_id": "model.jaffle_shop.stg_payments"} */
create or replace  view jaffle_shop.bruno.stg_payments
  
   as (
    with source as (
    select * from jaffle_shop.bruno.raw_payments

),

renamed as (

    select
        id as payment_id,
        order_id,
        payment_method,

        -- `amount` is currently stored in cents, so we convert it to dollars
        amount / 100 as amount

    from source

)

select * from renamed
  );
[0m03:41:36.420459 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m03:41:37.187495 [debug] [Thread-1  ]: SQL status: SUCCESS 1 in 0.77 seconds
[0m03:41:37.193971 [debug] [Thread-1  ]: finished collecting timing info
[0m03:41:37.194467 [debug] [Thread-1  ]: On model.jaffle_shop.stg_payments: Close
[0m03:41:37.525052 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'f50e8d1b-f442-4902-ac19-2d430a329182', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x114745190>]}
[0m03:41:37.526355 [info ] [Thread-1  ]: 6 of 28 OK created sql view model bruno.stg_payments ........................... [[32mSUCCESS 1[0m in 1.12s]
[0m03:41:37.527328 [debug] [Thread-1  ]: Finished running node model.jaffle_shop.stg_payments
[0m03:41:37.527702 [debug] [Thread-1  ]: Began running node test.jaffle_shop.not_null_stg_customers_customer_id.e2cfb1f9aa
[0m03:41:37.528208 [info ] [Thread-1  ]: 7 of 28 START test not_null_stg_customers_customer_id .......................... [RUN]
[0m03:41:37.529833 [debug] [Thread-1  ]: Acquiring new snowflake connection "test.jaffle_shop.not_null_stg_customers_customer_id.e2cfb1f9aa"
[0m03:41:37.530163 [debug] [Thread-1  ]: Began compiling node test.jaffle_shop.not_null_stg_customers_customer_id.e2cfb1f9aa
[0m03:41:37.530476 [debug] [Thread-1  ]: Compiling test.jaffle_shop.not_null_stg_customers_customer_id.e2cfb1f9aa
[0m03:41:37.551600 [debug] [Thread-1  ]: Writing injected SQL for node "test.jaffle_shop.not_null_stg_customers_customer_id.e2cfb1f9aa"
[0m03:41:37.552652 [debug] [Thread-1  ]: finished collecting timing info
[0m03:41:37.552918 [debug] [Thread-1  ]: Began executing node test.jaffle_shop.not_null_stg_customers_customer_id.e2cfb1f9aa
[0m03:41:37.575444 [debug] [Thread-1  ]: Writing runtime sql for node "test.jaffle_shop.not_null_stg_customers_customer_id.e2cfb1f9aa"
[0m03:41:37.576581 [debug] [Thread-1  ]: Using snowflake connection "test.jaffle_shop.not_null_stg_customers_customer_id.e2cfb1f9aa"
[0m03:41:37.576744 [debug] [Thread-1  ]: On test.jaffle_shop.not_null_stg_customers_customer_id.e2cfb1f9aa: /* {"app": "dbt", "dbt_version": "1.3.2", "profile_name": "jaffle_shop", "target_name": "dev", "node_id": "test.jaffle_shop.not_null_stg_customers_customer_id.e2cfb1f9aa"} */
select
      count(*) as failures,
      count(*) != 0 as should_warn,
      count(*) != 0 as should_error
    from (
      
    
    



select customer_id
from jaffle_shop.bruno.stg_customers
where customer_id is null



      
    ) dbt_internal_test
[0m03:41:37.576889 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m03:41:38.412420 [debug] [Thread-1  ]: SQL status: SUCCESS 1 in 0.84 seconds
[0m03:41:38.428317 [debug] [Thread-1  ]: finished collecting timing info
[0m03:41:38.428654 [debug] [Thread-1  ]: On test.jaffle_shop.not_null_stg_customers_customer_id.e2cfb1f9aa: Close
[0m03:41:38.823401 [info ] [Thread-1  ]: 7 of 28 PASS not_null_stg_customers_customer_id ................................ [[32mPASS[0m in 1.29s]
[0m03:41:38.824155 [debug] [Thread-1  ]: Finished running node test.jaffle_shop.not_null_stg_customers_customer_id.e2cfb1f9aa
[0m03:41:38.824442 [debug] [Thread-1  ]: Began running node test.jaffle_shop.unique_stg_customers_customer_id.c7614daada
[0m03:41:38.824782 [info ] [Thread-1  ]: 8 of 28 START test unique_stg_customers_customer_id ............................ [RUN]
[0m03:41:38.825791 [debug] [Thread-1  ]: Acquiring new snowflake connection "test.jaffle_shop.unique_stg_customers_customer_id.c7614daada"
[0m03:41:38.826013 [debug] [Thread-1  ]: Began compiling node test.jaffle_shop.unique_stg_customers_customer_id.c7614daada
[0m03:41:38.826214 [debug] [Thread-1  ]: Compiling test.jaffle_shop.unique_stg_customers_customer_id.c7614daada
[0m03:41:38.836643 [debug] [Thread-1  ]: Writing injected SQL for node "test.jaffle_shop.unique_stg_customers_customer_id.c7614daada"
[0m03:41:38.838089 [debug] [Thread-1  ]: finished collecting timing info
[0m03:41:38.838284 [debug] [Thread-1  ]: Began executing node test.jaffle_shop.unique_stg_customers_customer_id.c7614daada
[0m03:41:38.841368 [debug] [Thread-1  ]: Writing runtime sql for node "test.jaffle_shop.unique_stg_customers_customer_id.c7614daada"
[0m03:41:38.842413 [debug] [Thread-1  ]: Using snowflake connection "test.jaffle_shop.unique_stg_customers_customer_id.c7614daada"
[0m03:41:38.842565 [debug] [Thread-1  ]: On test.jaffle_shop.unique_stg_customers_customer_id.c7614daada: /* {"app": "dbt", "dbt_version": "1.3.2", "profile_name": "jaffle_shop", "target_name": "dev", "node_id": "test.jaffle_shop.unique_stg_customers_customer_id.c7614daada"} */
select
      count(*) as failures,
      count(*) != 0 as should_warn,
      count(*) != 0 as should_error
    from (
      
    
    

select
    customer_id as unique_field,
    count(*) as n_records

from jaffle_shop.bruno.stg_customers
where customer_id is not null
group by customer_id
having count(*) > 1



      
    ) dbt_internal_test
[0m03:41:38.842704 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m03:41:39.538972 [debug] [Thread-1  ]: SQL status: SUCCESS 1 in 0.7 seconds
[0m03:41:39.544256 [debug] [Thread-1  ]: finished collecting timing info
[0m03:41:39.544597 [debug] [Thread-1  ]: On test.jaffle_shop.unique_stg_customers_customer_id.c7614daada: Close
[0m03:41:39.883640 [info ] [Thread-1  ]: 8 of 28 PASS unique_stg_customers_customer_id .................................. [[32mPASS[0m in 1.06s]
[0m03:41:39.884814 [debug] [Thread-1  ]: Finished running node test.jaffle_shop.unique_stg_customers_customer_id.c7614daada
[0m03:41:39.885228 [debug] [Thread-1  ]: Began running node test.jaffle_shop.accepted_values_stg_orders_status__placed__shipped__completed__return_pending__returned.080fb20aad
[0m03:41:39.885756 [info ] [Thread-1  ]: 9 of 28 START test accepted_values_stg_orders_status__placed__shipped__completed__return_pending__returned  [RUN]
[0m03:41:39.887098 [debug] [Thread-1  ]: Acquiring new snowflake connection "test.jaffle_shop.accepted_values_stg_orders_status__placed__shipped__completed__return_pending__returned.080fb20aad"
[0m03:41:39.887407 [debug] [Thread-1  ]: Began compiling node test.jaffle_shop.accepted_values_stg_orders_status__placed__shipped__completed__return_pending__returned.080fb20aad
[0m03:41:39.887723 [debug] [Thread-1  ]: Compiling test.jaffle_shop.accepted_values_stg_orders_status__placed__shipped__completed__return_pending__returned.080fb20aad
[0m03:41:39.902141 [debug] [Thread-1  ]: Writing injected SQL for node "test.jaffle_shop.accepted_values_stg_orders_status__placed__shipped__completed__return_pending__returned.080fb20aad"
[0m03:41:39.903124 [debug] [Thread-1  ]: finished collecting timing info
[0m03:41:39.903394 [debug] [Thread-1  ]: Began executing node test.jaffle_shop.accepted_values_stg_orders_status__placed__shipped__completed__return_pending__returned.080fb20aad
[0m03:41:39.907600 [debug] [Thread-1  ]: Writing runtime sql for node "test.jaffle_shop.accepted_values_stg_orders_status__placed__shipped__completed__return_pending__returned.080fb20aad"
[0m03:41:39.909146 [debug] [Thread-1  ]: Using snowflake connection "test.jaffle_shop.accepted_values_stg_orders_status__placed__shipped__completed__return_pending__returned.080fb20aad"
[0m03:41:39.909345 [debug] [Thread-1  ]: On test.jaffle_shop.accepted_values_stg_orders_status__placed__shipped__completed__return_pending__returned.080fb20aad: /* {"app": "dbt", "dbt_version": "1.3.2", "profile_name": "jaffle_shop", "target_name": "dev", "node_id": "test.jaffle_shop.accepted_values_stg_orders_status__placed__shipped__completed__return_pending__returned.080fb20aad"} */
select
      count(*) as failures,
      count(*) != 0 as should_warn,
      count(*) != 0 as should_error
    from (
      
    
    

with all_values as (

    select
        status as value_field,
        count(*) as n_records

    from jaffle_shop.bruno.stg_orders
    group by status

)

select *
from all_values
where value_field not in (
    'placed','shipped','completed','return_pending','returned'
)



      
    ) dbt_internal_test
[0m03:41:39.909541 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m03:41:40.675455 [debug] [Thread-1  ]: SQL status: SUCCESS 1 in 0.77 seconds
[0m03:41:40.682070 [debug] [Thread-1  ]: finished collecting timing info
[0m03:41:40.682580 [debug] [Thread-1  ]: On test.jaffle_shop.accepted_values_stg_orders_status__placed__shipped__completed__return_pending__returned.080fb20aad: Close
[0m03:41:41.080449 [info ] [Thread-1  ]: 9 of 28 PASS accepted_values_stg_orders_status__placed__shipped__completed__return_pending__returned  [[32mPASS[0m in 1.19s]
[0m03:41:41.081480 [debug] [Thread-1  ]: Finished running node test.jaffle_shop.accepted_values_stg_orders_status__placed__shipped__completed__return_pending__returned.080fb20aad
[0m03:41:41.081912 [debug] [Thread-1  ]: Began running node test.jaffle_shop.not_null_stg_orders_order_id.81cfe2fe64
[0m03:41:41.082347 [info ] [Thread-1  ]: 10 of 28 START test not_null_stg_orders_order_id ............................... [RUN]
[0m03:41:41.083635 [debug] [Thread-1  ]: Acquiring new snowflake connection "test.jaffle_shop.not_null_stg_orders_order_id.81cfe2fe64"
[0m03:41:41.083938 [debug] [Thread-1  ]: Began compiling node test.jaffle_shop.not_null_stg_orders_order_id.81cfe2fe64
[0m03:41:41.084208 [debug] [Thread-1  ]: Compiling test.jaffle_shop.not_null_stg_orders_order_id.81cfe2fe64
[0m03:41:41.095884 [debug] [Thread-1  ]: Writing injected SQL for node "test.jaffle_shop.not_null_stg_orders_order_id.81cfe2fe64"
[0m03:41:41.096706 [debug] [Thread-1  ]: finished collecting timing info
[0m03:41:41.096957 [debug] [Thread-1  ]: Began executing node test.jaffle_shop.not_null_stg_orders_order_id.81cfe2fe64
[0m03:41:41.101604 [debug] [Thread-1  ]: Writing runtime sql for node "test.jaffle_shop.not_null_stg_orders_order_id.81cfe2fe64"
[0m03:41:41.103069 [debug] [Thread-1  ]: Using snowflake connection "test.jaffle_shop.not_null_stg_orders_order_id.81cfe2fe64"
[0m03:41:41.103310 [debug] [Thread-1  ]: On test.jaffle_shop.not_null_stg_orders_order_id.81cfe2fe64: /* {"app": "dbt", "dbt_version": "1.3.2", "profile_name": "jaffle_shop", "target_name": "dev", "node_id": "test.jaffle_shop.not_null_stg_orders_order_id.81cfe2fe64"} */
select
      count(*) as failures,
      count(*) != 0 as should_warn,
      count(*) != 0 as should_error
    from (
      
    
    



select order_id
from jaffle_shop.bruno.stg_orders
where order_id is null



      
    ) dbt_internal_test
[0m03:41:41.103511 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m03:41:41.794756 [debug] [Thread-1  ]: SQL status: SUCCESS 1 in 0.69 seconds
[0m03:41:41.801259 [debug] [Thread-1  ]: finished collecting timing info
[0m03:41:41.801762 [debug] [Thread-1  ]: On test.jaffle_shop.not_null_stg_orders_order_id.81cfe2fe64: Close
[0m03:41:42.235849 [info ] [Thread-1  ]: 10 of 28 PASS not_null_stg_orders_order_id ..................................... [[32mPASS[0m in 1.15s]
[0m03:41:42.236814 [debug] [Thread-1  ]: Finished running node test.jaffle_shop.not_null_stg_orders_order_id.81cfe2fe64
[0m03:41:42.237192 [debug] [Thread-1  ]: Began running node test.jaffle_shop.unique_stg_orders_order_id.e3b841c71a
[0m03:41:42.237631 [info ] [Thread-1  ]: 11 of 28 START test unique_stg_orders_order_id ................................. [RUN]
[0m03:41:42.238912 [debug] [Thread-1  ]: Acquiring new snowflake connection "test.jaffle_shop.unique_stg_orders_order_id.e3b841c71a"
[0m03:41:42.239215 [debug] [Thread-1  ]: Began compiling node test.jaffle_shop.unique_stg_orders_order_id.e3b841c71a
[0m03:41:42.239494 [debug] [Thread-1  ]: Compiling test.jaffle_shop.unique_stg_orders_order_id.e3b841c71a
[0m03:41:42.248363 [debug] [Thread-1  ]: Writing injected SQL for node "test.jaffle_shop.unique_stg_orders_order_id.e3b841c71a"
[0m03:41:42.249295 [debug] [Thread-1  ]: finished collecting timing info
[0m03:41:42.249566 [debug] [Thread-1  ]: Began executing node test.jaffle_shop.unique_stg_orders_order_id.e3b841c71a
[0m03:41:42.254322 [debug] [Thread-1  ]: Writing runtime sql for node "test.jaffle_shop.unique_stg_orders_order_id.e3b841c71a"
[0m03:41:42.256131 [debug] [Thread-1  ]: Using snowflake connection "test.jaffle_shop.unique_stg_orders_order_id.e3b841c71a"
[0m03:41:42.256351 [debug] [Thread-1  ]: On test.jaffle_shop.unique_stg_orders_order_id.e3b841c71a: /* {"app": "dbt", "dbt_version": "1.3.2", "profile_name": "jaffle_shop", "target_name": "dev", "node_id": "test.jaffle_shop.unique_stg_orders_order_id.e3b841c71a"} */
select
      count(*) as failures,
      count(*) != 0 as should_warn,
      count(*) != 0 as should_error
    from (
      
    
    

select
    order_id as unique_field,
    count(*) as n_records

from jaffle_shop.bruno.stg_orders
where order_id is not null
group by order_id
having count(*) > 1



      
    ) dbt_internal_test
[0m03:41:42.256538 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m03:41:43.102328 [debug] [Thread-1  ]: SQL status: SUCCESS 1 in 0.85 seconds
[0m03:41:43.108035 [debug] [Thread-1  ]: finished collecting timing info
[0m03:41:43.108608 [debug] [Thread-1  ]: On test.jaffle_shop.unique_stg_orders_order_id.e3b841c71a: Close
[0m03:41:43.440808 [info ] [Thread-1  ]: 11 of 28 PASS unique_stg_orders_order_id ....................................... [[32mPASS[0m in 1.20s]
[0m03:41:43.441765 [debug] [Thread-1  ]: Finished running node test.jaffle_shop.unique_stg_orders_order_id.e3b841c71a
[0m03:41:43.442139 [debug] [Thread-1  ]: Began running node test.jaffle_shop.accepted_values_stg_payments_payment_method__credit_card__coupon__bank_transfer__gift_card.3c3820f278
[0m03:41:43.442584 [info ] [Thread-1  ]: 12 of 28 START test accepted_values_stg_payments_payment_method__credit_card__coupon__bank_transfer__gift_card  [RUN]
[0m03:41:43.443653 [debug] [Thread-1  ]: Acquiring new snowflake connection "test.jaffle_shop.accepted_values_stg_payments_payment_method__credit_card__coupon__bank_transfer__gift_card.3c3820f278"
[0m03:41:43.443903 [debug] [Thread-1  ]: Began compiling node test.jaffle_shop.accepted_values_stg_payments_payment_method__credit_card__coupon__bank_transfer__gift_card.3c3820f278
[0m03:41:43.444128 [debug] [Thread-1  ]: Compiling test.jaffle_shop.accepted_values_stg_payments_payment_method__credit_card__coupon__bank_transfer__gift_card.3c3820f278
[0m03:41:43.456399 [debug] [Thread-1  ]: Writing injected SQL for node "test.jaffle_shop.accepted_values_stg_payments_payment_method__credit_card__coupon__bank_transfer__gift_card.3c3820f278"
[0m03:41:43.457155 [debug] [Thread-1  ]: finished collecting timing info
[0m03:41:43.457392 [debug] [Thread-1  ]: Began executing node test.jaffle_shop.accepted_values_stg_payments_payment_method__credit_card__coupon__bank_transfer__gift_card.3c3820f278
[0m03:41:43.461367 [debug] [Thread-1  ]: Writing runtime sql for node "test.jaffle_shop.accepted_values_stg_payments_payment_method__credit_card__coupon__bank_transfer__gift_card.3c3820f278"
[0m03:41:43.462854 [debug] [Thread-1  ]: Using snowflake connection "test.jaffle_shop.accepted_values_stg_payments_payment_method__credit_card__coupon__bank_transfer__gift_card.3c3820f278"
[0m03:41:43.463084 [debug] [Thread-1  ]: On test.jaffle_shop.accepted_values_stg_payments_payment_method__credit_card__coupon__bank_transfer__gift_card.3c3820f278: /* {"app": "dbt", "dbt_version": "1.3.2", "profile_name": "jaffle_shop", "target_name": "dev", "node_id": "test.jaffle_shop.accepted_values_stg_payments_payment_method__credit_card__coupon__bank_transfer__gift_card.3c3820f278"} */
select
      count(*) as failures,
      count(*) != 0 as should_warn,
      count(*) != 0 as should_error
    from (
      
    
    

with all_values as (

    select
        payment_method as value_field,
        count(*) as n_records

    from jaffle_shop.bruno.stg_payments
    group by payment_method

)

select *
from all_values
where value_field not in (
    'credit_card','coupon','bank_transfer','gift_card'
)



      
    ) dbt_internal_test
[0m03:41:43.463264 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m03:41:44.252687 [debug] [Thread-1  ]: SQL status: SUCCESS 1 in 0.79 seconds
[0m03:41:44.259320 [debug] [Thread-1  ]: finished collecting timing info
[0m03:41:44.259810 [debug] [Thread-1  ]: On test.jaffle_shop.accepted_values_stg_payments_payment_method__credit_card__coupon__bank_transfer__gift_card.3c3820f278: Close
[0m03:41:44.592301 [info ] [Thread-1  ]: 12 of 28 PASS accepted_values_stg_payments_payment_method__credit_card__coupon__bank_transfer__gift_card  [[32mPASS[0m in 1.15s]
[0m03:41:44.593495 [debug] [Thread-1  ]: Finished running node test.jaffle_shop.accepted_values_stg_payments_payment_method__credit_card__coupon__bank_transfer__gift_card.3c3820f278
[0m03:41:44.593905 [debug] [Thread-1  ]: Began running node test.jaffle_shop.not_null_stg_payments_payment_id.c19cc50075
[0m03:41:44.594349 [info ] [Thread-1  ]: 13 of 28 START test not_null_stg_payments_payment_id ........................... [RUN]
[0m03:41:44.595617 [debug] [Thread-1  ]: Acquiring new snowflake connection "test.jaffle_shop.not_null_stg_payments_payment_id.c19cc50075"
[0m03:41:44.595916 [debug] [Thread-1  ]: Began compiling node test.jaffle_shop.not_null_stg_payments_payment_id.c19cc50075
[0m03:41:44.596191 [debug] [Thread-1  ]: Compiling test.jaffle_shop.not_null_stg_payments_payment_id.c19cc50075
[0m03:41:44.607558 [debug] [Thread-1  ]: Writing injected SQL for node "test.jaffle_shop.not_null_stg_payments_payment_id.c19cc50075"
[0m03:41:44.608384 [debug] [Thread-1  ]: finished collecting timing info
[0m03:41:44.608639 [debug] [Thread-1  ]: Began executing node test.jaffle_shop.not_null_stg_payments_payment_id.c19cc50075
[0m03:41:44.613131 [debug] [Thread-1  ]: Writing runtime sql for node "test.jaffle_shop.not_null_stg_payments_payment_id.c19cc50075"
[0m03:41:44.614465 [debug] [Thread-1  ]: Using snowflake connection "test.jaffle_shop.not_null_stg_payments_payment_id.c19cc50075"
[0m03:41:44.614724 [debug] [Thread-1  ]: On test.jaffle_shop.not_null_stg_payments_payment_id.c19cc50075: /* {"app": "dbt", "dbt_version": "1.3.2", "profile_name": "jaffle_shop", "target_name": "dev", "node_id": "test.jaffle_shop.not_null_stg_payments_payment_id.c19cc50075"} */
select
      count(*) as failures,
      count(*) != 0 as should_warn,
      count(*) != 0 as should_error
    from (
      
    
    



select payment_id
from jaffle_shop.bruno.stg_payments
where payment_id is null



      
    ) dbt_internal_test
[0m03:41:44.614929 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m03:41:45.480766 [debug] [Thread-1  ]: SQL status: SUCCESS 1 in 0.87 seconds
[0m03:41:45.487530 [debug] [Thread-1  ]: finished collecting timing info
[0m03:41:45.487994 [debug] [Thread-1  ]: On test.jaffle_shop.not_null_stg_payments_payment_id.c19cc50075: Close
[0m03:41:45.819884 [info ] [Thread-1  ]: 13 of 28 PASS not_null_stg_payments_payment_id ................................. [[32mPASS[0m in 1.22s]
[0m03:41:45.821007 [debug] [Thread-1  ]: Finished running node test.jaffle_shop.not_null_stg_payments_payment_id.c19cc50075
[0m03:41:45.821380 [debug] [Thread-1  ]: Began running node test.jaffle_shop.unique_stg_payments_payment_id.3744510712
[0m03:41:45.821827 [info ] [Thread-1  ]: 14 of 28 START test unique_stg_payments_payment_id ............................. [RUN]
[0m03:41:45.823085 [debug] [Thread-1  ]: Acquiring new snowflake connection "test.jaffle_shop.unique_stg_payments_payment_id.3744510712"
[0m03:41:45.823380 [debug] [Thread-1  ]: Began compiling node test.jaffle_shop.unique_stg_payments_payment_id.3744510712
[0m03:41:45.823642 [debug] [Thread-1  ]: Compiling test.jaffle_shop.unique_stg_payments_payment_id.3744510712
[0m03:41:45.833054 [debug] [Thread-1  ]: Writing injected SQL for node "test.jaffle_shop.unique_stg_payments_payment_id.3744510712"
[0m03:41:45.834743 [debug] [Thread-1  ]: finished collecting timing info
[0m03:41:45.835087 [debug] [Thread-1  ]: Began executing node test.jaffle_shop.unique_stg_payments_payment_id.3744510712
[0m03:41:45.840063 [debug] [Thread-1  ]: Writing runtime sql for node "test.jaffle_shop.unique_stg_payments_payment_id.3744510712"
[0m03:41:45.842125 [debug] [Thread-1  ]: Using snowflake connection "test.jaffle_shop.unique_stg_payments_payment_id.3744510712"
[0m03:41:45.842347 [debug] [Thread-1  ]: On test.jaffle_shop.unique_stg_payments_payment_id.3744510712: /* {"app": "dbt", "dbt_version": "1.3.2", "profile_name": "jaffle_shop", "target_name": "dev", "node_id": "test.jaffle_shop.unique_stg_payments_payment_id.3744510712"} */
select
      count(*) as failures,
      count(*) != 0 as should_warn,
      count(*) != 0 as should_error
    from (
      
    
    

select
    payment_id as unique_field,
    count(*) as n_records

from jaffle_shop.bruno.stg_payments
where payment_id is not null
group by payment_id
having count(*) > 1



      
    ) dbt_internal_test
[0m03:41:45.842525 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m03:41:46.606226 [debug] [Thread-1  ]: SQL status: SUCCESS 1 in 0.76 seconds
[0m03:41:46.612626 [debug] [Thread-1  ]: finished collecting timing info
[0m03:41:46.613072 [debug] [Thread-1  ]: On test.jaffle_shop.unique_stg_payments_payment_id.3744510712: Close
[0m03:41:47.035447 [info ] [Thread-1  ]: 14 of 28 PASS unique_stg_payments_payment_id ................................... [[32mPASS[0m in 1.21s]
[0m03:41:47.036601 [debug] [Thread-1  ]: Finished running node test.jaffle_shop.unique_stg_payments_payment_id.3744510712
[0m03:41:47.038033 [debug] [Thread-1  ]: Began running node model.jaffle_shop.customers
[0m03:41:47.038703 [info ] [Thread-1  ]: 15 of 28 START python table model bruno.customers .............................. [RUN]
[0m03:41:47.040181 [debug] [Thread-1  ]: Acquiring new snowflake connection "model.jaffle_shop.customers"
[0m03:41:47.040502 [debug] [Thread-1  ]: Began compiling node model.jaffle_shop.customers
[0m03:41:47.040779 [debug] [Thread-1  ]: Compiling model.jaffle_shop.customers
[0m03:41:47.075064 [debug] [Thread-1  ]: Writing injected SQL for node "model.jaffle_shop.customers"
[0m03:41:47.076642 [debug] [Thread-1  ]: finished collecting timing info
[0m03:41:47.076865 [debug] [Thread-1  ]: Began executing node model.jaffle_shop.customers
[0m03:41:47.103538 [debug] [Thread-1  ]: Writing runtime python for node "model.jaffle_shop.customers"
[0m03:41:47.105878 [debug] [Thread-1  ]: Using snowflake connection "model.jaffle_shop.customers"
[0m03:41:47.106005 [debug] [Thread-1  ]: On model.jaffle_shop.customers: /* {"app": "dbt", "dbt_version": "1.3.2", "profile_name": "jaffle_shop", "target_name": "dev", "node_id": "model.jaffle_shop.customers"} */
WITH customers__dbt_sp AS PROCEDURE ()

RETURNS STRING
LANGUAGE PYTHON
RUNTIME_VERSION = '3.8'
PACKAGES = ('snowflake-snowpark-python')

HANDLER = 'main'
EXECUTE AS CALLER
AS
$$

  
    
import snowflake.snowpark.functions as F

def model(dbt, session):

    stg_customers = dbt.ref('stg_customers')
    stg_orders = dbt.ref('stg_orders')
    stg_payments = dbt.ref('stg_payments')

    customer_orders = (
        stg_orders
        .group_by("customer_id")
        .agg(
            F.min(F.col("order_date")).alias('first_order'),
            F.max(F.col("order_date")).alias('most_recent_order'),
            F.count(F.col("order_id")).alias('number_of_orders')
        )
    )

    customer_payments = (
        stg_payments
        .join(stg_orders, stg_payments.order_id == stg_orders.order_id, "left")
        .group_by(stg_orders.customer_id)
        .agg(
            F.sum(F.col("amount")).alias('total_amount')
        )
    )

    final_df = (
        stg_customers
        .join(customer_orders, stg_customers.customer_id == customer_orders.customer_id, "left")
        .join(customer_payments, stg_customers.customer_id == customer_payments.customer_id, "left")
        .select(stg_customers.customer_id.alias("customer_id"),
                stg_customers.first_name.alias("first_name"),
                stg_customers.last_name.alias("last_name"),
                customer_orders.first_order.alias("first_order"),
                customer_orders.most_recent_order.alias("most_recent_order"),
                customer_orders.number_of_orders.alias("number_of_orders"),
                customer_payments.total_amount.alias("customer_lifetime_value")
        )
    )

    return final_df


# This part is user provided model code
# you will need to copy the next section to run the code
# COMMAND ----------
# this part is dbt logic for get ref work, do not modify

def ref(*args,dbt_load_df_function):
    refs = {"stg_customers": "jaffle_shop.bruno.stg_customers", "stg_orders": "jaffle_shop.bruno.stg_orders", "stg_payments": "jaffle_shop.bruno.stg_payments"}
    key = ".".join(args)
    return dbt_load_df_function(refs[key])


def source(*args, dbt_load_df_function):
    sources = {}
    key = ".".join(args)
    return dbt_load_df_function(sources[key])


config_dict = {}


class config:
    def __init__(self, *args, **kwargs):
        pass

    @staticmethod
    def get(key, default=None):
        return config_dict.get(key, default)

class this:
    """dbt.this() or dbt.this.identifier"""
    database = 'jaffle_shop'
    schema = 'bruno'
    identifier = 'customers'
    def __repr__(self):
        return 'jaffle_shop.bruno.customers'


class dbtObj:
    def __init__(self, load_df_function) -> None:
        self.source = lambda *args: source(*args, dbt_load_df_function=load_df_function)
        self.ref = lambda *args: ref(*args, dbt_load_df_function=load_df_function)
        self.config = config
        self.this = this()
        self.is_incremental = False

# COMMAND ----------

# To run this in snowsight, you need to select entry point to be main
# And you may have to modify the return type to text to get the result back
# def main(session):
#     dbt = dbtObj(session.table)
#     df = model(dbt, session)
#     return df.collect()

# to run this in local notebook, you need to create a session following examples https://github.com/Snowflake-Labs/sfguide-getting-started-snowpark-python
# then you can do the following to run model
# dbt = dbtObj(session.table)
# df = model(dbt, session)


def materialize(session, df, target_relation):
    # make sure pandas exists
    import importlib.util
    package_name = 'pandas'
    if importlib.util.find_spec(package_name):
        import pandas
        if isinstance(df, pandas.core.frame.DataFrame):
          # session.write_pandas does not have overwrite function
          df = session.createDataFrame(df)
    df.write.mode("overwrite").save_as_table("jaffle_shop.bruno.customers", create_temp_table=False)

def main(session):
    dbt = dbtObj(session.table)
    df = model(dbt, session)
    materialize(session, df, dbt.this)
    return "OK"

  
$$
CALL customers__dbt_sp();
[0m03:41:47.106113 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m03:41:56.949346 [debug] [Thread-1  ]: SQL status: SUCCESS 1 in 9.84 seconds
[0m03:41:56.955025 [debug] [Thread-1  ]: finished collecting timing info
[0m03:41:56.955327 [debug] [Thread-1  ]: On model.jaffle_shop.customers: Close
[0m03:41:57.291720 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'f50e8d1b-f442-4902-ac19-2d430a329182', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1147e72e0>]}
[0m03:41:57.292648 [info ] [Thread-1  ]: 15 of 28 OK created python table model bruno.customers ......................... [[32mSUCCESS 1[0m in 10.25s]
[0m03:41:57.293494 [debug] [Thread-1  ]: Finished running node model.jaffle_shop.customers
[0m03:41:57.293863 [debug] [Thread-1  ]: Began running node model.jaffle_shop.orders
[0m03:41:57.294438 [info ] [Thread-1  ]: 16 of 28 START python table model bruno.orders ................................. [RUN]
[0m03:41:57.295877 [debug] [Thread-1  ]: Acquiring new snowflake connection "model.jaffle_shop.orders"
[0m03:41:57.296217 [debug] [Thread-1  ]: Began compiling node model.jaffle_shop.orders
[0m03:41:57.296526 [debug] [Thread-1  ]: Compiling model.jaffle_shop.orders
[0m03:41:57.304323 [debug] [Thread-1  ]: Writing injected SQL for node "model.jaffle_shop.orders"
[0m03:41:57.306105 [debug] [Thread-1  ]: finished collecting timing info
[0m03:41:57.306389 [debug] [Thread-1  ]: Began executing node model.jaffle_shop.orders
[0m03:41:57.311386 [debug] [Thread-1  ]: Writing runtime python for node "model.jaffle_shop.orders"
[0m03:41:57.315008 [debug] [Thread-1  ]: Using snowflake connection "model.jaffle_shop.orders"
[0m03:41:57.315256 [debug] [Thread-1  ]: On model.jaffle_shop.orders: /* {"app": "dbt", "dbt_version": "1.3.2", "profile_name": "jaffle_shop", "target_name": "dev", "node_id": "model.jaffle_shop.orders"} */
WITH orders__dbt_sp AS PROCEDURE ()

RETURNS STRING
LANGUAGE PYTHON
RUNTIME_VERSION = '3.8'
PACKAGES = ('snowflake-snowpark-python')

HANDLER = 'main'
EXECUTE AS CALLER
AS
$$

  
    
import snowflake.snowpark.functions as F

def model(dbt, session):

    stg_orders = dbt.ref('stg_orders')
    stg_payments = dbt.ref('stg_payments')

    payment_methods = ['credit_card', 'coupon', 'bank_transfer', 'gift_card']

    agg_list = [F.sum(F.when(stg_payments.payment_method == payment_method, stg_payments.amount).otherwise(0)).alias(payment_method + "_amount") for payment_method in payment_methods]

    agg_list.append(F.sum(F.col("amount")).alias("total_amount"))

    order_payments = (
        stg_payments
        .group_by("order_id")
        .agg(*agg_list)
    )

    final_df = (
        stg_orders
        .join(order_payments, stg_orders.order_id == order_payments.order_id, "left")
        .select(stg_orders.order_id.alias("order_id"),
                stg_orders.customer_id.alias("customer_id"),
                stg_orders.order_date.alias("order_date"),
                stg_orders.status.alias("status"),
                *[F.col(payment_method + "_amount") for payment_method in payment_methods],
                order_payments.total_amount.alias("amount")
        )
    )

    return final_df


# This part is user provided model code
# you will need to copy the next section to run the code
# COMMAND ----------
# this part is dbt logic for get ref work, do not modify

def ref(*args,dbt_load_df_function):
    refs = {"stg_orders": "jaffle_shop.bruno.stg_orders", "stg_payments": "jaffle_shop.bruno.stg_payments"}
    key = ".".join(args)
    return dbt_load_df_function(refs[key])


def source(*args, dbt_load_df_function):
    sources = {}
    key = ".".join(args)
    return dbt_load_df_function(sources[key])


config_dict = {}


class config:
    def __init__(self, *args, **kwargs):
        pass

    @staticmethod
    def get(key, default=None):
        return config_dict.get(key, default)

class this:
    """dbt.this() or dbt.this.identifier"""
    database = 'jaffle_shop'
    schema = 'bruno'
    identifier = 'orders'
    def __repr__(self):
        return 'jaffle_shop.bruno.orders'


class dbtObj:
    def __init__(self, load_df_function) -> None:
        self.source = lambda *args: source(*args, dbt_load_df_function=load_df_function)
        self.ref = lambda *args: ref(*args, dbt_load_df_function=load_df_function)
        self.config = config
        self.this = this()
        self.is_incremental = False

# COMMAND ----------

# To run this in snowsight, you need to select entry point to be main
# And you may have to modify the return type to text to get the result back
# def main(session):
#     dbt = dbtObj(session.table)
#     df = model(dbt, session)
#     return df.collect()

# to run this in local notebook, you need to create a session following examples https://github.com/Snowflake-Labs/sfguide-getting-started-snowpark-python
# then you can do the following to run model
# dbt = dbtObj(session.table)
# df = model(dbt, session)


def materialize(session, df, target_relation):
    # make sure pandas exists
    import importlib.util
    package_name = 'pandas'
    if importlib.util.find_spec(package_name):
        import pandas
        if isinstance(df, pandas.core.frame.DataFrame):
          # session.write_pandas does not have overwrite function
          df = session.createDataFrame(df)
    df.write.mode("overwrite").save_as_table("jaffle_shop.bruno.orders", create_temp_table=False)

def main(session):
    dbt = dbtObj(session.table)
    df = model(dbt, session)
    materialize(session, df, dbt.this)
    return "OK"

  
$$
CALL orders__dbt_sp();
[0m03:41:57.315452 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m03:42:03.799315 [debug] [Thread-1  ]: SQL status: SUCCESS 1 in 6.48 seconds
[0m03:42:03.808804 [debug] [Thread-1  ]: finished collecting timing info
[0m03:42:03.809274 [debug] [Thread-1  ]: On model.jaffle_shop.orders: Close
[0m03:42:04.170055 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'f50e8d1b-f442-4902-ac19-2d430a329182', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1148048e0>]}
[0m03:42:04.171212 [info ] [Thread-1  ]: 16 of 28 OK created python table model bruno.orders ............................ [[32mSUCCESS 1[0m in 6.87s]
[0m03:42:04.172163 [debug] [Thread-1  ]: Finished running node model.jaffle_shop.orders
[0m03:42:04.172553 [debug] [Thread-1  ]: Began running node test.jaffle_shop.not_null_customers_customer_id.5c9bf9911d
[0m03:42:04.173123 [info ] [Thread-1  ]: 17 of 28 START test not_null_customers_customer_id ............................. [RUN]
[0m03:42:04.174935 [debug] [Thread-1  ]: Acquiring new snowflake connection "test.jaffle_shop.not_null_customers_customer_id.5c9bf9911d"
[0m03:42:04.175289 [debug] [Thread-1  ]: Began compiling node test.jaffle_shop.not_null_customers_customer_id.5c9bf9911d
[0m03:42:04.175620 [debug] [Thread-1  ]: Compiling test.jaffle_shop.not_null_customers_customer_id.5c9bf9911d
[0m03:42:04.185750 [debug] [Thread-1  ]: Writing injected SQL for node "test.jaffle_shop.not_null_customers_customer_id.5c9bf9911d"
[0m03:42:04.187971 [debug] [Thread-1  ]: finished collecting timing info
[0m03:42:04.188321 [debug] [Thread-1  ]: Began executing node test.jaffle_shop.not_null_customers_customer_id.5c9bf9911d
[0m03:42:04.193176 [debug] [Thread-1  ]: Writing runtime sql for node "test.jaffle_shop.not_null_customers_customer_id.5c9bf9911d"
[0m03:42:04.194708 [debug] [Thread-1  ]: Using snowflake connection "test.jaffle_shop.not_null_customers_customer_id.5c9bf9911d"
[0m03:42:04.194910 [debug] [Thread-1  ]: On test.jaffle_shop.not_null_customers_customer_id.5c9bf9911d: /* {"app": "dbt", "dbt_version": "1.3.2", "profile_name": "jaffle_shop", "target_name": "dev", "node_id": "test.jaffle_shop.not_null_customers_customer_id.5c9bf9911d"} */
select
      count(*) as failures,
      count(*) != 0 as should_warn,
      count(*) != 0 as should_error
    from (
      
    
    



select customer_id
from jaffle_shop.bruno.customers
where customer_id is null



      
    ) dbt_internal_test
[0m03:42:04.195089 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m03:42:05.145097 [debug] [Thread-1  ]: SQL status: SUCCESS 1 in 0.95 seconds
[0m03:42:05.149734 [debug] [Thread-1  ]: finished collecting timing info
[0m03:42:05.150136 [debug] [Thread-1  ]: On test.jaffle_shop.not_null_customers_customer_id.5c9bf9911d: Close
[0m03:42:05.498609 [info ] [Thread-1  ]: 17 of 28 PASS not_null_customers_customer_id ................................... [[32mPASS[0m in 1.32s]
[0m03:42:05.499880 [debug] [Thread-1  ]: Finished running node test.jaffle_shop.not_null_customers_customer_id.5c9bf9911d
[0m03:42:05.500281 [debug] [Thread-1  ]: Began running node test.jaffle_shop.unique_customers_customer_id.c5af1ff4b1
[0m03:42:05.500727 [info ] [Thread-1  ]: 18 of 28 START test unique_customers_customer_id ............................... [RUN]
[0m03:42:05.502096 [debug] [Thread-1  ]: Acquiring new snowflake connection "test.jaffle_shop.unique_customers_customer_id.c5af1ff4b1"
[0m03:42:05.502405 [debug] [Thread-1  ]: Began compiling node test.jaffle_shop.unique_customers_customer_id.c5af1ff4b1
[0m03:42:05.502683 [debug] [Thread-1  ]: Compiling test.jaffle_shop.unique_customers_customer_id.c5af1ff4b1
[0m03:42:05.512019 [debug] [Thread-1  ]: Writing injected SQL for node "test.jaffle_shop.unique_customers_customer_id.c5af1ff4b1"
[0m03:42:05.513721 [debug] [Thread-1  ]: finished collecting timing info
[0m03:42:05.514154 [debug] [Thread-1  ]: Began executing node test.jaffle_shop.unique_customers_customer_id.c5af1ff4b1
[0m03:42:05.519124 [debug] [Thread-1  ]: Writing runtime sql for node "test.jaffle_shop.unique_customers_customer_id.c5af1ff4b1"
[0m03:42:05.520904 [debug] [Thread-1  ]: Using snowflake connection "test.jaffle_shop.unique_customers_customer_id.c5af1ff4b1"
[0m03:42:05.521137 [debug] [Thread-1  ]: On test.jaffle_shop.unique_customers_customer_id.c5af1ff4b1: /* {"app": "dbt", "dbt_version": "1.3.2", "profile_name": "jaffle_shop", "target_name": "dev", "node_id": "test.jaffle_shop.unique_customers_customer_id.c5af1ff4b1"} */
select
      count(*) as failures,
      count(*) != 0 as should_warn,
      count(*) != 0 as should_error
    from (
      
    
    

select
    customer_id as unique_field,
    count(*) as n_records

from jaffle_shop.bruno.customers
where customer_id is not null
group by customer_id
having count(*) > 1



      
    ) dbt_internal_test
[0m03:42:05.521361 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m03:42:06.367035 [debug] [Thread-1  ]: SQL status: SUCCESS 1 in 0.85 seconds
[0m03:42:06.369839 [debug] [Thread-1  ]: finished collecting timing info
[0m03:42:06.370116 [debug] [Thread-1  ]: On test.jaffle_shop.unique_customers_customer_id.c5af1ff4b1: Close
[0m03:42:06.781703 [info ] [Thread-1  ]: 18 of 28 PASS unique_customers_customer_id ..................................... [[32mPASS[0m in 1.28s]
[0m03:42:06.782425 [debug] [Thread-1  ]: Finished running node test.jaffle_shop.unique_customers_customer_id.c5af1ff4b1
[0m03:42:06.782696 [debug] [Thread-1  ]: Began running node test.jaffle_shop.accepted_values_orders_status__placed__shipped__completed__return_pending__returned.be6b5b5ec3
[0m03:42:06.783016 [info ] [Thread-1  ]: 19 of 28 START test accepted_values_orders_status__placed__shipped__completed__return_pending__returned  [RUN]
[0m03:42:06.783925 [debug] [Thread-1  ]: Acquiring new snowflake connection "test.jaffle_shop.accepted_values_orders_status__placed__shipped__completed__return_pending__returned.be6b5b5ec3"
[0m03:42:06.784147 [debug] [Thread-1  ]: Began compiling node test.jaffle_shop.accepted_values_orders_status__placed__shipped__completed__return_pending__returned.be6b5b5ec3
[0m03:42:06.784357 [debug] [Thread-1  ]: Compiling test.jaffle_shop.accepted_values_orders_status__placed__shipped__completed__return_pending__returned.be6b5b5ec3
[0m03:42:06.842733 [debug] [Thread-1  ]: Writing injected SQL for node "test.jaffle_shop.accepted_values_orders_status__placed__shipped__completed__return_pending__returned.be6b5b5ec3"
[0m03:42:06.843197 [debug] [Thread-1  ]: finished collecting timing info
[0m03:42:06.843310 [debug] [Thread-1  ]: Began executing node test.jaffle_shop.accepted_values_orders_status__placed__shipped__completed__return_pending__returned.be6b5b5ec3
[0m03:42:06.845310 [debug] [Thread-1  ]: Writing runtime sql for node "test.jaffle_shop.accepted_values_orders_status__placed__shipped__completed__return_pending__returned.be6b5b5ec3"
[0m03:42:06.846033 [debug] [Thread-1  ]: Using snowflake connection "test.jaffle_shop.accepted_values_orders_status__placed__shipped__completed__return_pending__returned.be6b5b5ec3"
[0m03:42:06.846130 [debug] [Thread-1  ]: On test.jaffle_shop.accepted_values_orders_status__placed__shipped__completed__return_pending__returned.be6b5b5ec3: /* {"app": "dbt", "dbt_version": "1.3.2", "profile_name": "jaffle_shop", "target_name": "dev", "node_id": "test.jaffle_shop.accepted_values_orders_status__placed__shipped__completed__return_pending__returned.be6b5b5ec3"} */
select
      count(*) as failures,
      count(*) != 0 as should_warn,
      count(*) != 0 as should_error
    from (
      
    
    

with all_values as (

    select
        status as value_field,
        count(*) as n_records

    from jaffle_shop.bruno.orders
    group by status

)

select *
from all_values
where value_field not in (
    'placed','shipped','completed','return_pending','returned'
)



      
    ) dbt_internal_test
[0m03:42:06.846221 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m03:42:07.603900 [debug] [Thread-1  ]: SQL status: SUCCESS 1 in 0.76 seconds
[0m03:42:07.607546 [debug] [Thread-1  ]: finished collecting timing info
[0m03:42:07.607882 [debug] [Thread-1  ]: On test.jaffle_shop.accepted_values_orders_status__placed__shipped__completed__return_pending__returned.be6b5b5ec3: Close
[0m03:42:07.939711 [info ] [Thread-1  ]: 19 of 28 PASS accepted_values_orders_status__placed__shipped__completed__return_pending__returned  [[32mPASS[0m in 1.16s]
[0m03:42:07.940760 [debug] [Thread-1  ]: Finished running node test.jaffle_shop.accepted_values_orders_status__placed__shipped__completed__return_pending__returned.be6b5b5ec3
[0m03:42:07.941150 [debug] [Thread-1  ]: Began running node test.jaffle_shop.not_null_orders_amount.106140f9fd
[0m03:42:07.941592 [info ] [Thread-1  ]: 20 of 28 START test not_null_orders_amount ..................................... [RUN]
[0m03:42:07.942853 [debug] [Thread-1  ]: Acquiring new snowflake connection "test.jaffle_shop.not_null_orders_amount.106140f9fd"
[0m03:42:07.943153 [debug] [Thread-1  ]: Began compiling node test.jaffle_shop.not_null_orders_amount.106140f9fd
[0m03:42:07.943429 [debug] [Thread-1  ]: Compiling test.jaffle_shop.not_null_orders_amount.106140f9fd
[0m03:42:07.952903 [debug] [Thread-1  ]: Writing injected SQL for node "test.jaffle_shop.not_null_orders_amount.106140f9fd"
[0m03:42:07.953899 [debug] [Thread-1  ]: finished collecting timing info
[0m03:42:07.954179 [debug] [Thread-1  ]: Began executing node test.jaffle_shop.not_null_orders_amount.106140f9fd
[0m03:42:07.958610 [debug] [Thread-1  ]: Writing runtime sql for node "test.jaffle_shop.not_null_orders_amount.106140f9fd"
[0m03:42:07.959812 [debug] [Thread-1  ]: Using snowflake connection "test.jaffle_shop.not_null_orders_amount.106140f9fd"
[0m03:42:07.960004 [debug] [Thread-1  ]: On test.jaffle_shop.not_null_orders_amount.106140f9fd: /* {"app": "dbt", "dbt_version": "1.3.2", "profile_name": "jaffle_shop", "target_name": "dev", "node_id": "test.jaffle_shop.not_null_orders_amount.106140f9fd"} */
select
      count(*) as failures,
      count(*) != 0 as should_warn,
      count(*) != 0 as should_error
    from (
      
    
    



select amount
from jaffle_shop.bruno.orders
where amount is null



      
    ) dbt_internal_test
[0m03:42:07.960185 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m03:42:08.827527 [debug] [Thread-1  ]: SQL status: SUCCESS 1 in 0.87 seconds
[0m03:42:08.835144 [debug] [Thread-1  ]: finished collecting timing info
[0m03:42:08.835676 [debug] [Thread-1  ]: On test.jaffle_shop.not_null_orders_amount.106140f9fd: Close
[0m03:42:09.218514 [info ] [Thread-1  ]: 20 of 28 PASS not_null_orders_amount ........................................... [[32mPASS[0m in 1.28s]
[0m03:42:09.219781 [debug] [Thread-1  ]: Finished running node test.jaffle_shop.not_null_orders_amount.106140f9fd
[0m03:42:09.220165 [debug] [Thread-1  ]: Began running node test.jaffle_shop.not_null_orders_bank_transfer_amount.7743500c49
[0m03:42:09.220657 [info ] [Thread-1  ]: 21 of 28 START test not_null_orders_bank_transfer_amount ....................... [RUN]
[0m03:42:09.221936 [debug] [Thread-1  ]: Acquiring new snowflake connection "test.jaffle_shop.not_null_orders_bank_transfer_amount.7743500c49"
[0m03:42:09.222259 [debug] [Thread-1  ]: Began compiling node test.jaffle_shop.not_null_orders_bank_transfer_amount.7743500c49
[0m03:42:09.222590 [debug] [Thread-1  ]: Compiling test.jaffle_shop.not_null_orders_bank_transfer_amount.7743500c49
[0m03:42:09.232531 [debug] [Thread-1  ]: Writing injected SQL for node "test.jaffle_shop.not_null_orders_bank_transfer_amount.7743500c49"
[0m03:42:09.233533 [debug] [Thread-1  ]: finished collecting timing info
[0m03:42:09.233804 [debug] [Thread-1  ]: Began executing node test.jaffle_shop.not_null_orders_bank_transfer_amount.7743500c49
[0m03:42:09.238344 [debug] [Thread-1  ]: Writing runtime sql for node "test.jaffle_shop.not_null_orders_bank_transfer_amount.7743500c49"
[0m03:42:09.239669 [debug] [Thread-1  ]: Using snowflake connection "test.jaffle_shop.not_null_orders_bank_transfer_amount.7743500c49"
[0m03:42:09.239867 [debug] [Thread-1  ]: On test.jaffle_shop.not_null_orders_bank_transfer_amount.7743500c49: /* {"app": "dbt", "dbt_version": "1.3.2", "profile_name": "jaffle_shop", "target_name": "dev", "node_id": "test.jaffle_shop.not_null_orders_bank_transfer_amount.7743500c49"} */
select
      count(*) as failures,
      count(*) != 0 as should_warn,
      count(*) != 0 as should_error
    from (
      
    
    



select bank_transfer_amount
from jaffle_shop.bruno.orders
where bank_transfer_amount is null



      
    ) dbt_internal_test
[0m03:42:09.240046 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m03:42:09.912785 [debug] [Thread-1  ]: SQL status: SUCCESS 1 in 0.67 seconds
[0m03:42:09.917636 [debug] [Thread-1  ]: finished collecting timing info
[0m03:42:09.918043 [debug] [Thread-1  ]: On test.jaffle_shop.not_null_orders_bank_transfer_amount.7743500c49: Close
[0m03:42:10.259502 [info ] [Thread-1  ]: 21 of 28 PASS not_null_orders_bank_transfer_amount ............................. [[32mPASS[0m in 1.04s]
[0m03:42:10.260481 [debug] [Thread-1  ]: Finished running node test.jaffle_shop.not_null_orders_bank_transfer_amount.7743500c49
[0m03:42:10.260862 [debug] [Thread-1  ]: Began running node test.jaffle_shop.not_null_orders_coupon_amount.ab90c90625
[0m03:42:10.261280 [info ] [Thread-1  ]: 22 of 28 START test not_null_orders_coupon_amount .............................. [RUN]
[0m03:42:10.262483 [debug] [Thread-1  ]: Acquiring new snowflake connection "test.jaffle_shop.not_null_orders_coupon_amount.ab90c90625"
[0m03:42:10.262816 [debug] [Thread-1  ]: Began compiling node test.jaffle_shop.not_null_orders_coupon_amount.ab90c90625
[0m03:42:10.263069 [debug] [Thread-1  ]: Compiling test.jaffle_shop.not_null_orders_coupon_amount.ab90c90625
[0m03:42:10.272439 [debug] [Thread-1  ]: Writing injected SQL for node "test.jaffle_shop.not_null_orders_coupon_amount.ab90c90625"
[0m03:42:10.273255 [debug] [Thread-1  ]: finished collecting timing info
[0m03:42:10.273480 [debug] [Thread-1  ]: Began executing node test.jaffle_shop.not_null_orders_coupon_amount.ab90c90625
[0m03:42:10.277551 [debug] [Thread-1  ]: Writing runtime sql for node "test.jaffle_shop.not_null_orders_coupon_amount.ab90c90625"
[0m03:42:10.278821 [debug] [Thread-1  ]: Using snowflake connection "test.jaffle_shop.not_null_orders_coupon_amount.ab90c90625"
[0m03:42:10.279067 [debug] [Thread-1  ]: On test.jaffle_shop.not_null_orders_coupon_amount.ab90c90625: /* {"app": "dbt", "dbt_version": "1.3.2", "profile_name": "jaffle_shop", "target_name": "dev", "node_id": "test.jaffle_shop.not_null_orders_coupon_amount.ab90c90625"} */
select
      count(*) as failures,
      count(*) != 0 as should_warn,
      count(*) != 0 as should_error
    from (
      
    
    



select coupon_amount
from jaffle_shop.bruno.orders
where coupon_amount is null



      
    ) dbt_internal_test
[0m03:42:10.279255 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m03:42:10.862556 [debug] [Thread-1  ]: SQL status: SUCCESS 1 in 0.58 seconds
[0m03:42:10.866052 [debug] [Thread-1  ]: finished collecting timing info
[0m03:42:10.866362 [debug] [Thread-1  ]: On test.jaffle_shop.not_null_orders_coupon_amount.ab90c90625: Close
[0m03:42:11.206534 [info ] [Thread-1  ]: 22 of 28 PASS not_null_orders_coupon_amount .................................... [[32mPASS[0m in 0.94s]
[0m03:42:11.208639 [debug] [Thread-1  ]: Finished running node test.jaffle_shop.not_null_orders_coupon_amount.ab90c90625
[0m03:42:11.209519 [debug] [Thread-1  ]: Began running node test.jaffle_shop.not_null_orders_credit_card_amount.d3ca593b59
[0m03:42:11.210359 [info ] [Thread-1  ]: 23 of 28 START test not_null_orders_credit_card_amount ......................... [RUN]
[0m03:42:11.212397 [debug] [Thread-1  ]: Acquiring new snowflake connection "test.jaffle_shop.not_null_orders_credit_card_amount.d3ca593b59"
[0m03:42:11.213005 [debug] [Thread-1  ]: Began compiling node test.jaffle_shop.not_null_orders_credit_card_amount.d3ca593b59
[0m03:42:11.214090 [debug] [Thread-1  ]: Compiling test.jaffle_shop.not_null_orders_credit_card_amount.d3ca593b59
[0m03:42:11.226823 [debug] [Thread-1  ]: Writing injected SQL for node "test.jaffle_shop.not_null_orders_credit_card_amount.d3ca593b59"
[0m03:42:11.228112 [debug] [Thread-1  ]: finished collecting timing info
[0m03:42:11.228607 [debug] [Thread-1  ]: Began executing node test.jaffle_shop.not_null_orders_credit_card_amount.d3ca593b59
[0m03:42:11.234200 [debug] [Thread-1  ]: Writing runtime sql for node "test.jaffle_shop.not_null_orders_credit_card_amount.d3ca593b59"
[0m03:42:11.235919 [debug] [Thread-1  ]: Using snowflake connection "test.jaffle_shop.not_null_orders_credit_card_amount.d3ca593b59"
[0m03:42:11.236243 [debug] [Thread-1  ]: On test.jaffle_shop.not_null_orders_credit_card_amount.d3ca593b59: /* {"app": "dbt", "dbt_version": "1.3.2", "profile_name": "jaffle_shop", "target_name": "dev", "node_id": "test.jaffle_shop.not_null_orders_credit_card_amount.d3ca593b59"} */
select
      count(*) as failures,
      count(*) != 0 as should_warn,
      count(*) != 0 as should_error
    from (
      
    
    



select credit_card_amount
from jaffle_shop.bruno.orders
where credit_card_amount is null



      
    ) dbt_internal_test
[0m03:42:11.236494 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m03:42:12.070723 [debug] [Thread-1  ]: SQL status: SUCCESS 1 in 0.83 seconds
[0m03:42:12.078047 [debug] [Thread-1  ]: finished collecting timing info
[0m03:42:12.078954 [debug] [Thread-1  ]: On test.jaffle_shop.not_null_orders_credit_card_amount.d3ca593b59: Close
[0m03:42:12.488603 [info ] [Thread-1  ]: 23 of 28 PASS not_null_orders_credit_card_amount ............................... [[32mPASS[0m in 1.28s]
[0m03:42:12.489929 [debug] [Thread-1  ]: Finished running node test.jaffle_shop.not_null_orders_credit_card_amount.d3ca593b59
[0m03:42:12.490385 [debug] [Thread-1  ]: Began running node test.jaffle_shop.not_null_orders_customer_id.c5f02694af
[0m03:42:12.490894 [info ] [Thread-1  ]: 24 of 28 START test not_null_orders_customer_id ................................ [RUN]
[0m03:42:12.492518 [debug] [Thread-1  ]: Acquiring new snowflake connection "test.jaffle_shop.not_null_orders_customer_id.c5f02694af"
[0m03:42:12.493078 [debug] [Thread-1  ]: Began compiling node test.jaffle_shop.not_null_orders_customer_id.c5f02694af
[0m03:42:12.493431 [debug] [Thread-1  ]: Compiling test.jaffle_shop.not_null_orders_customer_id.c5f02694af
[0m03:42:12.507535 [debug] [Thread-1  ]: Writing injected SQL for node "test.jaffle_shop.not_null_orders_customer_id.c5f02694af"
[0m03:42:12.508545 [debug] [Thread-1  ]: finished collecting timing info
[0m03:42:12.508834 [debug] [Thread-1  ]: Began executing node test.jaffle_shop.not_null_orders_customer_id.c5f02694af
[0m03:42:12.513290 [debug] [Thread-1  ]: Writing runtime sql for node "test.jaffle_shop.not_null_orders_customer_id.c5f02694af"
[0m03:42:12.514685 [debug] [Thread-1  ]: Using snowflake connection "test.jaffle_shop.not_null_orders_customer_id.c5f02694af"
[0m03:42:12.514889 [debug] [Thread-1  ]: On test.jaffle_shop.not_null_orders_customer_id.c5f02694af: /* {"app": "dbt", "dbt_version": "1.3.2", "profile_name": "jaffle_shop", "target_name": "dev", "node_id": "test.jaffle_shop.not_null_orders_customer_id.c5f02694af"} */
select
      count(*) as failures,
      count(*) != 0 as should_warn,
      count(*) != 0 as should_error
    from (
      
    
    



select customer_id
from jaffle_shop.bruno.orders
where customer_id is null



      
    ) dbt_internal_test
[0m03:42:12.515070 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m03:42:13.231346 [debug] [Thread-1  ]: SQL status: SUCCESS 1 in 0.72 seconds
[0m03:42:13.239526 [debug] [Thread-1  ]: finished collecting timing info
[0m03:42:13.240295 [debug] [Thread-1  ]: On test.jaffle_shop.not_null_orders_customer_id.c5f02694af: Close
[0m03:42:13.643235 [info ] [Thread-1  ]: 24 of 28 PASS not_null_orders_customer_id ...................................... [[32mPASS[0m in 1.15s]
[0m03:42:13.645067 [debug] [Thread-1  ]: Finished running node test.jaffle_shop.not_null_orders_customer_id.c5f02694af
[0m03:42:13.645839 [debug] [Thread-1  ]: Began running node test.jaffle_shop.not_null_orders_gift_card_amount.413a0d2d7a
[0m03:42:13.646503 [info ] [Thread-1  ]: 25 of 28 START test not_null_orders_gift_card_amount ........................... [RUN]
[0m03:42:13.648247 [debug] [Thread-1  ]: Acquiring new snowflake connection "test.jaffle_shop.not_null_orders_gift_card_amount.413a0d2d7a"
[0m03:42:13.648802 [debug] [Thread-1  ]: Began compiling node test.jaffle_shop.not_null_orders_gift_card_amount.413a0d2d7a
[0m03:42:13.649173 [debug] [Thread-1  ]: Compiling test.jaffle_shop.not_null_orders_gift_card_amount.413a0d2d7a
[0m03:42:13.664746 [debug] [Thread-1  ]: Writing injected SQL for node "test.jaffle_shop.not_null_orders_gift_card_amount.413a0d2d7a"
[0m03:42:13.665875 [debug] [Thread-1  ]: finished collecting timing info
[0m03:42:13.666202 [debug] [Thread-1  ]: Began executing node test.jaffle_shop.not_null_orders_gift_card_amount.413a0d2d7a
[0m03:42:13.672277 [debug] [Thread-1  ]: Writing runtime sql for node "test.jaffle_shop.not_null_orders_gift_card_amount.413a0d2d7a"
[0m03:42:13.674204 [debug] [Thread-1  ]: Using snowflake connection "test.jaffle_shop.not_null_orders_gift_card_amount.413a0d2d7a"
[0m03:42:13.674460 [debug] [Thread-1  ]: On test.jaffle_shop.not_null_orders_gift_card_amount.413a0d2d7a: /* {"app": "dbt", "dbt_version": "1.3.2", "profile_name": "jaffle_shop", "target_name": "dev", "node_id": "test.jaffle_shop.not_null_orders_gift_card_amount.413a0d2d7a"} */
select
      count(*) as failures,
      count(*) != 0 as should_warn,
      count(*) != 0 as should_error
    from (
      
    
    



select gift_card_amount
from jaffle_shop.bruno.orders
where gift_card_amount is null



      
    ) dbt_internal_test
[0m03:42:13.674674 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m03:42:14.460581 [debug] [Thread-1  ]: SQL status: SUCCESS 1 in 0.79 seconds
[0m03:42:14.469859 [debug] [Thread-1  ]: finished collecting timing info
[0m03:42:14.470608 [debug] [Thread-1  ]: On test.jaffle_shop.not_null_orders_gift_card_amount.413a0d2d7a: Close
[0m03:42:14.801523 [info ] [Thread-1  ]: 25 of 28 PASS not_null_orders_gift_card_amount ................................. [[32mPASS[0m in 1.15s]
[0m03:42:14.803512 [debug] [Thread-1  ]: Finished running node test.jaffle_shop.not_null_orders_gift_card_amount.413a0d2d7a
[0m03:42:14.804421 [debug] [Thread-1  ]: Began running node test.jaffle_shop.not_null_orders_order_id.cf6c17daed
[0m03:42:14.805166 [info ] [Thread-1  ]: 26 of 28 START test not_null_orders_order_id ................................... [RUN]
[0m03:42:14.807415 [debug] [Thread-1  ]: Acquiring new snowflake connection "test.jaffle_shop.not_null_orders_order_id.cf6c17daed"
[0m03:42:14.808085 [debug] [Thread-1  ]: Began compiling node test.jaffle_shop.not_null_orders_order_id.cf6c17daed
[0m03:42:14.808483 [debug] [Thread-1  ]: Compiling test.jaffle_shop.not_null_orders_order_id.cf6c17daed
[0m03:42:14.822457 [debug] [Thread-1  ]: Writing injected SQL for node "test.jaffle_shop.not_null_orders_order_id.cf6c17daed"
[0m03:42:14.823488 [debug] [Thread-1  ]: finished collecting timing info
[0m03:42:14.823812 [debug] [Thread-1  ]: Began executing node test.jaffle_shop.not_null_orders_order_id.cf6c17daed
[0m03:42:14.828969 [debug] [Thread-1  ]: Writing runtime sql for node "test.jaffle_shop.not_null_orders_order_id.cf6c17daed"
[0m03:42:14.830315 [debug] [Thread-1  ]: Using snowflake connection "test.jaffle_shop.not_null_orders_order_id.cf6c17daed"
[0m03:42:14.830569 [debug] [Thread-1  ]: On test.jaffle_shop.not_null_orders_order_id.cf6c17daed: /* {"app": "dbt", "dbt_version": "1.3.2", "profile_name": "jaffle_shop", "target_name": "dev", "node_id": "test.jaffle_shop.not_null_orders_order_id.cf6c17daed"} */
select
      count(*) as failures,
      count(*) != 0 as should_warn,
      count(*) != 0 as should_error
    from (
      
    
    



select order_id
from jaffle_shop.bruno.orders
where order_id is null



      
    ) dbt_internal_test
[0m03:42:14.830779 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m03:42:15.439277 [debug] [Thread-1  ]: SQL status: SUCCESS 1 in 0.61 seconds
[0m03:42:15.445642 [debug] [Thread-1  ]: finished collecting timing info
[0m03:42:15.446536 [debug] [Thread-1  ]: On test.jaffle_shop.not_null_orders_order_id.cf6c17daed: Close
[0m03:42:15.793687 [info ] [Thread-1  ]: 26 of 28 PASS not_null_orders_order_id ......................................... [[32mPASS[0m in 0.99s]
[0m03:42:15.795018 [debug] [Thread-1  ]: Finished running node test.jaffle_shop.not_null_orders_order_id.cf6c17daed
[0m03:42:15.795684 [debug] [Thread-1  ]: Began running node test.jaffle_shop.relationships_orders_customer_id__customer_id__ref_customers_.c6ec7f58f2
[0m03:42:15.796307 [info ] [Thread-1  ]: 27 of 28 START test relationships_orders_customer_id__customer_id__ref_customers_  [RUN]
[0m03:42:15.799297 [debug] [Thread-1  ]: Acquiring new snowflake connection "test.jaffle_shop.relationships_orders_customer_id__customer_id__ref_customers_.c6ec7f58f2"
[0m03:42:15.801409 [debug] [Thread-1  ]: Began compiling node test.jaffle_shop.relationships_orders_customer_id__customer_id__ref_customers_.c6ec7f58f2
[0m03:42:15.802268 [debug] [Thread-1  ]: Compiling test.jaffle_shop.relationships_orders_customer_id__customer_id__ref_customers_.c6ec7f58f2
[0m03:42:15.815738 [debug] [Thread-1  ]: Writing injected SQL for node "test.jaffle_shop.relationships_orders_customer_id__customer_id__ref_customers_.c6ec7f58f2"
[0m03:42:15.816475 [debug] [Thread-1  ]: finished collecting timing info
[0m03:42:15.816684 [debug] [Thread-1  ]: Began executing node test.jaffle_shop.relationships_orders_customer_id__customer_id__ref_customers_.c6ec7f58f2
[0m03:42:15.821394 [debug] [Thread-1  ]: Writing runtime sql for node "test.jaffle_shop.relationships_orders_customer_id__customer_id__ref_customers_.c6ec7f58f2"
[0m03:42:15.823212 [debug] [Thread-1  ]: Using snowflake connection "test.jaffle_shop.relationships_orders_customer_id__customer_id__ref_customers_.c6ec7f58f2"
[0m03:42:15.824010 [debug] [Thread-1  ]: On test.jaffle_shop.relationships_orders_customer_id__customer_id__ref_customers_.c6ec7f58f2: /* {"app": "dbt", "dbt_version": "1.3.2", "profile_name": "jaffle_shop", "target_name": "dev", "node_id": "test.jaffle_shop.relationships_orders_customer_id__customer_id__ref_customers_.c6ec7f58f2"} */
select
      count(*) as failures,
      count(*) != 0 as should_warn,
      count(*) != 0 as should_error
    from (
      
    
    

with child as (
    select customer_id as from_field
    from jaffle_shop.bruno.orders
    where customer_id is not null
),

parent as (
    select customer_id as to_field
    from jaffle_shop.bruno.customers
)

select
    from_field

from child
left join parent
    on child.from_field = parent.to_field

where parent.to_field is null



      
    ) dbt_internal_test
[0m03:42:15.824338 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m03:42:16.602960 [debug] [Thread-1  ]: SQL status: SUCCESS 1 in 0.78 seconds
[0m03:42:16.613197 [debug] [Thread-1  ]: finished collecting timing info
[0m03:42:16.614179 [debug] [Thread-1  ]: On test.jaffle_shop.relationships_orders_customer_id__customer_id__ref_customers_.c6ec7f58f2: Close
[0m03:42:16.960697 [info ] [Thread-1  ]: 27 of 28 PASS relationships_orders_customer_id__customer_id__ref_customers_ .... [[32mPASS[0m in 1.16s]
[0m03:42:16.962754 [debug] [Thread-1  ]: Finished running node test.jaffle_shop.relationships_orders_customer_id__customer_id__ref_customers_.c6ec7f58f2
[0m03:42:16.963525 [debug] [Thread-1  ]: Began running node test.jaffle_shop.unique_orders_order_id.fed79b3a6e
[0m03:42:16.964439 [info ] [Thread-1  ]: 28 of 28 START test unique_orders_order_id ..................................... [RUN]
[0m03:42:16.966578 [debug] [Thread-1  ]: Acquiring new snowflake connection "test.jaffle_shop.unique_orders_order_id.fed79b3a6e"
[0m03:42:16.967453 [debug] [Thread-1  ]: Began compiling node test.jaffle_shop.unique_orders_order_id.fed79b3a6e
[0m03:42:16.968757 [debug] [Thread-1  ]: Compiling test.jaffle_shop.unique_orders_order_id.fed79b3a6e
[0m03:42:16.984984 [debug] [Thread-1  ]: Writing injected SQL for node "test.jaffle_shop.unique_orders_order_id.fed79b3a6e"
[0m03:42:16.986398 [debug] [Thread-1  ]: finished collecting timing info
[0m03:42:16.986806 [debug] [Thread-1  ]: Began executing node test.jaffle_shop.unique_orders_order_id.fed79b3a6e
[0m03:42:16.993116 [debug] [Thread-1  ]: Writing runtime sql for node "test.jaffle_shop.unique_orders_order_id.fed79b3a6e"
[0m03:42:16.995292 [debug] [Thread-1  ]: Using snowflake connection "test.jaffle_shop.unique_orders_order_id.fed79b3a6e"
[0m03:42:16.995661 [debug] [Thread-1  ]: On test.jaffle_shop.unique_orders_order_id.fed79b3a6e: /* {"app": "dbt", "dbt_version": "1.3.2", "profile_name": "jaffle_shop", "target_name": "dev", "node_id": "test.jaffle_shop.unique_orders_order_id.fed79b3a6e"} */
select
      count(*) as failures,
      count(*) != 0 as should_warn,
      count(*) != 0 as should_error
    from (
      
    
    

select
    order_id as unique_field,
    count(*) as n_records

from jaffle_shop.bruno.orders
where order_id is not null
group by order_id
having count(*) > 1



      
    ) dbt_internal_test
[0m03:42:16.996272 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m03:42:17.602323 [debug] [Thread-1  ]: SQL status: SUCCESS 1 in 0.61 seconds
[0m03:42:17.609151 [debug] [Thread-1  ]: finished collecting timing info
[0m03:42:17.609927 [debug] [Thread-1  ]: On test.jaffle_shop.unique_orders_order_id.fed79b3a6e: Close
[0m03:42:18.038453 [info ] [Thread-1  ]: 28 of 28 PASS unique_orders_order_id ........................................... [[32mPASS[0m in 1.07s]
[0m03:42:18.039764 [debug] [Thread-1  ]: Finished running node test.jaffle_shop.unique_orders_order_id.fed79b3a6e
[0m03:42:18.043156 [debug] [MainThread]: Acquiring new snowflake connection "master"
[0m03:42:18.045203 [info ] [MainThread]: 
[0m03:42:18.046186 [info ] [MainThread]: Finished running 3 seeds, 3 view models, 20 tests, 2 table models in 0 hours 0 minutes and 56.66 seconds (56.66s).
[0m03:42:18.047078 [debug] [MainThread]: Connection 'master' was properly closed.
[0m03:42:18.047488 [debug] [MainThread]: Connection 'test.jaffle_shop.unique_orders_order_id.fed79b3a6e' was properly closed.
[0m03:42:18.074611 [info ] [MainThread]: 
[0m03:42:18.075145 [info ] [MainThread]: [32mCompleted successfully[0m
[0m03:42:18.075829 [info ] [MainThread]: 
[0m03:42:18.076287 [info ] [MainThread]: Done. PASS=28 WARN=0 ERROR=0 SKIP=0 TOTAL=28
[0m03:42:18.077085 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x112a094c0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x112f41eb0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x11469b6d0>]}
[0m03:42:18.077533 [debug] [MainThread]: Flushing usage events
